Project Path: arc_gmh5225_android-overlay-protection_jmhp84hs

Source Tree:

```txt
arc_gmh5225_android-overlay-protection_jmhp84hs
├── LICENSE
├── README.md
├── app
│   ├── build.gradle
│   ├── libs
│   │   └── android-viewbadger.jar
│   ├── proguard-rules.pro
│   └── src
│       ├── androidTest
│       │   └── java
│       │       └── com
│       │           └── geeksonsecurity
│       │               └── android
│       │                   └── overlayprotector
│       │                       └── ApplicationTest.java
│       └── main
│           ├── AndroidManifest.xml
│           ├── java
│           │   └── com
│           │       └── geeksonsecurity
│           │           └── android
│           │               └── overlayprotector
│           │                   ├── AppListChangedReceiver.java
│           │                   ├── MainActivity.java
│           │                   ├── MonitorAccessibilityService.java
│           │                   ├── MyApplication.java
│           │                   ├── NavigationDrawerFragment.java
│           │                   ├── adapter
│           │                   │   ├── DetectedOverlayAdapter.java
│           │                   │   ├── SuspectedAppsAdapter.java
│           │                   │   └── WhiteEntryAdapter.java
│           │                   ├── database
│           │                   │   ├── DatabaseHelper.java
│           │                   │   └── DatabaseUtils.java
│           │                   ├── domain
│           │                   │   ├── ConcurrentArrayList.java
│           │                   │   ├── DetectedOverlay.java
│           │                   │   ├── DetectionEngine.java
│           │                   │   ├── EventCounter.java
│           │                   │   ├── OverlayState.java
│           │                   │   ├── ProcessUpdateEntry.java
│           │                   │   ├── ServiceCommunication.java
│           │                   │   ├── Settings.java
│           │                   │   ├── SuspectedApp.java
│           │                   │   └── WhiteEntry.java
│           │                   ├── service
│           │                   │   ├── AbstractDetectionEngine.java
│           │                   │   ├── AdvancedDetectionService.java
│           │                   │   ├── BaseDetectionEngine.java
│           │                   │   ├── IOverlayNotifyService.java
│           │                   │   └── ProcessHelper.java
│           │                   ├── tasks
│           │                   │   ├── IServiceStatusProcessor.java
│           │                   │   └── ServiceStatusTask.java
│           │                   ├── view
│           │                   │   ├── DetectedOverlayFragment.java
│           │                   │   ├── HomeFragment.java
│           │                   │   ├── SettingsFragment.java
│           │                   │   ├── SuspectedAppsFragment.java
│           │                   │   └── WhiteListFragment.java
│           │                   └── wizard
│           │                       ├── ConfigWizardActivity.java
│           │                       ├── ConfigWizardModel.java
│           │                       ├── WizardInfoPage.java
│           │                       └── WizardInfoPageFragment.java
│           └── res
│               ├── drawable
│               │   ├── apptheme_activated_background_holo_dark.xml
│               │   ├── apptheme_btn_check_holo_dark.xml
│               │   ├── apptheme_btn_default_holo_dark.xml
│               │   ├── apptheme_btn_radio_holo_dark.xml
│               │   ├── apptheme_edit_text_holo_dark.xml
│               │   ├── apptheme_fastscroll_thumb_holo.xml
│               │   ├── apptheme_item_background_holo_dark.xml
│               │   ├── apptheme_list_selector_background_transition_holo_dark.xml
│               │   ├── apptheme_list_selector_holo_dark.xml
│               │   ├── configstep1.png
│               │   ├── configstep2.png
│               │   ├── configstep3.png
│               │   ├── drawer_list_selector.xml
│               │   ├── eventborder.xml
│               │   ├── overlay_back.xml
│               │   └── rectangle.xml
│               ├── drawable-hdpi
│               │   ├── apptheme_btn_check_off_disabled_focused_holo_dark.png
│               │   ├── apptheme_btn_check_off_disabled_holo_dark.png
│               │   ├── apptheme_btn_check_off_focused_holo_dark.png
│               │   ├── apptheme_btn_check_off_holo_dark.png
│               │   ├── apptheme_btn_check_off_pressed_holo_dark.png
│               │   ├── apptheme_btn_check_on_disabled_focused_holo_dark.png
│               │   ├── apptheme_btn_check_on_disabled_holo_dark.png
│               │   ├── apptheme_btn_check_on_focused_holo_dark.png
│               │   ├── apptheme_btn_check_on_holo_dark.png
│               │   ├── apptheme_btn_check_on_pressed_holo_dark.png
│               │   ├── apptheme_btn_default_disabled_focused_holo_dark.9.png
│               │   ├── apptheme_btn_default_disabled_holo_dark.9.png
│               │   ├── apptheme_btn_default_focused_holo_dark.9.png
│               │   ├── apptheme_btn_default_normal_holo_dark.9.png
│               │   ├── apptheme_btn_default_pressed_holo_dark.9.png
│               │   ├── apptheme_btn_radio_off_disabled_focused_holo_dark.png
│               │   ├── apptheme_btn_radio_off_disabled_holo_dark.png
│               │   ├── apptheme_btn_radio_off_focused_holo_dark.png
│               │   ├── apptheme_btn_radio_off_holo_dark.png
│               │   ├── apptheme_btn_radio_off_pressed_holo_dark.png
│               │   ├── apptheme_btn_radio_on_disabled_focused_holo_dark.png
│               │   ├── apptheme_btn_radio_on_disabled_holo_dark.png
│               │   ├── apptheme_btn_radio_on_focused_holo_dark.png
│               │   ├── apptheme_btn_radio_on_holo_dark.png
│               │   ├── apptheme_btn_radio_on_pressed_holo_dark.png
│               │   ├── apptheme_fastscroll_thumb_default_holo.png
│               │   ├── apptheme_fastscroll_thumb_pressed_holo.png
│               │   ├── apptheme_ic_navigation_drawer.png
│               │   ├── apptheme_list_activated_holo.9.png
│               │   ├── apptheme_list_focused_holo.9.png
│               │   ├── apptheme_list_longpressed_holo.9.png
│               │   ├── apptheme_list_pressed_holo_dark.9.png
│               │   ├── apptheme_list_selector_disabled_holo_dark.9.png
│               │   ├── apptheme_textfield_activated_holo_dark.9.png
│               │   ├── apptheme_textfield_default_holo_dark.9.png
│               │   ├── apptheme_textfield_disabled_focused_holo_dark.9.png
│               │   ├── apptheme_textfield_disabled_holo_dark.9.png
│               │   ├── apptheme_textfield_focused_holo_dark.9.png
│               │   ├── drawer_shadow.9.png
│               │   ├── ic_action_new.png
│               │   ├── ic_action_refresh.png
│               │   ├── ic_action_save.png
│               │   ├── ic_actionbar.png
│               │   ├── ic_delete.png
│               │   ├── ic_launcher.png
│               │   ├── ic_launcher_circle.png
│               │   ├── ic_launcher_transparent.png
│               │   ├── ic_notification_small.png
│               │   ├── ic_question_icon.png
│               │   ├── ic_system.png
│               │   └── ic_user.png
│               ├── drawable-mdpi
│               │   ├── apptheme_btn_check_off_disabled_focused_holo_dark.png
│               │   ├── apptheme_btn_check_off_disabled_holo_dark.png
│               │   ├── apptheme_btn_check_off_focused_holo_dark.png
│               │   ├── apptheme_btn_check_off_holo_dark.png
│               │   ├── apptheme_btn_check_off_pressed_holo_dark.png
│               │   ├── apptheme_btn_check_on_disabled_focused_holo_dark.png
│               │   ├── apptheme_btn_check_on_disabled_holo_dark.png
│               │   ├── apptheme_btn_check_on_focused_holo_dark.png
│               │   ├── apptheme_btn_check_on_holo_dark.png
│               │   ├── apptheme_btn_check_on_pressed_holo_dark.png
│               │   ├── apptheme_btn_default_disabled_focused_holo_dark.9.png
│               │   ├── apptheme_btn_default_disabled_holo_dark.9.png
│               │   ├── apptheme_btn_default_focused_holo_dark.9.png
│               │   ├── apptheme_btn_default_normal_holo_dark.9.png
│               │   ├── apptheme_btn_default_pressed_holo_dark.9.png
│               │   ├── apptheme_btn_radio_off_disabled_focused_holo_dark.png
│               │   ├── apptheme_btn_radio_off_disabled_holo_dark.png
│               │   ├── apptheme_btn_radio_off_focused_holo_dark.png
│               │   ├── apptheme_btn_radio_off_holo_dark.png
│               │   ├── apptheme_btn_radio_off_pressed_holo_dark.png
│               │   ├── apptheme_btn_radio_on_disabled_focused_holo_dark.png
│               │   ├── apptheme_btn_radio_on_disabled_holo_dark.png
│               │   ├── apptheme_btn_radio_on_focused_holo_dark.png
│               │   ├── apptheme_btn_radio_on_holo_dark.png
│               │   ├── apptheme_btn_radio_on_pressed_holo_dark.png
│               │   ├── apptheme_fastscroll_thumb_default_holo.png
│               │   ├── apptheme_fastscroll_thumb_pressed_holo.png
│               │   ├── apptheme_ic_navigation_drawer.png
│               │   ├── apptheme_list_activated_holo.9.png
│               │   ├── apptheme_list_focused_holo.9.png
│               │   ├── apptheme_list_longpressed_holo.9.png
│               │   ├── apptheme_list_pressed_holo_dark.9.png
│               │   ├── apptheme_list_selector_disabled_holo_dark.9.png
│               │   ├── apptheme_textfield_activated_holo_dark.9.png
│               │   ├── apptheme_textfield_default_holo_dark.9.png
│               │   ├── apptheme_textfield_disabled_focused_holo_dark.9.png
│               │   ├── apptheme_textfield_disabled_holo_dark.9.png
│               │   ├── apptheme_textfield_focused_holo_dark.9.png
│               │   ├── drawer_shadow.9.png
│               │   ├── ic_action_new.png
│               │   ├── ic_action_refresh.png
│               │   ├── ic_action_save.png
│               │   ├── ic_actionbar.png
│               │   ├── ic_delete.png
│               │   ├── ic_launcher.png
│               │   ├── ic_launcher_circle.png
│               │   ├── ic_launcher_transparent.png
│               │   ├── ic_notification_small.png
│               │   ├── ic_question_icon.png
│               │   ├── ic_system.png
│               │   └── ic_user.png
│               ├── drawable-xhdpi
│               │   ├── apptheme_btn_check_off_disabled_focused_holo_dark.png
│               │   ├── apptheme_btn_check_off_disabled_holo_dark.png
│               │   ├── apptheme_btn_check_off_focused_holo_dark.png
│               │   ├── apptheme_btn_check_off_holo_dark.png
│               │   ├── apptheme_btn_check_off_pressed_holo_dark.png
│               │   ├── apptheme_btn_check_on_disabled_focused_holo_dark.png
│               │   ├── apptheme_btn_check_on_disabled_holo_dark.png
│               │   ├── apptheme_btn_check_on_focused_holo_dark.png
│               │   ├── apptheme_btn_check_on_holo_dark.png
│               │   ├── apptheme_btn_check_on_pressed_holo_dark.png
│               │   ├── apptheme_btn_default_disabled_focused_holo_dark.9.png
│               │   ├── apptheme_btn_default_disabled_holo_dark.9.png
│               │   ├── apptheme_btn_default_focused_holo_dark.9.png
│               │   ├── apptheme_btn_default_normal_holo_dark.9.png
│               │   ├── apptheme_btn_default_pressed_holo_dark.9.png
│               │   ├── apptheme_btn_radio_off_disabled_focused_holo_dark.png
│               │   ├── apptheme_btn_radio_off_disabled_holo_dark.png
│               │   ├── apptheme_btn_radio_off_focused_holo_dark.png
│               │   ├── apptheme_btn_radio_off_holo_dark.png
│               │   ├── apptheme_btn_radio_off_pressed_holo_dark.png
│               │   ├── apptheme_btn_radio_on_disabled_focused_holo_dark.png
│               │   ├── apptheme_btn_radio_on_disabled_holo_dark.png
│               │   ├── apptheme_btn_radio_on_focused_holo_dark.png
│               │   ├── apptheme_btn_radio_on_holo_dark.png
│               │   ├── apptheme_btn_radio_on_pressed_holo_dark.png
│               │   ├── apptheme_fastscroll_thumb_default_holo.png
│               │   ├── apptheme_fastscroll_thumb_pressed_holo.png
│               │   ├── apptheme_ic_navigation_drawer.png
│               │   ├── apptheme_list_activated_holo.9.png
│               │   ├── apptheme_list_focused_holo.9.png
│               │   ├── apptheme_list_longpressed_holo.9.png
│               │   ├── apptheme_list_pressed_holo_dark.9.png
│               │   ├── apptheme_list_selector_disabled_holo_dark.9.png
│               │   ├── apptheme_textfield_activated_holo_dark.9.png
│               │   ├── apptheme_textfield_default_holo_dark.9.png
│               │   ├── apptheme_textfield_disabled_focused_holo_dark.9.png
│               │   ├── apptheme_textfield_disabled_holo_dark.9.png
│               │   ├── apptheme_textfield_focused_holo_dark.9.png
│               │   ├── drawer_shadow.9.png
│               │   ├── ic_action_new.png
│               │   ├── ic_action_refresh.png
│               │   ├── ic_action_save.png
│               │   ├── ic_actionbar.png
│               │   ├── ic_delete.png
│               │   ├── ic_launcher.png
│               │   ├── ic_launcher_circle.png
│               │   ├── ic_launcher_transparent.png
│               │   ├── ic_notification_small.png
│               │   ├── ic_question_icon.png
│               │   ├── ic_system.png
│               │   └── ic_user.png
│               ├── drawable-xxhdpi
│               │   ├── apptheme_btn_check_off_disabled_focused_holo_dark.png
│               │   ├── apptheme_btn_check_off_disabled_holo_dark.png
│               │   ├── apptheme_btn_check_off_focused_holo_dark.png
│               │   ├── apptheme_btn_check_off_holo_dark.png
│               │   ├── apptheme_btn_check_off_pressed_holo_dark.png
│               │   ├── apptheme_btn_check_on_disabled_focused_holo_dark.png
│               │   ├── apptheme_btn_check_on_disabled_holo_dark.png
│               │   ├── apptheme_btn_check_on_focused_holo_dark.png
│               │   ├── apptheme_btn_check_on_holo_dark.png
│               │   ├── apptheme_btn_check_on_pressed_holo_dark.png
│               │   ├── apptheme_btn_default_disabled_focused_holo_dark.9.png
│               │   ├── apptheme_btn_default_disabled_holo_dark.9.png
│               │   ├── apptheme_btn_default_focused_holo_dark.9.png
│               │   ├── apptheme_btn_default_normal_holo_dark.9.png
│               │   ├── apptheme_btn_default_pressed_holo_dark.9.png
│               │   ├── apptheme_btn_radio_off_disabled_focused_holo_dark.png
│               │   ├── apptheme_btn_radio_off_disabled_holo_dark.png
│               │   ├── apptheme_btn_radio_off_focused_holo_dark.png
│               │   ├── apptheme_btn_radio_off_holo_dark.png
│               │   ├── apptheme_btn_radio_off_pressed_holo_dark.png
│               │   ├── apptheme_btn_radio_on_disabled_focused_holo_dark.png
│               │   ├── apptheme_btn_radio_on_disabled_holo_dark.png
│               │   ├── apptheme_btn_radio_on_focused_holo_dark.png
│               │   ├── apptheme_btn_radio_on_holo_dark.png
│               │   ├── apptheme_btn_radio_on_pressed_holo_dark.png
│               │   ├── apptheme_fastscroll_thumb_default_holo.png
│               │   ├── apptheme_fastscroll_thumb_pressed_holo.png
│               │   ├── apptheme_ic_navigation_drawer.png
│               │   ├── apptheme_list_activated_holo.9.png
│               │   ├── apptheme_list_focused_holo.9.png
│               │   ├── apptheme_list_longpressed_holo.9.png
│               │   ├── apptheme_list_pressed_holo_dark.9.png
│               │   ├── apptheme_list_selector_disabled_holo_dark.9.png
│               │   ├── apptheme_textfield_activated_holo_dark.9.png
│               │   ├── apptheme_textfield_default_holo_dark.9.png
│               │   ├── apptheme_textfield_disabled_focused_holo_dark.9.png
│               │   ├── apptheme_textfield_disabled_holo_dark.9.png
│               │   ├── apptheme_textfield_focused_holo_dark.9.png
│               │   ├── drawer_shadow.9.png
│               │   ├── ic_action_new.png
│               │   ├── ic_action_refresh.png
│               │   ├── ic_action_save.png
│               │   ├── ic_actionbar.png
│               │   ├── ic_delete.png
│               │   ├── ic_launcher.png
│               │   ├── ic_launcher_circle.png
│               │   ├── ic_launcher_transparent.png
│               │   ├── ic_notification_small.png
│               │   ├── ic_question_icon.png
│               │   ├── ic_system.png
│               │   └── ic_user.png
│               ├── drawable-xxxhdpi
│               │   ├── ic_actionbar.png
│               │   ├── ic_launcher.png
│               │   ├── ic_launcher_circle.png
│               │   ├── ic_launcher_transparent.png
│               │   └── ic_notification_small.png
│               ├── layout
│               │   ├── activity_main.xml
│               │   ├── add_whitelist_dialog.xml
│               │   ├── configwizard.xml
│               │   ├── detectedoverlay_item.xml
│               │   ├── fragment_detectedoverlay_grid.xml
│               │   ├── fragment_detectedoverlay_list.xml
│               │   ├── fragment_main.xml
│               │   ├── fragment_navigation_drawer.xml
│               │   ├── fragment_settings.xml
│               │   ├── fragment_suspectedapps_grid.xml
│               │   ├── fragment_suspectedapps_list.xml
│               │   ├── fragment_whitelist_grid.xml
│               │   ├── fragment_whitelist_list.xml
│               │   ├── logcat_dialog.xml
│               │   ├── overlaydetected.xml
│               │   ├── suspectedapps_item.xml
│               │   ├── whitelist_item.xml
│               │   └── wizard_info_page.xml
│               ├── menu
│               │   ├── detected_overlays_menu.xml
│               │   ├── settings_menu.xml
│               │   ├── suspected_apps_menu.xml
│               │   └── whitelist_menu.xml
│               ├── values
│               │   ├── colors.xml
│               │   ├── colors_apptheme.xml
│               │   ├── dimens.xml
│               │   ├── refs.xml
│               │   ├── strings.xml
│               │   ├── styles.xml
│               │   ├── styles_apptheme.xml
│               │   └── themes_apptheme.xml
│               └── xml
│                   └── accessibilityservice.xml
├── build.gradle
├── gradle
│   └── wrapper
│       ├── gradle-wrapper.jar
│       └── gradle-wrapper.properties
├── gradle.properties
├── gradlew
├── gradlew.bat
└── settings.gradle

```

`LICENSE`:

```
                                 Apache License
                           Version 2.0, January 2004
                        http://www.apache.org/licenses/

   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION

   1. Definitions.

      "License" shall mean the terms and conditions for use, reproduction,
      and distribution as defined by Sections 1 through 9 of this document.

      "Licensor" shall mean the copyright owner or entity authorized by
      the copyright owner that is granting the License.

      "Legal Entity" shall mean the union of the acting entity and all
      other entities that control, are controlled by, or are under common
      control with that entity. For the purposes of this definition,
      "control" means (i) the power, direct or indirect, to cause the
      direction or management of such entity, whether by contract or
      otherwise, or (ii) ownership of fifty percent (50%) or more of the
      outstanding shares, or (iii) beneficial ownership of such entity.

      "You" (or "Your") shall mean an individual or Legal Entity
      exercising permissions granted by this License.

      "Source" form shall mean the preferred form for making modifications,
      including but not limited to software source code, documentation
      source, and configuration files.

      "Object" form shall mean any form resulting from mechanical
      transformation or translation of a Source form, including but
      not limited to compiled object code, generated documentation,
      and conversions to other media types.

      "Work" shall mean the work of authorship, whether in Source or
      Object form, made available under the License, as indicated by a
      copyright notice that is included in or attached to the work
      (an example is provided in the Appendix below).

      "Derivative Works" shall mean any work, whether in Source or Object
      form, that is based on (or derived from) the Work and for which the
      editorial revisions, annotations, elaborations, or other modifications
      represent, as a whole, an original work of authorship. For the purposes
      of this License, Derivative Works shall not include works that remain
      separable from, or merely link (or bind by name) to the interfaces of,
      the Work and Derivative Works thereof.

      "Contribution" shall mean any work of authorship, including
      the original version of the Work and any modifications or additions
      to that Work or Derivative Works thereof, that is intentionally
      submitted to Licensor for inclusion in the Work by the copyright owner
      or by an individual or Legal Entity authorized to submit on behalf of
      the copyright owner. For the purposes of this definition, "submitted"
      means any form of electronic, verbal, or written communication sent
      to the Licensor or its representatives, including but not limited to
      communication on electronic mailing lists, source code control systems,
      and issue tracking systems that are managed by, or on behalf of, the
      Licensor for the purpose of discussing and improving the Work, but
      excluding communication that is conspicuously marked or otherwise
      designated in writing by the copyright owner as "Not a Contribution."

      "Contributor" shall mean Licensor and any individual or Legal Entity
      on behalf of whom a Contribution has been received by Licensor and
      subsequently incorporated within the Work.

   2. Grant of Copyright License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      copyright license to reproduce, prepare Derivative Works of,
      publicly display, publicly perform, sublicense, and distribute the
      Work and such Derivative Works in Source or Object form.

   3. Grant of Patent License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      (except as stated in this section) patent license to make, have made,
      use, offer to sell, sell, import, and otherwise transfer the Work,
      where such license applies only to those patent claims licensable
      by such Contributor that are necessarily infringed by their
      Contribution(s) alone or by combination of their Contribution(s)
      with the Work to which such Contribution(s) was submitted. If You
      institute patent litigation against any entity (including a
      cross-claim or counterclaim in a lawsuit) alleging that the Work
      or a Contribution incorporated within the Work constitutes direct
      or contributory patent infringement, then any patent licenses
      granted to You under this License for that Work shall terminate
      as of the date such litigation is filed.

   4. Redistribution. You may reproduce and distribute copies of the
      Work or Derivative Works thereof in any medium, with or without
      modifications, and in Source or Object form, provided that You
      meet the following conditions:

      (a) You must give any other recipients of the Work or
          Derivative Works a copy of this License; and

      (b) You must cause any modified files to carry prominent notices
          stating that You changed the files; and

      (c) You must retain, in the Source form of any Derivative Works
          that You distribute, all copyright, patent, trademark, and
          attribution notices from the Source form of the Work,
          excluding those notices that do not pertain to any part of
          the Derivative Works; and

      (d) If the Work includes a "NOTICE" text file as part of its
          distribution, then any Derivative Works that You distribute must
          include a readable copy of the attribution notices contained
          within such NOTICE file, excluding those notices that do not
          pertain to any part of the Derivative Works, in at least one
          of the following places: within a NOTICE text file distributed
          as part of the Derivative Works; within the Source form or
          documentation, if provided along with the Derivative Works; or,
          within a display generated by the Derivative Works, if and
          wherever such third-party notices normally appear. The contents
          of the NOTICE file are for informational purposes only and
          do not modify the License. You may add Your own attribution
          notices within Derivative Works that You distribute, alongside
          or as an addendum to the NOTICE text from the Work, provided
          that such additional attribution notices cannot be construed
          as modifying the License.

      You may add Your own copyright statement to Your modifications and
      may provide additional or different license terms and conditions
      for use, reproduction, or distribution of Your modifications, or
      for any such Derivative Works as a whole, provided Your use,
      reproduction, and distribution of the Work otherwise complies with
      the conditions stated in this License.

   5. Submission of Contributions. Unless You explicitly state otherwise,
      any Contribution intentionally submitted for inclusion in the Work
      by You to the Licensor shall be under the terms and conditions of
      this License, without any additional terms or conditions.
      Notwithstanding the above, nothing herein shall supersede or modify
      the terms of any separate license agreement you may have executed
      with Licensor regarding such Contributions.

   6. Trademarks. This License does not grant permission to use the trade
      names, trademarks, service marks, or product names of the Licensor,
      except as required for reasonable and customary use in describing the
      origin of the Work and reproducing the content of the NOTICE file.

   7. Disclaimer of Warranty. Unless required by applicable law or
      agreed to in writing, Licensor provides the Work (and each
      Contributor provides its Contributions) on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
      implied, including, without limitation, any warranties or conditions
      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
      PARTICULAR PURPOSE. You are solely responsible for determining the
      appropriateness of using or redistributing the Work and assume any
      risks associated with Your exercise of permissions under this License.

   8. Limitation of Liability. In no event and under no legal theory,
      whether in tort (including negligence), contract, or otherwise,
      unless required by applicable law (such as deliberate and grossly
      negligent acts) or agreed to in writing, shall any Contributor be
      liable to You for damages, including any direct, indirect, special,
      incidental, or consequential damages of any character arising as a
      result of this License or out of the use or inability to use the
      Work (including but not limited to damages for loss of goodwill,
      work stoppage, computer failure or malfunction, or any and all
      other commercial damages or losses), even if such Contributor
      has been advised of the possibility of such damages.

   9. Accepting Warranty or Additional Liability. While redistributing
      the Work or Derivative Works thereof, You may choose to offer,
      and charge a fee for, acceptance of support, warranty, indemnity,
      or other liability obligations and/or rights consistent with this
      License. However, in accepting such obligations, You may act only
      on Your own behalf and on Your sole responsibility, not on behalf
      of any other Contributor, and only if You agree to indemnify,
      defend, and hold each Contributor harmless for any liability
      incurred by, or claims asserted against, such Contributor by reason
      of your accepting any such warranty or additional liability.

   END OF TERMS AND CONDITIONS

   APPENDIX: How to apply the Apache License to your work.

      To apply the Apache License to your work, attach the following
      boilerplate notice, with the fields enclosed by brackets "{}"
      replaced with your own identifying information. (Don't include
      the brackets!)  The text should be enclosed in the appropriate
      comment syntax for the file format. We also recommend that a
      file or class name and description of purpose be included on the
      same "printed page" as the copyright notice for easier
      identification within third-party archives.

   Copyright {yyyy} {name of copyright owner}

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

```

`README.md`:

```md
# Android Overlay Protection
This is our attempt to defeat android overlay attacks by detecting them and advice the user about whats going on.

You can find information about this vulnerability and an overview of the application on the [dedicated website](https://geeksonsecurity.github.io/overlay-protector-website/).

Feel free to contribute and extend the current detection engines (or even create some new ones!).

![Overlay Detector](https://geeksonsecurity.github.io/overlay-protector-website/img/nexus_isometric.png)

```

`app/build.gradle`:

```gradle
apply plugin: 'com.android.application'

android {
    compileSdkVersion 22
    buildToolsVersion "21.1.2"

    defaultConfig {
        applicationId "com.geeksonsecurity.android.overlayprotector.beta"
        minSdkVersion 14
        targetSdkVersion 22
        versionCode 6
        versionName "1.2"
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
}

dependencies {
    compile fileTree(dir: 'libs', include: ['*.jar'])
    compile 'com.android.support:appcompat-v7:22.2.0'
    compile 'com.j256.ormlite:ormlite-android:4.46'
    compile 'com.github.techfreak:wizardpager:1.0.0'
    compile 'com.google.code.gson:gson:2.3.1'
}

```

`app/src/androidTest/java/com/geeksonsecurity/android/overlayprotector/ApplicationTest.java`:

```java
package com.geeksonsecurity.android.overlayprotector;

import android.app.Application;
import android.test.ApplicationTestCase;

/**
 * <a href="http://d.android.com/tools/testing/testing_android.html">Testing Fundamentals</a>
 */
public class ApplicationTest extends ApplicationTestCase<Application> {
    public ApplicationTest() {
        super(Application.class);
    }
}
```

`app/src/main/AndroidManifest.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.geeksonsecurity.android.overlayprotector">

    <uses-permission android:name="android.permission.GET_TASKS" />
    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
    <uses-permission android:name="android.permission.KILL_BACKGROUND_PROCESSES" />

    <application
        android:allowBackup="true"
        android:icon="@drawable/ic_launcher"
        android:label="@string/app_name"
        android:theme="@style/AppTheme"
        android:name="MyApplication">
        <service
            android:name=".MonitorAccessibilityService"
            android:permission="android.permission.BIND_ACCESSIBILITY_SERVICE">
            <intent-filter>
                <action android:name="android.accessibilityservice.AccessibilityService" />
            </intent-filter>

            <meta-data
                android:name="android.accessibilityservice"
                android:resource="@xml/accessibilityservice" />
        </service>

        <activity
            android:name=".MainActivity"
            android:label="@string/app_name">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />

                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
        <activity android:name=".wizard.ConfigWizardActivity" />

        <receiver
            android:name=".AppListChangedReceiver"
            android:enabled="true"
            android:exported="true"></receiver>
    </application>

</manifest>

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/AppListChangedReceiver.java`:

```java
package com.geeksonsecurity.android.overlayprotector;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager;
import android.preference.PreferenceManager;
import android.util.Log;

import com.geeksonsecurity.android.overlayprotector.database.DatabaseHelper;
import com.geeksonsecurity.android.overlayprotector.domain.Settings;
import com.geeksonsecurity.android.overlayprotector.domain.SuspectedApp;
import com.google.gson.Gson;
import com.j256.ormlite.dao.Dao;
import com.j256.ormlite.stmt.DeleteBuilder;

import java.util.Arrays;
import java.util.List;

public class AppListChangedReceiver extends BroadcastReceiver {
    private String TAG = this.getClass().getSimpleName();
    private Gson gson = new Gson();

    public AppListChangedReceiver() {
        Log.i(TAG, "Initialized");
    }

    @Override
    public void onReceive(Context context, Intent intent) {
        if (intent == null || intent.getData() == null) {
            return;
        }
        String pkg = intent.getData().toString();
        pkg = pkg.replace("package:", "");
        Log.i(TAG, String.format("Install/Uninstall intent for %s received!", pkg));
        try {
            Dao<SuspectedApp, Integer> suspectedAppDao = DatabaseHelper.getHelper(context).getSuspectedAppDao();

            if (intent.getAction() == Intent.ACTION_PACKAGE_ADDED) {
                try {
                    PackageManager pm = context.getPackageManager();
                    PackageInfo packageInfo = pm.getPackageInfo(pkg, PackageManager.GET_PERMISSIONS);
                    if (packageInfo != null && packageInfo.requestedPermissions != null) {
                        List<String> list = Arrays.asList(packageInfo.requestedPermissions);
                        if (list.contains("android.permission.SYSTEM_ALERT_WINDOW") && list.contains("android.permission.GET_TASKS")) {
                            SuspectedApp app = new SuspectedApp();
                            app.setPackageName(packageInfo.packageName);
                            final String applicationName = pm.getApplicationLabel(packageInfo.applicationInfo).toString();
                            app.setAppName(applicationName);
                            suspectedAppDao.createIfNotExists(app);
                        }
                    }
                } catch (PackageManager.NameNotFoundException e) {
                    e.printStackTrace();
                }

            } else if (intent.getAction() == Intent.ACTION_PACKAGE_REMOVED) {
                DeleteBuilder db = suspectedAppDao.deleteBuilder();
                db.where().eq("packageName", pkg);
                suspectedAppDao.delete(db.prepare());
            }
            SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(context);
            String json = prefs.getString(Settings.KEY_SETTINGS, "");
            Settings settings = gson.fromJson(json, Settings.class);
            settings.setSuspectedAppUpdateTimestamp(System.currentTimeMillis());
            String serialized = gson.toJson(settings);
            SharedPreferences.Editor editor = prefs.edit();
            editor.putString(Settings.KEY_SETTINGS, serialized);
            editor.apply();
        } catch (Exception e) {
            Log.e(TAG, e.toString());
        }
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/MainActivity.java`:

```java
package com.geeksonsecurity.android.overlayprotector;

import android.content.Intent;
import android.content.IntentFilter;
import android.os.Bundle;
import android.support.v4.app.Fragment;
import android.support.v4.app.FragmentManager;
import android.support.v4.widget.DrawerLayout;
import android.support.v7.app.ActionBar;
import android.support.v7.app.ActionBarActivity;
import android.view.Menu;
import android.view.MenuItem;

import com.geeksonsecurity.android.overlayprotector.database.DatabaseUtils;
import com.geeksonsecurity.android.overlayprotector.view.DetectedOverlayFragment;
import com.geeksonsecurity.android.overlayprotector.view.HomeFragment;
import com.geeksonsecurity.android.overlayprotector.view.SettingsFragment;
import com.geeksonsecurity.android.overlayprotector.view.SuspectedAppsFragment;
import com.geeksonsecurity.android.overlayprotector.view.WhiteListFragment;


public class MainActivity extends ActionBarActivity
        implements NavigationDrawerFragment.NavigationDrawerCallbacks {

    /**
     * Fragment managing the behaviors, interactions and presentation of the navigation drawer.
     */
    private NavigationDrawerFragment mNavigationDrawerFragment;

    /**
     * Used to store the last screen title. For use in {@link #restoreActionBar()}.
     */
    private CharSequence mTitle;
    AppListChangedReceiver _packageUpdateReceiver = new AppListChangedReceiver();

    @Override
    protected void onDestroy() {
        super.onDestroy();
        unregisterReceiver(_packageUpdateReceiver);
    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        IntentFilter intentFilter = new IntentFilter();
        intentFilter.addAction(Intent.ACTION_PACKAGE_ADDED);
        intentFilter.addAction(Intent.ACTION_PACKAGE_REMOVED);
        intentFilter.addDataScheme("package");

        registerReceiver(_packageUpdateReceiver, intentFilter);

        mNavigationDrawerFragment = (NavigationDrawerFragment)
                getSupportFragmentManager().findFragmentById(R.id.navigation_drawer);
        mTitle = getTitle();

        // Set up the drawer.
        mNavigationDrawerFragment.setUp(
                R.id.navigation_drawer,
                (DrawerLayout) findViewById(R.id.drawer_layout));

        restoreActionBar();

        DatabaseUtils.fillSuspectedApps(this);
    }

    @Override
    public void onNavigationDrawerItemSelected(int position) {
        // update the main content by replacing fragments
        FragmentManager fragmentManager = getSupportFragmentManager();
        fragmentManager.beginTransaction()
                .replace(R.id.container, PlaceholderFragment.newInstance(position + 1))
                .commit();
    }

    public void onSectionAttached(int number) {
        switch (number) {
            case 1:
                mTitle = getString(R.string.app_name);
                break;
            case 2:
                mTitle = getString(R.string.suspected_app_section);
                break;
            case 3:
                mTitle = getString(R.string.overlay_detected_section);
                break;
            case 4:
                mTitle = getString(R.string.whitelist_section);
                break;
            case 5:
                mTitle = getString(R.string.settings_section);
                break;
        }
        ActionBar ab = getSupportActionBar();
        if (ab != null) {
            ab.setTitle(mTitle);
        } else {
            setTitle(mTitle);
        }
    }


    public void restoreActionBar() {
        ActionBar actionBar = getSupportActionBar();
        if (actionBar != null) {
            actionBar.setDisplayShowTitleEnabled(true);
            actionBar.setTitle(mTitle);
            actionBar.setDisplayShowHomeEnabled(true);
            actionBar.setIcon(R.drawable.ic_launcher_transparent);
        }
    }


    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
       /* if (!mNavigationDrawerFragment.isDrawerOpen()) {
            // Only show items in the action bar relevant to this screen
            // if the drawer is not showing. Otherwise, let the drawer
            // decide what to show in the action bar.
            getMenuInflater().inflate(R.menu.main, menu);
            restoreActionBar();
            return true;
        }*/
        return super.onCreateOptionsMenu(menu);
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        // Handle action bar item clicks here. The action bar will
        // automatically handle clicks on the Home/Up button, so long
        // as you specify a parent activity in AndroidManifest.xml.
        //int id = item.getItemId();

        return super.onOptionsItemSelected(item);
    }

    /**
     * A placeholder fragment containing a simple view.
     */
    public static class PlaceholderFragment {
        /**
         * The fragment argument representing the section number for this
         * fragment.
         */
        private static final String ARG_SECTION_NUMBER = "section_number";

        /**
         * Returns a new instance of this fragment for the given section
         * number.
         */
        public static Fragment newInstance(int sectionNumber) {
            switch (sectionNumber) {
                case 1:
                    return HomeFragment.newInstance();
                case 2:
                    return SuspectedAppsFragment.newInstance();
                case 3:
                    return DetectedOverlayFragment.newInstance();
                case 4:
                    return WhiteListFragment.newInstance();
                case 5:
                    return SettingsFragment.newInstance();
            }

            return null;
        }
    }

}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/MonitorAccessibilityService.java`:

```java
package com.geeksonsecurity.android.overlayprotector;

import android.accessibilityservice.AccessibilityService;
import android.app.ActivityManager;
import android.app.KeyguardManager;
import android.app.Notification;
import android.app.NotificationManager;
import android.app.PendingIntent;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.pm.ApplicationInfo;
import android.content.pm.PackageManager;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.PixelFormat;
import android.graphics.drawable.Drawable;
import android.net.Uri;
import android.os.CountDownTimer;
import android.os.ResultReceiver;
import android.preference.PreferenceManager;
import android.support.v4.app.NotificationCompat;
import android.text.Html;
import android.util.Log;
import android.view.View;
import android.view.WindowManager;
import android.view.accessibility.AccessibilityEvent;
import android.widget.Button;
import android.widget.ImageView;
import android.widget.TextView;

import com.geeksonsecurity.android.overlayprotector.database.DatabaseHelper;
import com.geeksonsecurity.android.overlayprotector.domain.DetectedOverlay;
import com.geeksonsecurity.android.overlayprotector.domain.EventCounter;
import com.geeksonsecurity.android.overlayprotector.domain.OverlayState;
import com.geeksonsecurity.android.overlayprotector.domain.ServiceCommunication;
import com.geeksonsecurity.android.overlayprotector.domain.Settings;
import com.geeksonsecurity.android.overlayprotector.domain.WhiteEntry;
import com.geeksonsecurity.android.overlayprotector.service.AbstractDetectionEngine;
import com.geeksonsecurity.android.overlayprotector.service.IOverlayNotifyService;
import com.geeksonsecurity.android.overlayprotector.service.ProcessHelper;
import com.google.gson.Gson;
import com.j256.ormlite.dao.Dao;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.atomic.AtomicReference;

public class MonitorAccessibilityService extends AccessibilityService implements IOverlayNotifyService {

    public static final int NOTIFICATION_ID = 666999;
    private static final String TAG = "MonitorService";

    private final Gson _gson = new Gson();
    private final EventCounter _eventCounter = new EventCounter();

    private List<WhiteEntry> _whiteEntries = new ArrayList<>();
    private DatabaseHelper _helper = null;
    private Settings _settings = new Settings();
    private NotificationCompat.Builder _notificationBuilder;

    private NotificationManager _notificationManager;
    private ResultReceiver _resultReceiver = null;
    private AbstractDetectionEngine _detectionEngine;
    private KeyguardManager _keyguardManager;


    @Override
    protected void onServiceConnected() {
        refreshSettings();
        _keyguardManager = (KeyguardManager) getSystemService(Context.KEYGUARD_SERVICE);

        _helper = DatabaseHelper.getHelper(getApplicationContext());

        InitializeDetectionEngine();


        _notificationBuilder = new NotificationCompat.Builder(getApplicationContext());
        _notificationBuilder.setSmallIcon(R.drawable.ic_notification_small).setContentTitle("Overlay Protector").setContentText("Running...");
        Bitmap largeIcon = BitmapFactory.decodeResource(getResources(), R.drawable.ic_launcher_circle);

        _notificationBuilder.setLargeIcon(largeIcon);

        Intent notificationIntent = new Intent(this,
                MainActivity.class);
        PendingIntent pending = PendingIntent.getActivity(getApplicationContext(), 0, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);

        _notificationBuilder.setContentIntent(pending);
        _notificationBuilder.setOngoing(true);
        _notificationBuilder.setShowWhen(false);
        _notificationBuilder.setPriority(Notification.PRIORITY_LOW);
        _notificationBuilder.setOnlyAlertOnce(true);

        _notificationManager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);
        _notificationManager.notify(NOTIFICATION_ID, _notificationBuilder.build());

        super.onServiceConnected();
    }

    private void InitializeDetectionEngine() {
        Class clazz = _settings.getDetectionEngine().getDetectionClass();
        if (_detectionEngine != null) {
            if (clazz.isInstance(_detectionEngine)) {
                return;
            }
        }

        try {
            ActivityManager activityManager = (ActivityManager) getApplicationContext().getSystemService(ACTIVITY_SERVICE);
            ProcessHelper processHelper = new ProcessHelper(activityManager);
            _detectionEngine = (AbstractDetectionEngine) clazz
                    .getConstructor(Context.class, DatabaseHelper.class, KeyguardManager.class, IOverlayNotifyService.class, ProcessHelper.class)
                    .newInstance(getApplicationContext(), _helper, _keyguardManager, this, processHelper);
        } catch (Exception e) {
            Log.e(TAG, "Failed to instantiate detection engine", e);
        }

    }

    @Override
    public int onStartCommand(Intent intent, int flags, int startId) {
        if (_helper == null)
            _helper = DatabaseHelper.getHelper(getApplicationContext());

        if (null != intent) {
            if (intent.getAction() != null) {
                Log.i(TAG, "Received intent action " + intent.getAction());
                if (intent.getAction().equals(ServiceCommunication.MSG_SETTINGS_UPDATED)) {
                    Log.i(TAG, "Settings updated!");
                    refreshSettings();
                    InitializeDetectionEngine();
                    if (_detectionEngine != null) {
                        _detectionEngine.refreshSettings();
                    }
                } else if (intent.getAction().equals(ServiceCommunication.MSG_WHITELIST_UPDATED)) {
                    Log.i(TAG, "White-list updated!");
                    if (_detectionEngine != null) {
                        _detectionEngine.refreshWhiteList();
                    }
                }
            }

            _resultReceiver = intent.getParcelableExtra("receiver");
        }
        return super.onStartCommand(intent, flags, startId);
    }


    public void refreshSettings() {
        SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(getApplicationContext());
        AtomicReference<String> json = new AtomicReference<>(prefs.getString(Settings.KEY_SETTINGS, ""));
        assert json.get() != null;
        if (!json.get().isEmpty()) {
            _settings = _gson.fromJson(json.get(), Settings.class);
        }
    }

    @Override
    public void onAccessibilityEvent(AccessibilityEvent event) {
        _detectionEngine.handleEvent(event);
    }

    @Override
    public void onInterrupt() {
        Log.d(TAG, "Interrupt");
    }

    @Override
    public void onDestroy() {
        super.onDestroy();
        NotificationManager nManager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);
        nManager.cancel(NOTIFICATION_ID);
    }

    @Override
    public boolean onUnbind(Intent intent) {
        NotificationManager nManager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);
        nManager.cancel(NOTIFICATION_ID);
        return super.onUnbind(intent);
    }

    @Override
    public void processOverlayState(final OverlayState state) {
        if (!state.isHasOverlay())
            return;

        try {
            String[] command = {"logcat", "-v", "time", "-t", "300", "-s", "MonitorService"};
            // Load logcat output to additional information
            Process process = Runtime.getRuntime().exec(command);
            BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(process.getInputStream()));
            StringBuilder sb = new StringBuilder();
            String line;
            while ((line = bufferedReader.readLine()) != null) {
                sb.insert(0, line + "\n");
            }

            state.setAdditionalInfo(sb.toString());
        } catch (IOException e) {
            e.printStackTrace();
        }

        Log.i(TAG, "showOverlayWarning");
        state.setHasOverlay(true);
        state.setOverlayShown(true);

        Log.i(TAG, "showOverlayWarning: layout parameter set");

        final WindowManager.LayoutParams params = new WindowManager.LayoutParams(
                WindowManager.LayoutParams.MATCH_PARENT,
                WindowManager.LayoutParams.MATCH_PARENT,
                WindowManager.LayoutParams.TYPE_SYSTEM_ALERT,
                WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN,
                PixelFormat.TRANSLUCENT);

        final WindowManager windowManager = (WindowManager) getSystemService(Context.WINDOW_SERVICE);

        final View oView = View.inflate(getApplicationContext(), R.layout.overlaydetected, null);

        if (oView != null) {
            final TextView offender = (TextView) oView.findViewById(R.id.odOffenderNameLabel);
            final String offenderName = state.getOffender();

            final PackageManager pm = getApplicationContext().getPackageManager();
            ApplicationInfo ai;
            try {
                ai = pm.getApplicationInfo(offenderName, 0);
            } catch (final PackageManager.NameNotFoundException e) {
                ai = null;
            }
            final String applicationName = (String) (ai != null ? pm.getApplicationLabel(ai) : offenderName);

            offender.setText(Html.fromHtml("<b>" + applicationName + "</b> <small> (" + offenderName + ")</small>"));

            ImageView iconImageView = (ImageView) oView.findViewById(R.id.iconImageView);

            Drawable icon;
            try {
                icon = getPackageManager().getApplicationIcon(offenderName);
            } catch (PackageManager.NameNotFoundException e) {
                icon = getResources().getDrawable(R.drawable.ic_question_icon);
            }
            iconImageView.setImageDrawable(icon);

            TextView uninstallWarning = (TextView) oView.findViewById(R.id.uninstallWarningTextView);
            String s = getResources().getString(R.string.op_uninstallWarning);
            s = String.format(s, _settings.getUninstallTimeoutSeconds());
            uninstallWarning.setText(s);

            Button ignore = (Button) oView.findViewById(R.id.odIgnoreButton);
            ignore.setOnClickListener(new View.OnClickListener() {
                @Override
                public void onClick(View v) {
                    try {
                        // Add entry and update cache
                        Dao<WhiteEntry, Integer> whiteListDao = _helper.getWhiteListDao();
                        long duplicate = whiteListDao.queryBuilder().where().eq("name", offenderName).countOf();
                        if (duplicate == 0) {
                            WhiteEntry we = new WhiteEntry(offenderName, System.currentTimeMillis(), 1, false, true);
                            whiteListDao.create(we);
                            _whiteEntries.add(we);
                            Log.i(TAG,
                                    String.format("Added user white list entry for %s", we.getName()));
                        } else {
                            Log.w(TAG, String.format("White entry %s already in DB", offenderName));
                        }
                    } catch (SQLException e) {
                        Log.e(TAG,
                                String.format("Failed to update white list entry for %s", offenderName), e);
                    }
                    windowManager.removeViewImmediate(oView);
                    state.resetState();
                }
            });

            Button ignoreOnce = (Button) oView.findViewById(R.id.odIgnoreOnce);
            ignoreOnce.setOnClickListener(new View.OnClickListener() {
                @Override
                public void onClick(View v) {
                    state.setIgnoreOncePackage(offenderName);
                    windowManager.removeViewImmediate(oView);
                    CountDownTimer cdt = new CountDownTimer(_settings.getIgnoreOnceTimeoutSeconds() * 1000, _settings.getIgnoreOnceTimeoutSeconds() * 1000) {
                        @Override
                        public void onTick(long millisUntilFinished) {

                        }

                        @Override
                        public void onFinish() {
                            Log.d(TAG, "Ignore once timeout expired, removing flag...");
                            state.resetState();
                        }
                    };
                    cdt.start();
                }
            });

            Button uninstall = (Button) oView.findViewById(R.id.odUninstallButton);
            uninstall.setOnClickListener(new View.OnClickListener() {
                @Override
                public void onClick(View v) {
                    final ActivityManager am = (ActivityManager) getSystemService(ACTIVITY_SERVICE);
                    am.killBackgroundProcesses(offenderName);

                    try {
                        Dao<DetectedOverlay, Integer> detectedOverlayDao = _helper.getDetectedOverlayDao();
                        DetectedOverlay detectedOverlay = new DetectedOverlay(offenderName, System.currentTimeMillis());
                        detectedOverlayDao.create(detectedOverlay);
                        Log.i(TAG,
                                String.format("Added new detected overlay entry for offender %s", detectedOverlay.getOffender()));
                    } catch (SQLException e) {
                        Log.e(TAG,
                                String.format("Failed to add detected overlay entry for offender %s", offenderName), e);
                    }

                    Intent intent = new Intent(Intent.ACTION_UNINSTALL_PACKAGE);
                    intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP
                            | Intent.FLAG_ACTIVITY_NEW_TASK);

                    String packageName = "package:" + offenderName;
                    intent.setData(Uri.parse(packageName));
                    Log.i(TAG,
                            String.format("Started uninstall intent for %s", packageName));
                    startActivity(intent);
                    windowManager.removeViewImmediate(oView);
                    state.setPendingUninstall(true);

                    final List<String> offenderProcesses = new ArrayList<>();
                    List<ActivityManager.RunningServiceInfo> runningServices = am.getRunningServices(1000);
                    for (ActivityManager.RunningServiceInfo s : runningServices) {
                        if (s.process.equals(state.getOffender())) {
                            offenderProcesses.add(s.service.getClassName());
                        }
                    }
                    offenderProcesses.add(state.getOffender());
                    CountDownTimer cdt = new CountDownTimer(_settings.getUninstallTimeoutSeconds() * 1000, 250) {
                        @Override
                        public void onTick(long millisUntilFinished) {
                            for (String o : offenderProcesses)
                                am.killBackgroundProcesses(o);
                        }

                        @Override
                        public void onFinish() {
                            Log.d(TAG, "Uninstall timeout expired, removing flag...");
                            state.setPendingUninstall(false);
                        }
                    };
                    state.resetState();
                    Log.d(TAG, "Starting uninstall countdown!");
                    cdt.start();

                }
            });

            Log.i(TAG, "!!!  OVERLAY WARNING VIEW ADDED !!!");
            windowManager.addView(oView, params);
        }
    }

    @Override
    public void updateNotificationCount(long lastMinuteEventCount) {
        _notificationBuilder.setContentText(String.format("Secured %d UI events in the last minute!", lastMinuteEventCount));
        _notificationManager.notify(NOTIFICATION_ID, _notificationBuilder.build());
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/MyApplication.java`:

```java
package com.geeksonsecurity.android.overlayprotector;

import android.app.Application;

import com.geeksonsecurity.android.overlayprotector.database.DatabaseUtils;

public class MyApplication extends Application {

    @Override
    public void onCreate() {
        super.onCreate();
        DatabaseUtils.fillSuspectedApps(getApplicationContext());
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/NavigationDrawerFragment.java`:

```java
package com.geeksonsecurity.android.overlayprotector;

import android.app.Activity;
import android.content.SharedPreferences;
import android.content.res.Configuration;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.support.v4.app.Fragment;
import android.support.v4.view.GravityCompat;
import android.support.v4.widget.DrawerLayout;
import android.support.v7.app.ActionBar;
import android.support.v7.app.ActionBarActivity;
import android.support.v7.app.ActionBarDrawerToggle;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.ListView;

/**
 * Fragment used for managing interactions for and presentation of a navigation drawer.
 * See the <a href="https://developer.android.com/design/patterns/navigation-drawer.html#Interaction">
 * design guidelines</a> for a complete explanation of the behaviors implemented here.
 */
public class NavigationDrawerFragment extends Fragment {

    /**
     * Remember the position of the selected item.
     */
    private static final String STATE_SELECTED_POSITION = "selected_navigation_drawer_position";

    /**
     * Per the design guidelines, you should show the drawer on launch until the user manually
     * expands it. This shared preference tracks this.
     */
    private static final String PREF_USER_LEARNED_DRAWER = "navigation_drawer_learned";

    /**
     * A pointer to the current callbacks instance (the Activity).
     */
    private NavigationDrawerCallbacks mCallbacks;

    /**
     * Helper component that ties the action bar to the navigation drawer.
     */
    private ActionBarDrawerToggle mDrawerToggle;

    private DrawerLayout mDrawerLayout;
    private ListView mDrawerListView;
    private View mFragmentContainerView;

    private int mCurrentSelectedPosition = 0;
    private boolean mFromSavedInstanceState;
    private boolean mUserLearnedDrawer;

    public NavigationDrawerFragment() {
    }

    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        // Read in the flag indicating whether or not the user has demonstrated awareness of the
        // drawer. See PREF_USER_LEARNED_DRAWER for details.
        SharedPreferences sp = PreferenceManager.getDefaultSharedPreferences(getActivity());
        mUserLearnedDrawer = sp.getBoolean(PREF_USER_LEARNED_DRAWER, false);

        if (savedInstanceState != null) {
            mCurrentSelectedPosition = savedInstanceState.getInt(STATE_SELECTED_POSITION);
            mFromSavedInstanceState = true;
        }

        // Select either the default item (0) or the last selected item.
        selectItem(mCurrentSelectedPosition);
    }

    @Override
    public void onActivityCreated(Bundle savedInstanceState) {
        super.onActivityCreated(savedInstanceState);
        // Indicate that this fragment would like to influence the set of actions in the action bar.
        setHasOptionsMenu(true);
    }

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {

        View myParentView = inflater.inflate(
                R.layout.fragment_navigation_drawer, container, false);
        mDrawerListView = (ListView) myParentView.findViewById(R.id.opNavigationDrawerList);

        mDrawerListView.setOnItemClickListener(new AdapterView.OnItemClickListener() {
            @Override
            public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
                selectItem(position);
            }
        });
        mDrawerListView.setAdapter(new ArrayAdapter<String>(
                getActionBar().getThemedContext(),
                android.R.layout.simple_list_item_activated_1,
                android.R.id.text1,
                new String[]{
                        getString(R.string.home_section),
                        getString(R.string.suspected_app_section),
                        getString(R.string.overlay_detected_section),
                        getString(R.string.whitelist_section),
                        getString(R.string.settings_section)
                }));
        mDrawerListView.setItemChecked(mCurrentSelectedPosition, true);
        return mDrawerListView;
    }

    public boolean isDrawerOpen() {
        return mDrawerLayout != null && mDrawerLayout.isDrawerOpen(mFragmentContainerView);
    }

    /**
     * Users of this fragment must call this method to set up the navigation drawer interactions.
     *
     * @param fragmentId   The android:id of this fragment in its activity's layout.
     * @param drawerLayout The DrawerLayout containing this fragment's UI.
     */
    public void setUp(int fragmentId, DrawerLayout drawerLayout) {
        mFragmentContainerView = getActivity().findViewById(fragmentId);
        mDrawerLayout = drawerLayout;

        // set a custom shadow that overlays the main content when the drawer opens
        mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
        // set up the drawer's list view with items and click listener

        ActionBar actionBar = getActionBar();
        actionBar.setDisplayHomeAsUpEnabled(true);
        actionBar.setHomeButtonEnabled(true);

        // ActionBarDrawerToggle ties together the the proper interactions
        // between the navigation drawer and the action bar app icon.
        mDrawerToggle = new ActionBarDrawerToggle(
                getActivity(),                    /* host Activity */
                mDrawerLayout,                    /* DrawerLayout object */
                R.string.navigation_drawer_open,  /* "open drawer" description for accessibility */
                R.string.navigation_drawer_close  /* "close drawer" description for accessibility */
        ) {
            @Override
            public void onDrawerClosed(View drawerView) {
                super.onDrawerClosed(drawerView);
                if (!isAdded()) {
                    return;
                }

                getActivity().supportInvalidateOptionsMenu(); // calls onPrepareOptionsMenu()
            }

            @Override
            public void onDrawerOpened(View drawerView) {
                super.onDrawerOpened(drawerView);
                if (!isAdded()) {
                    return;
                }

                if (!mUserLearnedDrawer) {
                    // The user manually opened the drawer; store this flag to prevent auto-showing
                    // the navigation drawer automatically in the future.
                    mUserLearnedDrawer = true;
                    SharedPreferences sp = PreferenceManager
                            .getDefaultSharedPreferences(getActivity());
                    sp.edit().putBoolean(PREF_USER_LEARNED_DRAWER, true).apply();
                }

                getActivity().supportInvalidateOptionsMenu(); // calls onPrepareOptionsMenu()
            }
        };

        // If the user hasn't 'learned' about the drawer, open it to introduce them to the drawer,
        // per the navigation drawer design guidelines.
        if (!mUserLearnedDrawer && !mFromSavedInstanceState) {
            mDrawerLayout.openDrawer(mFragmentContainerView);
        }

        // Defer code dependent on restoration of previous instance state.
        mDrawerLayout.post(new Runnable() {
            @Override
            public void run() {
                mDrawerToggle.syncState();
            }
        });

        mDrawerLayout.setDrawerListener(mDrawerToggle);
    }

    private void selectItem(int position) {
        mCurrentSelectedPosition = position;
        if (mDrawerListView != null) {
            mDrawerListView.setItemChecked(position, true);
        }
        if (mDrawerLayout != null) {
            mDrawerLayout.closeDrawer(mFragmentContainerView);
        }
        if (mCallbacks != null) {
            mCallbacks.onNavigationDrawerItemSelected(position);
        }
    }

    @Override
    public void onAttach(Activity activity) {
        super.onAttach(activity);
        try {
            mCallbacks = (NavigationDrawerCallbacks) activity;
        } catch (ClassCastException e) {
            throw new ClassCastException("Activity must implement NavigationDrawerCallbacks.");
        }
    }

    @Override
    public void onDetach() {
        super.onDetach();
        mCallbacks = null;
    }

    @Override
    public void onSaveInstanceState(Bundle outState) {
        super.onSaveInstanceState(outState);
        outState.putInt(STATE_SELECTED_POSITION, mCurrentSelectedPosition);
    }

    @Override
    public void onConfigurationChanged(Configuration newConfig) {
        super.onConfigurationChanged(newConfig);
        // Forward the new configuration the drawer toggle component.
        mDrawerToggle.onConfigurationChanged(newConfig);
    }

    @Override
    public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
        // If the drawer is open, show the global app actions in the action bar. See also
        // showGlobalContextActionBar, which controls the top-left area of the action bar.
        /*if (mDrawerLayout != null && isDrawerOpen()) {
            inflater.inflate(R.menu.global, menu);
            showGlobalContextActionBar();
        }*/
        super.onCreateOptionsMenu(menu, inflater);
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        if (mDrawerToggle.onOptionsItemSelected(item)) {
            return true;
        }

        /*if (item.getItemId() == R.id.action_example) {
            Toast.makeText(getActivity(), "Example action.", Toast.LENGTH_SHORT).show();
            return true;
        }*/

        return super.onOptionsItemSelected(item);
    }

    /**
     * Per the navigation drawer design guidelines, updates the action bar to show the global app
     * 'context', rather than just what's in the current screen.
     */
    private void showGlobalContextActionBar() {
        ActionBar actionBar = getActionBar();
        actionBar.setDisplayShowTitleEnabled(true);
        actionBar.setNavigationMode(ActionBar.NAVIGATION_MODE_STANDARD);
        actionBar.setTitle(R.string.app_name);
    }

    private ActionBar getActionBar() {
        return ((ActionBarActivity) getActivity()).getSupportActionBar();
    }

    /**
     * Callbacks interface that all activities using this fragment must implement.
     */
    public static interface NavigationDrawerCallbacks {
        /**
         * Called when an item in the navigation drawer is selected.
         */
        void onNavigationDrawerItemSelected(int position);
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/adapter/DetectedOverlayAdapter.java`:

```java
package com.geeksonsecurity.android.overlayprotector.adapter;

import android.content.Context;
import android.content.pm.PackageManager;
import android.graphics.drawable.Drawable;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ArrayAdapter;
import android.widget.ImageView;
import android.widget.TextView;

import com.geeksonsecurity.android.overlayprotector.R;
import com.geeksonsecurity.android.overlayprotector.domain.DetectedOverlay;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;

public class DetectedOverlayAdapter extends ArrayAdapter<DetectedOverlay> {

    SimpleDateFormat sdf = new SimpleDateFormat("dd.MM.yyyy HH:mm");

    public DetectedOverlayAdapter(Context c, List<DetectedOverlay> items) {
        super(c, 0, items);
    }

    @Override
    public View getView(int position, View convertView, ViewGroup parent) {
        // Get the data item for this position
        DetectedOverlay detectedOverlay = getItem(position);
        // Check if an existing view is being reused, otherwise inflate the view
        if (convertView == null) {
            convertView = LayoutInflater.from(getContext()).inflate(R.layout.detectedoverlay_item, parent, false);
        }
        ImageView iconImageView = (ImageView) convertView.findViewById(R.id.iconImageView);
        TextView offenderTextView = (TextView) convertView.findViewById(R.id.offenderLabel);
        TextView timestampTextView = (TextView) convertView.findViewById(R.id.timestampLabel);
        // Populate the data into the template view using the data object
        offenderTextView.setText(detectedOverlay.getOffender());
        Drawable icon;
        try {
            icon = getContext().getPackageManager().getApplicationIcon(detectedOverlay.getOffender());
        } catch (PackageManager.NameNotFoundException e) {
            icon = getContext().getResources().getDrawable(R.drawable.ic_question_icon);
        }
        iconImageView.setImageDrawable(icon);
        Date resultdate = new Date(detectedOverlay.getTimestamp());
        timestampTextView.setText(sdf.format(resultdate));
        // Return the completed view to render on screen
        return convertView;

    }

}
```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/adapter/SuspectedAppsAdapter.java`:

```java
package com.geeksonsecurity.android.overlayprotector.adapter;

import android.content.Context;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.graphics.drawable.Drawable;
import android.net.Uri;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ArrayAdapter;
import android.widget.ImageView;
import android.widget.TextView;

import com.geeksonsecurity.android.overlayprotector.R;
import com.geeksonsecurity.android.overlayprotector.domain.SuspectedApp;

import java.text.SimpleDateFormat;
import java.util.List;

public class SuspectedAppsAdapter extends ArrayAdapter<SuspectedApp> {

    private static final String TAG = SuspectedAppsAdapter.class.getSimpleName();
    SimpleDateFormat sdf = new SimpleDateFormat("dd.MM.yyyy HH:mm");

    public SuspectedAppsAdapter(Context c) {
        super(c, 0);
    }

    public SuspectedAppsAdapter(Context c, List<SuspectedApp> items) {
        super(c, 0, items);
    }

    @Override
    public View getView(int position, View convertView, ViewGroup parent) {
        // Get the data item for this position
        final SuspectedApp suspectedApp = getItem(position);
        // Check if an existing view is being reused, otherwise inflate the view
        if (convertView == null) {
            convertView = LayoutInflater.from(getContext()).inflate(R.layout.suspectedapps_item, parent, false);
        }
        ImageView iconImageView = (ImageView) convertView.findViewById(R.id.iconImageView);
        TextView appName = (TextView) convertView.findViewById(R.id.appName);
        TextView packageName = (TextView) convertView.findViewById(R.id.packageName);
        // Populate the data into the template view using the data object
        appName.setText(suspectedApp.getAppName());
        packageName.setText(suspectedApp.getPackageName());
        Drawable icon;
        try {
            icon = getContext().getPackageManager().getApplicationIcon(suspectedApp.getPackageName());
        } catch (PackageManager.NameNotFoundException e) {
            icon = getContext().getResources().getDrawable(R.drawable.ic_question_icon);
        }
        iconImageView.setImageDrawable(icon);


        ImageView delete = (ImageView) convertView.findViewById(R.id.uninstallImageView);
        delete.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                Intent intent = new Intent(Intent.ACTION_DELETE);
                intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                String packageName = "package:" + suspectedApp.getPackageName();
                intent.setData(Uri.parse(packageName));
                Log.i(TAG,
                        String.format("Started uninstall intent for %s", packageName));
                getContext().startActivity(intent);
            }
        });

        // Return the completed view to render on screen
        return convertView;

    }

}
```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/adapter/WhiteEntryAdapter.java`:

```java
package com.geeksonsecurity.android.overlayprotector.adapter;

import android.app.AlertDialog;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.graphics.drawable.Drawable;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ArrayAdapter;
import android.widget.ImageView;
import android.widget.TextView;
import android.widget.Toast;

import com.geeksonsecurity.android.overlayprotector.MonitorAccessibilityService;
import com.geeksonsecurity.android.overlayprotector.R;
import com.geeksonsecurity.android.overlayprotector.database.DatabaseHelper;
import com.geeksonsecurity.android.overlayprotector.domain.ServiceCommunication;
import com.geeksonsecurity.android.overlayprotector.domain.WhiteEntry;
import com.j256.ormlite.dao.Dao;
import com.readystatesoftware.viewbadger.BadgeView;

import java.sql.SQLException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;

public class WhiteEntryAdapter extends ArrayAdapter<WhiteEntry> {

    private static final String TAG = WhiteEntryAdapter.class.getSimpleName();
    SimpleDateFormat sdf = new SimpleDateFormat("dd.MM.yyyy HH:mm");

    public WhiteEntryAdapter(Context c, List<WhiteEntry> items) {
        super(c, 0, items);
    }

    @Override
    public View getView(int position, View convertView, ViewGroup parent) {
        // Get the data item for this position
        final WhiteEntry whiteEntry = getItem(position);
        // Check if an existing view is being reused, otherwise inflate the view
        if (convertView == null) {
            convertView = LayoutInflater.from(getContext()).inflate(R.layout.whitelist_item, parent, false);
        }
        ImageView iconImageView = (ImageView) convertView.findViewById(R.id.iconImageView);
        TextView nameTextView = (TextView) convertView.findViewById(R.id.nameLabel);
        TextView timestampTextView = (TextView) convertView.findViewById(R.id.timestampLabel);
        // Populate the data into the template view using the data object
        nameTextView.setText(whiteEntry.getName() + (!whiteEntry.isExactMatch() ? "*" : ""));
        Drawable icon = getContext().getResources().getDrawable(whiteEntry.isSystemEntry() ? R.drawable.ic_system : R.drawable.ic_user);
        iconImageView.setImageDrawable(icon);

        if (whiteEntry.getHitCount() > 0) {
            BadgeView badge = new BadgeView(getContext(), iconImageView);
            badge.setText(whiteEntry.getHitCount() > 99 ? "99+" : String.valueOf(whiteEntry.getHitCount()));
            badge.show();
        }

        ImageView delete = (ImageView) convertView.findViewById(R.id.deleteImageView);
        delete.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                AlertDialog.Builder builder = new AlertDialog.Builder(getContext());
                // Set the dialog title
                builder.setTitle("Delete Confirmation");
                builder.setMessage("Delete selected white entry?");
                builder.setNegativeButton("No", new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int id) {
                        // Nothing
                    }
                });
                builder.setPositiveButton("Yes", new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                        try {
                            Dao<WhiteEntry, Integer> wed = DatabaseHelper.getHelper(getContext()).getWhiteListDao();
                            wed.delete(whiteEntry);
                            WhiteEntryAdapter.this.remove(whiteEntry);
                            notifyChangesToService();
                        } catch (SQLException e) {
                            Toast.makeText(getContext(), "Failed to delete entry!", Toast.LENGTH_SHORT);
                            Log.e(TAG, "Failed to delete whitelist entry", e);
                        }
                    }
                });
                builder.create().show();
            }
        });

        Date resultDate = new Date(whiteEntry.getAddedTimestamp());
        timestampTextView.setText(sdf.format(resultDate));
        // Return the completed view to render on screen
        return convertView;

    }

    private void notifyChangesToService() {
        Intent intent = new Intent(getContext(), MonitorAccessibilityService.class);
        intent.setAction(ServiceCommunication.MSG_WHITELIST_UPDATED);
        getContext().startService(intent);
    }

}
```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/database/DatabaseHelper.java`:

```java
package com.geeksonsecurity.android.overlayprotector.database;

import android.content.Context;
import android.database.sqlite.SQLiteDatabase;
import android.util.Log;

import com.geeksonsecurity.android.overlayprotector.domain.DetectedOverlay;
import com.geeksonsecurity.android.overlayprotector.domain.SuspectedApp;
import com.geeksonsecurity.android.overlayprotector.domain.WhiteEntry;
import com.j256.ormlite.android.apptools.OrmLiteSqliteOpenHelper;
import com.j256.ormlite.dao.Dao;
import com.j256.ormlite.stmt.DeleteBuilder;
import com.j256.ormlite.support.ConnectionSource;
import com.j256.ormlite.table.TableUtils;

import java.sql.SQLException;


public class DatabaseHelper extends OrmLiteSqliteOpenHelper {

    private static DatabaseHelper instance;

    // name of the database file for your application -- change to something appropriate for your app
    private static final String DATABASE_NAME = "overlayprotector.db";
    // any time you make changes to your database objects, you may have to increase the database version
    private static final int DATABASE_VERSION = 2;
    private final String TAG = DatabaseHelper.class.getSimpleName();
    private Dao<WhiteEntry, Integer> whiteListDao = null;
    private Dao<DetectedOverlay, Integer> detectedOverlayDao = null;
    private Dao<SuspectedApp, Integer> suspectedAppDao = null;

    private DatabaseHelper(Context context) {
        super(context, DATABASE_NAME, null, DATABASE_VERSION);
    }

    /**
     * This is called when the database is first created. Usually you should call createTable statements here to create
     * the tables that will store your data.
     */
    @Override
    public void onCreate(SQLiteDatabase db, ConnectionSource connectionSource) {
        try {
            Log.i(TAG, "onCreate");
            TableUtils.createTable(connectionSource, WhiteEntry.class);
            TableUtils.createTable(connectionSource, SuspectedApp.class);
            TableUtils.createTable(connectionSource, DetectedOverlay.class);
        } catch (SQLException e) {
            Log.e(TAG, "Can't create database", e);
            throw new RuntimeException(e);
        }

        // Add system whitelist entries
        Dao<WhiteEntry, Integer> dao;
        try {
            dao = getWhiteListDao();
            long now = System.currentTimeMillis();

            String[] androidSystemSinglePackages = new String[]{"android", "system"};
            String[] androidSystemPackages = new String[]{"android.", "com.android", "system.", "com.google."};

            for (String i : androidSystemSinglePackages) {
                WhiteEntry w1 = new WhiteEntry(i, now, 0, true, true);
                dao.create(w1);
            }

            for (String i : androidSystemPackages) {
                WhiteEntry w1 = new WhiteEntry(i, now, 0, true, false);
                dao.create(w1);
            }
            Log.i(TAG, "created system whitelist entries in onCreate");
        } catch (SQLException e) {
            Log.e(TAG, "Exception adding system whitelist entries", e);
        }

    }

    /**
     * This is called when your application is upgraded and it has a higher version number. This allows you to adjust
     * the various data to match the new version number.
     */
    @Override
    public void onUpgrade(SQLiteDatabase db, ConnectionSource connectionSource, int oldVersion, int newVersion) {
        try {
            Log.i(TAG, "onUpgrade");
            TableUtils.dropTable(connectionSource, SuspectedApp.class, true);
            Log.d(TAG, String.format("Dropped suspected app table!"));
            Dao<WhiteEntry, Integer> whiteListDao = getWhiteListDao();
            DeleteBuilder<WhiteEntry, Integer> deleteBuilder = whiteListDao.deleteBuilder();
            deleteBuilder.where().eq("systemEntry", Boolean.TRUE);
            int deleted = deleteBuilder.delete();
            Log.d(TAG, String.format("Delete %d old system whitelist entries", deleted));
            onCreate(db, connectionSource);
        } catch (SQLException e) {
            Log.e(TAG, "Can't drop databases", e);
            throw new RuntimeException(e);
        }
    }

    /**
     * Returns the Database Access Object (DAO) for our SimpleData class. It will create it or just give the cached
     * value.
     */
    public Dao<WhiteEntry, Integer> getWhiteListDao() throws SQLException {
        if (whiteListDao == null) {
            whiteListDao = getDao(WhiteEntry.class);
        }
        return whiteListDao;
    }

    public Dao<DetectedOverlay, Integer> getDetectedOverlayDao() throws SQLException {
        if (detectedOverlayDao == null) {
            detectedOverlayDao = getDao(DetectedOverlay.class);
        }
        return detectedOverlayDao;
    }

    public Dao<SuspectedApp, Integer> getSuspectedAppDao() throws SQLException {
        if (suspectedAppDao == null) {
            suspectedAppDao = getDao(SuspectedApp.class);
        }
        return suspectedAppDao;
    }

    /**
     * Close the database connections and clear any cached DAOs.
     */
    @Override
    public void close() {
        super.close();
        whiteListDao = null;
    }

    public static synchronized DatabaseHelper getHelper(Context context) {
        if (instance == null)
            instance = new DatabaseHelper(context);
        return instance;
    }

}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/database/DatabaseUtils.java`:

```java
package com.geeksonsecurity.android.overlayprotector.database;

import android.content.Context;
import android.content.SharedPreferences;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager;
import android.preference.PreferenceManager;
import android.util.Log;

import com.geeksonsecurity.android.overlayprotector.domain.Settings;
import com.geeksonsecurity.android.overlayprotector.domain.SuspectedApp;
import com.google.gson.Gson;
import com.j256.ormlite.dao.Dao;
import com.j256.ormlite.stmt.DeleteBuilder;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;


public class DatabaseUtils {

    public static void fillSuspectedApps(Context context) {
        Gson gson = new Gson();
        String TAG = "DatabaseUtils.fillSuspectedApps";


        Context ctx = context.getApplicationContext();
        SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(ctx);

        String json = prefs.getString(Settings.KEY_SETTINGS, "");
        Settings settings = new Settings();
        if (!(json != null ? json.isEmpty() : true)) {
            settings = gson.fromJson(json, Settings.class);
        }

        if (settings.getSuspectedAppUpdateTimestamp() > 0) {
            Log.d(TAG, "Suspected apps already populated, skipping");
            return;
        }

        List<SuspectedApp> listData = new ArrayList<>();
        PackageManager p = context.getPackageManager();
        final List<PackageInfo> installedApps =
                p.getInstalledPackages(PackageManager.GET_PERMISSIONS |
                        PackageManager.GET_PROVIDERS);

        long refreshTimestamp = System.currentTimeMillis();

        Dao<SuspectedApp, Integer> suspectedAppDao = null;
        try {
            suspectedAppDao = DatabaseHelper.getHelper(context).getSuspectedAppDao();
            DeleteBuilder<SuspectedApp, Integer> deleteBuilder = suspectedAppDao.deleteBuilder();
            deleteBuilder.where().gt("id", 0);
            int deleted = deleteBuilder.delete();
            Log.i(TAG, "Deleted " + deleted + " entries from suspected apps");
        } catch (SQLException e) {
            Log.e(TAG, "Failed to retrieve suspected apps DAO", e);
        }

        for (PackageInfo i : installedApps) {
            if (i != null && i.requestedPermissions != null) {

                if (i.packageName.equals(context.getPackageName()))
                    continue;

                List<String> list = Arrays.asList(i.requestedPermissions);
                if (list.contains("android.permission.SYSTEM_ALERT_WINDOW") && list.contains("android.permission.GET_TASKS")) {
                    SuspectedApp app = new SuspectedApp();
                    app.setPackageName(i.packageName);
                    final String applicationName = p.getApplicationLabel(i.applicationInfo).toString();
                    app.setAppName(applicationName);
                    listData.add(app);
                    if (suspectedAppDao != null) {
                        try {
                            suspectedAppDao.createIfNotExists(app);
                        } catch (SQLException e) {
                            Log.e(TAG, "Failed to create suspected app " + app.getPackageName(), e);
                        }
                    }
                }
            }
        }

        settings.setSuspectedAppUpdateTimestamp(refreshTimestamp);
        SharedPreferences.Editor editor = prefs.edit();
        String serialized = gson.toJson(settings);
        editor.putString(Settings.KEY_SETTINGS, serialized);
        editor.apply();
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/domain/ConcurrentArrayList.java`:

```java
package com.geeksonsecurity.android.overlayprotector.domain;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantReadWriteLock;

public class ConcurrentArrayList<T> {

    /**
     * use this to lock for write operations like add/remove
     */
    private final Lock readLock;
    /**
     * use this to lock for read operations like get/iterator/contains..
     */
    private final Lock writeLock;
    /**
     * the underlying list
     */
    private final List<T> list = new ArrayList<>();

    {
        ReentrantReadWriteLock rwLock = new ReentrantReadWriteLock();
        readLock = rwLock.readLock();
        writeLock = rwLock.writeLock();
    }

    public void add(T e) {
        writeLock.lock();
        try {
            list.add(e);
        } finally {
            writeLock.unlock();
        }
    }

    public void get(int index) {
        readLock.lock();
        try {
            list.get(index);
        } finally {
            readLock.unlock();
        }
    }

    public Iterator<T> iterator() {
        readLock.lock();
        try {
            return new ArrayList<T>(list).iterator();
            //^ we iterate over an snapshot of our list
        } finally {
            readLock.unlock();
        }
    }

    public void clear() {
        writeLock.lock();
        try {
            list.clear();
        } finally {
            writeLock.unlock();
        }

    }

    public void remove(T value) {
        writeLock.lock();
        try {
            list.remove(value);
        } finally {
            writeLock.unlock();
        }

    }

    public boolean contains(T value) {
        readLock.lock();
        try {
            return list.contains(value);
        } finally {
            readLock.unlock();
        }
    }

    public int size() {
        readLock.lock();
        try {
            return list.size();
        } finally {
            readLock.unlock();
        }
    }
}
```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/domain/DetectedOverlay.java`:

```java
package com.geeksonsecurity.android.overlayprotector.domain;

import com.j256.ormlite.field.DatabaseField;
import com.j256.ormlite.table.DatabaseTable;


@DatabaseTable(tableName = "detected_overlays")
public class DetectedOverlay {
    @DatabaseField(generatedId = true)
    public int id;

    @DatabaseField(index = true)
    private String offender;

    @DatabaseField
    private long timestamp;

    public DetectedOverlay() {

    }

    public DetectedOverlay(String offender, long timestamp) {
        this.offender = offender;
        this.timestamp = timestamp;
    }

    public String getOffender() {
        return offender;
    }

    public void setOffender(String offender) {
        this.offender = offender;
    }

    public long getTimestamp() {
        return timestamp;
    }

    public void setTimestamp(long timestamp) {
        this.timestamp = timestamp;
    }

    @Override
    public String toString() {
        return getTimestamp() + ": " + getOffender();
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/domain/DetectionEngine.java`:

```java
package com.geeksonsecurity.android.overlayprotector.domain;

import com.geeksonsecurity.android.overlayprotector.service.AdvancedDetectionService;
import com.geeksonsecurity.android.overlayprotector.service.BaseDetectionEngine;


public enum DetectionEngine {
    ADVANCED("Advanced", AdvancedDetectionService.class),
    BASE("Base", BaseDetectionEngine.class);

    private String _name;
    private Class _clazz;

    DetectionEngine(String name, Class clazz) {
        _name = name;
        _clazz = clazz;
    }

    @Override
    public String toString() {
        return _name;
    }

    public static DetectionEngine get(String name) {
        if (name == BASE.toString()) {
            return BASE;
        } else {
            return ADVANCED;
        }
    }

    public Class getDetectionClass() {
        return _clazz;
    }
}
```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/domain/EventCounter.java`:

```java
package com.geeksonsecurity.android.overlayprotector.domain;

public class EventCounter {
    private long[] _minuteCount = new long[60];
    private long _lastTimestamp;

    private int _currentIdx = 0;

    public void newEvent() {
        long now = System.currentTimeMillis();
        if (_lastTimestamp == 0) {
            _lastTimestamp = now;
        }

        long deltaSec = (now - _lastTimestamp) / 1000;

        if (deltaSec >= 1) {
            for (int i = 0; i < deltaSec && i < _minuteCount.length; i++)
                _minuteCount[i] = 0;

            _currentIdx += deltaSec;
            _currentIdx = _currentIdx % _minuteCount.length;
            _minuteCount[_currentIdx] = 0;
            _lastTimestamp = now;
        }
        _minuteCount[_currentIdx] += 1;
    }

    public long getLastMinuteEventCount() {
        long total = 0;
        for (long i : _minuteCount) {
            total += i;
        }
        return total;
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/domain/OverlayState.java`:

```java
package com.geeksonsecurity.android.overlayprotector.domain;

public class OverlayState {
    private boolean hasOverlay = false;
    private boolean overlayShown = false;
    private String process = "";
    private String offender = "";
    private long processTimestamp = 0;
    private boolean pendingUninstall = false;
    private String ignoreOncePackage = "";
    private String additionalInfo;

    public synchronized boolean isHasOverlay() {
        return hasOverlay;
    }

    public synchronized void setHasOverlay(boolean hasOverlay) {
        this.hasOverlay = hasOverlay;
    }

    public synchronized void setProcess(String process) {
        this.process = process;
        processTimestamp = System.currentTimeMillis();
    }

    public synchronized String getOffender() {
        return offender;
    }

    public synchronized void setOffender(String offender) {
        this.offender = offender;
    }

    public synchronized boolean isOverlayShown() {
        return overlayShown;
    }

    public synchronized void setOverlayShown(boolean overlayShown) {
        this.overlayShown = overlayShown;
    }

    public synchronized void resetState() {
        process = "";
        hasOverlay = false;
        overlayShown = false;
        offender = "";
        ignoreOncePackage = "";
        additionalInfo = "";
    }

    public synchronized void setPendingUninstall(boolean pendingUninstall) {
        this.pendingUninstall = pendingUninstall;
    }

    public synchronized boolean isPendingUninstall() {
        return pendingUninstall;
    }

    public synchronized void setIgnoreOncePackage(String ignoreOncePackage) {
        this.ignoreOncePackage = ignoreOncePackage;
    }

    public synchronized String getIgnoreOncePackage() {
        return ignoreOncePackage;
    }

    public synchronized String getProcess() {
        return process;
    }

    public synchronized void setAdditionalInfo(String additionalInfo) {
        this.additionalInfo = additionalInfo;
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/domain/ProcessUpdateEntry.java`:

```java
package com.geeksonsecurity.android.overlayprotector.domain;

public class ProcessUpdateEntry {
    private String process;
    private boolean hasChanged;

    public boolean isHasChanged() {
        return hasChanged;
    }

    public void setHasChanged(boolean hasChanged) {
        this.hasChanged = hasChanged;
    }

    public String getProcess() {
        return process;
    }

    public void setProcess(String process) {
        this.process = process;
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/domain/ServiceCommunication.java`:

```java
package com.geeksonsecurity.android.overlayprotector.domain;

public class ServiceCommunication {

    public static final String MSG_SETTINGS_UPDATED = "OP_UPDATE_SETTINGS";
    public static final String MSG_WHITELIST_UPDATED = "OP_UPDATE_WHITELIST";

    public static final int MSG_EVENT_COUNT_UPDATE = 1984;
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/domain/Settings.java`:

```java
package com.geeksonsecurity.android.overlayprotector.domain;

public class Settings {

    public static final String KEY_SETTINGS = "settings";

    // Setting default values
    private long suspectedAppUpdateTimestamp = 0;
    private int uninstallTimeoutSeconds = 15;
    private int ignoreOnceTimeoutSeconds = 10;
    private boolean advancedMode = true;
    private DetectionEngine detectionEngine = DetectionEngine.ADVANCED;

    public long getSuspectedAppUpdateTimestamp() {
        return suspectedAppUpdateTimestamp;
    }

    public void setSuspectedAppUpdateTimestamp(long suspectedAppUpdateTimestamp) {
        this.suspectedAppUpdateTimestamp = suspectedAppUpdateTimestamp;
    }

    public boolean isAdvancedMode() {
        return advancedMode;
    }

    public void setAdvancedMode(boolean advancedMode) {
        this.advancedMode = advancedMode;
    }

    public int getUninstallTimeoutSeconds() {
        return uninstallTimeoutSeconds;
    }

    public void setUninstallTimeoutSeconds(int uninstallTimeoutSeconds) {
        this.uninstallTimeoutSeconds = uninstallTimeoutSeconds;
    }

    public int getIgnoreOnceTimeoutSeconds() {
        return ignoreOnceTimeoutSeconds;
    }

    public void setIgnoreOnceTimeoutSeconds(int ignoreOnceTimeoutSeconds) {
        this.ignoreOnceTimeoutSeconds = ignoreOnceTimeoutSeconds;
    }

    public long getEventProcessingDelayMilliSeconds() {
        return 350;
    }

    public boolean isDetectOnTypeWindowsChanged() {
        return true;
    }

    public boolean isDetectOnTypeWindowContentChanged() {
        return true;
    }

    public boolean isDetectOnTypeWindowStateChanged() {
        return true;
    }

    public void setDetectionEngine(DetectionEngine detectionEngine) {
        this.detectionEngine = detectionEngine;
    }

    public DetectionEngine getDetectionEngine() {
        return detectionEngine;
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/domain/SuspectedApp.java`:

```java
package com.geeksonsecurity.android.overlayprotector.domain;

import com.j256.ormlite.field.DatabaseField;

public class SuspectedApp {
    @DatabaseField(generatedId = true)
    public int id;

    @DatabaseField
    private String packageName;

    @DatabaseField
    private String appName;

    public String getPackageName() {
        return packageName;
    }

    public void setPackageName(String packageName) {
        this.packageName = packageName;
    }

    public String getAppName() {
        return appName;
    }

    public void setAppName(String appName) {
        this.appName = appName;
    }

}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/domain/WhiteEntry.java`:

```java
package com.geeksonsecurity.android.overlayprotector.domain;

import com.j256.ormlite.field.DatabaseField;
import com.j256.ormlite.table.DatabaseTable;


@DatabaseTable(tableName = "whitelist")
public class WhiteEntry {
    @DatabaseField(generatedId = true)
    public int id;

    @DatabaseField(index = true)
    private String name;

    public WhiteEntry() {

    }

    public WhiteEntry(String name, long addedTimestamp, int hitCount, boolean systemEntry, boolean exactMatch) {
        this.name = name;
        this.addedTimestamp = addedTimestamp;
        this.hitCount = hitCount;
        this.systemEntry = systemEntry;
        this.exactMatch = exactMatch;
    }

    public WhiteEntry(String name, long addedTimestamp) {
        this(name, addedTimestamp, 0, false, false);
    }

    @DatabaseField
    private long addedTimestamp;

    @DatabaseField
    private int hitCount;

    @DatabaseField
    private boolean systemEntry;

    @DatabaseField
    private boolean exactMatch;

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public long getAddedTimestamp() {
        return addedTimestamp;
    }

    public void setAddedTimestamp(long addedTimestamp) {
        this.addedTimestamp = addedTimestamp;
    }

    public int getHitCount() {
        return hitCount;
    }

    public void setHitCount(int hitCount) {
        this.hitCount = hitCount;
    }

    public boolean isSystemEntry() {
        return systemEntry;
    }

    public void setSystemEntry(boolean systemEntry) {
        this.systemEntry = systemEntry;
    }

    public boolean isExactMatch() {
        return exactMatch;
    }

    public void setExactMatch(boolean exactMatch) {
        this.exactMatch = exactMatch;
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/service/AbstractDetectionEngine.java`:

```java
package com.geeksonsecurity.android.overlayprotector.service;

import android.content.ComponentName;
import android.content.Context;
import android.content.SharedPreferences;
import android.content.pm.ActivityInfo;
import android.content.pm.PackageManager;
import android.preference.PreferenceManager;
import android.util.Log;
import android.view.accessibility.AccessibilityEvent;

import com.geeksonsecurity.android.overlayprotector.database.DatabaseHelper;
import com.geeksonsecurity.android.overlayprotector.domain.Settings;
import com.geeksonsecurity.android.overlayprotector.domain.SuspectedApp;
import com.geeksonsecurity.android.overlayprotector.domain.WhiteEntry;
import com.google.gson.Gson;
import com.j256.ormlite.dao.Dao;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.atomic.AtomicReference;


public abstract class AbstractDetectionEngine {

    private final String TAG = AbstractDetectionEngine.class.getSimpleName();

    protected final Context _context;
    protected final DatabaseHelper _helper;
    protected final IOverlayNotifyService _notifyService;
    protected final Gson _gson = new Gson();
    protected final ProcessHelper _processHelper;

    protected List<WhiteEntry> _whiteEntries = new ArrayList<>();
    protected Settings _settings = new Settings();


    public AbstractDetectionEngine(Context context, DatabaseHelper helper, IOverlayNotifyService notifyService, ProcessHelper processHelper) {

        _context = context;
        _helper = helper;
        _notifyService = notifyService;
        _processHelper = processHelper;

        // Initialize settings & whitelist entries
        refreshSettings();
        refreshWhiteList();
    }

    abstract public void handleEvent(AccessibilityEvent event);

    public void refreshWhiteList() {
        try {
            _whiteEntries = _helper.getWhiteListDao().queryForAll();
            Log.i(TAG, String.format("Loaded %d whitelist entries from database in cache", _whiteEntries.size()));
        } catch (SQLException e) {
            Log.e(TAG, "Failed to load white list entries", e);
        }
    }

    public void refreshSettings() {
        Context ctx = _context.getApplicationContext();
        SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(ctx);
        AtomicReference<String> json = new AtomicReference<>(prefs.getString(Settings.KEY_SETTINGS, ""));
        assert json.get() != null;
        if (!json.get().isEmpty()) {
            _settings = _gson.fromJson(json.get(), Settings.class);
        }
    }

    protected boolean checkWhitelistHit(String packageName) {
        boolean whitelistHit = false;
        for (WhiteEntry entry : _whiteEntries) {
            if (entry.isExactMatch() ? packageName.equals(entry.getName()) : packageName.startsWith(entry.getName())) {
                Log.d(TAG, "Whitelist entry hit " + entry.getName() + " saved " + packageName);
                whitelistHit = true;
                if (!entry.isSystemEntry()) {
                    entry.setHitCount(entry.getHitCount() + 1);
                    try {
                        _helper.getWhiteListDao().update(entry);
                        Log.i(TAG,
                                String.format("Updated white list entry for %s with new hit count of %d", entry.getName(), entry.getHitCount()));
                    } catch (SQLException e) {
                        Log.e(TAG,
                                String.format("Failed to update white list entry for %s with new hit count of %d", entry.getName(), entry.getHitCount()), e);
                    }
                }
                break;
            }
        }
        return whitelistHit;
    }

    protected boolean checkSuspectedApps(String packageName) {
        boolean matched = true;
        if (!_settings.isAdvancedMode()) {
            try {
                Dao<SuspectedApp, Integer> suspectedAppDao = DatabaseHelper.getHelper(_context.getApplicationContext()).getSuspectedAppDao();
                List<SuspectedApp> res = suspectedAppDao.queryForEq("packageName", packageName);
                if (res.size() == 0) {
                    Log.i(TAG, String.format("Skipping %s since not in suspected app list and is probably a FP", packageName));
                    matched = false;
                } else {
                    Log.d(TAG, String.format("Process %s found in suspected apps", packageName));
                    matched = true;
                }
            } catch (SQLException e) {
                Log.e(TAG, String.format("SQL exception: %s", e.getMessage()));
                matched = false;
            }
        }
        return matched;
    }


    protected ActivityInfo tryGetActivity(ComponentName componentName) {
        try {
            return _context.getPackageManager().getActivityInfo(componentName, 0);
        } catch (PackageManager.NameNotFoundException e) {
            return null;
        }
    }

}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/service/AdvancedDetectionService.java`:

```java
package com.geeksonsecurity.android.overlayprotector.service;

import android.app.KeyguardManager;
import android.content.Context;
import android.os.Bundle;
import android.os.CountDownTimer;
import android.os.ResultReceiver;
import android.util.Log;
import android.view.accessibility.AccessibilityEvent;
import android.view.accessibility.AccessibilityNodeInfo;

import com.geeksonsecurity.android.overlayprotector.database.DatabaseHelper;
import com.geeksonsecurity.android.overlayprotector.domain.ConcurrentArrayList;
import com.geeksonsecurity.android.overlayprotector.domain.EventCounter;
import com.geeksonsecurity.android.overlayprotector.domain.OverlayState;
import com.geeksonsecurity.android.overlayprotector.domain.ServiceCommunication;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Iterator;
import java.util.List;

public class AdvancedDetectionService extends AbstractDetectionEngine {

    private static final String TAG = AdvancedDetectionService.class.getSimpleName();

    private final OverlayState _overlayState = new OverlayState();
    private final EventCounter _eventCounter = new EventCounter();
    private final ConcurrentArrayList<CountDownTimer> _eventTimers = new ConcurrentArrayList<>();

    private String _oldProcess = "";
    private String _currentProcess = "";

    private KeyguardManager _keyguardManager;
    private ResultReceiver _resultReceiver = null;
    private List<String> _baseProcesses = new ArrayList<>(Arrays.asList("com.google.android.googlequicksearchbox", "com.sec.android.app.launcher"));

    public AdvancedDetectionService(Context context, DatabaseHelper helper, KeyguardManager keyguardManager, IOverlayNotifyService notifyService, ProcessHelper processHelper) {
        super(context, helper, notifyService, processHelper);
        _keyguardManager = keyguardManager;
    }

    @Override
    public void handleEvent(AccessibilityEvent event) {
        // Avoid processing events when screen is locked
        if (_keyguardManager != null) {
            boolean locked = _keyguardManager.inKeyguardRestrictedInputMode();
            if (locked) {
                Log.i(TAG, "Screen locked, skipping overlay check!");
                return;
            }
        }

        // When overlay is detected avoid performing useless computation
        if (_overlayState.isHasOverlay())
            return;

        if (event.getEventType() == AccessibilityEvent.TYPE_VIEW_CLICKED) {
            CountDownTimer eventTimer = new CountDownTimer(100, 100) {

                @Override
                public void onTick(long millisUntilFinished) {

                }

                @Override
                public void onFinish() {
                    updateProcessName("");
                    Log.d(TAG, String.format("New process: " + _currentProcess));
                }
            };
            eventTimer.start();
        }

        final String eventDescription = event.toString();
        final AccessibilityNodeInfo info = event.getSource();
        final String source = info != null ? info.getClassName().toString() : "";
        final String eventPackage = event.getPackageName() != null ? event.getPackageName().toString() : "";
        final int eventType = event.getEventType();

        long postponeMs = _settings.getEventProcessingDelayMilliSeconds();
        Log.i(TAG, String.format("Postponing event %d of %d ms, %s", eventType, postponeMs, eventDescription));

        /*if(event.getEventType() == AccessibilityEvent.TYPE_WINDOW_CONTENT_CHANGED) {
            AccessibilityNodeInfo parent = info.getParent();
            if (parent != null) {
                Log.d(TAG, "Node parent: " + parent.toString());
                int child = info.getChildCount();
                for (int i = 0; i < child; i++) {
                    AccessibilityNodeInfo childNodeView = parent.getChild(i);
                    Log.d(TAG, childNodeView.toString());
                }
            } else {
                Log.d(TAG, String.format("Event %s has no parent", info.toString()));
            }
        }*/

        // Postpone events to avoid false positive during application startup
        CountDownTimer eventTimer = new CountDownTimer(postponeMs, postponeMs) {
            @Override
            public void onTick(long millisUntilFinished) {
            }

            @Override
            public void onFinish() {
                /*if (eventPackage.equals(_oldProcess)) {
                    Log.d(TAG, String.format("Event " + eventType + " processing avoided since still owned by old ng%s", _oldProcess));
                    return;
                }*/

                if (!_eventTimers.contains(this)) {
                    Log.d(TAG, "Event " + eventType + " processing avoided since timer event has been canceled");
                    return;
                }

                // No one would inject on a base process right?
                if (_baseProcesses.contains(_currentProcess)) {
                    Log.d(TAG, String.format("Event %s processing aborted since its base process %s since its a base process", eventType, _currentProcess));
                    return;
                }

                if (eventType == AccessibilityEvent.TYPE_WINDOWS_CHANGED) {
                    Log.i(TAG, "*** WINDOW CHANGED! ***");

                    if (_settings.isDetectOnTypeWindowsChanged()) {
                        Log.i(TAG, String.format("Checking %s for overlay: %s, %s", _currentProcess, source, eventPackage));
                        checkForOverlay(_currentProcess, source, eventPackage);
                    }


                } else if (eventType == AccessibilityEvent.TYPE_WINDOW_CONTENT_CHANGED) {
                    Log.i(TAG, "*** WINDOW CONTENT CHANGED! ***");

                    if (_settings.isDetectOnTypeWindowContentChanged()) {
                        Log.i(TAG, String.format("Checking %s for overlay: %s, %s", _currentProcess, source, eventPackage));
                        checkForOverlay(_currentProcess, source, eventPackage);
                    }

                } else if (eventType == AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED) {
                    Log.i(TAG, "PopupWindow, Menu or Dialog opened");

                    if (_settings.isDetectOnTypeWindowStateChanged()) {
                        checkForOverlay(_currentProcess, source, eventPackage);

                    }
                } else {
                    Log.w(TAG, String.format("Unknown event %d", eventType));
                }

                Log.i(TAG, String.format("Event %d, %s", eventType, eventDescription));
                _eventTimers.remove(this);
                Log.i(TAG, String.format("Finished processing event %d", eventType));
            }
        };
        _eventTimers.add(eventTimer);
        eventTimer.start();

        if (_eventCounter.getLastMinuteEventCount() % 5 == 0) {
            _notifyService.updateNotificationCount(_eventCounter.getLastMinuteEventCount());

            if (_resultReceiver != null) {
                Bundle bundle = new Bundle();
                bundle.putLong("eventCount", _eventCounter.getLastMinuteEventCount());
                _resultReceiver.send(ServiceCommunication.MSG_EVENT_COUNT_UPDATE, bundle);
            }
        }
    }

    private String updateProcessName(String procName) {
        String foregroundProcess = procName;
        if (procName.isEmpty()) {
            foregroundProcess = _processHelper.getForegroundApp();
            if (foregroundProcess.isEmpty()) {
                Log.w(TAG, String.format("*** Unable to resolve foreground process"));
            } else {
                Log.i(TAG, String.format("--- Process %s", foregroundProcess));
            }
        }
        // Just for the first time!
        if (_currentProcess.isEmpty()) {
            _currentProcess = foregroundProcess;
        }

        if (!foregroundProcess.equals(_currentProcess)) {
            _oldProcess = _currentProcess;
            _currentProcess = foregroundProcess;
            Log.i(TAG, String.format("--- PROCESS CHANGED ---- From %s to %s", _oldProcess, foregroundProcess));
            // If is not starting
            if (!_baseProcesses.contains(_oldProcess)) {
                clearEventTimers();
            }
        }

        return _currentProcess;
    }

    private void clearEventTimers() {
        Iterator<CountDownTimer> it = _eventTimers.iterator();

        Log.i(TAG, "All event timers canceled and cleared! Count " + _eventTimers.size());
        _eventTimers.clear();

        while (it.hasNext()) {
            it.next().cancel();
        }

    }

    private void checkForOverlay(final String process, final String... compares) {
        _eventCounter.newEvent();
        if (_overlayState.isHasOverlay()) {
            Log.d(TAG, "checkForOverlay: Overlay already detected, skipping check");
            return;
        } else if (process.isEmpty()) {
            Log.d(TAG, "checkForOverlay: Process is empty");
            return;
        }

        boolean result = false;
        for (String source : compares) {
            result = true;
            if (source.isEmpty()) {
                Log.d(TAG, "Source empty continuing");
                continue;
            }

            // Is our overlay detected?
            if (source.startsWith(_context.getApplicationContext().getPackageName())) {
                Log.d(TAG, String.format("Source contains same application package as our: %s", _context.getApplicationContext().getPackageName()));
                continue;
            }

            if (!checkWhitelistHit(source)) {
                Log.d(TAG, String.format("Comparing %s with process %s", source, _overlayState.getProcess()));
                if (source.startsWith(process)) {
                    Log.d(TAG, String.format("Source %s match foreground package %s", source, process));
                    result = false;
                }

                if (result && checkSuspectedApps(source)) {
                    Log.d(TAG, String.format("Overlay found by package %s over %s", source, process));
                    _overlayState.setOffender(source);
                    _overlayState.setProcess(process);
                    result = true;
                    break;
                }
            }
        }

        if (result && !_overlayState.getOffender().isEmpty() && !_overlayState.isOverlayShown()) {
            Log.w(TAG, "Overlay by " + _overlayState.getOffender());
            _overlayState.setHasOverlay(true);
            clearEventTimers();
            _notifyService.processOverlayState(_overlayState);
        }
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/service/BaseDetectionEngine.java`:

```java
package com.geeksonsecurity.android.overlayprotector.service;

import android.app.KeyguardManager;
import android.content.ComponentName;
import android.content.Context;
import android.content.pm.ActivityInfo;
import android.os.Bundle;
import android.os.ResultReceiver;
import android.util.Log;
import android.util.LogPrinter;
import android.view.accessibility.AccessibilityEvent;

import com.geeksonsecurity.android.overlayprotector.database.DatabaseHelper;
import com.geeksonsecurity.android.overlayprotector.domain.EventCounter;
import com.geeksonsecurity.android.overlayprotector.domain.OverlayState;
import com.geeksonsecurity.android.overlayprotector.domain.ServiceCommunication;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

public class BaseDetectionEngine extends AbstractDetectionEngine {
    private static final String TAG = BaseDetectionEngine.class.getSimpleName();

    private final OverlayState _overlayState = new OverlayState();
    private final EventCounter _eventCounter = new EventCounter();
    private String _currentProcess = "";

    private KeyguardManager _keyguardManager;
    private ResultReceiver _resultReceiver = null;

    private String previousEventPackage = "";
    private List<String> _layoutClasses = new ArrayList<>(Arrays.asList("android.view.ViewGroup", "android.widget.LinearLayout", "android.widget.RelativeLayout", "android.widget.FrameLayout", "android.widget.GridLayout"));


    public BaseDetectionEngine(Context context, DatabaseHelper helper, KeyguardManager keyguardManager, IOverlayNotifyService notifyService, ProcessHelper processHelper) {
        super(context, helper, notifyService, processHelper);
        _keyguardManager = keyguardManager;
    }

    @Override
    public void handleEvent(AccessibilityEvent event) {
        // Avoid processing events when screen is locked
        if (_keyguardManager != null) {
            boolean locked = _keyguardManager.inKeyguardRestrictedInputMode();
            if (locked) {
                Log.i(TAG, "Screen locked, skipping overlay check!");
                return;
            }
        }

        Log.d(TAG, String.format("New event %s", event.toString()));
        _eventCounter.newEvent();
        _notifyService.updateNotificationCount(_eventCounter.getLastMinuteEventCount());
        if (_resultReceiver != null) {
            Bundle bundle = new Bundle();
            bundle.putLong("eventCount", _eventCounter.getLastMinuteEventCount());
            _resultReceiver.send(ServiceCommunication.MSG_EVENT_COUNT_UPDATE, bundle);
        }


        // When overlay is detected avoid performing useless computation
        if (_overlayState.isHasOverlay() || _overlayState.isPendingUninstall())
            return;

        if (event.getEventType() == AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED) {
            if (event.getPackageName() == null)
                return;

            String eventPackage = event.getPackageName().toString();
            ComponentName componentName = new ComponentName(
                    eventPackage,
                    event.getClassName().toString()
            );
            ActivityInfo activityInfo = tryGetActivity(componentName);
            boolean isActivity = activityInfo != null;
            if (isActivity) {
                LogPrinter logPrinter = new LogPrinter(Log.DEBUG, TAG);
                activityInfo.dump(logPrinter, "");
            }
            String className = event.getClassName().toString();

            // Perform detection
            boolean parentAvailable = event.getSource() != null ? event.getSource().getParent() != null : false;

            Log.d(TAG, String.format("Collected info isActivity %s, parentAvailable: %s", String.valueOf(isActivity), String.valueOf(parentAvailable)));

            if (_overlayState.getIgnoreOncePackage().equals(eventPackage)) {
                Log.d(TAG, String.format("Package %s ignored once", eventPackage));
            } else if (eventPackage.equals(previousEventPackage)) {
                Log.d(TAG, String.format("Last two event have the same package %s, skipping check!", eventPackage));
            } else if (_layoutClasses.contains(className) && !isActivity && !parentAvailable) {
                Log.d(TAG, String.format("Detected suspicious class %s without activity and parent for process %s, checking whitelist", className, eventPackage));
                if (!checkWhitelistHit(eventPackage)) {
                    Log.d(TAG, "No whitelist entry found");
                    if (checkSuspectedApps(eventPackage)) {
                        Log.d(TAG, String.format("******* VIEW OVERLAY DETECTED!!!"));
                        _overlayState.setOffender(eventPackage);
                        _overlayState.setProcess(_currentProcess);
                        _notifyService.processOverlayState(_overlayState);
                    }
                } else {
                    Log.d(TAG, "Whitelist hit skipping!");
                }
            } else if (isActivity && activityInfo.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE && !parentAvailable) {
                Log.d(TAG, String.format("Detected suspicious activity %s with single instance flag, checking whitelist", activityInfo.packageName));
                if (!checkWhitelistHit(eventPackage)) {
                    Log.d(TAG, "No whitelist entry found");
                    if (checkSuspectedApps(eventPackage)) {
                        Log.d(TAG, String.format("******* ACTIVITY OVERLAY DETECTED!!!"));
                        _overlayState.setOffender(eventPackage);
                        _overlayState.setProcess(_currentProcess);
                        _notifyService.processOverlayState(_overlayState);
                    }
                } else {
                    Log.d(TAG, "Whitelist hit skipping!");
                }
            }
            previousEventPackage = eventPackage;
        }
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/service/IOverlayNotifyService.java`:

```java
package com.geeksonsecurity.android.overlayprotector.service;

import com.geeksonsecurity.android.overlayprotector.domain.OverlayState;

public interface IOverlayNotifyService {
    void processOverlayState(OverlayState state);

    void updateNotificationCount(long lastMinuteEventCount);
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/tasks/IServiceStatusProcessor.java`:

```java
package com.geeksonsecurity.android.overlayprotector.tasks;


public interface IServiceStatusProcessor {
    void processResult(boolean result);
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/tasks/ServiceStatusTask.java`:

```java
package com.geeksonsecurity.android.overlayprotector.tasks;

import android.accessibilityservice.AccessibilityServiceInfo;
import android.content.Context;
import android.os.AsyncTask;
import android.view.accessibility.AccessibilityEvent;
import android.view.accessibility.AccessibilityManager;

import java.util.List;

public class ServiceStatusTask extends AsyncTask<Void, Void, Boolean> {

    private AccessibilityManager accessibilityManager;
    private IServiceStatusProcessor listener;
    private Context context;

    public ServiceStatusTask(Context context, IServiceStatusProcessor serviceStatusProcessor) {
        this.context = context;
        accessibilityManager = (AccessibilityManager) context.getSystemService(Context.ACCESSIBILITY_SERVICE);
        listener = serviceStatusProcessor;
    }

    @Override
    protected Boolean doInBackground(Void... params) {
        boolean running = false;
        List<AccessibilityServiceInfo> runningServices = accessibilityManager
                .getEnabledAccessibilityServiceList(AccessibilityEvent.TYPES_ALL_MASK);
        for (AccessibilityServiceInfo service : runningServices) {
            if (service.getId().contains(context.getApplicationContext().getPackageName())) {
                running = true;
                break;
            }
        }
        return running;
    }

    @Override
    protected void onPostExecute(Boolean result) {
        super.onPostExecute(result);
        listener.processResult(result);
    }


}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/view/DetectedOverlayFragment.java`:

```java
package com.geeksonsecurity.android.overlayprotector.view;

import android.app.Activity;
import android.os.Bundle;
import android.support.v4.app.Fragment;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AbsListView;
import android.widget.AdapterView;

import com.geeksonsecurity.android.overlayprotector.MainActivity;
import com.geeksonsecurity.android.overlayprotector.R;
import com.geeksonsecurity.android.overlayprotector.adapter.DetectedOverlayAdapter;
import com.geeksonsecurity.android.overlayprotector.database.DatabaseHelper;
import com.geeksonsecurity.android.overlayprotector.domain.DetectedOverlay;
import com.j256.ormlite.dao.Dao;
import com.j256.ormlite.stmt.DeleteBuilder;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

public class DetectedOverlayFragment extends Fragment implements AbsListView.OnItemClickListener {
    /**
     * The fragment's ListView/GridView.
     */
    private AbsListView mListView;

    /**
     * The Adapter which will be used to populate the ListView/GridView with
     * Views.
     */
    private DetectedOverlayAdapter mAdapter;

    public static DetectedOverlayFragment newInstance() {
        return new DetectedOverlayFragment();
    }

    /**
     * Mandatory empty constructor for the fragment manager to instantiate the
     * fragment (e.g. upon screen orientation changes).
     */
    public DetectedOverlayFragment() {
    }


    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setHasOptionsMenu(true);

        List<DetectedOverlay> listData = new ArrayList<>();
        mAdapter = new DetectedOverlayAdapter(getActivity(), listData);
        refreshItems();
    }

    @Override
    public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
        super.onCreateOptionsMenu(menu, inflater);
        inflater.inflate(R.menu.detected_overlays_menu, menu);
    }


    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        switch (item.getItemId()) {
            case R.id.op_od_menu_refresh:
                refreshItems();
                break;
            case R.id.op_od_menu_clear:
                clearHistory();
                break;
            default:
                break;
        }
        return false;
    }

    private void clearHistory() {
        try {
            Dao<DetectedOverlay, Integer> detectedOverlayDao = DatabaseHelper.getHelper(getActivity()).getDetectedOverlayDao();
            DeleteBuilder<DetectedOverlay, Integer> deleteBuilder = detectedOverlayDao.deleteBuilder();
            deleteBuilder.where().gt("id", 0);
            int deleted = deleteBuilder.delete();
            Log.i(getTag(), "Deleted " + deleted + " entries from DetectedOverlay");
        } catch (SQLException e) {
            Log.e(getTag(), "Failed to deleted entries", e);
        }
        mAdapter.clear();
    }

    private void refreshItems() {
        List<DetectedOverlay> listData = new ArrayList<>();
        try {
            listData = DatabaseHelper.getHelper(getActivity()).getDetectedOverlayDao().queryBuilder().orderBy("timestamp", false).query();
        } catch (SQLException e) {
            Log.e(getTag(), "Failed to obtain detected overlays objects", e);
        }
        mAdapter.clear();
        mAdapter.addAll(listData);
    }

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
        View view = inflater.inflate(R.layout.fragment_detectedoverlay, container, false);

        // Set the adapter
        mListView = (AbsListView) view.findViewById(android.R.id.list);
        mListView.setEmptyView(view.findViewById(android.R.id.empty));
        mListView.setAdapter(mAdapter);

        // Set OnItemClickListener so we can be notified on item clicks
        mListView.setOnItemClickListener(this);

        return view;
    }

    @Override
    public void onStart() {
        super.onStart();
    }

    @Override
    public void onDetach() {
        super.onDetach();
    }

    @Override
    public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
        //if (null != mListener) {
        // Notify the active callbacks interface (the activity, if the
        // fragment is attached to one) that an item has been selected.
        //mListener.onFragmentInteraction(DummyContent.ITEMS.get(position).id);
        //}
    }

    @Override
    public void onAttach(Activity activity) {
        super.onAttach(activity);
        ((MainActivity) activity).onSectionAttached(3);
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/view/HomeFragment.java`:

```java
package com.geeksonsecurity.android.overlayprotector.view;

import android.app.Activity;
import android.app.NotificationManager;
import android.content.Context;
import android.content.Intent;
import android.graphics.Color;
import android.os.Bundle;
import android.os.Handler;
import android.os.Looper;
import android.os.ResultReceiver;
import android.support.v4.app.Fragment;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.TextView;

import com.geeksonsecurity.android.overlayprotector.MainActivity;
import com.geeksonsecurity.android.overlayprotector.MonitorAccessibilityService;
import com.geeksonsecurity.android.overlayprotector.R;
import com.geeksonsecurity.android.overlayprotector.database.DatabaseHelper;
import com.geeksonsecurity.android.overlayprotector.domain.DetectedOverlay;
import com.geeksonsecurity.android.overlayprotector.domain.ServiceCommunication;
import com.geeksonsecurity.android.overlayprotector.tasks.IServiceStatusProcessor;
import com.geeksonsecurity.android.overlayprotector.tasks.ServiceStatusTask;
import com.geeksonsecurity.android.overlayprotector.wizard.ConfigWizardActivity;
import com.j256.ormlite.dao.Dao;
import com.j256.ormlite.stmt.QueryBuilder;

import java.sql.SQLException;
import java.util.Calendar;
import java.util.Date;
import java.util.Timer;
import java.util.TimerTask;

public class HomeFragment extends Fragment {

    private static final String TAG = HomeFragment.class.getSimpleName();
    private static Timer checkStatusTimer;
    private Dao<DetectedOverlay, Integer> detectedOverlayDao = null;
    private CustomResultReceiver resultReceiver = null;
    NotificationManager _notificationManager = null;

    public static Fragment newInstance() {
        HomeFragment fragment = new HomeFragment();
        Bundle args = new Bundle();
        fragment.setArguments(args);
        return fragment;
    }

    public HomeFragment() {
        // Required empty public constructor
    }

    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        _notificationManager = (NotificationManager) getActivity().getSystemService(Context.NOTIFICATION_SERVICE);

        try {
            detectedOverlayDao = DatabaseHelper.getHelper(getActivity()).getDetectedOverlayDao();
        } catch (SQLException e) {
            Log.e(TAG, "Unable to load detected overlay DAO", e);
        }

        resultReceiver = new CustomResultReceiver(null);
        Intent intent = new Intent(getActivity(), MonitorAccessibilityService.class);
        intent.putExtra("receiver", resultReceiver);
        getActivity().startService(intent);
    }

    @Override
    public void onPause() {
        super.onPause();
        checkStatusTimer.cancel();
    }

    @Override
    public void onResume() {
        super.onResume();

        getStatusTimer().scheduleAtFixedRate(new TimerTask() {
            @Override
            public void run() {
                new ServiceStatusTask(getActivity(), new IServiceStatusProcessor() {
                    @Override
                    public void processResult(boolean running) {
                        View view = getView();
                        if (view != null) {
                            final Button enableProtectionBtn = (Button) view.findViewById(R.id.opEnableProtectionBtn);
                            final TextView checkServiceRunningLbl = (TextView) view.findViewById(R.id.checkServiceRunningLbl);
                            checkServiceRunningLbl.setTextColor(running ? Color.GREEN : Color.RED);
                            checkServiceRunningLbl.setText(running ? "RUNNING" : "NOT RUNNING");
                            if (!running && _notificationManager != null) {
                                _notificationManager.cancel(MonitorAccessibilityService.NOTIFICATION_ID);
                            }
                            enableProtectionBtn.setVisibility(running ? View.GONE : View.VISIBLE);
                        }
                    }
                }).execute();

                View view = getView();
                if (view != null) {
                    final TextView monthCount = (TextView) view.findViewById(R.id.monthlyDetectedCount);
                    final TextView suspectedAppCountTextView = (TextView) view.findViewById(R.id.suspectedAppsCount);
                    QueryBuilder<DetectedOverlay, Integer> qb = detectedOverlayDao.queryBuilder();
                    Calendar cal = Calendar.getInstance();
                    cal.setTime(new Date());
                    cal.add(Calendar.MONTH, -1);
                    try {
                        final long overlayCount = qb.where().between("timestamp", cal.getTimeInMillis(), System.currentTimeMillis()).countOf();
                        final String overlayCountLabel = String.format(getString(R.string.detectedCount), overlayCount);

                        final long suspectedAppsCount = DatabaseHelper.getHelper(getActivity()).getSuspectedAppDao().countOf();
                        final String suspectedAppsCountLabel = String.format(getString(R.string.suspectedAppCount), suspectedAppsCount);

                        new Handler(Looper.getMainLooper()).post(new Runnable() {
                            @Override
                            public void run() {
                                if (monthCount != null)
                                    monthCount.setText(overlayCountLabel);
                                if (suspectedAppCountTextView != null)
                                    suspectedAppCountTextView.setText(suspectedAppsCountLabel);
                            }
                        });
                    } catch (SQLException e) {
                        Log.e(TAG, "Unable to compute amount of detected overlay for the last month", e);
                    }
                }

            }
        }, 0, 2000);
    }

    @Override
    public View onCreateView(final LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
        final View rootView = inflater.inflate(R.layout.fragment_main, container, false);

        final Button enableProtectionBtn = (Button) rootView.findViewById(R.id.opEnableProtectionBtn);
        enableProtectionBtn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                Intent intent = new Intent(getActivity(), ConfigWizardActivity.class);
                getActivity().startActivity(intent);
            }
        });

        TextView e = (TextView) rootView.findViewById(R.id.eventProcessedCount);
        String s = getString(R.string.eventCountLoading);
        e.setText(String.format(s, 0));

        return rootView;
    }

    public Timer getStatusTimer() {
        checkStatusTimer = new Timer();
        return checkStatusTimer;
    }

    @Override
    public void onAttach(Activity activity) {
        super.onAttach(activity);
        ((MainActivity) activity).onSectionAttached(1);
    }

    class CustomResultReceiver extends ResultReceiver {
        public CustomResultReceiver(Handler handler) {
            super(handler);
        }

        @Override
        protected void onReceiveResult(int resultCode, final Bundle resultData) {

            if (resultCode == ServiceCommunication.MSG_EVENT_COUNT_UPDATE) {
                new Handler(Looper.getMainLooper()).post(new Runnable() {
                    @Override
                    public void run() {
                        UpdateEventCount(resultData.getLong("eventCount"));
                    }
                });
            }
        }
    }

    private void UpdateEventCount(long eventCount) {
        View v = getView();
        if (v != null) {
            TextView e = (TextView) v.findViewById(R.id.eventProcessedCount);
            String s = getString(R.string.eventCount);
            e.setText(String.format(s, eventCount));
        }
    }

}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/view/SettingsFragment.java`:

```java
package com.geeksonsecurity.android.overlayprotector.view;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.graphics.PixelFormat;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.support.v4.app.Fragment;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.view.WindowManager;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.CheckBox;
import android.widget.SeekBar;
import android.widget.Spinner;
import android.widget.TextView;
import android.widget.Toast;

import com.geeksonsecurity.android.overlayprotector.MainActivity;
import com.geeksonsecurity.android.overlayprotector.MonitorAccessibilityService;
import com.geeksonsecurity.android.overlayprotector.R;
import com.geeksonsecurity.android.overlayprotector.domain.DetectionEngine;
import com.geeksonsecurity.android.overlayprotector.domain.ServiceCommunication;
import com.geeksonsecurity.android.overlayprotector.domain.Settings;
import com.google.gson.Gson;

public class SettingsFragment extends Fragment {
    Gson gson = new Gson();

    public static SettingsFragment newInstance() {
        return new SettingsFragment();
    }

    public SettingsFragment() {
        // Required empty public constructor
    }

    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setHasOptionsMenu(true);
    }

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
        // Inflate the layout for this fragment
        final View view = inflater.inflate(R.layout.fragment_settings, container, false);

        loadValues(view);

        // Load handlers for buttons

        Button startAccessibilityBtn = (Button) view.findViewById(R.id.overlayStartAccessibiltyBtn);

        startAccessibilityBtn.setOnClickListener(new View.OnClickListener() {
            public void onClick(View v) {
                Intent intent = new Intent(android.provider.Settings.ACTION_ACCESSIBILITY_SETTINGS);
                startActivityForResult(intent, 0);
            }
        });

        Button resetDefault = (Button) view.findViewById(R.id.resetDefaultButton);
        resetDefault.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                Context ctx = getActivity().getApplicationContext();
                SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(ctx);

                String serialized = gson.toJson(new Settings());
                SharedPreferences.Editor editor = prefs.edit();
                editor.putString(Settings.KEY_SETTINGS, serialized);
                editor.apply();
                loadValues(view);
                notifySettingsChanged();
            }
        });

        Button showOverlay = (Button) view.findViewById(R.id.showOverlayButton);
        showOverlay.setOnClickListener(new View.OnClickListener() {
            public void onClick(View v) {
                final WindowManager.LayoutParams params = new WindowManager.LayoutParams(
                        WindowManager.LayoutParams.MATCH_PARENT,
                        WindowManager.LayoutParams.MATCH_PARENT,
                        WindowManager.LayoutParams.TYPE_SYSTEM_ALERT,
                        WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN,
                        PixelFormat.TRANSLUCENT);

                final WindowManager windowManager = (WindowManager) getActivity().getSystemService(Context.WINDOW_SERVICE);

                LayoutInflater li = (LayoutInflater) getActivity().getSystemService(Context.LAYOUT_INFLATER_SERVICE);
                final View oView = li.inflate(R.layout.overlaydetected, null);

                Button ignore = (Button) oView.findViewById(R.id.odIgnoreButton);
                ignore.setOnClickListener(new View.OnClickListener() {
                    @Override
                    public void onClick(View v) {
                        windowManager.removeView(oView);
                    }
                });

                Button uninstall = (Button) oView.findViewById(R.id.odUninstallButton);
                uninstall.setOnClickListener(new View.OnClickListener() {
                    @Override
                    public void onClick(View v) {
                        windowManager.removeView(oView);
                    }
                });

                windowManager.addView(oView, params);
            }
        });

        return view;

    }

    private void loadValues(View view) {
        Context ctx = getActivity().getApplicationContext();
        SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(ctx);
        String json = prefs.getString(Settings.KEY_SETTINGS, "");
        Settings settings = new Settings();

        if (!(json.isEmpty())) {
            settings = gson.fromJson(json, Settings.class);
        }

        CheckBox nonSuspectedAppModeCheckbox = (CheckBox) view.findViewById(R.id.enabledAdvancedProtectionCheckBox);
        nonSuspectedAppModeCheckbox.setChecked(settings.isAdvancedMode());


        SeekBar uninstallSeekBar = (SeekBar) view.findViewById(R.id.uninstallTimeoutSeekBar);
        final TextView uninstallValue = (TextView) view.findViewById(R.id.uninstallValueTextView);
        final String sec = getResources().getString(R.string.od_seconds_label);
        uninstallValue.setText(String.format(sec, settings.getUninstallTimeoutSeconds()));
        uninstallSeekBar.setProgress(settings.getUninstallTimeoutSeconds());
        uninstallSeekBar.setOnSeekBarChangeListener(new SeekBar.OnSeekBarChangeListener() {
            @Override
            public void onProgressChanged(SeekBar seekBar, int progress, boolean fromUser) {
                if (progress < 5) {
                    progress = 5;
                }
                seekBar.setProgress(progress);
                uninstallValue.setText(String.format(sec, progress));

            }

            @Override
            public void onStartTrackingTouch(SeekBar seekBar) {
            }

            @Override
            public void onStopTrackingTouch(SeekBar seekBar) {
            }
        });

        SeekBar ignoreSeekBar = (SeekBar) view.findViewById(R.id.ignoreOnceTimeoutSeekBar);
        final TextView ignoreValue = (TextView) view.findViewById(R.id.ignoreOnceValueTextView);
        ignoreValue.setText(String.format(sec, settings.getIgnoreOnceTimeoutSeconds()));
        ignoreSeekBar.setProgress(settings.getIgnoreOnceTimeoutSeconds());
        ignoreSeekBar.setOnSeekBarChangeListener(new SeekBar.OnSeekBarChangeListener() {
            @Override
            public void onProgressChanged(SeekBar seekBar, int progress, boolean fromUser) {
                if (progress < 5) {
                    progress = 5;
                }
                seekBar.setProgress(progress);
                ignoreValue.setText(String.format(sec, progress));

            }

            @Override
            public void onStartTrackingTouch(SeekBar seekBar) {
            }

            @Override
            public void onStopTrackingTouch(SeekBar seekBar) {
            }
        });

        Spinner detectionEngineSpinner = (Spinner) view.findViewById(R.id.detectionEngineSpinner);
        ArrayAdapter<DetectionEngine> detectionEngineArrayAdapter = new ArrayAdapter<>(getActivity(),
                android.R.layout.simple_list_item_1, DetectionEngine.values());
        detectionEngineSpinner.setAdapter(detectionEngineArrayAdapter);
        detectionEngineSpinner.setSelection(detectionEngineArrayAdapter.getPosition(settings.getDetectionEngine()));
    }

    @Override
    public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
        super.onCreateOptionsMenu(menu, inflater);
        inflater.inflate(R.menu.settings_menu, menu);
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        switch (item.getItemId()) {
            case R.id.op_settings_menu_save:
                save();
                break;
            default:
                break;
        }
        return false;
    }

    @Override
    public void onAttach(Activity activity) {
        super.onAttach(activity);
        ((MainActivity) activity).onSectionAttached(5);
    }

    @Override
    public void onDetach() {
        super.onDetach();
    }

    private void save() {
        View view = getView();
        if (view != null) {
            Settings settings = new Settings();

            CheckBox nonSuppectedAppModeCheckbox = (CheckBox) view.findViewById(R.id.enabledAdvancedProtectionCheckBox);
            settings.setAdvancedMode(nonSuppectedAppModeCheckbox.isChecked());

            SeekBar uninstallSeekbar = (SeekBar) view.findViewById(R.id.uninstallTimeoutSeekBar);
            settings.setUninstallTimeoutSeconds(uninstallSeekbar.getProgress());

            SeekBar ignoreSeekbak = (SeekBar) view.findViewById(R.id.ignoreOnceTimeoutSeekBar);
            settings.setIgnoreOnceTimeoutSeconds(ignoreSeekbak.getProgress());

            Spinner detectionEngineSpinner = (Spinner) view.findViewById(R.id.detectionEngineSpinner);
            DetectionEngine selectedItem = (DetectionEngine) detectionEngineSpinner.getSelectedItem();
            settings.setDetectionEngine(selectedItem);

            Context ctx = getActivity().getApplicationContext();
            SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(ctx);

            String serialized = gson.toJson(settings);
            SharedPreferences.Editor editor = prefs.edit();
            editor.putString(Settings.KEY_SETTINGS, serialized);
            editor.apply();
            Toast.makeText(ctx, "Settings saved!", Toast.LENGTH_SHORT).show();
            notifySettingsChanged();
        }
    }

    private void notifySettingsChanged() {
        Intent intent = new Intent(getActivity(), MonitorAccessibilityService.class);
        intent.setAction(ServiceCommunication.MSG_SETTINGS_UPDATED);
        getActivity().startService(intent);
    }
}
```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/view/SuspectedAppsFragment.java`:

```java
package com.geeksonsecurity.android.overlayprotector.view;

import android.app.Activity;
import android.content.Context;
import android.content.SharedPreferences;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AbsListView;
import android.widget.AdapterView;
import android.widget.ListView;
import android.widget.TextView;

import com.geeksonsecurity.android.overlayprotector.MainActivity;
import com.geeksonsecurity.android.overlayprotector.R;
import com.geeksonsecurity.android.overlayprotector.adapter.SuspectedAppsAdapter;
import com.geeksonsecurity.android.overlayprotector.database.DatabaseHelper;
import com.geeksonsecurity.android.overlayprotector.database.DatabaseUtils;
import com.geeksonsecurity.android.overlayprotector.domain.Settings;
import com.geeksonsecurity.android.overlayprotector.domain.SuspectedApp;
import com.google.gson.Gson;
import com.j256.ormlite.dao.Dao;

import java.sql.SQLException;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;

public class SuspectedAppsFragment extends android.support.v4.app.Fragment implements AbsListView.OnItemClickListener {

    private static final String TAG = SuspectedAppsFragment.class.getSimpleName();
    /**
     * The fragment's ListView/GridView.
     */
    private ListView mListView;
    private TextView _headerTitle;
    private TextView _footerTitle;
    /**
     * The Adapter which will be used to populate the ListView/GridView with
     * Views.
     */
    private SuspectedAppsAdapter mAdapter;
    private Gson gson = new Gson();

    public static SuspectedAppsFragment newInstance() {
        SuspectedAppsFragment fragment = new SuspectedAppsFragment();
        return fragment;
    }

    /**
     * Mandatory empty constructor for the fragment manager to instantiate the
     * fragment (e.g. upon screen orientation changes).
     */
    public SuspectedAppsFragment() {
    }


    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setHasOptionsMenu(true);
        mAdapter = new SuspectedAppsAdapter(getActivity());

        try {
            Context ctx = getActivity().getApplicationContext();
            SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(ctx);
            String json = prefs.getString(Settings.KEY_SETTINGS, "");
            if (!(json != null ? json.isEmpty() : true)) {
                Settings settings = gson.fromJson(json, Settings.class);
                if (settings.getSuspectedAppUpdateTimestamp() > 0) {
                    Dao<SuspectedApp, Integer> suspectedAppDao = DatabaseHelper.getHelper(getActivity()).getSuspectedAppDao();
                    List<SuspectedApp> suspectedApps = suspectedAppDao.queryBuilder().orderBy("appName", true).query();
                    mAdapter.clear();
                    mAdapter.addAll(suspectedApps);

                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }

    }

    @Override
    public void onResume() {
        super.onResume();
        refreshHeaderView(getView());
        refreshList();
    }

    private void refreshList() {
        Dao<SuspectedApp, Integer> suspectedAppDao = null;
        try {
            suspectedAppDao = DatabaseHelper.getHelper(getActivity()).getSuspectedAppDao();
            List<SuspectedApp> suspectedApps = suspectedAppDao.queryBuilder().orderBy("appName", true).query();
            mAdapter.clear();
            mAdapter.addAll(suspectedApps);
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    @Override
    public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
        super.onCreateOptionsMenu(menu, inflater);
        inflater.inflate(R.menu.suspected_apps_menu, menu);
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        switch (item.getItemId()) {
            case R.id.op_sa_menu_refresh:
                DatabaseUtils.fillSuspectedApps(getActivity());
                refreshList();
                break;
            default:
                break;
        }
        return false;
    }

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
        View view = inflater.inflate(R.layout.fragment_suspectedapps, container, false);
        // Set the adapter
        mListView = (ListView) view.findViewById(android.R.id.list);
        mListView.setEmptyView(view.findViewById(android.R.id.empty));
        mListView.setAdapter(mAdapter);

        // Set OnItemClickListener so we can be notified on item clicks
        mListView.setOnItemClickListener(this);

        return view;
    }

    private void refreshHeaderView(View view) {
        if (view == null)
            return;

        Context ctx = getActivity().getApplicationContext();
        SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(ctx);
        String json = prefs.getString(Settings.KEY_SETTINGS, "");
        Settings settings = !json.isEmpty() ? gson.fromJson(json, Settings.class) : new Settings();

        Date date = new Date(settings.getSuspectedAppUpdateTimestamp());
        DateFormat formatter = new SimpleDateFormat("dd.MM.yyyy HH:mm");
        ListView listview = (ListView) view.findViewById(android.R.id.list);

        if (_headerTitle == null) {
            _headerTitle = new TextView(getActivity());
            _headerTitle.setPadding(20, 10, 5, 10);
            listview.addHeaderView(_headerTitle);
        }

        if (_footerTitle == null) {
            _footerTitle = new TextView(getActivity());
            _footerTitle.setPadding(20, 10, 5, 10);
            listview.addFooterView(_footerTitle);
        }
        _footerTitle.setText(R.string.od_suspectedapps_explanation);
        _headerTitle.setText(String.format("Last update: %s", settings.getSuspectedAppUpdateTimestamp() == 0 ? "never" : formatter.format(date)));


    }

    @Override
    public void onStart() {
        super.onStart();
    }

    @Override
    public void onDetach() {
        super.onDetach();
    }

    @Override
    public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
        //if (null != mListener) {
        // Notify the active callbacks interface (the activity, if the
        // fragment is attached to one) that an item has been selected.
        //mListener.onFragmentInteraction(DummyContent.ITEMS.get(position).id);
        //}
    }

    @Override
    public void onAttach(Activity activity) {
        super.onAttach(activity);
        ((MainActivity) activity).onSectionAttached(2);
    }

}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/view/WhiteListFragment.java`:

```java
package com.geeksonsecurity.android.overlayprotector.view;

import android.app.Activity;
import android.app.AlertDialog;
import android.app.Dialog;
import android.content.DialogInterface;
import android.content.Intent;
import android.os.Bundle;
import android.support.v4.app.Fragment;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AbsListView;
import android.widget.AdapterView;
import android.widget.Button;
import android.widget.CheckBox;
import android.widget.EditText;
import android.widget.Toast;

import com.geeksonsecurity.android.overlayprotector.MainActivity;
import com.geeksonsecurity.android.overlayprotector.MonitorAccessibilityService;
import com.geeksonsecurity.android.overlayprotector.R;
import com.geeksonsecurity.android.overlayprotector.adapter.WhiteEntryAdapter;
import com.geeksonsecurity.android.overlayprotector.database.DatabaseHelper;
import com.geeksonsecurity.android.overlayprotector.domain.ServiceCommunication;
import com.geeksonsecurity.android.overlayprotector.domain.WhiteEntry;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

public class WhiteListFragment extends Fragment implements AbsListView.OnItemClickListener {

    private static final String TAG = WhiteListFragment.class.getSimpleName();
    /**
     * The fragment's ListView/GridView.
     */
    private AbsListView mListView;

    /**
     * The Adapter which will be used to populate the ListView/GridView with
     * Views.
     */
    private WhiteEntryAdapter mAdapter;

    public static WhiteListFragment newInstance() {
        WhiteListFragment fragment = new WhiteListFragment();
        return fragment;
    }

    /**
     * Mandatory empty constructor for the fragment manager to instantiate the
     * fragment (e.g. upon screen orientation changes).
     */
    public WhiteListFragment() {
    }


    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setHasOptionsMenu(true);

        refreshWhiteEntries();
    }

    @Override
    public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
        super.onCreateOptionsMenu(menu, inflater);
        inflater.inflate(R.menu.whitelist_menu, menu);
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        switch (item.getItemId()) {
            case R.id.op_wl_menu_refresh:
                refreshWhiteEntries();
                break;
            case R.id.op_wl_menu_add:
                final Dialog addDialog = new Dialog(getActivity());
                addDialog.setContentView(R.layout.add_whitelist_dialog);
                addDialog.setTitle("New white entry");

                Button cancel = (Button) addDialog.findViewById(R.id.cancelButton);
                cancel.setOnClickListener(new View.OnClickListener() {

                    @Override
                    public void onClick(View v) {
                        addDialog.dismiss();
                    }
                });

                Button ok = (Button) addDialog.findViewById(R.id.okButton);
                ok.setOnClickListener(new View.OnClickListener() {
                    @Override
                    public void onClick(View v) {
                        String packageName = ((EditText) addDialog.findViewById(R.id.packageEditText)).getText().toString();
                        boolean exactlyMatch = !((CheckBox) addDialog.findViewById(R.id.wildcardCheckBox)).isChecked();

                        if (packageName.length() > 0) {
                            WhiteEntry we = new WhiteEntry(packageName, System.currentTimeMillis(), 0, false, exactlyMatch);
                            try {
                                DatabaseHelper.getHelper(getActivity()).getWhiteListDao().create(we);
                                mAdapter.add(we);
                                addDialog.dismiss();
                                notifyChangesToService();
                            } catch (SQLException e) {
                                Log.e(TAG, "Failed to add new white entry", e);
                                Toast.makeText(getActivity(), "Failed to add new white entry!", Toast.LENGTH_SHORT);
                            }
                        } else {
                            AlertDialog.Builder builder = new AlertDialog.Builder(getActivity());
                            // Set the dialog title
                            builder.setTitle("Error");
                            builder.setMessage("The package field is empty!");
                            builder.setNegativeButton("Ok", new DialogInterface.OnClickListener() {
                                @Override
                                public void onClick(DialogInterface dialog, int id) {
                                    // Nothing
                                }
                            });
                            builder.create().show();
                        }
                    }
                });
                addDialog.show();
                break;
            default:
                break;
        }
        return false;
    }

    private void notifyChangesToService() {
        Intent intent = new Intent(getActivity(), MonitorAccessibilityService.class);
        intent.setAction(ServiceCommunication.MSG_WHITELIST_UPDATED);
        getActivity().startService(intent);
    }

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
        View view = inflater.inflate(R.layout.fragment_whitelist, container, false);

        // Set the adapter
        mListView = (AbsListView) view.findViewById(android.R.id.list);
        mListView.setEmptyView(view.findViewById(android.R.id.empty));
        mListView.setAdapter(mAdapter);

        // Set OnItemClickListener so we can be notified on item clicks
        mListView.setOnItemClickListener(this);

        return view;
    }

    @Override
    public void onStart() {
        super.onStart();
    }

    @Override
    public void onDetach() {
        super.onDetach();
    }

    @Override
    public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
        //if (null != mListener) {
        // Notify the active callbacks interface (the activity, if the
        // fragment is attached to one) that an item has been selected.
        //mListener.onFragmentInteraction(DummyContent.ITEMS.get(position).id);
        //}
    }

    @Override
    public void onAttach(Activity activity) {
        super.onAttach(activity);
        ((MainActivity) activity).onSectionAttached(4);
    }

    public void refreshWhiteEntries() {
        List<WhiteEntry> listData = new ArrayList<>();
        try {
            listData = DatabaseHelper.getHelper(getActivity()).getWhiteListDao().queryBuilder().where().eq("systemEntry", Boolean.FALSE).query();
        } catch (SQLException e) {
            Log.e(getTag(), "Failed to obtain detected user-whitelist objects", e);
        }

        if (mAdapter == null) {
            mAdapter = new WhiteEntryAdapter(getActivity(), listData);
        } else {
            mAdapter.clear();
            mAdapter.addAll(listData);
        }
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/wizard/ConfigWizardActivity.java`:

```java
package com.geeksonsecurity.android.overlayprotector.wizard;


import android.content.Intent;
import android.os.Bundle;
import android.support.v4.app.Fragment;
import android.support.v4.app.FragmentManager;
import android.support.v4.app.FragmentStatePagerAdapter;
import android.support.v4.view.ViewPager;
import android.support.v7.app.ActionBarActivity;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Button;

import com.geeksonsecurity.android.overlayprotector.R;
import com.tech.freak.wizardpager.model.AbstractWizardModel;
import com.tech.freak.wizardpager.model.ModelCallbacks;
import com.tech.freak.wizardpager.model.Page;
import com.tech.freak.wizardpager.ui.PageFragmentCallbacks;
import com.tech.freak.wizardpager.ui.ReviewFragment;
import com.tech.freak.wizardpager.ui.StepPagerStrip;

import java.util.List;

public class ConfigWizardActivity extends ActionBarActivity implements
        PageFragmentCallbacks, ReviewFragment.Callbacks, ModelCallbacks {

    private ViewPager mPager;
    private MyPagerAdapter mPagerAdapter;

    private boolean mEditingAfterReview;


    private boolean mConsumePageSelectedEvent;

    private Button mNextButton;
    private Button mPrevButton;

    private List<Page> mCurrentPageSequence;
    private StepPagerStrip mStepPagerStrip;

    private AbstractWizardModel mWizardModel;

    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.configwizard);
        mWizardModel = new ConfigWizardModel(this);
        if (savedInstanceState != null) {
            mWizardModel.load(savedInstanceState.getBundle("model"));
        }

        setTitle("Enable Overlay Protection");

        if (savedInstanceState != null) {
            mWizardModel.load(savedInstanceState.getBundle("model"));
        }

        mWizardModel.registerListener(this);
        mPagerAdapter = new MyPagerAdapter(getSupportFragmentManager());
        mPager = (ViewPager) findViewById(R.id.pager);
        mPager.setAdapter(mPagerAdapter);
        mStepPagerStrip = (StepPagerStrip) findViewById(R.id.strip);
        mStepPagerStrip
                .setOnPageSelectedListener(new StepPagerStrip.OnPageSelectedListener() {
                    @Override
                    public void onPageStripSelected(int position) {
                        position = Math.min(mPagerAdapter.getCount() - 1,
                                position);
                        if (mPager.getCurrentItem() != position) {
                            mPager.setCurrentItem(position);
                        }
                    }
                });

        mPager.setOnPageChangeListener(new ViewPager.SimpleOnPageChangeListener() {
            @Override
            public void onPageSelected(int position) {
                mStepPagerStrip.setCurrentPage(position);

                if (mConsumePageSelectedEvent) {
                    mConsumePageSelectedEvent = false;
                    return;
                }

                mEditingAfterReview = false;
                updateBottomBar();
            }
        });

        mNextButton = (Button) findViewById(R.id.next_button);
        mPrevButton = (Button) findViewById(R.id.prev_button);
        mNextButton.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                if (mPager.getCurrentItem() == mCurrentPageSequence.size() - 1) {
                    finish();
                    Intent intent = new Intent(android.provider.Settings.ACTION_ACCESSIBILITY_SETTINGS);
                    startActivityForResult(intent, 0);
                } else {
                    mPager.setCurrentItem(mPager.getCurrentItem() + 1);
                }
            }
        });

        mPrevButton.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                mPager.setCurrentItem(mPager.getCurrentItem() - 1);
            }
        });

        onPageTreeChanged();
        updateBottomBar();
    }

    @Override
    public void onPageTreeChanged() {
        mCurrentPageSequence = mWizardModel.getCurrentPageSequence();
        recalculateCutOffPage();
        mStepPagerStrip.setPageCount(mCurrentPageSequence.size()); // + 1 =
        // review
        // step
        mPagerAdapter.notifyDataSetChanged();
        updateBottomBar();

    }

    private void updateBottomBar() {
        int position = mPager.getCurrentItem();
        if (position == mCurrentPageSequence.size() - 1) {
            mNextButton.setText(R.string.finishWizardBtnLabel);
        } else {
            mNextButton.setText(R.string.opWizardNext);
        }

        mPrevButton
                .setVisibility(position <= 0 ? View.INVISIBLE : View.VISIBLE);
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        mWizardModel.unregisterListener(this);
    }

    @Override
    protected void onSaveInstanceState(Bundle outState) {
        super.onSaveInstanceState(outState);
        outState.putBundle("model", mWizardModel.save());
    }

    @Override
    public AbstractWizardModel onGetModel() {
        return mWizardModel;
    }

    @Override
    public void onEditScreenAfterReview(String key) {
        for (int i = mCurrentPageSequence.size() - 1; i >= 0; i--) {
            if (mCurrentPageSequence.get(i).getKey().equals(key)) {
                mConsumePageSelectedEvent = true;
                mEditingAfterReview = true;
                mPager.setCurrentItem(i);
                updateBottomBar();
                break;
            }
        }
    }

    @Override
    public void onPageDataChanged(Page page) {
        if (page.isRequired()) {
            if (recalculateCutOffPage()) {
                mPagerAdapter.notifyDataSetChanged();
                updateBottomBar();
            }
        }
    }

    @Override
    public Page onGetPage(String key) {
        return mWizardModel.findByKey(key);
    }

    private boolean recalculateCutOffPage() {
        // Cut off the pager adapter at first required page that isn't completed
        int cutOffPage = mCurrentPageSequence.size();
        for (int i = 0; i < mCurrentPageSequence.size(); i++) {
            Page page = mCurrentPageSequence.get(i);
            if (page.isRequired() && !page.isCompleted()) {
                cutOffPage = i;
                break;
            }
        }

        if (mPagerAdapter.getCutOffPage() != cutOffPage) {
            mPagerAdapter.setCutOffPage(cutOffPage);
            return true;
        }

        return false;
    }

    public class MyPagerAdapter extends FragmentStatePagerAdapter {
        private int mCutOffPage;
        private Fragment mPrimaryItem;

        public MyPagerAdapter(FragmentManager fm) {
            super(fm);
        }

        @Override
        public Fragment getItem(int i) {
            if (i >= mCurrentPageSequence.size()) {
                return mCurrentPageSequence.get(mCurrentPageSequence.size() - 1).createFragment();
            }
            return mCurrentPageSequence.get(i).createFragment();
        }

        @Override
        public int getItemPosition(Object object) {
            // TODO: be smarter about this
            if (object == mPrimaryItem) {
                // Re-use the current fragment (its position never changes)
                return POSITION_UNCHANGED;
            }

            return POSITION_NONE;
        }

        @Override
        public void setPrimaryItem(ViewGroup container, int position,
                                   Object object) {
            super.setPrimaryItem(container, position, object);
            mPrimaryItem = (Fragment) object;
        }

        @Override
        public int getCount() {
            return Math.min(mCutOffPage, mCurrentPageSequence == null ? 1
                    : mCurrentPageSequence.size());
        }

        public void setCutOffPage(int cutOffPage) {
            if (cutOffPage < 0) {
                cutOffPage = Integer.MAX_VALUE;
            }
            mCutOffPage = cutOffPage;
        }

        public int getCutOffPage() {
            return mCutOffPage;
        }
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/wizard/ConfigWizardModel.java`:

```java
package com.geeksonsecurity.android.overlayprotector.wizard;

import android.content.Context;

import com.geeksonsecurity.android.overlayprotector.R;
import com.tech.freak.wizardpager.model.AbstractWizardModel;
import com.tech.freak.wizardpager.model.PageList;

public class ConfigWizardModel extends AbstractWizardModel {

    public ConfigWizardModel(Context context) {
        super(context);
    }

    @Override
    protected PageList onNewRootPageList() {
        return new PageList(new WizardInfoPage(this, mContext.getString(R.string.op_wizard_step1_title))
                .setValue(0, mContext.getString(R.string.op_wizard_step1_content)),
                new WizardInfoPage(this, mContext.getString(R.string.op_wizard_step2_title)).setValue(R.drawable.configstep1, mContext.getString(R.string.op_wizard_step2_content)),
                new WizardInfoPage(this, mContext.getString(R.string.op_wizard_step3_title)).setValue(R.drawable.configstep2, mContext.getString(R.string.op_wizard_step3_content)),
                new WizardInfoPage(this, mContext.getString(R.string.op_wizard_step4_title)).setValue(R.drawable.configstep3, mContext.getString(R.string.op_wizard_step4_content)));

    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/wizard/WizardInfoPage.java`:

```java
package com.geeksonsecurity.android.overlayprotector.wizard;

import android.support.v4.app.Fragment;
import android.text.TextUtils;

import com.tech.freak.wizardpager.model.ModelCallbacks;
import com.tech.freak.wizardpager.model.Page;
import com.tech.freak.wizardpager.model.ReviewItem;

import java.util.ArrayList;

public class WizardInfoPage extends Page {

    public WizardInfoPage(ModelCallbacks callbacks, String title) {
        super(callbacks, title);
    }

    @Override
    public Fragment createFragment() {
        return WizardInfoPageFragment.create(getKey());
    }

    @Override
    public void getReviewItems(ArrayList<ReviewItem> dest) {
    }

    @Override
    public boolean isCompleted() {
        return !TextUtils.isEmpty(mData.getString(SIMPLE_DATA_KEY));
    }

    public WizardInfoPage setValue(int imageDrawableId, String descriptionText) {
        mData.putInt(WizardInfoPageFragment.IMAGE_KEY, imageDrawableId);
        mData.putString(WizardInfoPageFragment.DESCRIPTION_KEY, descriptionText);
        return this;
    }
}

```

`app/src/main/java/com/geeksonsecurity/android/overlayprotector/wizard/WizardInfoPageFragment.java`:

```java
package com.geeksonsecurity.android.overlayprotector.wizard;

import android.app.Activity;
import android.net.Uri;
import android.os.Bundle;
import android.support.v4.app.Fragment;
import android.support.v4.content.res.ResourcesCompat;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ImageView;
import android.widget.TextView;

import com.geeksonsecurity.android.overlayprotector.R;
import com.tech.freak.wizardpager.model.Page;
import com.tech.freak.wizardpager.ui.PageFragmentCallbacks;

public class WizardInfoPageFragment extends Fragment {
    public static final String DESCRIPTION_KEY = "descriptionKey";
    public static final String IMAGE_KEY = "imageKey";
    private static final java.lang.String ARG_KEY = "key";

    private PageFragmentCallbacks mCallbacks;
    private String mKey;
    private Page mPage;
    private ImageView imageView;

    private Uri mNewImageUri;

    public static WizardInfoPageFragment create(String key) {
        Bundle args = new Bundle();
        args.putString(ARG_KEY, key);
        WizardInfoPageFragment f = new WizardInfoPageFragment();
        f.setArguments(args);
        return f;
    }

    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        Bundle args = getArguments();
        mKey = args.getString(ARG_KEY);
        mPage = mCallbacks.onGetPage(mKey);
    }

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
        View rootView = inflater.inflate(R.layout.wizard_info_page,
                container, false);

        ((TextView) rootView.findViewById(android.R.id.title)).setText(mPage.getTitle());

        imageView = (ImageView) rootView.findViewById(R.id.imageView);

        String descriptionData = mPage.getData().getString(DESCRIPTION_KEY);
        ((TextView) rootView.findViewById(R.id.wizardDescriptionText)).setText(descriptionData);

        int res = mPage.getData().getInt(IMAGE_KEY);
        if (res > 0) {
            imageView.setImageDrawable(ResourcesCompat.getDrawable(getResources(), res, null));
        } else {
            imageView.setVisibility(View.INVISIBLE);
        }
        return rootView;
    }

    @Override
    public void onAttach(Activity activity) {
        super.onAttach(activity);

        if (!(activity instanceof PageFragmentCallbacks)) {
            throw new ClassCastException(
                    "Activity must implement PageFragmentCallbacks");
        }

        mCallbacks = (PageFragmentCallbacks) activity;
    }

    @Override
    public void onDetach() {
        super.onDetach();
        mCallbacks = null;
    }

}
```

`app/src/main/res/drawable/apptheme_activated_background_holo_dark.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?><!-- Copyright (C) 2008 The Android Open Source Project

     Licensed under the Apache License, Version 2.0 (the "License");
     you may not use this file except in compliance with the License.
     You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

     Unless required by applicable law or agreed to in writing, software
     distributed under the License is distributed on an "AS IS" BASIS,
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     See the License for the specific language governing permissions and
     limitations under the License.
-->

<selector xmlns:android="http://schemas.android.com/apk/res/android">
    <item android:state_activated="true" android:drawable="@drawable/apptheme_list_activated_holo" />
    <item android:drawable="@android:color/transparent" />
</selector>

```

`app/src/main/res/drawable/apptheme_btn_check_holo_dark.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?><!-- Copyright (C) 2011 The Android Open Source Project

     Licensed under the Apache License, Version 2.0 (the "License");
     you may not use this file except in compliance with the License.
     You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

     Unless required by applicable law or agreed to in writing, software
     distributed under the License is distributed on an "AS IS" BASIS,
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     See the License for the specific language governing permissions and
     limitations under the License.
-->

<selector xmlns:android="http://schemas.android.com/apk/res/android">

    <!-- Enabled states -->

    <item android:state_checked="true" android:state_window_focused="false" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_check_on_holo_dark" />
    <item android:state_checked="false" android:state_window_focused="false" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_check_off_holo_dark" />

    <item android:state_checked="true" android:state_pressed="true" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_check_on_pressed_holo_dark" />
    <item android:state_checked="false" android:state_pressed="true" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_check_off_pressed_holo_dark" />

    <item android:state_checked="true" android:state_focused="true" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_check_on_focused_holo_dark" />
    <item android:state_checked="false" android:state_focused="true" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_check_off_focused_holo_dark" />

    <item android:state_checked="false" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_check_off_holo_dark" />
    <item android:state_checked="true" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_check_on_holo_dark" />


    <!-- Disabled states -->

    <item android:state_checked="true" android:state_window_focused="false" android:drawable="@drawable/apptheme_btn_check_on_disabled_holo_dark" />
    <item android:state_checked="false" android:state_window_focused="false" android:drawable="@drawable/apptheme_btn_check_off_disabled_holo_dark" />

    <item android:state_checked="true" android:state_focused="true" android:drawable="@drawable/apptheme_btn_check_on_disabled_focused_holo_dark" />
    <item android:state_checked="false" android:state_focused="true" android:drawable="@drawable/apptheme_btn_check_off_disabled_focused_holo_dark" />

    <item android:state_checked="false" android:drawable="@drawable/apptheme_btn_check_off_disabled_holo_dark" />
    <item android:state_checked="true" android:drawable="@drawable/apptheme_btn_check_on_disabled_holo_dark" />

</selector>

```

`app/src/main/res/drawable/apptheme_btn_default_holo_dark.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?><!-- Copyright (C) 2010 The Android Open Source Project

     Licensed under the Apache License, Version 2.0 (the "License");
     you may not use this file except in compliance with the License.
     You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

     Unless required by applicable law or agreed to in writing, software
     distributed under the License is distributed on an "AS IS" BASIS,
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     See the License for the specific language governing permissions and
     limitations under the License.
-->

<selector xmlns:android="http://schemas.android.com/apk/res/android">
    <item android:state_window_focused="false" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_default_normal_holo_dark" />
    <item android:state_window_focused="false" android:state_enabled="false" android:drawable="@drawable/apptheme_btn_default_disabled_holo_dark" />
    <item android:state_pressed="true" android:drawable="@drawable/apptheme_btn_default_pressed_holo_dark" />
    <item android:state_focused="true" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_default_focused_holo_dark" />
    <item android:state_enabled="true" android:drawable="@drawable/apptheme_btn_default_normal_holo_dark" />
    <item android:state_focused="true" android:drawable="@drawable/apptheme_btn_default_disabled_focused_holo_dark" />
    <item android:drawable="@drawable/apptheme_btn_default_disabled_holo_dark" />
</selector>

```

`app/src/main/res/drawable/apptheme_btn_radio_holo_dark.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?><!-- Copyright (C) 2011 The Android Open Source Project

     Licensed under the Apache License, Version 2.0 (the "License");
     you may not use this file except in compliance with the License.
     You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

     Unless required by applicable law or agreed to in writing, software
     distributed under the License is distributed on an "AS IS" BASIS,
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     See the License for the specific language governing permissions and
     limitations under the License.
-->

<selector xmlns:android="http://schemas.android.com/apk/res/android">
    <item android:state_checked="true" android:state_window_focused="false" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_radio_on_holo_dark" />
    <item android:state_checked="false" android:state_window_focused="false" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_radio_off_holo_dark" />

    <item android:state_checked="true" android:state_pressed="true" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_radio_on_pressed_holo_dark" />
    <item android:state_checked="false" android:state_pressed="true" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_radio_off_pressed_holo_dark" />

    <item android:state_checked="true" android:state_focused="true" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_radio_on_focused_holo_dark" />
    <item android:state_checked="false" android:state_focused="true" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_radio_off_focused_holo_dark" />

    <item android:state_checked="false" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_radio_off_holo_dark" />
    <item android:state_checked="true" android:state_enabled="true" android:drawable="@drawable/apptheme_btn_radio_on_holo_dark" />

    <!-- Disabled states -->

    <item android:state_checked="true" android:state_window_focused="false" android:drawable="@drawable/apptheme_btn_radio_on_disabled_holo_dark" />
    <item android:state_checked="false" android:state_window_focused="false" android:drawable="@drawable/apptheme_btn_radio_off_disabled_holo_dark" />

    <item android:state_checked="true" android:state_focused="true" android:drawable="@drawable/apptheme_btn_radio_on_disabled_focused_holo_dark" />
    <item android:state_checked="false" android:state_focused="true" android:drawable="@drawable/apptheme_btn_radio_off_disabled_focused_holo_dark" />

    <item android:state_checked="false" android:drawable="@drawable/apptheme_btn_radio_off_disabled_holo_dark" />
    <item android:state_checked="true" android:drawable="@drawable/apptheme_btn_radio_on_disabled_holo_dark" />

</selector>

```

`app/src/main/res/drawable/apptheme_edit_text_holo_dark.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?><!-- Copyright (C) 2010 The Android Open Source Project

     Licensed under the Apache License, Version 2.0 (the "License");
     you may not use this file except in compliance with the License.
     You may obtain a copy of the License at
  
          http://www.apache.org/licenses/LICENSE-2.0
  
     Unless required by applicable law or agreed to in writing, software
     distributed under the License is distributed on an "AS IS" BASIS,
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     See the License for the specific language governing permissions and
     limitations under the License.
-->

<selector xmlns:android="http://schemas.android.com/apk/res/android">
    <item android:state_window_focused="false" android:state_enabled="true" android:drawable="@drawable/apptheme_textfield_default_holo_dark" />
    <item android:state_window_focused="false" android:state_enabled="false" android:drawable="@drawable/apptheme_textfield_disabled_holo_dark" />
    <item android:state_enabled="true" android:state_focused="true" android:drawable="@drawable/apptheme_textfield_activated_holo_dark" />
    <item android:state_enabled="true" android:state_activated="true" android:drawable="@drawable/apptheme_textfield_focused_holo_dark" />
    <item android:state_enabled="true" android:drawable="@drawable/apptheme_textfield_default_holo_dark" />
    <item android:state_focused="true" android:drawable="@drawable/apptheme_textfield_disabled_focused_holo_dark" />
    <item android:drawable="@drawable/apptheme_textfield_disabled_holo_dark" />
</selector>
```

`app/src/main/res/drawable/apptheme_fastscroll_thumb_holo.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?><!-- Copyright (C) 2010 The Android Open Source Project

     Licensed under the Apache License, Version 2.0 (the "License");
     you may not use this file except in compliance with the License.
     You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

     Unless required by applicable law or agreed to in writing, software
     distributed under the License is distributed on an "AS IS" BASIS,
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     See the License for the specific language governing permissions and
     limitations under the License.
-->

<selector xmlns:android="http://schemas.android.com/apk/res/android">
    <item android:state_pressed="true" android:drawable="@drawable/apptheme_fastscroll_thumb_pressed_holo" />
    <item android:drawable="@drawable/apptheme_fastscroll_thumb_default_holo" />
</selector>

```

`app/src/main/res/drawable/apptheme_item_background_holo_dark.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?><!-- Copyright (C) 2010 The Android Open Source Project

     Licensed under the Apache License, Version 2.0 (the "License");
     you may not use this file except in compliance with the License.
     You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

     Unless required by applicable law or agreed to in writing, software
     distributed under the License is distributed on an "AS IS" BASIS,
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     See the License for the specific language governing permissions and
     limitations under the License.
-->

<selector xmlns:android="http://schemas.android.com/apk/res/android">

    <!-- Even though these two point to the same resource, have two states so the drawable will invalidate itself when coming out of pressed state. -->
    <item android:state_focused="true" android:state_enabled="false" android:state_pressed="true" android:drawable="@drawable/apptheme_list_selector_disabled_holo_dark" />
    <item android:state_focused="true" android:state_enabled="false" android:drawable="@drawable/apptheme_list_selector_disabled_holo_dark" />
    <item android:state_focused="true" android:state_pressed="true" android:drawable="@drawable/apptheme_list_selector_background_transition_holo_dark" />
    <item android:state_focused="false" android:state_pressed="true" android:drawable="@drawable/apptheme_list_selector_background_transition_holo_dark" />
    <item android:state_focused="true" android:drawable="@drawable/apptheme_list_focused_holo" />
    <item android:drawable="@android:color/transparent" />
</selector>

```

`app/src/main/res/drawable/apptheme_list_selector_background_transition_holo_dark.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?><!-- Copyright (C) 2010 The Android Open Source Project

     Licensed under the Apache License, Version 2.0 (the "License");
     you may not use this file except in compliance with the License.
     You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

     Unless required by applicable law or agreed to in writing, software
     distributed under the License is distributed on an "AS IS" BASIS,
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     See the License for the specific language governing permissions and
     limitations under the License.
-->

<transition xmlns:android="http://schemas.android.com/apk/res/android">
    <item android:drawable="@drawable/apptheme_list_pressed_holo_dark" />
    <item android:drawable="@drawable/apptheme_list_longpressed_holo" />
</transition>

```

`app/src/main/res/drawable/apptheme_list_selector_holo_dark.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?><!-- Copyright (C) 2010 The Android Open Source Project

     Licensed under the Apache License, Version 2.0 (the "License");
     you may not use this file except in compliance with the License.
     You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

     Unless required by applicable law or agreed to in writing, software
     distributed under the License is distributed on an "AS IS" BASIS,
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     See the License for the specific language governing permissions and
     limitations under the License.
-->

<selector xmlns:android="http://schemas.android.com/apk/res/android">

    <item android:state_window_focused="false" android:drawable="@android:color/transparent" />

    <!-- Even though these two point to the same resource, have two states so the drawable will invalidate itself when coming out of pressed state. -->
    <item android:state_focused="true" android:state_enabled="false" android:state_pressed="true" android:drawable="@drawable/apptheme_list_selector_disabled_holo_dark" />
    <item android:state_focused="true" android:state_enabled="false" android:drawable="@drawable/apptheme_list_selector_disabled_holo_dark" />
    <item android:state_focused="true" android:state_pressed="true" android:drawable="@drawable/apptheme_list_selector_background_transition_holo_dark" />
    <item android:state_focused="false" android:state_pressed="true" android:drawable="@drawable/apptheme_list_selector_background_transition_holo_dark" />
    <item android:state_focused="true" android:drawable="@drawable/apptheme_list_focused_holo" />
</selector>

```

`app/src/main/res/drawable/drawer_list_selector.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<selector xmlns:android="http://schemas.android.com/apk/res/android">
    <item android:state_pressed="true" android:drawable="@color/primaryGold" />

    <item android:state_activated="true" android:drawable="@color/secondaryGold" />

    <item android:drawable="@android:color/transparent" />
</selector>
```

`app/src/main/res/drawable/eventborder.xml`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<shape xmlns:android="http://schemas.android.com/apk/res/android"
    android:shape="rectangle">
    <corners android:radius="20dp" />
    <padding
        android:left="10dp"
        android:right="10dp"
        android:top="10dp"
        android:bottom="10dp" />
    <solid android:color="#C32C2C2C" />
    <stroke
        android:color="@color/primaryGold"
        android:width="3px" />
</shape>
```

`app/src/main/res/drawable/overlay_back.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<shape xmlns:android="http://schemas.android.com/apk/res/android">
    <gradient
        android:type="linear"
        android:startColor="#B000"
        android:endColor="#B000"
        android:centerColor="#BCCC"
        android:angle="45" />
</shape>
```

`app/src/main/res/drawable/rectangle.xml`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<shape xmlns:android="http://schemas.android.com/apk/res/android"
    android:shape="rectangle">
    <solid android:color="@color/secondaryGold" />
    <corners
        android:bottomLeftRadius="7dip"
        android:topRightRadius="7dip"
        android:topLeftRadius="7dip"
        android:bottomRightRadius="7dip" />
</shape>
```

`app/src/main/res/layout/activity_main.xml`:

```xml
<!-- A DrawerLayout is intended to be used as the top-level content view using match_parent for both width and height to consume the full space available. -->
<android.support.v4.widget.DrawerLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:id="@+id/drawer_layout"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context=".MainActivity">

    <!-- As the main content view, the view below consumes the entire
         space available using match_parent in both dimensions. -->
    <FrameLayout
        android:id="@+id/container"
        android:layout_width="match_parent"
        android:layout_height="match_parent" />

    <!-- android:layout_gravity="start" tells DrawerLayout to treat
         this as a sliding drawer on the left side for left-to-right
         languages and on the right side for right-to-left languages.
         If you're not building against API 17 or higher, use
         android:layout_gravity="left" instead. -->
    <!-- The drawer is given a fixed width in dp and extends the full height of
         the container. -->
    <fragment
        android:id="@+id/navigation_drawer"
        android:name="com.geeksonsecurity.android.overlayprotector.NavigationDrawerFragment"
        android:layout_width="@dimen/navigation_drawer_width"
        android:layout_height="match_parent"
        android:layout_gravity="start"
        tools:layout="@layout/fragment_navigation_drawer" />

</android.support.v4.widget.DrawerLayout>

```

`app/src/main/res/layout/add_whitelist_dialog.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:padding="10dp">

    <TextView
        android:id="@+id/packageTitleLabel"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="@string/op_enter_package_name" />

    <EditText
        android:id="@+id/packageEditText"
        android:layout_width="fill_parent"
        android:layout_height="wrap_content"
        android:layout_below="@+id/packageTitleLabel"
        android:hint="@string/op_package_hint" />

    <CheckBox
        android:id="@+id/wildcardCheckBox"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_below="@+id/packageEditText"
        android:text="@string/op_include_subpackage_flag" />

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_below="@+id/wildcardCheckBox"
        android:orientation="horizontal">

        <Button
            android:id="@+id/cancelButton"
            android:layout_width="0dip"
            android:layout_height="wrap_content"
            android:layout_weight="0.5"
            android:text="@string/op_cancel" />

        <Button
            android:id="@+id/okButton"
            android:layout_width="0dip"
            android:layout_height="wrap_content"
            android:layout_weight="0.5"
            android:text="@string/op_save" />

    </LinearLayout>


</RelativeLayout>

```

`app/src/main/res/layout/configwizard.xml`:

```xml
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical">

    <com.tech.freak.wizardpager.ui.StepPagerStrip
        android:id="@+id/strip"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginLeft="16dp"
        android:layout_marginRight="16dp"
        android:gravity="left"
        android:paddingBottom="8dp"
        android:paddingLeft="@dimen/list_item_padding_left"
        android:paddingRight="@dimen/list_item_padding_right"
        android:paddingTop="16dp" />

    <android.support.v4.view.ViewPager
        android:id="@+id/pager"
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1" />

    <View
        android:id="@+id/divider"
        android:layout_width="match_parent"
        android:layout_height="1dp"
        android:background="?android:attr/listDivider" />

    <LinearLayout
        style="@style/ButtonBar"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="horizontal">

        <Button
            android:id="@+id/prev_button"
            style="@style/ButtonBarButton"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:text="@string/opWizardPrevious" />

        <View
            android:layout_width="1dp"
            android:layout_height="match_parent"
            android:background="?android:attr/listDivider" />

        <Button
            android:id="@+id/next_button"
            style="@style/ButtonBarButton"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:text="@string/opWizardNext" />
    </LinearLayout>

</LinearLayout>
```

`app/src/main/res/layout/detectedoverlay_item.xml`:

```xml
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:layout_gravity="center_vertical"
    android:gravity="center_vertical"
    android:orientation="horizontal"
    android:padding="5dp">

    <ImageView
        android:id="@+id/iconImageView"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:scaleType="fitCenter"
        android:padding="5dp" />

    <LinearLayout
        android:layout_width="0dip"
        android:layout_height="wrap_content"
        android:orientation="vertical"
        android:layout_weight="0.7">

        <TextView
            android:id="@+id/timestampLabel"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/op_none_placeholder"
            android:textStyle="italic" />

        <TextView
            android:id="@+id/offenderLabel"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:textStyle="bold"
            android:text="@string/op_none_placeholder"
            android:paddingLeft="5dp" />


    </LinearLayout>
</LinearLayout>
```

`app/src/main/res/layout/fragment_detectedoverlay_grid.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context="com.geeksonsecurity.android.overlayprotector.view.DetectedOverlayFragment">

    <GridView
        android:id="@android:id/list"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:numColumns="2"
        android:listSelector="@android:color/transparent" />

    <TextView
        android:id="@android:id/empty"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:gravity="center"
        android:text="@string/op_od_empty" />

</FrameLayout>

```

`app/src/main/res/layout/fragment_detectedoverlay_list.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context="com.geeksonsecurity.android.overlayprotector.view.DetectedOverlayFragment">

    <ListView
        android:id="@android:id/list"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:listSelector="@android:color/transparent" />

    <TextView
        android:id="@android:id/empty"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:gravity="center"
        android:text="@string/op_od_empty" />

</FrameLayout>

```

`app/src/main/res/layout/fragment_main.xml`:

```xml
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:paddingBottom="@dimen/activity_vertical_margin"
    android:paddingLeft="@dimen/activity_horizontal_margin"
    android:paddingRight="@dimen/activity_horizontal_margin"
    android:paddingTop="@dimen/activity_vertical_margin"
    tools:context=".MainActivity$PlaceholderFragment">

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:paddingBottom="10dp"
        android:paddingTop="10dp">

        <TextView
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:paddingRight="10dp"
            android:text="@string/op_protection_status"
            android:textSize="20dp" />

        <TextView
            android:id="@+id/checkServiceRunningLbl"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/op_not_working"
            android:textSize="20dp" />

    </LinearLayout>


    <Button
        android:id="@+id/opEnableProtectionBtn"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:padding="10dp"
        android:text="@string/opEnableProtectionBtnLabel" />

    <LinearLayout
        android:layout_marginTop="15dp"
        android:padding="12dp"
        android:orientation="vertical"
        android:id="@+id/statsContainer"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:background="@drawable/eventborder">

        <TextView
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:paddingTop="5dp"
            android:text="@string/op_statistics"
            android:textStyle="bold"
            android:textSize="18dp" />


        <TextView
            android:id="@+id/monthlyDetectedCount"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/detectedCount"
            android:textSize="18dp"
            android:paddingBottom="10dp"
            android:paddingTop="10dp" />

        <TextView
            android:id="@+id/suspectedAppsCount"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/suspectedAppCount"
            android:textSize="18dp"
            android:paddingBottom="10dp"
            android:paddingTop="10dp" />

        <TextView
            android:id="@+id/eventProcessedCount"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/eventCount"
            android:textSize="18dp"
            android:paddingBottom="10dp"
            android:paddingTop="10dp" />


    </LinearLayout>

</LinearLayout>

```

`app/src/main/res/layout/fragment_navigation_drawer.xml`:

```xml
<ListView xmlns:android="http://schemas.android.com/apk/res/android"
    android:id="@+id/opNavigationDrawerList"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:choiceMode="singleChoice"
    android:divider="@android:color/transparent"
    android:dividerHeight="0dp"
    android:background="#D92C2C2C"
    tools:context=".NavigationDrawerFragment" />

```

`app/src/main/res/layout/fragment_settings.xml`:

```xml
<FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context="com.geeksonsecurity.android.overlayprotector.view.SettingsFragment">

    <ScrollView
        android:layout_width="fill_parent"
        android:layout_height="wrap_content">

        <LinearLayout
            android:layout_width="fill_parent"
            android:layout_height="wrap_content"
            android:orientation="vertical"
            android:padding="5dp">

            <CheckBox
                android:id="@+id/enabledAdvancedProtectionCheckBox"
                android:layout_width="fill_parent"
                android:layout_height="wrap_content"
                android:text="Check every app, not only the suspected one" />

            <TextView
                android:layout_width="fill_parent"
                android:layout_height="wrap_content"
                android:text="This may cause some false positive at the beginning since you need to populate the whitelist with the some legitimate apps" />

            <View
                android:layout_width="fill_parent"
                android:layout_height="wrap_content"
                android:layout_marginBottom="20dp" />


            <TextView
                android:layout_width="fill_parent"
                android:layout_height="wrap_content"
                android:text="Uninstall timeout" />

            <SeekBar
                android:id="@+id/uninstallTimeoutSeekBar"
                android:layout_width="fill_parent"
                android:layout_height="wrap_content"
                android:max="120" />

            <TextView
                android:id="@+id/uninstallValueTextView"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="@string/od_seconds_label"
                android:layout_gravity="center_horizontal"
                android:paddingBottom="10dp" />

            <TextView
                android:layout_width="fill_parent"
                android:layout_height="wrap_content"
                android:text="Ignore Once timeout" />

            <SeekBar
                android:id="@+id/ignoreOnceTimeoutSeekBar"
                android:layout_width="fill_parent"
                android:layout_height="wrap_content"
                android:max="60" />

            <TextView
                android:id="@+id/ignoreOnceValueTextView"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="@string/od_seconds_label"
                android:layout_gravity="center_horizontal" />

            <View
                android:layout_width="fill_parent"
                android:layout_height="wrap_content"
                android:layout_marginBottom="20dp" />

            <Spinner
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:id="@+id/detectionEngineSpinner" />

            <Button
                android:id="@+id/overlayStartAccessibiltyBtn"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:text="@string/op_start_accessibility_page" />

            <Button
                android:id="@+id/showOverlayButton"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:text="@string/op_show_warning_example" />

            <Button
                android:id="@+id/resetDefaultButton"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:text="@string/settings_reset_defaults" />

        </LinearLayout>
    </ScrollView>
</FrameLayout>

```

`app/src/main/res/layout/fragment_suspectedapps_grid.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context="com.geeksonsecurity.android.overlayprotector.view.SuspectedAppsFragment">

    <GridView
        android:id="@android:id/list"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:numColumns="2"
        android:listSelector="@android:color/transparent" />

    <TextView
        android:id="@android:id/empty"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:gravity="center"
        android:text="@string/op_suspectedapps_empty" />

</FrameLayout>

```

`app/src/main/res/layout/fragment_suspectedapps_list.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context="com.geeksonsecurity.android.overlayprotector.view.SuspectedAppsFragment">

    <ListView
        android:id="@android:id/list"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:listSelector="@android:color/transparent" />

    <TextView
        android:id="@android:id/empty"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:gravity="center"
        android:text="@string/op_suspectedapps_empty" />

</FrameLayout>

```

`app/src/main/res/layout/fragment_whitelist_grid.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context="com.geeksonsecurity.android.overlayprotector.view.DetectedOverlayFragment">

    <GridView
        android:id="@android:id/list"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:numColumns="2"
        android:listSelector="@android:color/transparent" />

    <TextView
        android:id="@android:id/empty"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:gravity="center"
        android:text="@string/op_wl_empty" />

</FrameLayout>

```

`app/src/main/res/layout/fragment_whitelist_list.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context="com.geeksonsecurity.android.overlayprotector.view.DetectedOverlayFragment">

    <ListView
        android:id="@android:id/list"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:listSelector="@android:color/transparent" />

    <TextView
        android:id="@android:id/empty"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:gravity="center"
        android:text="@string/op_wl_empty" />

</FrameLayout>

```

`app/src/main/res/layout/logcat_dialog.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:background="@android:color/background_dark"
    android:paddingTop="20dp">

    <ScrollView
        android:layout_width="fill_parent"
        android:layout_height="fill_parent">

        <TextView
            android:id="@+id/logcat"
            android:layout_width="fill_parent"
            android:layout_height="fill_parent"
            android:text="" />
    </ScrollView>

    <LinearLayout
        android:layout_width="fill_parent"
        android:layout_height="wrap_content"
        android:layout_alignParentBottom="true"
        android:gravity="center"
        android:orientation="vertical">

        <Button
            android:id="@+id/close"
            android:layout_width="fill_parent"
            android:layout_height="wrap_content"
            android:text="@string/op_close" />

        <Button
            android:id="@+id/send"
            android:layout_width="fill_parent"
            android:layout_height="wrap_content"
            android:text="@string/op_send_developer" />
    </LinearLayout>

</RelativeLayout>

```

`app/src/main/res/layout/overlaydetected.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="fill_parent"
    android:layout_height="fill_parent"
    android:layout_gravity="center"
    android:background="#D9676767"
    android:gravity="center"
    android:orientation="horizontal">

    <LinearLayout
        android:layout_width="fill_parent"
        android:layout_height="wrap_content"
        android:background="#d9d5b868"
        android:padding="30dp">

        <LinearLayout
            android:layout_width="fill_parent"
            android:layout_height="wrap_content"
            android:layout_gravity="left|center_vertical"
            android:orientation="vertical">

            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:layout_gravity="center_vertical"
                android:gravity="center"
                android:orientation="horizontal"
                android:layout_marginBottom="20dp">

                <ImageView
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:scaleType="fitCenter"
                    android:src="@drawable/ic_launcher_circle" />

                <TextView
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:layout_gravity="center"
                    android:layout_marginLeft="10dp"
                    android:text="@string/op_overlay_detected_title"
                    android:textColor="@android:color/secondary_text_light"
                    android:textSize="30dp"
                    android:textStyle="bold" />
            </LinearLayout>


            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="match_parent"
                android:orientation="vertical"
                android:background="@drawable/rectangle">

                <LinearLayout
                    android:layout_width="match_parent"
                    android:layout_height="match_parent"
                    android:layout_gravity="center_vertical"
                    android:gravity="center"
                    android:orientation="horizontal"
                    android:padding="2dp">

                    <ImageView
                        android:id="@+id/iconImageView"
                        android:layout_width="wrap_content"
                        android:layout_height="wrap_content"
                        android:padding="2dp"
                        android:src="@drawable/ic_question_icon"
                        android:scaleType="fitCenter" />

                    <TextView
                        android:id="@+id/odOffenderNameLabel"
                        android:layout_width="wrap_content"
                        android:layout_height="wrap_content"
                        android:text="@string/op_malware_package_example"
                        android:textColor="@android:color/secondary_text_light"
                        android:textSize="18dp" />

                </LinearLayout>

                <LinearLayout
                    android:layout_width="fill_parent"
                    android:layout_height="wrap_content"
                    android:gravity="center"
                    android:paddingLeft="15dp"
                    android:paddingRight="15dp"
                    android:orientation="horizontal">

                    <Button
                        android:id="@+id/odIgnoreButton"
                        android:layout_weight="1"
                        android:layout_width="0dp"
                        android:layout_height="wrap_content"
                        android:textSize="12dp"
                        android:text="@string/op_warning_ignore" />

                    <Button
                        android:id="@+id/odIgnoreOnce"
                        android:layout_weight="1"
                        android:layout_width="0dp"
                        android:layout_height="wrap_content"
                        android:textSize="12dp"
                        android:paddingLeft="5dp"
                        android:paddingRight="5dp"
                        android:text="@string/op_ignore_once" />

                    <Button
                        android:id="@+id/odUninstallButton"
                        android:layout_weight="1"
                        android:layout_width="0dp"
                        android:layout_height="wrap_content"
                        android:textSize="12dp"
                        android:textStyle="bold"
                        android:text="@string/op_warning_uninstall" />

                </LinearLayout>

                <TextView
                    android:id="@+id/uninstallWarningTextView"
                    android:padding="10dp"
                    android:layout_width="fill_parent"
                    android:layout_height="wrap_content"
                    android:text="@string/op_uninstallWarning"
                    android:textColor="#000000" />
            </LinearLayout>
        </LinearLayout>
    </LinearLayout>
</LinearLayout>
```

`app/src/main/res/layout/suspectedapps_item.xml`:

```xml
<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:layout_gravity="center_vertical"
    android:gravity="center_vertical">

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_alignParentLeft="true"
        android:layout_gravity="center_vertical"
        android:gravity="center_vertical"
        android:orientation="horizontal"
        android:padding="5dp">

        <ImageView
            android:id="@+id/iconImageView"
            android:layout_width="0dip"
            android:layout_height="match_parent"
            android:padding="5dp"
            android:scaleType="fitCenter"
            android:layout_weight="0.15" />

        <LinearLayout
            android:layout_width="0dip"
            android:layout_height="wrap_content"
            android:layout_weight="0.85"
            android:orientation="vertical">

            <TextView
                android:id="@+id/appName"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="@string/op_none_placeholder"
                android:textStyle="bold" />

            <TextView
                android:id="@+id/packageName"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:paddingLeft="5dp"
                android:text="@string/op_none_placeholder"
                android:textStyle="italic" />


        </LinearLayout>

    </LinearLayout>

    <ImageView
        android:id="@+id/uninstallImageView"
        android:layout_width="wrap_content"
        android:layout_height="match_parent"
        android:layout_alignParentRight="true"
        android:layout_centerVertical="true"
        android:scaleType="fitCenter"
        android:src="@drawable/ic_delete" />
</RelativeLayout>
```

`app/src/main/res/layout/whitelist_item.xml`:

```xml
<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:layout_gravity="center_vertical"
    android:gravity="center_vertical">

    <LinearLayout
        android:id="@+id/whitelist_container"
        android:layout_alignParentLeft="true"
        android:layout_width="match_parent"
        android:gravity="center_vertical"
        android:layout_height="wrap_content"
        android:orientation="horizontal"
        android:padding="5dp">

        <ImageView
            android:id="@+id/iconImageView"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:padding="5dp"
            android:scaleType="fitCenter" />

        <LinearLayout
            android:layout_width="0dip"
            android:layout_height="wrap_content"
            android:layout_weight="0.7"
            android:orientation="vertical">

            <TextView
                android:id="@+id/timestampLabel"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="@string/op_none_placeholder"
                android:textStyle="italic" />

            <TextView
                android:id="@+id/nameLabel"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:paddingLeft="5dp"
                android:text="@string/op_none_placeholder"
                android:textStyle="bold" />


        </LinearLayout>
    </LinearLayout>

    <ImageView
        android:id="@+id/deleteImageView"
        android:layout_width="wrap_content"
        android:layout_height="match_parent"
        android:scaleType="fitCenter"
        android:src="@drawable/ic_delete"
        android:layout_alignParentRight="true"
        android:layout_centerVertical="true" />
</RelativeLayout>
```

`app/src/main/res/layout/wizard_info_page.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<ScrollView xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="fill_parent"
    android:layout_height="fill_parent">

    <LinearLayout
        style="@style/WizardPageContainer"
        android:orientation="vertical"
        tools:ignore="UseCompoundDrawables">

        <TextView
            style="@style/CustomWizardPageTitle"
            android:text="@string/op_title" />

        <FrameLayout
            android:id="@+id/frameLayoutImageContainer"
            style="@style/WizardPageImageContainer">

            <ImageView
                android:id="@+id/imageView"
                style="@style/WizardPageImage"
                tools:ignore="ContentDescription" />
        </FrameLayout>

        <TextView
            android:id="@+id/wizardDescriptionText"
            style="@style/CustomWizardPageDescription"
            android:text="@string/op_description" />
    </LinearLayout>
</ScrollView>
```

`app/src/main/res/menu/detected_overlays_menu.xml`:

```xml
<menu xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto">
    <item
        android:id="@+id/op_od_menu_refresh"
        android:icon="@drawable/ic_action_refresh"
        android:title="@string/op_refresh"
        android:visible="true"
        app:showAsAction="always" />

    <item
        android:id="@+id/op_od_menu_clear"
        android:title="@string/op_clear_history"
        android:visible="true"
        app:showAsAction="never" />
</menu>
```

`app/src/main/res/menu/settings_menu.xml`:

```xml
<menu xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto">
    <item
        android:id="@+id/op_settings_menu_save"
        android:icon="@drawable/ic_action_save"
        android:title="@string/op_save"
        android:visible="true"
        app:showAsAction="always" />
</menu>
```

`app/src/main/res/menu/suspected_apps_menu.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<menu xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto">
    <item
        android:id="@+id/op_sa_menu_refresh"
        android:icon="@drawable/ic_action_refresh"
        android:title="@string/op_refresh"
        android:visible="true"
        app:showAsAction="always" />
</menu>
```

`app/src/main/res/menu/whitelist_menu.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<menu xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto">
    <item
        android:id="@+id/op_wl_menu_add"
        android:icon="@drawable/ic_action_new"
        android:title="@string/op_add"
        android:visible="true"
        app:showAsAction="always" />
    <item
        android:id="@+id/op_wl_menu_refresh"
        android:icon="@drawable/ic_action_refresh"
        android:title="@string/op_refresh"
        android:visible="true"
        app:showAsAction="always" />
</menu>
```

`app/src/main/res/values/colors.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <color name="primaryGold">#FFD5B868</color>
    <color name="secondaryGold">#94D5B868</color>

    <color name="step_pager_previous_tab_color">@color/secondaryGold</color>
    <color name="step_pager_selected_tab_color">@color/primaryGold</color>
    <color name="step_pager_selected_last_tab_color">@color/primaryGold</color>
    <color name="step_pager_next_tab_color">@color/secondaryGold</color>
</resources>
```

`app/src/main/res/values/colors_apptheme.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <color name="apptheme_color">#d5b868</color>
</resources>

```

`app/src/main/res/values/dimens.xml`:

```xml
<resources>
    <!-- Default screen margins, per the Android Design guidelines. -->
    <dimen name="activity_horizontal_margin">16dp</dimen>
    <dimen name="activity_vertical_margin">16dp</dimen>

    <!-- Per the design guidelines, navigation drawers should be between 240dp and 320dp:
         https://developer.android.com/design/patterns/navigation-drawer.html -->
    <dimen name="navigation_drawer_width">240dp</dimen>
</resources>

```

`app/src/main/res/values/refs.xml`:

```xml
<resources>

    <!--
    Layout alias to replace the single-pane version of the layout with a
    two-pane version on Large screens.

    For more on layout aliases, see:
    http://developer.android.com/training/multiscreen/screensizes.html#TaskUseAliasFilters
    -->
    <item name="fragment_detectedoverlay" type="layout">@layout/fragment_detectedoverlay_list</item>
    <item name="fragment_whitelist" type="layout">@layout/fragment_whitelist_list</item>

    <!--
    Layout alias to replace the single-pane version of the layout with a
    two-pane version on Large screens.

    For more on layout aliases, see:
    http://developer.android.com/training/multiscreen/screensizes.html#TaskUseAliasFilters
    -->
    <item name="fragment_suspectedapps" type="layout">@layout/fragment_suspectedapps_list</item>

</resources>
```

`app/src/main/res/values/strings.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<resources>

    <string name="app_name">Overlay Protector</string>
    <string name="home_section">Home</string>
    <string name="settings_section">Settings</string>
    <string name="navigation_drawer_open">Open navigation drawer</string>
    <string name="navigation_drawer_close">Close navigation drawer</string>
    <string name="action_example">Example action</string>
    <string name="action_settings">Settings</string>
    <string name="overlay_accessibility_settings_btn">Accessibility Settings</string>

    <!-- TODO: Remove or change this placeholder text -->
    <string name="hello_blank_fragment">Hello blank fragment</string>
    <string name="overlay_start_btn">Start Overlay</string>
    <string name="overlay_stop_btn">Stop Overlay</string>
    <string name="overlay_check_service_running_btn">Check server running</string>
    <string name="opAccessibilityServiceDescription">This service monitors the user interface (UI) in order to detect phishing attacks aimed to steal your credentials or make you perform malicious actions</string>
    <string name="opAccessibilityServiceName">Overlay Protector</string>
    <string name="opConfigInstructionStep1">In the Accessibility page please press the \'OverlayProtector\' service</string>
    <string name="opConfigInstructionStep2">Press the switch on the top-right to enable the service</string>
    <string name="opEnableProtectionBtnLabel">Enable Protection</string>
    <string name="finishWizardBtnLabel">Finish</string>
    <string name="opWizardNext">Next</string>
    <string name="opWizardPrevious">Previous</string>
    <string name="overlay_detected_section">Detected Overlays</string>
    <string name="op_od_empty">Yay! No overlay detected yet!</string>
    <string name="op_wl_empty">No custom whitelist entries yet!</string>
    <string name="whitelist_section">White List</string>
    <string name="settings_reset_defaults">Reset to Default Values</string>
    <string name="detectedCount">%d overlay detected in the last 30 days</string>
    <string name="eventCount">%d UI events processed in the last minute</string>
    <string name="suspected_app_section">Suspected Apps</string>
    <string name="op_refresh">Refresh</string>
    <string name="op_clear_history">Clear History</string>
    <string name="op_save">Save</string>
    <string name="op_add">Add</string>
    <string name="op_enter_package_name">Enter package name</string>
    <string name="op_title">Title</string>
    <string name="op_package_hint">com.ignore.this</string>
    <string name="op_include_subpackage_flag">Include all sub-packages (*)</string>
    <string name="op_cancel">Cancel</string>
    <string name="op_detection_option_title">Detection should be performed on</string>
    <string name="op_protection_status">Protection Status</string>
    <string name="op_not_working">Not working</string>
    <string name="op_none_placeholder">NONE</string>
    <string name="op_description">Description</string>
    <string name="op_close">Close</string>
    <string name="op_send_developer">Send to developer</string>
    <string name="op_overlay_detected_title">Overlay detected</string>
    <string name="op_settings_detection_delay">Detection delay (ms):</string>
    <string name="op_hint_milliseconds">value in milliseconds</string>
    <string name="op_statistics">Statistics</string>
    <string name="op_malware_package_example">com.gos.malware</string>
    <string name="op_settings_open_close_grace_period">Open/Close grace period (ms):</string>
    <string name="op_start_accessibility_page">Start Accessibility Page</string>
    <string name="op_show_warning_example">Show Warning Example</string>
    <string name="op_warning_ignore">Trust app</string>
    <string name="op_ignore_once">Ignore Once</string>
    <string name="op_warning_uninstall">Uninstall</string>
    <string name="op_warning_more_info">More Infos</string>
    <string name="op_legitimate_package_name">overlaying com.legitimate.app</string>
    <string name="op_wizard_step1_content">
        With this wizard you are guided on how to enable the overlay protection on your device, it requires just a couple of small steps!\n
        The application uses an accessibility service to monitor the user interface (UI) changes and detect eventual attacks aimed to steal our data.
    </string>
    <string name="op_wizard_step1_title">Let\'s start</string>
    <string name="op_wizard_step2_title">Locate Overlay Protector</string>
    <string name="op_wizard_step2_content">On the Accessibility page press the Overlay Protector item</string>
    <string name="op_wizard_step3_title">Enable the service</string>
    <string name="op_wizard_step3_content">Toggle the top-right switch to be on the \'On\' position</string>
    <string name="op_wizard_step4_content">
        Press OK to accept the permissions imposed by the service.
        \nThis is the last page, you will be now redirected to the Accessibility settings page where you can performs these steps and enable the protection!</string>

    <string name="op_wizard_step4_title">Accept the permissions</string>
    <string name="eventCountLoading">Waiting for UI event count...</string>
    <string name="op_uninstallWarning"><![CDATA[If, after pressing uninstall, you don\'t see a system dialog it means that the overlay is covering it. If so, we suggest you to uninstall the application via Settings -> Application menu. The overlay protector won\'t bother you with warnings for the next %d seconds.]]></string>
    <string name="od_seconds_label">%d seconds</string>
    <string name="op_suspectedapps_empty">No suspected apps detected!</string>
    <string name="od_suspectedapps_explanation">Suspected apps require SYSTEM_ALERT_WINDOW and GET_TASKS permissions</string>
    <string name="suspectedAppCount">%d suspected apps found</string>
</resources>

```

`app/src/main/res/values/styles.xml`:

```xml
<resources>

    <style name="ButtonBar" parent="@android:style/ButtonBar">
        <item name="android:background">@android:color/transparent</item>
        <item name="android:padding">0dp</item>
    </style>

    <style name="ButtonBarButton">
        <item name="android:minHeight">@dimen/list_item_height_small</item>
    </style>

    <style name="CustomWizardPageDescription">
        <item name="android:layout_width">match_parent</item>
        <item name="android:layout_height">wrap_content</item>
        <item name="android:layout_marginTop">5dp</item>
        <item name="android:paddingLeft">@dimen/list_item_padding_left</item>
        <item name="android:textSize">16sp</item>
        <item name="android:textColor">@color/secondaryGold</item>
    </style>

    <style name="CustomWizardPageTitle">
        <item name="android:id">@android:id/title</item>
        <item name="android:layout_width">match_parent</item>
        <item name="android:layout_height">wrap_content</item>
        <item name="android:layout_marginBottom">8dp</item>
        <item name="android:paddingLeft">@dimen/list_item_padding_left</item>
        <item name="android:textSize">36sp</item>
        <item name="android:textColor">@color/primaryGold</item>
    </style>

</resources>

```

`app/src/main/res/values/styles_apptheme.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>

<!-- Generated with http://android-holo-colors.com -->
<resources xmlns:android="http://schemas.android.com/apk/res/android">

    <style name="EditTextAppTheme" parent="android:Widget.EditText">
        <item name="android:background">@drawable/apptheme_edit_text_holo_dark</item>
        <item name="android:textColor">#ffffff</item>
    </style>

    <style name="CheckBoxAppTheme" parent="android:Widget.CompoundButton.CheckBox">
        <item name="android:button">@drawable/apptheme_btn_check_holo_dark</item>
    </style>

    <style name="RadioButtonAppTheme" parent="android:Widget.CompoundButton.RadioButton">
        <item name="android:button">@drawable/apptheme_btn_radio_holo_dark</item>
    </style>

    <style name="ButtonAppTheme" parent="android:Widget.Button">
        <item name="android:background">@drawable/apptheme_btn_default_holo_dark</item>
        <item name="android:minHeight">48dip</item>
        <item name="android:minWidth">64dip</item>
        <item name="android:textColor">#ffffff</item>
    </style>

    <style name="ImageButtonAppTheme" parent="android:Widget.ImageButton">
        <item name="android:background">@drawable/apptheme_btn_default_holo_dark</item>
    </style>

    <style name="ListViewAppTheme" parent="android:Widget.ListView">
        <item name="android:listSelector">@drawable/apptheme_list_selector_holo_dark</item>
    </style>

    <style name="ListViewAppTheme.White" parent="android:Widget.ListView.White">
        <item name="android:listSelector">@drawable/apptheme_list_selector_holo_dark</item>
    </style>

    <style name="SpinnerItemAppTheme" parent="android:TextAppearance.Widget.TextView.SpinnerItem">
        <item name="android:textColor">#ffffff</item>
    </style>

</resources>
```

`app/src/main/res/values/themes_apptheme.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>

<!-- Generated with http://android-holo-colors.com -->
<resources xmlns:android="http://schemas.android.com/apk/res/android">

    <style name="AppTheme" parent="Theme.AppCompat">

        <item name="android:activatedBackgroundIndicator">@drawable/drawer_list_selector</item>

        <item name="android:editTextStyle">@style/EditTextAppTheme</item>

        <item name="android:checkboxStyle">@style/CheckBoxAppTheme</item>

        <item name="android:radioButtonStyle">@style/RadioButtonAppTheme</item>

        <item name="android:buttonStyle">@style/ButtonAppTheme</item>

        <item name="android:imageButtonStyle">@style/ImageButtonAppTheme</item>

        <item name="android:listViewStyle">@style/ListViewAppTheme</item>

        <item name="android:listViewWhiteStyle">@style/ListViewAppTheme.White</item>

        <item name="android:spinnerItemStyle">@style/SpinnerItemAppTheme</item>

    </style>

</resources>
```

`app/src/main/res/xml/accessibilityservice.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<accessibility-service xmlns:android="http://schemas.android.com/apk/res/android"
    android:name="@string/opAccessibilityServiceName"
    android:accessibilityEventTypes="typeViewClicked|typeWindowStateChanged|typeWindowContentChanged"
    android:accessibilityFeedbackType="feedbackGeneric"
    android:accessibilityFlags="flagIncludeNotImportantViews|flagRetrieveInteractiveWindows"
    android:canRetrieveWindowContent="true"
    android:description="@string/opAccessibilityServiceDescription" />
```

`build.gradle`:

```gradle
// Top-level build file where you can add configuration options common to all sub-projects/modules.

buildscript {
    repositories {
        jcenter()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:2.2.0'

        // NOTE: Do not place your application dependencies here; they belong
        // in the individual module build.gradle files
    }
}

allprojects {
    repositories {
        jcenter();
        maven {
            url "https://jitpack.io"
        }
    }
}

```

`gradle.properties`:

```properties
# Project-wide Gradle settings.
# IDE (e.g. Android Studio) users:
# Gradle settings configured through the IDE *will override*
# any settings specified in this file.
# For more details on how to configure your build environment visit
# http://www.gradle.org/docs/current/userguide/build_environment.html
# Specifies the JVM arguments used for the daemon process.
# The setting is particularly useful for tweaking memory settings.
# Default value: -Xmx10248m -XX:MaxPermSize=256m
# org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
# When configured, Gradle will run in incubating parallel mode.
# This option should only be used with decoupled projects. More details, visit
# http://www.gradle.org/docs/current/userguide/multi_project_builds.html#sec:decoupled_projects
# org.gradle.parallel=true
```

`gradle/wrapper/gradle-wrapper.properties`:

```properties
#Sat Oct 22 18:59:05 CEST 2016
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-2.14.1-all.zip

```

`gradlew`:

```
#!/usr/bin/env bash

##############################################################################
##
##  Gradle start up script for UN*X
##
##############################################################################

# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
DEFAULT_JVM_OPTS=""

APP_NAME="Gradle"
APP_BASE_NAME=`basename "$0"`

# Use the maximum available, or set MAX_FD != -1 to use that value.
MAX_FD="maximum"

warn ( ) {
    echo "$*"
}

die ( ) {
    echo
    echo "$*"
    echo
    exit 1
}

# OS specific support (must be 'true' or 'false').
cygwin=false
msys=false
darwin=false
case "`uname`" in
  CYGWIN* )
    cygwin=true
    ;;
  Darwin* )
    darwin=true
    ;;
  MINGW* )
    msys=true
    ;;
esac

# For Cygwin, ensure paths are in UNIX format before anything is touched.
if $cygwin ; then
    [ -n "$JAVA_HOME" ] && JAVA_HOME=`cygpath --unix "$JAVA_HOME"`
fi

# Attempt to set APP_HOME
# Resolve links: $0 may be a link
PRG="$0"
# Need this for relative symlinks.
while [ -h "$PRG" ] ; do
    ls=`ls -ld "$PRG"`
    link=`expr "$ls" : '.*-> \(.*\)$'`
    if expr "$link" : '/.*' > /dev/null; then
        PRG="$link"
    else
        PRG=`dirname "$PRG"`"/$link"
    fi
done
SAVED="`pwd`"
cd "`dirname \"$PRG\"`/" >&-
APP_HOME="`pwd -P`"
cd "$SAVED" >&-

CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar

# Determine the Java command to use to start the JVM.
if [ -n "$JAVA_HOME" ] ; then
    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
        # IBM's JDK on AIX uses strange locations for the executables
        JAVACMD="$JAVA_HOME/jre/sh/java"
    else
        JAVACMD="$JAVA_HOME/bin/java"
    fi
    if [ ! -x "$JAVACMD" ] ; then
        die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
    fi
else
    JAVACMD="java"
    which java >/dev/null 2>&1 || die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
fi

# Increase the maximum file descriptors if we can.
if [ "$cygwin" = "false" -a "$darwin" = "false" ] ; then
    MAX_FD_LIMIT=`ulimit -H -n`
    if [ $? -eq 0 ] ; then
        if [ "$MAX_FD" = "maximum" -o "$MAX_FD" = "max" ] ; then
            MAX_FD="$MAX_FD_LIMIT"
        fi
        ulimit -n $MAX_FD
        if [ $? -ne 0 ] ; then
            warn "Could not set maximum file descriptor limit: $MAX_FD"
        fi
    else
        warn "Could not query maximum file descriptor limit: $MAX_FD_LIMIT"
    fi
fi

# For Darwin, add options to specify how the application appears in the dock
if $darwin; then
    GRADLE_OPTS="$GRADLE_OPTS \"-Xdock:name=$APP_NAME\" \"-Xdock:icon=$APP_HOME/media/gradle.icns\""
fi

# For Cygwin, switch paths to Windows format before running java
if $cygwin ; then
    APP_HOME=`cygpath --path --mixed "$APP_HOME"`
    CLASSPATH=`cygpath --path --mixed "$CLASSPATH"`

    # We build the pattern for arguments to be converted via cygpath
    ROOTDIRSRAW=`find -L / -maxdepth 1 -mindepth 1 -type d 2>/dev/null`
    SEP=""
    for dir in $ROOTDIRSRAW ; do
        ROOTDIRS="$ROOTDIRS$SEP$dir"
        SEP="|"
    done
    OURCYGPATTERN="(^($ROOTDIRS))"
    # Add a user-defined pattern to the cygpath arguments
    if [ "$GRADLE_CYGPATTERN" != "" ] ; then
        OURCYGPATTERN="$OURCYGPATTERN|($GRADLE_CYGPATTERN)"
    fi
    # Now convert the arguments - kludge to limit ourselves to /bin/sh
    i=0
    for arg in "$@" ; do
        CHECK=`echo "$arg"|egrep -c "$OURCYGPATTERN" -`
        CHECK2=`echo "$arg"|egrep -c "^-"`                                 ### Determine if an option

        if [ $CHECK -ne 0 ] && [ $CHECK2 -eq 0 ] ; then                    ### Added a condition
            eval `echo args$i`=`cygpath --path --ignore --mixed "$arg"`
        else
            eval `echo args$i`="\"$arg\""
        fi
        i=$((i+1))
    done
    case $i in
        (0) set -- ;;
        (1) set -- "$args0" ;;
        (2) set -- "$args0" "$args1" ;;
        (3) set -- "$args0" "$args1" "$args2" ;;
        (4) set -- "$args0" "$args1" "$args2" "$args3" ;;
        (5) set -- "$args0" "$args1" "$args2" "$args3" "$args4" ;;
        (6) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" ;;
        (7) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" ;;
        (8) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" "$args7" ;;
        (9) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" "$args7" "$args8" ;;
    esac
fi

# Split up the JVM_OPTS And GRADLE_OPTS values into an array, following the shell quoting and substitution rules
function splitJvmOpts() {
    JVM_OPTS=("$@")
}
eval splitJvmOpts $DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS
JVM_OPTS[${#JVM_OPTS[*]}]="-Dorg.gradle.appname=$APP_BASE_NAME"

exec "$JAVACMD" "${JVM_OPTS[@]}" -classpath "$CLASSPATH" org.gradle.wrapper.GradleWrapperMain "$@"

```

`gradlew.bat`:

```bat
@if "%DEBUG%" == "" @echo off
@rem ##########################################################################
@rem
@rem  Gradle startup script for Windows
@rem
@rem ##########################################################################

@rem Set local scope for the variables with windows NT shell
if "%OS%"=="Windows_NT" setlocal

@rem Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
set DEFAULT_JVM_OPTS=

set DIRNAME=%~dp0
if "%DIRNAME%" == "" set DIRNAME=.
set APP_BASE_NAME=%~n0
set APP_HOME=%DIRNAME%

@rem Find java.exe
if defined JAVA_HOME goto findJavaFromJavaHome

set JAVA_EXE=java.exe
%JAVA_EXE% -version >NUL 2>&1
if "%ERRORLEVEL%" == "0" goto init

echo.
echo ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
echo.
echo Please set the JAVA_HOME variable in your environment to match the
echo location of your Java installation.

goto fail

:findJavaFromJavaHome
set JAVA_HOME=%JAVA_HOME:"=%
set JAVA_EXE=%JAVA_HOME%/bin/java.exe

if exist "%JAVA_EXE%" goto init

echo.
echo ERROR: JAVA_HOME is set to an invalid directory: %JAVA_HOME%
echo.
echo Please set the JAVA_HOME variable in your environment to match the
echo location of your Java installation.

goto fail

:init
@rem Get command-line arguments, handling Windowz variants

if not "%OS%" == "Windows_NT" goto win9xME_args
if "%@eval[2+2]" == "4" goto 4NT_args

:win9xME_args
@rem Slurp the command line arguments.
set CMD_LINE_ARGS=
set _SKIP=2

:win9xME_args_slurp
if "x%~1" == "x" goto execute

set CMD_LINE_ARGS=%*
goto execute

:4NT_args
@rem Get arguments from the 4NT Shell from JP Software
set CMD_LINE_ARGS=%$

:execute
@rem Setup the command line

set CLASSPATH=%APP_HOME%\gradle\wrapper\gradle-wrapper.jar

@rem Execute Gradle
"%JAVA_EXE%" %DEFAULT_JVM_OPTS% %JAVA_OPTS% %GRADLE_OPTS% "-Dorg.gradle.appname=%APP_BASE_NAME%" -classpath "%CLASSPATH%" org.gradle.wrapper.GradleWrapperMain %CMD_LINE_ARGS%

:end
@rem End local scope for the variables with windows NT shell
if "%ERRORLEVEL%"=="0" goto mainEnd

:fail
rem Set variable GRADLE_EXIT_CONSOLE if you need the _script_ return code instead of
rem the _cmd.exe /c_ return code!
if  not "" == "%GRADLE_EXIT_CONSOLE%" exit 1
exit /b 1

:mainEnd
if "%OS%"=="Windows_NT" endlocal

:omega

```

`settings.gradle`:

```gradle
include ':app'

```