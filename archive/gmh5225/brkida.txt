Project Path: arc_gmh5225_brkida_gs50ygvz

Source Tree:

```txt
arc_gmh5225_brkida_gs50ygvz
├── LICENSE
├── README.md
├── include
│   └── brkida.hpp
└── src
    └── main.cpp

```

`LICENSE`:

```
MIT License

Copyright (c) 2024 Android1337

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

```

`README.md`:

```md
# brkida | C++ macro for x64 programs that breaks ida hex-rays decompiler tool.

## Description
This repository provides a one-header project that can easily prevent IDA decompiler tool to decompile the functions of any program by throwing a decompilation failure.\
Users can easily protect their functions using the `BRKIDA` macro provided in the header.\
The repository includes an example demonstrating the usage of `BRKIDA`.\
Currently only supports MSVC and x64.

## Key Aspects
 - The stub is generated at compile-time by using a random ptr formed by 4 random bytes, each based on an hash that's based on the date, time and a counter which increases every time a function is protected.
 - Supports C++14 and higher versions.

## What it actually does
This project exploits the fact that IDA decompiler fails when it encounters a stack access on a pointer that's too big.\
ASM:
```asm
jmp useless ; jump 8 byte after to skip the next instruction (E8 08)
mov [rsp + BIGINT_HERE], rcx ; this will never be executed or we would crash too (48 89 8C 24 DE AD BE EF)
useless:
ret ; C3
```

## How it shows
![IDA Decompilation Failure](https://i.imgur.com/ctg9Zxv.png)\

## Repository Structure
- **`include/`**: Contains the `brkida.hpp` header file.
- **`src/`**: Holds the example `main.cpp` file showcasing the usage of `BRKIDA`.
- **`LICENSE`**: Licensing information for the provided code.
- **`README.md`**: Documentation explaining how to use everything.

## Usage Example
The repository includes an example demonstrating the usage of the `BRKIDA` macro:

### `main.cpp`
```cpp
#include <stdio.h>
#include "brkida.hpp"

int main() {
    BRKIDA; // define this at the start of every function you want to break

    printf("Hello!\n");

    return 0;
}
```

```

`include/brkida.hpp`:

```hpp
/*
 * MIT License https://github.com/Android1337/brkida/blob/main/LICENSE
 *
 * Copyright (c) 2024 Android1337
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

#ifndef BRKIDA_HPP
#define BRKIDA_HPP

#if _MSC_VER && _WIN64 == 1 // only implemented for MSVC and x64 for now
#include <intrin.h> // __AddressOfReturnAddress

// very simple compile-time hash algorithm for binary randomness
unsigned constexpr long long const_hash(const char* input) {
    return *input ? static_cast<unsigned long long>(*input) + 33 * const_hash(input + 1) : 5381;
}

/*
* stub proc
* jmp useless ; E8 08
* mov [rsp + BIGINT_HERE], rcx; this will never be executed (48 89 8C 24 DE AD BE EF)
* useless:
* ret ; C3
* stub endp
*/

#define BRKIDA \
{ \
    constexpr unsigned __int8 stub[] = { \
        0xEB, 0x08, /* jmp 0x8 */ \
        0x48, 0x89, 0x8C, 0x24, /* mov [rsp + ????????], rcx */ \
        unsigned __int8((const_hash(__DATE__ __TIME__) + __COUNTER__ * __COUNTER__) % 0xFF /* mod of max uint8_t */), \
        unsigned __int8((const_hash(__DATE__ __TIME__) + __COUNTER__ * __COUNTER__) % 0xFF /* mod of max uint8_t */), \
        unsigned __int8((const_hash(__DATE__ __TIME__) + __COUNTER__ * __COUNTER__) % 0xFF /* mod of max uint8_t */), \
        unsigned __int8((const_hash(__DATE__ __TIME__) + __COUNTER__ * __COUNTER__) % 0xFF /* mod of max uint8_t */), \
        0xC3 /* ret */ \
    }; \
    \
	/* we don't want to execute the stub because we don't even change the protection to executable so it would crash */ \
    if (!_AddressOfReturnAddress()) { \
        ((void(*)())uintptr_t(stub))(); \
        ((void(*)())uintptr_t(0x0))(); /* a call to 0x0 sometimes breaks ida decompiler too */ \
	} \
}
#else
#define BRKIDA
#error("BRKIDA is currently only supported on MSVC x64")
#endif

#endif // include guard

```

`src/main.cpp`:

```cpp
#include <stdio.h>
#include "brkida.hpp"

int main() {
    BRKIDA; // define this at the start of every function you want to break

    printf("Hello!\n");

    return 0;
}

```