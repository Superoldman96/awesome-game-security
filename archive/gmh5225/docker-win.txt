Project Path: arc_gmh5225_docker-win_h0t6lrua

Source Tree:

```txt
arc_gmh5225_docker-win_h0t6lrua
├── Dockerfile
├── README.md
├── docker-compose.yml
├── img
│   └── .gitkeep
├── iso
│   └── .gitkeep
└── tools
    └── .gitkeep

```

`Dockerfile`:

```
FROM ubuntu:latest

# Install dependencies
RUN apt-get update && apt-get install -y  \
   binutils-mingw-w64     binutils-mingw-w64-i686     binutils-mingw-w64-x86-64     build-essential     clang     g++-mingw-w64     g++-mingw-w64-i686     g++-mingw-w64-x86-64     gcc-mingw-w64     gcc-mingw-w64-i686     gcc-mingw-w64-x86-64     git     git-email     gnutls-bin     libaio-dev     libbluetooth-dev     libbrlapi-dev     libbz2-dev     libcacard-dev     libcap-dev     libcap-ng-dev     libcurl4-gnutls-dev     libibverbs-dev     libiscsi-dev     libfdt-dev     libglib2.0-dev     libgtk-3-dev     libjpeg8-dev     liblzo2-dev     libncurses5-dev     libncursesw5-dev     libnfs-dev     libnuma-dev     libpam0g-dev     libpixman-1-dev     librbd-dev     librdmacm-dev     libsasl2-dev     libsdl1.2-dev     libsdl2-dev     libsdl2-image-dev     libseccomp-dev     libsnappy-dev     libssh2-1-dev     libusb-1.0-0-dev     libusb-dev     libvde-dev     libvdeplug-dev     libvirglrenderer-dev     libvte-2.91-dev     libxen-dev     libxml2-dev     libz-mingw-w64-dev     libzstd-dev     ninja-build     valgrind     win-iconv-mingw-w64-dev     xfslibs-dev     zlib1g-dev libspice-protocol-dev libspice-server-dev libusbredirparser-dev libusbredirparser1

RUN git clone https://gitlab.com/qemu-project/qemu.git -b v7.0.0 --depth 1 --recursive
RUN git clone https://github.com/zhaodice/qemu-anti-detection.git
RUN cd qemu && git apply ../qemu-anti-detection/qemu7.0.0.patch && cd .. && \
    mkdir qemu_build && cd qemu_build && \
    ../qemu/configure --target-list=x86_64-softmmu,x86_64-linux-user --prefix=/usr && \
    make -j$(nproc) && make install

ENTRYPOINT ["/bin/bash"]
```

`README.md`:

```md
# Usage
1. install docker https://docs.docker.com/engine/install/ubuntu/ or https://docs.docker.com/docker-for-windows/install/
   or Ubuntu2204 on windows app store and install docker on wsl2
2. git clone this repo
3. download windows iso into `/iso` folder
4. create image into `/img` folder
   ```shell
   > cd img
   > qemu-img create -f vhdx -o size=20G win7.vhdx
   ```
   [qemu-img for windows](https://cloudbase.it/qemu-img-windows/)
5. replace `win7.vhdx` in `docker-compose.yml` with your image name
   ```
   "-drive", "file=/img/win7.vhdx", 
   ```
   replace `cn_windows_7_ultimate_with_sp1_x64_dvd_u_677408.iso` in `docker-compose.yml` with your iso name
   ```
    "-cdrom", "/iso/cn_windows_7_ultimate_with_sp1_x64_dvd_u_677408.iso",
   ```
   if you want to boot from cdrom,  you need to uncomment `"-boot","d"` in `docker-compose.yml`

6. run docker-compose(need to run in wsl2)
   ```shell
    > wsl
    > docker-compose up (on first run, it will take a long time to build the image, network should be well connected)
   ```

if you want to connect to the vm from vncviewer, you need to uncomment `"-vnc", ":0"` 
and expose port 5900 by uncomment `5900:5900` and run `docker-compose up` again, use vncviewer to connect to the vm with `localhost:5900`

# TODO
- [ ] support samba

# Reference
https://github.com/zhaodice/qemu-anti-detection.git
```

`docker-compose.yml`:

```yml
version: "3.8"
services:
  qemu:
    container_name: qemu
    build: .
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
      - ./iso:/iso
      - ./img:/img
    # ports:
    #   - 5900:5900
    environment:
      - DISPLAY=$DISPLAY
    devices:
      - /dev/kvm
    entrypoint: ["/usr/bin/qemu-system-x86_64",
     "-enable-kvm", 
     "-m", "4G", 
     "-smp", "4", 
     "-drive", "file=/img/win7.vhdx", 
     "-machine", "usb=on", 
     "-device", "usb-tablet", 
      "-cpu", "host,vmware-cpuid-freq=false,enforce=false,host-phys-bits=true,hypervisor=off",
      "-cdrom", "/iso/cn_windows_7_ultimate_with_sp1_x64_dvd_u_677408.iso",
      # "-boot","d"
      # "-vnc", ":0", 
     ]
```