Project Path: arc_gmh5225_Hyara_3kbkg6_k

Source Tree:

```txt
arc_gmh5225_Hyara_3kbkg6_k
â”œâ”€â”€ Hyara_Cutter.py
â”œâ”€â”€ Hyara_Ghidra.py
â”œâ”€â”€ Hyara_IDA.py
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ __init__.py
â”œâ”€â”€ hyara_lib
â”‚   â”œâ”€â”€ integration
â”‚   â”‚   â”œâ”€â”€ bn_hyara
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ binaryninja_api.py
â”‚   â”‚   â”‚   â””â”€â”€ plugin.json
â”‚   â”‚   â”œâ”€â”€ cutter_api.py
â”‚   â”‚   â”œâ”€â”€ ghidra_api.py
â”‚   â”‚   â””â”€â”€ ida_api.py
â”‚   â”œâ”€â”€ plugins
â”‚   â”‚   â”œâ”€â”€ yara_checker.py
â”‚   â”‚   â”œâ”€â”€ yara_detector.py
â”‚   â”‚   â””â”€â”€ yara_icon.py
â”‚   â””â”€â”€ ui
â”‚       â””â”€â”€ settings.py
â”œâ”€â”€ images
â”‚   â”œâ”€â”€ Hyara.gif
â”‚   â”œâ”€â”€ Hyara_0.gif
â”‚   â”œâ”€â”€ Hyara_1.png
â”‚   â”œâ”€â”€ Hyara_2.png
â”‚   â”œâ”€â”€ Hyara_3.png
â”‚   â”œâ”€â”€ Hyara_4.png
â”‚   â”œâ”€â”€ Hyara_5.png
â”‚   â”œâ”€â”€ Hyara_6.png
â”‚   â”œâ”€â”€ Hyara_7.png
â”‚   â”œâ”€â”€ cutter_0.png
â”‚   â”œâ”€â”€ cutter_01.png
â”‚   â”œâ”€â”€ cutter_1.png
â”‚   â”œâ”€â”€ cutter__0.png
â”‚   â”œâ”€â”€ cutter_install__1.png
â”‚   â”œâ”€â”€ ghidra_0.png
â”‚   â””â”€â”€ wildcard_0.png
â””â”€â”€ requirements.txt

```

`Hyara_Cutter.py`:

```py
from .hyara_lib.integration.cutter_api import HyaraCutter
import PySide2.QtWidgets as QtWidgets
import cutter


class HyaraWidget(cutter.CutterDockWidget):
    def __init__(self, parent):
        super(HyaraWidget, self).__init__(parent)
        self.main = parent
        self.setObjectName("Hyara")
        self.setWindowTitle("Hyara")

        self.HyaraCutter = HyaraCutter()
        content = QtWidgets.QWidget()
        self.setWidget(content)
        content.setLayout(self.HyaraCutter.layout)


class HyaraPlugin(cutter.CutterPlugin):
    name = "Hyara Plugin"
    description = "Hyara"
    version = "2.3"
    author = "Hyun Yi @hyuunnn"
    hyaraWidget = None

    def setupPlugin(self):
        pass

    def setStartAddress(self):
        offset = int(self.startAddrAction.data())
        if offset:
            self.hyaraWidget.HyaraCutter._start_address.setText(hex(offset))
            self.hyaraWidget.HyaraCutter._variable_name.setText(f"str_{hex(offset)}")

    def setEndAddress(self):
        offset = int(self.endAddrAction.data())
        if offset:
            self.hyaraWidget.HyaraCutter._end_address.setText(hex(offset))

    def setupActions(self):
        self.startAddrAction = QtWidgets.QAction("Hyara - Select Start Address")
        self.endAddrAction = QtWidgets.QAction("Hyara - Select End Address")

        # Disassembly menu actions
        menu = self.hyaraWidget.main.getContextMenuExtensions(
            cutter.MainWindow.ContextMenuType.Disassembly
        )
        menu.addSeparator()
        menu.addAction(self.startAddrAction)
        menu.addAction(self.endAddrAction)
        self.startAddrAction.triggered.connect(self.setStartAddress)
        self.endAddrAction.triggered.connect(self.setEndAddress)

    def setupInterface(self, main):
        self.hyaraWidget = HyaraWidget(main)
        self.setupActions()
        main.addPluginDockWidget(self.hyaraWidget)

    def terminate(self):
        pass

```

`Hyara_Ghidra.py`:

```py
from hyara_lib.integration.ghidra_api import HyaraGhidra
import sys
try:
    import PySide2.QtWidgets as QtWidgets
except:
    import PySide6.QtWidgets as QtWidgets

class HyaraWidget(QtWidgets.QWidget):
    def __init__(self):
        QtWidgets.QWidget.__init__(self)

        self.HyaraGhidra = HyaraGhidra()
        self.setLayout(self.HyaraGhidra.layout)

def run():
    if not QtWidgets.QApplication.instance():
        app = QtWidgets.QApplication(sys.argv)
    else:
        app = QtWidgets.QApplication.instance()

    window = HyaraWidget()
    window.show()
    app.exec_()
```

`Hyara_IDA.py`:

```py
from hyara_lib.integration.ida_api import HyaraIDA
import ida_kernwin
import idaapi


class Hyara_action_handler_t(idaapi.action_handler_t):
    def __init__(self, widget):
        idaapi.action_handler_t.__init__(self)
        self.widget = widget

    def activate(self, ctx):
        self.widget.setText(hex(idaapi.get_screen_ea()))
        return 1

    def update(self, ctx):
        return idaapi.AST_ENABLE_ALWAYS


class Hooks(ida_kernwin.UI_Hooks):
    def __init__(self):
        ida_kernwin.UI_Hooks.__init__(self)

    def finish_populating_widget_popup(self, widget, popup):
        ida_kernwin.attach_action_to_popup(widget, popup, "Hyara:select_start_address", None)
        ida_kernwin.attach_action_to_popup(widget, popup, "Hyara:select_end_address", None)


class HyaraWidget(ida_kernwin.PluginForm):
    def OnCreate(self, form):
        self.parent = self.FormToPyQtWidget(form)
        self.HyaraIDA = HyaraIDA()
        self.parent.setLayout(self.HyaraIDA.layout)

        idaapi.register_action(
            ida_kernwin.action_desc_t(
                "Hyara:select_start_address",
                "Hyara - Select Start Address",
                Hyara_action_handler_t(self.HyaraIDA._start_address),
                "Ctrl+Shift+S",
                "Hyara - Select Start Address",
            )
        ),

        idaapi.register_action(
            ida_kernwin.action_desc_t(
                "Hyara:select_end_address",
                "Hyara - Select End Address",
                Hyara_action_handler_t(self.HyaraIDA._end_address),
                "Ctrl+Shift+E",
                "Hyara - Select End Address",
            )
        ),

    def OnClose(self, form):
        idaapi.unregister_action("Hyara:select_start_address")
        idaapi.unregister_action("Hyara:select_end_address")
        hooks.unhook()


class HyaraPlugin(idaapi.plugin_t):
    # https://www.hex-rays.com/products/ida/support/sdkdoc/group___p_l_u_g_i_n__.html
    flags = idaapi.PLUGIN_UNL
    comment = "Hyara"
    help = "help"
    wanted_name = "Hyara"
    wanted_hotkey = "Ctrl+Shift+Y"

    def init(self):
        global hooks
        idaapi.msg("[*] Hyara Plugin\n")
        hooks = Hooks()
        hooks.hook()
        return idaapi.PLUGIN_OK

    def run(self, arg):
        plg = HyaraWidget()
        plg.Show("Hyara")

        try:
            widget_a = ida_kernwin.find_widget("IDA View-A")
            widget_Hyara = ida_kernwin.find_widget("Hyara")
            if widget_Hyara and widget_a:
                ida_kernwin.set_dock_pos("Hyara", "IDA View-A", ida_kernwin.DP_RIGHT)
        except:
            print("find_widget option is available version 7.0 or later")

    def term(self):
        pass


def PLUGIN_ENTRY():
    return HyaraPlugin()

```

`LICENSE`:

```
MIT License

Copyright (c) 2021 Hyun Yi

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

```

`README.md`:

```md
# Hyara

![Version](https://img.shields.io/badge/version-2.3-blue.svg?cacheSeconds=2592000)

![](https://github.com/hyuunnn/Hyara/blob/master/images/Hyara.gif?raw=true)

> Hyara is plugin that provides convenience when writing yararule.
> 
> The plugin is currently undergoing a major revision!

- [Demo video](https://youtu.be/zgL4BkQJZ-w)

- [IDA Plugin Contest 2018](https://hex-rays.com/contests_details/contest2018/#Hyara)

## Instructions

### Start Screen and Options

- When you run Hyara, it docks itself to the right and docks the output window to the left.
- After specifying the address, press the `Make` button to show the specified hexadecimal or strings as a result.
- The results are saved in the table below when you click `Save`.
- If you double-click the table, you can clear the rule.
- You can modify the values to wildcards by right clicking after dragging.

![](https://github.com/hyuunnn/Hyara/blob/master/images/wildcard_0.png?raw=true)

- `Export Yara Rule`
  - Exports the previously created yara rules.

![](https://github.com/hyuunnn/Hyara/blob/master/images/Hyara_1.png?raw=true)


- `Right Click`
  - You can select either start address or end address. (IDA Pro, Cutter)

![](https://github.com/hyuunnn/Hyara/blob/master/images/Hyara_7.png?raw=true)
  
- `Comment Option`
  - Annotates the instructions next to the condition rule(s).
- `Rich Header` and `imphash`
  - Adds rich header and imphash matching to the rule.
- `String option`
  - This option extracts strings within the range specified.

![](https://github.com/hyuunnn/Hyara/blob/master/images/Hyara_3.png?raw=true)
![](https://github.com/hyuunnn/Hyara/blob/master/images/cutter_1.png?raw=true)

## Installation

### IDA Pro & BinaryNinja

- IDA Pro
  ```bash
  pip install -r requirements.txt
  ```
  - copy ``Hyara_IDA.py and hyara_lib folder`` to $ida_dir/plugins
  - Activate via Edit -> Plugins -> Hyara (or CTRL+SHIFT+Y)

- BinaryNinja
  - Just use the plugin manager!
  - Activate via View -> Other Docks -> Show Hyara

### Cutter

- Windows

Check the python version installed in the cutter and install it.

![](https://github.com/hyuunnn/Hyara/blob/master/images/cutter_0.png?raw=true)

```bash
C:\\Users\\User\\AppData\\Local\\Programs\\Python\\Python3X\\python.exe -m pip install -I -t $cutter_dir/python3X/site-packages -r requirements.txt
```

copy ``__init__.py, Hyara_Cutter.py and hyara_lib folder`` to $cutter_dir/plugins/python/Hyara

- Linux

![](https://github.com/hyuunnn/Hyara/blob/master/images/cutter_install__1.png?raw=true)

```bash
cp -r /tmp/.mount_Cutter5o3a5G/usr /root
```

Check the python version installed in the cutter and install it.

![](https://github.com/hyuunnn/Hyara/blob/master/images/cutter_01.png?raw=true)

```bash
pip3.X install -I -t /root/usr/lib/python3.X/site-packages -r /root/Hyara/requirements.txt
./Cutter-v2.0.3-x64.Linux.AppImage --pythonhome /root/usr
```

copy ``__init__.py, Hyara_Cutter.py and hyara_lib folder`` to /root/.local/share/rizin/cutter/plugins/python/Hyara

Activate via Windows -> Plugins -> Hyara

![](https://github.com/hyuunnn/Hyara/blob/master/images/cutter__0.png?raw=true)

### Ghidra (WIP)

Install <a href="https://github.com/mandiant/Ghidrathon">Ghidrathon</a> (<a href="https://youtu.be/Aatbqf6lcjU">Installation Guide</a>) to use Hyara Plugin.

```bash
pip install PySide2 or pip install PySide6
```

- Windows

copy ``Hyara_Ghidra.py and hyara_lib folder`` to ``C:\\Users\\User\\.ghidra\\.ghidra.X.X.X\\Extensions\\Ghidrathon-X.X.X\\data\\python\\``

```python
# Window -> Ghidrathon
import Hyara_Ghidra
Hyara_Ghidra.run()
```

![](https://github.com/hyuunnn/Hyara/blob/master/images/ghidra_0.png?raw=true)


## Features

- GUI-based
- Supports IDA, BinaryNinja, Cutter and Ghidra.
- YaraChecker
  - Tests the yararule on the fly.
  - ![](https://github.com/hyuunnn/Hyara/blob/master/images/Hyara_4.png?raw=true)
- YaraDetector
  - Shows which part is detected in the sample loaded to disassembler, and when "Address" is clicked, it moves to the corresponding address on the disassembler view.
  - ![](https://github.com/hyuunnn/Hyara/blob/master/images/Hyara_5.png?raw=true)
- YaraIcon
  - Creates yara rules for icon resources embedded in the PE.
  - ![](https://github.com/hyuunnn/Hyara/blob/master/images/Hyara_6.png?raw=true)

## Author

ðŸ‘¤ **hyuunnn**

* Github: [@hyuunnn](https://github.com/hyuunnn)

### Special Thanks

* Twitter: <a href="https://twitter.com/kjkwak12">kjkwak12</a>
* Github: <a href="https://github.com/gaasedelen">gaasedelen</a> - <a href="https://github.com/hyuunnn/Hyara/blob/master/hyara_lib/integration/bn_hyara/binaryninja_api.py#L9">Link</a>
* Github: <a href="https://github.com/ITAYC0HEN">ITAYC0HEN</a> - <a href="https://github.com/hyuunnn/Hyara/pull/14">Link</a>
* Github: <a href="https://github.com/psifertex">psifertex</a> - <a href="https://github.com/hyuunnn/Hyara/pull/18">Link</a>

```

`__init__.py`:

```py
try:
    from . import Hyara_Cutter
    cutter_found = True
except ImportError:
    cutter_found = False

if cutter_found:
    def create_cutter_plugin():
        return Hyara_Cutter.HyaraPlugin()
```

`hyara_lib/integration/bn_hyara/__init__.py`:

```py
from .binaryninja_api import HyaraBinaryNinja

from binaryninjaui import DockHandler, DockContextHandler, UIActionHandler
import PySide6.QtWidgets as QtWidgets
from PySide6.QtCore import Qt


class HyaraDockWidget(QtWidgets.QWidget, DockContextHandler):
    def __init__(self, parent, name, data):
        QtWidgets.QWidget.__init__(self, parent)
        DockContextHandler.__init__(self, self, name)

        self.actionHandler = UIActionHandler()
        self.actionHandler.setupActionHandler(self)

        self.HyaraBinaryNinja = HyaraBinaryNinja()
        self.setLayout(self.HyaraBinaryNinja.layout)

    def shouldBeVisible(self, view_frame):
        if view_frame is None:
            return False
        else:
            return True

    def notifyViewChanged(self, view_frame):
        pass

    @staticmethod
    def create_widget(name, parent, data=None):
        return HyaraDockWidget(parent, name, data)


dock_handler = DockHandler.getActiveDockHandler()
dock_handler.addDockWidget(
    "Hyara",
    HyaraDockWidget.create_widget,
    Qt.BottomDockWidgetArea,
    Qt.Horizontal,
    False,
)

```

`hyara_lib/integration/bn_hyara/binaryninja_api.py`:

```py
from ...ui.settings import HyaraGUI
import pefile
import binascii

from binaryninjaui import DockHandler
from binaryninja.transform import Transform


# https://github.com/gaasedelen/lighthouse/blob/master/plugins/lighthouse/util/disassembler/binja_api.py#L181
def binja_get_bv_from_dock():
    dh = DockHandler.getActiveDockHandler()
    if not dh:
        return None
    vf = dh.getViewFrame()
    if not vf:
        return None
    vi = vf.getCurrentViewInterface()
    bv = vi.getData()
    return bv


class HyaraBinaryNinja(HyaraGUI):
    def __init__(self):
        super(HyaraBinaryNinja, self).__init__()

    @property
    def bv(self):
        return binja_get_bv_from_dock()

    def get_disasm(self, start_address, end_address) -> list:
        result = []
        bv = self.bv
        while start_address < end_address:
            disas_text, length = next(bv.disassembly_text(start_address))
            result.append(disas_text)
            start_address += length
        return result

    def get_hex(self, start_address, end_address) -> str:
        return binascii.hexlify(self.bv.read(start_address, end_address - start_address)).decode()

    def get_comment_hex(self, start_address, end_address) -> list:
        result = []
        bv = self.bv
        while start_address < end_address:
            disas_text, length = next(bv.disassembly_text(start_address))
            end = start_address + length
            result.append(self.get_hex(start_address, end))
            start_address = end
        return result

    def get_string(self, start_address, end_address) -> list:
        return [i.value for i in self.bv.get_strings(start_address, end_address - start_address)]

    def get_filepath(self) -> str:
        return self.bv.file.original_filename

    def get_md5(self) -> str:
        bv = self.bv
        return Transform["RawHex"].encode(
            Transform["MD5"].encode(bv.file.raw.read(0, len(bv.file.raw)))
        ).decode()

    def get_imphash(self) -> str:
        return pefile.PE(self.get_filepath()).get_imphash()

    def get_rich_header(self) -> str:
        rich_header = pefile.PE(self.get_filepath()).parse_rich_header()
        return Transform["RawHex"].encode(Transform["MD5"].encode(rich_header["clear_data"])).decode()

    def get_pdb_path(self) -> str:
        # https://github.com/VirusTotal/yara/blob/master/docs/modules/pe.rst
        pe = pefile.PE(self.get_filepath())
        rva = pe.OPTIONAL_HEADER.DATA_DIRECTORY[6].VirtualAddress
        size = pe.OPTIONAL_HEADER.DATA_DIRECTORY[6].Size
        return (
            pe.parse_debug_directory(rva, size)[0]
            .entry.PdbFileName.split(b"\x00", 1)[0]
            .decode()
            .replace("\\", "\\\\")
        )

    def jump_to(self, addr):
        bv = self.bv
        bv.navigate(bv.view, addr)

```

`hyara_lib/integration/bn_hyara/plugin.json`:

```json
{
    "pluginmetadataversion": 2,
    "name": "Hyara",
    "type": [
        "ui"
    ],
    "api": [
        "python2",
        "python3"
    ],
    "description": "YARA rule making tool for Binary Ninja, Cutter, and IDA",
    "license": {
        "name": "MIT",
        "text": "Copyright (c) 2018 Hyun Yi\n\nPermission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE."
    },
    "platforms": [
        "Darwin",
        "Linux",
        "Windows"
    ],
    "installinstructions": {
        "Darwin": "",
        "Linux": "",
        "Windows": ""
    },
    "dependencies": {
    },
    "version": "2.3",
    "author": "Hyun Yi",
    "minimumbinaryninjaversion": 3469
}

```

`hyara_lib/integration/cutter_api.py`:

```py
from ..ui.settings import HyaraGUI
import cutter
import hashlib
import pefile
import base64


class HyaraCutter(HyaraGUI):
    def __init__(self):
        super(HyaraCutter, self).__init__()

    def get_disasm(self, start_address, end_address) -> list:
        length = end_address - start_address
        return cutter.cmd(f"pI {length} @ {start_address}").split("\n")

    def get_hex(self, start_address, end_address) -> str:
        length = end_address - start_address
        return cutter.cmd(f"p8 {length} @ {start_address}").strip()

    def get_comment_hex(self, start_address, end_address) -> list:
        result = []
        data = cutter.cmdj("pdj") # sometimes does not work.
        for i in data:
            if i["offset"] >= start_address and i["offset"] < end_address:
                result.append(i["bytes"])
        return result

    def get_string(self, start_address, end_address) -> list:
        result = []
        data = cutter.cmdj("Cslj")  # get single line strings : C*.@addr
        for i in data:
            if i["offset"] >= start_address and i["offset"] < end_address:
                result.append(base64.b64decode(i["name"]).decode())
        return result

    def get_filepath(self) -> str:
        return cutter.cmdj("ij")['core']['file']

    def get_md5(self) -> str:
        return cutter.cmdj("itj").get("md5", None)

    def get_imphash(self) -> str:
        return pefile.PE(self.get_filepath()).get_imphash()

    def get_rich_header(self) -> str:
        rich_header = pefile.PE(self.get_filepath()).parse_rich_header()
        return hashlib.md5(rich_header["clear_data"]).hexdigest()

    def get_pdb_path(self) -> str:
        # https://github.com/VirusTotal/yara/blob/master/docs/modules/pe.rst
        pe = pefile.PE(self.get_filepath())
        rva = pe.OPTIONAL_HEADER.DATA_DIRECTORY[6].VirtualAddress
        size = pe.OPTIONAL_HEADER.DATA_DIRECTORY[6].Size
        return (
            pe.parse_debug_directory(rva, size)[0]
            .entry.PdbFileName.split(b"\x00", 1)[0]
            .decode()
            .replace("\\", "\\\\")
        )

    def jump_to(self, addr):
        return cutter.cmd(f"s {addr}")

```

`hyara_lib/integration/ghidra_api.py`:

```py
from ..ui.settings import HyaraGUI
import binascii
import hashlib
import pefile
import java.io

from ghidra.program.util import DefinedDataIterator
from ghidra.util import MD5Utilities

class HyaraGhidra(HyaraGUI):
    def __init__(self):
        super(HyaraGhidra, self).__init__()

    def get_disasm(self, start_address, end_address) -> list:
        result = []
        current_address = toAddr(start_address)
        while int(current_address.toString(), 16) < end_address:
            data = getInstructionAt(current_address)
            result.append(data.toString())
            current_address = data.getNext().getMinAddress()
        return result

    # https://www.mandiant.com/resources/blog/ghidrathon-snaking-ghidra-python-3-scripting
    def get_hex(self, start_address, end_address) -> str:
        min_addr = toAddr(start_address)
        max_addr = toAddr(end_address)
        code = bytes(map(lambda b: b & 0xff, getBytes(min_addr, max_addr.subtract(min_addr))))
        return binascii.hexlify(code).decode()

    def get_comment_hex(self, start_address, end_address) -> list:
        result = []
        current_address = toAddr(start_address)
        while int(current_address.toString(), 16) < end_address:
            end = getInstructionAt(current_address).getNext().getMinAddress()
            result.append(
                self.get_hex(
                    int(current_address.toString(), 16), 
                    int(end.toString(), 16)
                )
            )
            current_address = end
        return result

    # https://gist.github.com/nstarke/ea83d6e8aba9a8b028a94cc14f5ff00d
    def get_string(self, start_address, end_address) -> list:
        result = []
        for i in DefinedDataIterator.definedStrings(getState().getCurrentProgram()):
            addr = int(i.getMinAddress().toString(), 16)

            if addr >= start_address and addr < end_address:
                result.append(i.getValue())

        return result

    def get_filepath(self) -> str:
        filepath = getState().getCurrentProgram().getExecutablePath()
        return filepath[1:]

    def get_md5(self) -> str:
        return MD5Utilities.getMD5Hash(java.io.File(self.get_filepath()))

    def get_imphash(self) -> str:
        return pefile.PE(self.get_filepath()).get_imphash()

    def get_rich_header(self) -> str:
        rich_header = pefile.PE(self.get_filepath()).parse_rich_header()
        # TODO: using MD5Utilities.hexDump(byte[] data)
        return hashlib.md5(rich_header["clear_data"]).hexdigest()

    def get_pdb_path(self) -> str:
        # https://github.com/VirusTotal/yara/blob/master/docs/modules/pe.rst
        pe = pefile.PE(self.get_filepath())
        rva = pe.OPTIONAL_HEADER.DATA_DIRECTORY[6].VirtualAddress
        size = pe.OPTIONAL_HEADER.DATA_DIRECTORY[6].Size
        return (
            pe.parse_debug_directory(rva, size)[0]
            .entry.PdbFileName.split(b"\x00", 1)[0]
            .decode()
            .replace("\\", "\\\\")
        )

    def jump_to(self, addr):
        goTo(toAddr(addr))
```

`hyara_lib/integration/ida_api.py`:

```py
from ..ui.settings import HyaraGUI

import ida_ida
import ida_bytes
import ida_nalt
import idautils
import idc
import binascii
import pefile
import hashlib


class HyaraIDA(HyaraGUI):
    def __init__(self):
        super(HyaraIDA, self).__init__()

    def get_disasm(self, start_address, end_address) -> list:
        result = []
        current_start = start_address
        while current_start < end_address:
            # https://github.com/idapython/src/blob/master/python/idautils.py#L202
            result.append(idc.GetDisasm(current_start))
            current_start = ida_bytes.next_head(current_start, ida_ida.cvar.inf.max_ea)
        return result

    def get_hex(self, start_address, end_address) -> str:
        length = end_address - start_address
        return binascii.hexlify(ida_bytes.get_bytes(start_address, length)).decode()

    def get_comment_hex(self, start_address, end_address) -> list:
        result = []
        current_start = start_address
        while current_start < end_address:
            # https://github.com/idapython/src/blob/master/python/idautils.py#L202
            next_start = ida_bytes.next_head(current_start, ida_ida.cvar.inf.max_ea)
            result.append(self.get_hex(current_start, next_start))
            current_start = next_start
        return result

    def get_string(self, start_address, end_address) -> list:
        result = []
        current_start = start_address
        while current_start < end_address:
            if ida_nalt.get_str_type(current_start) < 4294967295:
                result.append(
                    ida_bytes.get_strlit_contents(
                        current_start, -1, ida_nalt.get_str_type(current_start)
                    ).decode()
                )
            # https://github.com/idapython/src/blob/master/python/idautils.py#L202
            current_start = ida_bytes.next_head(current_start, ida_ida.cvar.inf.max_ea)
        return result

    def get_filepath(self) -> str:
        return ida_nalt.get_input_file_path()

    def get_md5(self) -> str:
        return idautils.GetInputFileMD5().hex()

    def get_imphash(self) -> str:
        return pefile.PE(self.get_filepath()).get_imphash()

    def get_rich_header(self) -> str:
        rich_header = pefile.PE(self.get_filepath()).parse_rich_header()
        return hashlib.md5(rich_header["clear_data"]).hexdigest()

    def get_pdb_path(self) -> str:
        # https://github.com/VirusTotal/yara/blob/master/docs/modules/pe.rst
        pe = pefile.PE(self.get_filepath())
        rva = pe.OPTIONAL_HEADER.DATA_DIRECTORY[6].VirtualAddress
        size = pe.OPTIONAL_HEADER.DATA_DIRECTORY[6].Size
        return (
            pe.parse_debug_directory(rva, size)[0]
            .entry.PdbFileName.split(b"\x00", 1)[0]
            .decode()
            .replace("\\", "\\\\")
        )

    def jump_to(self, addr):
        idc.jumpto(addr)

```

`hyara_lib/plugins/yara_checker.py`:

```py
from sys import modules

if "idaapi" in modules:
    # We are running inside IDA
    from PyQt5 import QtWidgets
else:
    # We are running inside Cutter, Binary Ninja or Ghidra
    try:
        import PySide2.QtWidgets as QtWidgets
    except:
        import PySide6.QtWidgets as QtWidgets

import os.path
import yara


class YaraChecker(QtWidgets.QDialog):
    def __init__(self, rule_text):
        super(YaraChecker, self).__init__()
        self.setObjectName("YaraChecker")
        self.setWindowTitle("YaraChecker")
        self.rule_text = rule_text

    def _ui_init(self):
        self._ui_setting()
        self._ui_init_layout()
        self._ui_clicked_connect()
        self._ui_init_table()
        self.exec_()

    def _ui_setting(self):
        self._folder_path = QtWidgets.QLineEdit()
        self._path_button = QtWidgets.QPushButton("Path")
        self._rule_plaintext = QtWidgets.QPlainTextEdit()
        self._rule_plaintext.setStyleSheet("QPlainTextEdit{font-family:'Consolas';}")
        self._rule_plaintext.insertPlainText(self.rule_text)
        self._search_button = QtWidgets.QPushButton("Search")
        self._detect_count = QtWidgets.QLabel("0")

    def _ui_init_layout(self):
        self.layout = QtWidgets.QVBoxLayout()
        GL1 = QtWidgets.QGridLayout()
        GL1.addWidget(QtWidgets.QLabel("Folder Path : "), 0, 0)
        GL1.addWidget(self._folder_path, 0, 1)
        GL1.addWidget(self._path_button, 0, 2)
        GL1.addWidget(QtWidgets.QLabel("Detect Count : "), 0, 3)
        GL1.addWidget(self._detect_count, 0, 4)
        self.layout.addLayout(GL1)

        self.layout.addWidget(QtWidgets.QLabel("Yara rule"))
        self.layout.addWidget(self._rule_plaintext)
        self.layout.addWidget(self._search_button)
        self.setLayout(self.layout)

    def _ui_clicked_connect(self):
        self._search_button.clicked.connect(self._search)
        self._path_button.clicked.connect(self._select_path)

    def _ui_init_table(self):
        self._table = QtWidgets.QTableWidget()
        self._table.setRowCount(0)
        self._table.setColumnCount(5)
        self._table.setHorizontalHeaderLabels(
            ["Path", "Filename", "Address", "Variable Name", "String"]
        )
        self.layout.addWidget(self._table)

    def _search(self):
        result = {}
        rule = yara.compile(source=self._rule_plaintext.toPlainText())
        for filename in os.listdir(self._folder_path.text()):
            try:
                with open(os.path.join(self._folder_path.text(), filename), "rb") as f:
                    matches = rule.match(data=f.read())
                    for match in matches:
                        strings = match.strings[0]
                        result[filename] = {
                            "path": self._folder_path.text(),
                            "addr": hex(strings[0]),
                            "rule_name": strings[1],
                            "value": strings[2].hex(),
                        }
            except IOError:  # Permission denied
                continue

        self._table.setRowCount(len(result))
        self._detect_count.setText(str(len(result)))

        for idx, (filename, value) in enumerate(result.items()):
            self._table.setItem(idx, 0, QtWidgets.QTableWidgetItem(value["path"]))
            self._table.setItem(idx, 1, QtWidgets.QTableWidgetItem(filename))
            self._table.setItem(idx, 2, QtWidgets.QTableWidgetItem(value["addr"]))
            self._table.setItem(idx, 3, QtWidgets.QTableWidgetItem(value["rule_name"]))
            self._table.setItem(idx, 4, QtWidgets.QTableWidgetItem(value["value"]))
        self.layout.addWidget(self._table)

    def _select_path(self):
        path = QtWidgets.QFileDialog.getExistingDirectory(
            self,
            "Open a folder",
            os.path.expanduser("~"),
            QtWidgets.QFileDialog.ShowDirsOnly,
        )

        if path:
            self._folder_path.setText(path)

```

`hyara_lib/plugins/yara_detector.py`:

```py
from sys import modules

if "idaapi" in modules:
    # We are running inside IDA
    from PyQt5 import QtWidgets
else:
    # We are running inside Cutter, Binary Ninja or Ghidra
    try:
        import PySide2.QtWidgets as QtWidgets
    except:
        import PySide6.QtWidgets as QtWidgets

import os.path
import yara
import pefile


class YaraDetector(QtWidgets.QDialog):
    def __init__(self, rule_text, file_path, jump_to):
        super(YaraDetector, self).__init__()
        self.setObjectName("YaraDetector")
        self.setWindowTitle("YaraDetector")
        self.rule_text = rule_text
        self.file_path = file_path
        self.jump_to = jump_to

    def _ui_init(self):
        try:
            self.pe = pefile.PE(self.file_path)
        except:
            self.pe = None

        self._ui_setting()
        self._ui_init_layout()
        self._ui_clicked_connect()
        self._ui_init_table()
        self.exec_()

    def _ui_setting(self):
        self._folder_path = QtWidgets.QLineEdit()
        self._path_button = QtWidgets.QPushButton("File")
        self._hyara_checkbox = QtWidgets.QCheckBox()
        self._search_button = QtWidgets.QPushButton("Search")

    def _ui_init_layout(self):
        self.layout = QtWidgets.QVBoxLayout()
        GL1 = QtWidgets.QGridLayout()
        GL1.addWidget(QtWidgets.QLabel("Yara Path : "), 0, 0)
        GL1.addWidget(self._folder_path, 0, 1)
        GL1.addWidget(self._path_button, 0, 2)
        GL1.addWidget(QtWidgets.QLabel("Hyara Rule"), 0, 3)
        GL1.addWidget(self._hyara_checkbox, 0, 4)
        self.layout.addLayout(GL1)

        self.layout.addWidget(self._search_button)
        self.setLayout(self.layout)

    def _ui_clicked_connect(self):
        self._search_button.clicked.connect(self._search)
        self._path_button.clicked.connect(self._select_path)

    def _ui_init_table(self):
        self._table = QtWidgets.QTableWidget()
        self._table.cellClicked.connect(self.jump_addr)
        self._table.setRowCount(0)
        self._table.setColumnCount(4)
        self._table.setHorizontalHeaderLabels(["Address", "Rule Name", "Variable Name", "Value"])
        self.layout.addWidget(self._table)

    def get_binarydata(self):
        with open(self.file_path, "rb") as f:
            return f.read()

    def get_va_from_offset(self, addr):
        return self.pe.OPTIONAL_HEADER.ImageBase + self.pe.get_rva_from_offset(addr)

    def jump_addr(self, row, column):
        addr = int(self._table.item(row, 0).text(), 16)  # RAW
        if self.pe:
            self.jump_to(self.get_va_from_offset(addr))
        else:
            self.jump_to(addr)

    def _search(self):
        result = []
        data = self.get_binarydata()

        if self._hyara_checkbox.isChecked():
            self.rule = yara.compile(source=self.rule_text)
        else:
            with open(self._folder_path.text(), "r") as f:
                self.rule = yara.compile(source=f.read())

        matches = self.rule.match(data=data)
        for match in matches:
            for i in match.strings:
                result.append(
                    {
                        "addr": hex(i[0]),
                        "rule_name": match.rule,
                        "variable_name": i[1],
                        "value": i[2].hex(),
                    }
                )
        self._table.setRowCount(len(result))

        for idx, value in enumerate(result):
            self._table.setItem(idx, 0, QtWidgets.QTableWidgetItem(value["addr"]))
            self._table.setItem(idx, 1, QtWidgets.QTableWidgetItem(value["rule_name"]))
            self._table.setItem(idx, 2, QtWidgets.QTableWidgetItem(value["variable_name"]))
            self._table.setItem(idx, 3, QtWidgets.QTableWidgetItem(value["value"]))
        self.layout.addWidget(self._table)

    def _select_path(self):
        path = QtWidgets.QFileDialog.getOpenFileName(
            self,
            "Open a file",
            os.path.expanduser("~"),
            "Yara Rule Files (*.yar *.yara);;All Files (*)",
        )

        if path:
            self._folder_path.setText(path[0])

```

`hyara_lib/plugins/yara_icon.py`:

```py
from sys import modules

if "idaapi" in modules:
    # We are running inside IDA
    from PyQt5 import QtWidgets, QtCore, QtGui
else:
    # We are running inside Cutter, Binary Ninja or Ghidra
    try:
        import PySide2.QtWidgets as QtWidgets
        import PySide2.QtCore as QtCore
        import PySide2.QtGui as QtGui
    except:
        import PySide6.QtWidgets as QtWidgets
        import PySide6.QtCore as QtCore
        import PySide6.QtGui as QtGui

from PIL import Image
from PIL.ImageQt import ImageQt
from functools import partial

import pefile
import io

ICON_HEADER = (
    b"\x00\x00\x01\x00\x01\x00\x30\x30\x00\x00\x01\x00\x08\x00\xA8\x0E\x00\x00\x16\x00\x00\x00"
)


class YaraIcon(QtWidgets.QDialog):
    def __init__(self, file_path, rule_list, _ui_populate_table):
        super(YaraIcon, self).__init__()
        self.setObjectName("YaraIcon")
        self.setWindowTitle("YaraIcon")
        self.file_path = file_path
        self.rule_list = rule_list
        self._ui_populate_table = _ui_populate_table

    def _ui_init(self):
        self._ui_setting()
        self._ui_init_layout()
        self._ui_clicked_connect()
        self.exec_()

    def _ui_setting(self):
        self._varable_name = QtWidgets.QLineEdit()
        self._start_offset = QtWidgets.QLineEdit()
        self._length = QtWidgets.QLineEdit()
        self._enter_button = QtWidgets.QPushButton("Enter")
        self._icon_data_list = self._get_icon()
        self._icon_rule_list = []
        self._enter_button_list = []

    def _ui_label_center(self, title):
        result = QtWidgets.QLabel(title)
        result.setAlignment(QtCore.Qt.AlignCenter)
        return result

    def _ui_set_pixmap(self, qimage):
        result = QtWidgets.QLabel()
        result.setPixmap(QtGui.QPixmap.fromImage(qimage))
        return result

    def _ui_init_layout(self):
        self.layout = QtWidgets.QVBoxLayout()
        GL0 = QtWidgets.QGridLayout()
        GL0.addWidget(QtWidgets.QLabel("Variable Name : "), 0, 0)
        GL0.addWidget(self._varable_name, 0, 1)
        GL0.addWidget(QtWidgets.QLabel("Start Offset : "), 0, 2)
        GL0.addWidget(self._start_offset, 0, 3)
        GL0.addWidget(QtWidgets.QLabel("Length : "), 0, 4)
        GL0.addWidget(self._length, 0, 5)
        GL0.addWidget(self._enter_button, 0, 6)
        self.layout.addLayout(GL0)

        GL1 = QtWidgets.QGridLayout()
        GL1.addWidget(self._ui_label_center("Icon"), 0, 0)
        GL1.addWidget(self._ui_label_center("Icon Size"), 0, 1)
        GL1.addWidget(self._ui_label_center("Rule"), 0, 2)
        GL1.addWidget(self._ui_label_center("Save Rule"), 0, 3)

        for idx, value in enumerate(self._icon_data_list):
            self._icon_rule_list.append(QtWidgets.QLineEdit())
            enter_button = QtWidgets.QPushButton("Enter")
            enter_button.clicked.connect(partial(self._yara_save_icon, idx))
            self._enter_button_list.append(enter_button)

            qimage = ImageQt(Image.open(io.BytesIO(ICON_HEADER + value["raw_data"])))
            GL1.addWidget(self._ui_set_pixmap(qimage), idx + 1, 0)
            GL1.addWidget(QtWidgets.QLabel(hex(value["size"])), idx + 1, 1)
            GL1.addWidget(self._icon_rule_list[idx], idx + 1, 2)
            GL1.addWidget(self._enter_button_list[idx], idx + 1, 3)

        self.layout.addLayout(GL1)
        self.setLayout(self.layout)

    def _ui_clicked_connect(self):
        self._enter_button.clicked.connect(self._yara_make_icon)

    def _get_icon(self):
        data = []
        pe = pefile.PE(self.file_path)
        for entry in pe.DIRECTORY_ENTRY_RESOURCE.entries:
            if entry.id == pefile.RESOURCE_TYPE["RT_ICON"]:
                for directory in entry.directory.entries:
                    for rsrc in directory.directory.entries:
                        offset = rsrc.data.struct.OffsetToData
                        size = rsrc.data.struct.Size
                        data.append(
                            {
                                "raw_data": pe.get_memory_mapped_image()[offset : offset + size],
                                "offset": offset,
                                "size": size,
                            }
                        )
        return data

    def _yara_make_icon(self):
        start_offset = int(self._start_offset.text(), 16)
        length = int(self._length.text(), 10)

        for idx, value in enumerate(self._icon_data_list):
            self._icon_rule_list[idx].setText(
                value["raw_data"][start_offset : start_offset + length].hex()
            )

    def _yara_save_icon(self, idx):
        variable_name = self._varable_name.text()
        rule_text = self._icon_rule_list[idx].text()
        start_offset = int(self._start_offset.text(), 16)
        end = start_offset + int(self._length.text(), 10)

        self.rule_list[variable_name] = {
            "text": rule_text,
            "start": str(start_offset),
            "end": str(end),
            "type": "icon",
        }

        self._ui_populate_table()

```

`hyara_lib/ui/settings.py`:

```py
from sys import modules

if "idaapi" in modules:
    # We are running inside IDA
    from PyQt5 import QtWidgets
else:
    # We are running inside Cutter, Binary Ninja or Ghidra
    try:
        import PySide2.QtWidgets as QtWidgets
    except:
        import PySide6.QtWidgets as QtWidgets

from abc import ABCMeta, abstractmethod
from ..plugins import yara_checker, yara_detector, yara_icon

import time
import pefile

class WildcardPlainTextEdit(QtWidgets.QPlainTextEdit):
    def __init__(self, parent=None):
        QtWidgets.QPlainTextEdit.__init__(self, parent)

    def contextMenuEvent(self, event):
        menu = QtWidgets.QMenu(self)
        wildcard_action = menu.addAction("Modify the values to &wild-cards")
        action = menu.exec_(self.mapToGlobal(event.pos()))

        if action == wildcard_action:
            self._wildcard_trigger()

    def _wildcard_trigger(self):
        result = ""
        cursor = self.textCursor()
        value = cursor.selectedText()

        for i in value:
            if ord(i) != ord(" "):
                result += "?"
            else:
                result += " "

        cursor.insertText(result)

# Based GUI
class MainGUI:
    def __init__(self):
        self.layout = QtWidgets.QVBoxLayout()
        self.rule_list = {}
        self._ui_init()

    def _ui_init(self):
        self._ui_setting()
        self._ui_init_layout()
        self._ui_init_table()

    def _ui_setting(self):
        self._variable_name = QtWidgets.QLineEdit()

        self._start_address = QtWidgets.QLineEdit()
        self._end_address = QtWidgets.QLineEdit()

        self._check_comment = QtWidgets.QCheckBox()
        self._check_wildcard = QtWidgets.QCheckBox()
        self._check_string = QtWidgets.QCheckBox()
        self._check_rich_header = QtWidgets.QCheckBox()
        self._check_imphash = QtWidgets.QCheckBox()
        self._check_pdb_path = QtWidgets.QCheckBox()

        self._result_plaintext = WildcardPlainTextEdit()

        self._make_button = QtWidgets.QPushButton("Make")
        self._save_button = QtWidgets.QPushButton("Save")
        self._delete_button = QtWidgets.QPushButton("Delete")
        self._yara_export_button = QtWidgets.QPushButton("Export Yara Rule")
        self._yara_checker_button = QtWidgets.QPushButton("Yara Checker")
        self._yara_detector_button = QtWidgets.QPushButton("Yara Detector")
        self._yara_icon_button = QtWidgets.QPushButton("Yara Icon")

    def _ui_init_layout(self):
        GL1 = QtWidgets.QGridLayout()
        GL1.addWidget(QtWidgets.QLabel("Variable Name : "), 0, 0)
        GL1.addWidget(self._variable_name, 0, 1)
        self.layout.addLayout(GL1)

        GL2 = QtWidgets.QGridLayout()
        GL2.addWidget(QtWidgets.QLabel("Start Address : "), 0, 0)
        GL2.addWidget(self._start_address, 0, 1)
        GL2.addWidget(QtWidgets.QLabel("End Address : "), 0, 3)
        GL2.addWidget(self._end_address, 0, 4)
        self.layout.addLayout(GL2)

        GL3 = QtWidgets.QHBoxLayout()
        GL3.addWidget(self._check_comment)
        GL3.addWidget(QtWidgets.QLabel("Comment Option"))
        GL3.addStretch()

        GL3.addWidget(self._check_wildcard)
        GL3.addWidget(QtWidgets.QLabel("Wildcard Option"))
        GL3.addStretch()

        GL3.addWidget(self._check_string)
        GL3.addWidget(QtWidgets.QLabel("String Option"))
        GL3.addStretch()

        GL3.addWidget(self._check_rich_header)
        GL3.addWidget(QtWidgets.QLabel("Rich Header"))
        GL3.addStretch()

        GL3.addWidget(self._check_imphash)
        GL3.addWidget(QtWidgets.QLabel("Imphash"))
        GL3.addStretch()

        GL3.addWidget(self._check_pdb_path)
        GL3.addWidget(QtWidgets.QLabel("PDB Path"))
        self.layout.addLayout(GL3)

        self.layout.addWidget(self._result_plaintext)

        GL4 = QtWidgets.QGridLayout()
        GL4.addWidget(self._make_button, 0, 0)
        GL4.addWidget(self._save_button, 0, 1)
        GL4.addWidget(self._delete_button, 0, 2)
        GL4.addWidget(self._yara_export_button, 0, 3)
        GL4.addWidget(self._yara_checker_button, 0, 4)
        GL4.addWidget(self._yara_detector_button, 0, 5)
        GL4.addWidget(self._yara_icon_button, 0, 6)
        self.layout.addLayout(GL4)

    def _ui_init_table(self):
        self._table = QtWidgets.QTableWidget()
        self._table.cellDoubleClicked.connect(self._ui_table_click)
        self._table.setRowCount(0)
        self._table.setColumnCount(4)
        self._table.setHorizontalHeaderLabels(["Variable Name", "Rule", "Start", "End"])
        self.layout.addWidget(self._table)

    def _ui_populate_table(self):
        self._table.setRowCount(len(self.rule_list))
        for idx, (name, value) in enumerate(self.rule_list.items()):
            self._table.setItem(idx, 0, QtWidgets.QTableWidgetItem(name))
            self._table.setItem(idx, 1, QtWidgets.QTableWidgetItem(value["text"]))
            self._table.setItem(idx, 2, QtWidgets.QTableWidgetItem(value["start"]))
            self._table.setItem(idx, 3, QtWidgets.QTableWidgetItem(value["end"]))
        self.layout.addWidget(self._table)

    def _ui_table_click(self, row, column):
        if self._remove_question() == QtWidgets.QMessageBox.Yes:
            variable_name = self._table.item(row, 0).text()
            del self.rule_list[variable_name]
        self._ui_populate_table()

    def _remove_question(self):
        msg = QtWidgets.QMessageBox.question(
            None,
            "Message",
            "Remove Yara Rule",
            QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No,
        )
        return msg


# add feature
class HyaraGUI(MainGUI):
    __metaclass__ = ABCMeta

    def __init__(self):
        super(HyaraGUI, self).__init__()
        self._ui_clicked_connect()

    @abstractmethod
    def get_disasm(self, start_address, end_address) -> list:
        pass

    @abstractmethod
    def get_hex(self, start_address, end_address) -> list:
        pass

    @abstractmethod
    def get_comment_hex(self, start_address, end_address) -> list:
        pass

    @abstractmethod
    def get_string(self, start_address, end_address) -> list:
        pass

    @abstractmethod
    def get_filepath(self) -> str:
        pass

    @abstractmethod
    def get_md5(self) -> str:
        pass

    @abstractmethod
    def get_imphash(self) -> str:
        pass

    @abstractmethod
    def get_rich_header(self) -> str:
        pass

    @abstractmethod
    def get_pdb_path(self) -> str:
        pass

    @abstractmethod
    def jump_to(self, addr):
        pass

    def pretty_hex(self, data):
        return " ".join(data[i : i + 2] for i in range(0, len(data), 2)).upper()

    def get_comment(self, value):
        if value["type"] == "hex":
            self.result += "      /*\n"
            for disasm, hex_value in zip(
                self.get_disasm(int(value["start"], 16), int(value["end"], 16)),
                self.get_comment_hex(int(value["start"], 16), int(value["end"], 16)),
            ):
                mnemonic = disasm.split(" ")[0]
                operend = " ".join(disasm.split(" ")[1:]).strip()
                self.result += "          {:10}\t{:30}\t\t|{}\n".format(
                    mnemonic, operend, hex_value.upper()
                )

            self.result += "      */\n"

    def get_rule_data(self, name, value):
        if value["type"] == "string":
            self.result += "      $" + name + ' = "' + value["text"] + '" nocase wide ascii\n'
        else:
            self.result += "      $" + name + " = {" + self.pretty_hex(value["text"]) + "}\n"

    def _make_hex_rule(self):
        self._result_plaintext.clear()
        start = int(self._start_address.text(), 16)
        end = int(self._end_address.text(), 16)

        if start < end:
            if self._check_string.isChecked():
                self._result_plaintext.insertPlainText("\n".join(self.get_string(start, end)))
            else:
                self._result_plaintext.insertPlainText("".join(self.get_hex(start, end)).upper())

    def _save_rule(self):
        if self._check_string.isChecked():
            string_list = self._result_plaintext.toPlainText().split("\n")
            for idx, string in enumerate(string_list):
                self.rule_list["{}_{}".format(self._variable_name.text(), str(idx))] = {
                    "text": string.replace("\"", "\\\""),
                    "start": self._start_address.text(),
                    "end": self._end_address.text(),
                    "type": "string",
                }
        else:
            self.rule_list[self._variable_name.text()] = {
                "text": self._result_plaintext.toPlainText(),
                "start": self._start_address.text(),
                "end": self._end_address.text(),
                "type": "hex",
            }
        self._ui_populate_table()

    def _remove_rule(self):
        if self._remove_question() == QtWidgets.QMessageBox.Yes:
            self.rule_list.clear()
        self._ui_populate_table()

    def _yara_result(self) -> str:
        self.result = 'import "hash"\n'
        self.result += 'import "pe"\n\n'
        self.result += "rule {} \n".format(self._variable_name.text())
        self.result += "{\n"
        self.result += "  meta:\n"
        self.result += '      tool = "https://github.com/hyuunnn/Hyara"\n'
        self.result += '      version = "2.3"\n'
        self.result += '      date = "{}"\n'.format(time.strftime("%Y-%m-%d"))
        self.result += '      MD5 = "{}"\n'.format(self.get_md5())
        self.result += "  strings:\n"

        for name, value in self.rule_list.items():

            if self._check_comment.isChecked():
                self.get_comment(value)

            self.get_rule_data(name, value)

        self.result += "  condition:\n"
        self.result += "      all of them"

        try:
            # Check if opened file is a PE
            pefile.PE(self.get_filepath())
            if self._check_rich_header.isChecked():
                self.result += (
                    ' and hash.md5(pe.rich_signature.clear_data) == "'
                    + self.get_rich_header()
                    + '"'
                )

            if self._check_imphash.isChecked():
                self.result += ' and pe.imphash() == "' + self.get_imphash() + '"'

            if self._check_pdb_path.isChecked():
                self.result += ' and pe.pdb_path == "' + self.get_pdb_path() + '"'
        except pefile.PEFormatError:
            # Not a PE file, continue
            pass

        self.result += "\n}"
        return self.result

    def _yara_export_rule(self):
        self._result_plaintext.clear()
        if len(self.rule_list) > 0:
            self._result_plaintext.insertPlainText(self._yara_result())

    def _yara_checker(self):
        yara_checker.YaraChecker(self._result_plaintext.toPlainText())._ui_init()

    def _yara_detector(self):
        yara_detector.YaraDetector(
            self._result_plaintext.toPlainText(), self.get_filepath(), self.jump_to
        )._ui_init()

    def _yara_icon(self):
        yara_icon.YaraIcon(self.get_filepath(), self.rule_list, self._ui_populate_table)._ui_init()

    def _ui_clicked_connect(self):
        self._make_button.clicked.connect(self._make_hex_rule)
        self._save_button.clicked.connect(self._save_rule)
        self._delete_button.clicked.connect(self._remove_rule)
        self._yara_export_button.clicked.connect(self._yara_export_rule)
        self._yara_checker_button.clicked.connect(self._yara_checker)
        self._yara_detector_button.clicked.connect(self._yara_detector)
        self._yara_icon_button.clicked.connect(self._yara_icon)

```

`requirements.txt`:

```txt
yara-python>=4.0.2
pefile>=2019.4.18
Pillow>=8.0.1

```