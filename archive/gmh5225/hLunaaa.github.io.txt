Project Path: arc_gmh5225_hLunaaa.github.io_rzt8ef7w

Source Tree:

```txt
arc_gmh5225_hLunaaa.github.io_rzt8ef7w
├── 404.html
├── Gemfile
├── Gemfile.lock
├── _config.yml
├── _includes
│   └── footer.html
├── _layouts
│   ├── default.html
│   ├── home.html
│   ├── page.html
│   └── post.html
├── _posts
│   ├── 2025-04-17-Minesweeper-Classic-ESP.markdown
│   ├── 2025-04-17-PageView64.markdown
│   ├── 2025-04-18-Exploring-CI.dll-and-Bigpool-Cache.markdown
│   ├── 2025-04-20-Inline-x86-Syscall-Abuse-on-x86_64-Systems.markdown
│   └── 2025-04-25-Bypassing-CR3-Abuse-with-Physical-RW copy.markdown
├── _site
│   ├── 2025
│   │   └── 04
│   │       ├── 17
│   │       │   ├── Minesweeper-Classic-ESP.html
│   │       │   └── PageView64.html
│   │       ├── 18
│   │       │   └── Exploring-CI.dll-and-Bigpool-Cache.html
│   │       ├── 20
│   │       │   └── Inline-x86-Syscall-Abuse-on-x86_64-Systems.html
│   │       ├── 25
│   │       │   └── Bypassing-CR3-Abuse-with-Physical-RW-copy.html
│   │       └── 29
│   │           └── Examining-Malware-Thread-Creation-Techniques.html
│   ├── 404.html
│   ├── about
│   │   └── index.html
│   ├── assets
│   │   ├── 4_level_paging.png
│   │   ├── PageView64.mp4
│   │   ├── image-1.png
│   │   ├── image.png
│   │   ├── image2.png
│   │   ├── main.css
│   │   ├── main.css.map
│   │   ├── minima-social-icons.svg
│   │   ├── {07E01347-FB93-43D5-BB8E-3880096AEA4B}.png
│   │   ├── {1C4BCA20-5531-4364-B3D0-B45FF6EB2670}.png
│   │   ├── {7E18B9B6-F4C0-4701-A08C-B2A6CF97B269}.png
│   │   ├── {80160CA8-EB1C-4189-9B32-ED16BD8B0FA4}.png
│   │   ├── {83E0EFE6-C7EE-420A-92C1-590E6A2EE129}.png
│   │   ├── {AB29194B-780E-4E52-A8D0-86B679B54278}.png
│   │   ├── {EAB758A4-2E16-4FE7-929F-726D7CB065AB}.png
│   │   ├── {FB211914-8E66-435F-9BAD-01036C06A600}.png
│   │   └── {FD14D6FB-2AEC-4018-9882-8ABCDAAA56CF}.png
│   ├── favicon.ico
│   ├── feed.xml
│   └── index.html
├── about.markdown
├── assets
│   ├── 2025-04-29-Examining-Malware-Thread-Creation-Techniques.markdown
│   ├── 4_level_paging.png
│   ├── PageView64.mp4
│   ├── image-1.png
│   ├── image.png
│   ├── image2.png
│   ├── {07E01347-FB93-43D5-BB8E-3880096AEA4B}.png
│   ├── {1C4BCA20-5531-4364-B3D0-B45FF6EB2670}.png
│   ├── {7E18B9B6-F4C0-4701-A08C-B2A6CF97B269}.png
│   ├── {80160CA8-EB1C-4189-9B32-ED16BD8B0FA4}.png
│   ├── {83E0EFE6-C7EE-420A-92C1-590E6A2EE129}.png
│   ├── {AB29194B-780E-4E52-A8D0-86B679B54278}.png
│   ├── {EAB758A4-2E16-4FE7-929F-726D7CB065AB}.png
│   ├── {FB211914-8E66-435F-9BAD-01036C06A600}.png
│   └── {FD14D6FB-2AEC-4018-9882-8ABCDAAA56CF}.png
├── favicon.ico
└── index.markdown

```

`404.html`:

```html
---
permalink: /404.html
layout: page
---

<style type="text/css" media="screen">
  .container {
    margin: 10px auto;
    max-width: 600px;
    text-align: center;
  }
  h1 {
    margin: 30px 0;
    font-size: 4em;
    line-height: 1;
    letter-spacing: -1px;
  }
</style>

<div class="container">
  <h1>404</h1>

  <p><strong>Page not found :(</strong></p>
  <p>The requested page could not be found.</p>
</div>

```

`Gemfile`:

```
source "https://rubygems.org"
# Hello! This is where you manage which Jekyll version is used to run.
# When you want to use a different version, change it below, save the
# file and run `bundle install`. Run Jekyll with `bundle exec`, like so:
#
#     bundle exec jekyll serve
#
# This will help ensure the proper Jekyll version is running.
# Happy Jekylling!
gem "jekyll", "~> 4.4.1"
# This is the default theme for new Jekyll sites. You may change this to anything you like.
gem "minima", "~> 2.5"
# If you want to use GitHub Pages, remove the "gem "jekyll"" above and
# uncomment the line below. To upgrade, run `bundle update github-pages`.
# gem "github-pages", group: :jekyll_plugins
# If you have any plugins, put them here!
group :jekyll_plugins do
  gem "jekyll-feed", "~> 0.12"
end

# Windows and JRuby does not include zoneinfo files, so bundle the tzinfo-data gem
# and associated library.
platforms :mingw, :x64_mingw, :mswin, :jruby do
  gem "tzinfo", ">= 1", "< 3"
  gem "tzinfo-data"
end

# Performance-booster for watching directories on Windows
gem "wdm", "~> 0.1", :platforms => [:mingw, :x64_mingw, :mswin]

# Lock `http_parser.rb` gem to `v0.6.x` on JRuby builds since newer versions of the gem
# do not have a Java counterpart.
gem "http_parser.rb", "~> 0.6.0", :platforms => [:jruby]

```

`Gemfile.lock`:

```lock
GEM
  remote: https://rubygems.org/
  specs:
    addressable (2.8.7)
      public_suffix (>= 2.0.2, < 7.0)
    base64 (0.2.0)
    bigdecimal (3.1.9)
    colorator (1.1.0)
    concurrent-ruby (1.3.5)
    csv (3.3.4)
    em-websocket (0.5.3)
      eventmachine (>= 0.12.9)
      http_parser.rb (~> 0)
    eventmachine (1.2.7)
    ffi (1.17.2-x64-mingw-ucrt)
    forwardable-extended (2.6.0)
    google-protobuf (4.30.2-x64-mingw-ucrt)
      bigdecimal
      rake (>= 13)
    http_parser.rb (0.8.0)
    i18n (1.14.7)
      concurrent-ruby (~> 1.0)
    jekyll (4.4.1)
      addressable (~> 2.4)
      base64 (~> 0.2)
      colorator (~> 1.0)
      csv (~> 3.0)
      em-websocket (~> 0.5)
      i18n (~> 1.0)
      jekyll-sass-converter (>= 2.0, < 4.0)
      jekyll-watch (~> 2.0)
      json (~> 2.6)
      kramdown (~> 2.3, >= 2.3.1)
      kramdown-parser-gfm (~> 1.0)
      liquid (~> 4.0)
      mercenary (~> 0.3, >= 0.3.6)
      pathutil (~> 0.9)
      rouge (>= 3.0, < 5.0)
      safe_yaml (~> 1.0)
      terminal-table (>= 1.8, < 4.0)
      webrick (~> 1.7)
    jekyll-feed (0.17.0)
      jekyll (>= 3.7, < 5.0)
    jekyll-sass-converter (3.1.0)
      sass-embedded (~> 1.75)
    jekyll-seo-tag (2.8.0)
      jekyll (>= 3.8, < 5.0)
    jekyll-watch (2.2.1)
      listen (~> 3.0)
    json (2.10.2)
    kramdown (2.5.1)
      rexml (>= 3.3.9)
    kramdown-parser-gfm (1.1.0)
      kramdown (~> 2.0)
    liquid (4.0.4)
    listen (3.9.0)
      rb-fsevent (~> 0.10, >= 0.10.3)
      rb-inotify (~> 0.9, >= 0.9.10)
    mercenary (0.4.0)
    minima (2.5.2)
      jekyll (>= 3.5, < 5.0)
      jekyll-feed (~> 0.9)
      jekyll-seo-tag (~> 2.1)
    pathutil (0.16.2)
      forwardable-extended (~> 2.6)
    public_suffix (6.0.1)
    rake (13.2.1)
    rb-fsevent (0.11.2)
    rb-inotify (0.11.1)
      ffi (~> 1.0)
    rexml (3.4.1)
    rouge (4.5.1)
    safe_yaml (1.0.5)
    sass-embedded (1.86.3-x64-mingw-ucrt)
      google-protobuf (~> 4.30)
    terminal-table (3.0.2)
      unicode-display_width (>= 1.1.1, < 3)
    tzinfo (2.0.6)
      concurrent-ruby (~> 1.0)
    tzinfo-data (1.2025.2)
      tzinfo (>= 1.0.0)
    unicode-display_width (2.6.0)
    wdm (0.2.0)
    webrick (1.9.1)

PLATFORMS
  x64-mingw-ucrt

DEPENDENCIES
  http_parser.rb (~> 0.6.0)
  jekyll (~> 4.4.1)
  jekyll-feed (~> 0.12)
  minima (~> 2.5)
  tzinfo (>= 1, < 3)
  tzinfo-data
  wdm (~> 0.1)

BUNDLED WITH
   2.6.8

```

`_config.yml`:

```yml
# Welcome to Jekyll!
#
# This config file is meant for settings that affect your whole blog, values
# which you are expected to set up once and rarely edit after that. If you find
# yourself editing this file very often, consider using Jekyll's data files
# feature for the data you need to update frequently.
#
# For technical reasons, this file is *NOT* reloaded automatically when you use
# 'bundle exec jekyll serve'. If you change this file, please restart the server process.
#
# If you need help with YAML syntax, here are some quick references for you:
# https://learn-the-web.algonquindesign.ca/topics/markdown-yaml-cheat-sheet/#yaml
# https://learnxinyminutes.com/docs/yaml/
#
# Site settings
# These are used to personalize your new site. If you look in the HTML files,
# you will see them accessed via {{ site.title }}, {{ site.email }}, and so on.
# You can create any custom variable you would like, and they will be accessible
# in the templates via {{ site.myvariable }}.

title: hLunaaa
email: hLunaaa@proton.me
description: >- # this means to ignore newlines until "baseurl:"
  8086 and C++23
baseurl: "" # the subpath of your site, e.g. /blog
url: "http://hLunaaa.github.io" # the base hostname & protocol for your site, e.g. http://example.com
#twitter_username: hLunaaa
github_username:  hLunaaa
# Build settings
theme: minima
plugins:
  - jekyll-feed
# Exclude from processing.
# The following items will not be processed, by default.
# Any item listed under the `exclude:` key here will be automatically added to
# the internal "default list".
#
# Excluded items can be processed by explicitly listing the directories or
# their entries' file path in the `include:` list.
#
# exclude:
#   - .sass-cache/
#   - .jekyll-cache/
#   - gemfiles/
#   - Gemfile
#   - Gemfile.lock
#   - node_modules/
#   - vendor/bundle/
#   - vendor/cache/
#   - vendor/gems/
#   - vendor/ruby/

```

`_layouts/default.html`:

```html
<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: "en" }}">

  {%- include head.html -%}

  <body>

    {%- include header.html -%}

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        {{ content }}
      </div>
    </main>

    {%- include footer.html -%}

  </body>

</html>

```

`_layouts/home.html`:

```html
---
layout: default
---

<div class="home">
  {%- if page.title -%}
    <h1 class="page-heading">{{ page.title }}</h1>
  {%- endif -%}

  {{ content }}

  {%- if site.posts.size > 0 -%}
    <h2 class="post-list-heading">{{ page.list_title | default: "Posts" }}</h2>
    <ul class="post-list">
      {%- for post in site.posts -%}
      <li>
        {%- assign date_format = site.minima.date_format | default: "%b %-d, %Y" -%}
        <span class="post-meta">{{ post.date | date: date_format }}</span>
        <h3>
          <a class="post-link" href="{{ post.url | relative_url }}">
            {{ post.title | escape }}
          </a>
        </h3>
        {%- if site.show_excerpts -%}
          {{ post.excerpt }}
        {%- endif -%}
      </li>
      {%- endfor -%}
    </ul>
  {%- endif -%}

</div>

```

`_layouts/page.html`:

```html
---
layout: default
---
<article class="post">

  <header class="post-header">
    <h1 class="post-title">{{ page.title | escape }}</h1>
  </header>

  <div class="post-content">
    {{ content }}
  </div>

</article>

```

`_layouts/post.html`:

```html
---
layout: default
---
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">{{ page.title | escape }}</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="{{ page.date | date_to_xmlschema }}" itemprop="datePublished">
        {%- assign date_format = site.minima.date_format | default: "%b %-d, %Y" -%}
        {{ page.date | date: date_format }}
      </time>
      {%- if page.author -%}
        • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">{{ page.author }}</span></span>
      {%- endif -%}</p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    {{ content }}
  </div>

  {%- if site.disqus.shortname -%}
    {%- include disqus_comments.html -%}
  {%- endif -%}

  <a class="u-url" href="{{ page.url | relative_url }}" hidden></a>
</article>

```

`_posts/2025-04-17-Minesweeper-Classic-ESP.markdown`:

```markdown
---
layout: post
title:  "Minesweeper Classic ESP"
date:   2025-04-17 09:19:42 +0200
---

Minesweeper is a fun little game about clicking squares and avoiding bombs. But I've always wondered how it works under the hood. A grid game. There's probably a bitmap somewhere. 

In the context menu we can create a custom came by setting width, height and number of bombs. I attach a debugger and see where these are accessed. They bring me to the function responsible for showing the dialog `winmine.hlp`. We rename the variables.

![](/assets/{AB29194B-780E-4E52-A8D0-86B679B54278}.png)

By cross referencing where these are used we find multiple functions. Some store the custom game values to registry keys, others load defaults on startup. We also find an interesting function that loops, reducing the bomb count on each iteration.

![](/assets/{FB211914-8E66-435F-9BAD-01036C06A600}.png)

At this point it is quite clear what this function does. We loop over the bitmap, setting the bomb flag `0x80` at random using `rand`. We see the bitmap stride `32 * Y + X`, with `X` and `Y` starting at `1`. With this information, we are able to read the bitmap and check for bomb flags.

{% highlight C++ %}
void loop_draw_esp(u8* game)
{
  u32 hdc = GetDC(0); // lazy, grab the entire screen
  if (!hdc)
    return;

  if(*(u32*)(game + 0x5164) == 0) // should clock start (is playing?)
    return;

  u32 win_x = *(u32*)(game + 0x56B0) + 18;
  u32 win_y = *(u32*)(game + 0x56B4) + 105; // window pos + offset to tile grid

  for (u32 y = 1; y <= *(u32*)(game + 0x5338); y++)
  for (u32 x = 1; x <= *(u32*)(game + 0x5334); x++) // walk coords
  {
    u32 tile = (game + 0x5340)[32 * y + x];
    if (tile & 0x80u) // has bomb?
      draw_tile(hdc, win_x + (x - 1) * 15, win_y + (y - 1) * 15, RGB(255, 0, 0));
  }

  ReleaseDC(0, hdc);
  Sleep(5);
}
{% endhighlight %}

It really is that shrimple. We inject and play. This is the result.

![](/assets/{EAB758A4-2E16-4FE7-929F-726D7CB065AB}.png)

```

`_posts/2025-04-17-PageView64.markdown`:

```markdown
---
layout: post
title:  "PageView64 Dynamic IA32e Paging Structure Explorer"
date:   2025-04-17 07:19:42 +0200
---

>Paging is a system which allows each process to see a full virtual address space, without actually requiring the full amount of physical memory to be available or present. 32-bit x86 processors support 32-bit virtual addresses and 4-GiB virtual address spaces, and current 64-bit processors support 48-bit virtual addressing and 256-TiB virtual address spaces.
<br>- [OSDev Wiki](https://wiki.osdev.org/Paging#64-Bit_Paging)

<br>
### __Rationale__
For a long time I struggled to visualize `IA32e` paging structures in my head. I always viewed paging as redundant. You'd think paging redundant on modern systems. Indeed, it is possible to implement virtual addressing, protection and session spacing with identity mapping.

The argument for memory efficiency is also not very convincing, but there aren't many reasons for Microsoft to mess with things that already work well enough, not to mention that paging as a concept is more a vertical issue than just software alone.

From the malware perspective, acting on the underlying physical memory is far more powerful than using official `API` to adjust virtual memory. We are able to get around many of the restrictions placed on virtual memory. We can ignore session spacing and page protection. We can construct our own paging structures and allocate memory hidden from the `Virtual Address Descriptor` or `VAD`.

The following diagram describes the layout of an `IA32e` virtual address.

![IA32e Paging Overview](/assets/4_level_paging.png)

Each page table is a list of `512` addresses. The first `256` are reserved for user addresses. There are four page tables. Also consider that `512 * sizeof(uintptr_t) == PAGE_SIZE`. The base physical address of the `PML4` is described by `EPROCESS.DirectoryTableBase`.

<br>
### __Address Translation__
Paging relates to session spacing. When a thread goes from one address space to another via `SwapContext`, the `CR3` is set. When the `CPU` wants to translate a physical address, it first checks if the translation already exists in the `Translation Lookaside Buffer` or `TLB`. If no translation exists, it walks the page tables.

>Paging in long mode is similar to that of 32-bit paging, except Physical Address Extension (PAE) is required. Registers CR2 and CR3 are extended to 64 bits. Instead of just having to utilize 3 levels of page maps: page directory pointer table, page directory, and page table, a fourth page-map table is used: the level-4 page map table (PML4). This allows a processor to map 48-bit virtual addresses to 52-bit physical addresses.
<br>- [OSDev Wiki](https://wiki.osdev.org/Paging#64-Bit_Paging)

As a sidenote, you can flush the `TLB` by toggling the `CR4.PGE` bit or firing the `INVLPG` instruction. User mode applications can use `SwitchToThread()` to force a context switch.

A word on naming conventions. Four-level paging is implemented in both `IA32e` and `AMD64`, but with different naming schemes. This often leads to confusion. In this paper we simplify to `PML4`, `PML3`, `PML2` and `PML1`.

We translate by walking down the chain.

{% highlight C++ %}
#define _pfn_to_page(pfn) (pfn << _page_shift)

u8* vtop(EPROCESS* proc, virt_addr_t va)
{
  // read from proc, but if it is currentproc we can obv __readcr3
  // procs can also obscure the DirectoryTableBase with tricks
  pml4e_t pml4e = read<pml4e_t>(_pfn_to_page(proc->DirectoryTableBase.pfn) + va.pml4_idx * sizeof(pml4e_t));
  if (!pml4e.present)
    return 0;
  
  pml3e_t pml3e = read<pml3e_t>(_pfn_to_page(pml4e.pfn) + va.pml3_idx * sizeof(pml3e_t))>
  if (!pml3e.present)
    return 0;

  pml2e_t pml2e = read<pml2e_t>(_pfn_to_page(pml3e.pfn) + va.pml2_idx * sizeof(pml2e_t))>
  if (!pml2e.present)
    return 0;

  pml1e_t pml1e = read<pml1e_t>(_pfn_to_page(pml2e.pfn) + va.pml1_idx * sizeof(pml1e_t))>
  if (!pml1e.present)
    return 0;
  
  // finally return pfn + page offset...
  return (u8*)(_pfn_to_page(pml1e.pfn) + va.offset);
}
{% endhighlight %}

Both `PML3` and `PML2` can have large page entries, describing `1GB` and `2MB` pages respectively if `HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management\LargePageDrivers` is set. This is all outlined in my [header file.](https://gist.github.com/hLunaaa/f23a48775bbe5425b4825eefcebf1197) We call these `PML3e_LARGE` and `PML2e_LARGE`. So in page table `PML3`, entries can describe the `PML2` or a `1GB` page directly. Similarly, entries in `PML2` might describe the `PML1` or a `2MB` page directly. We can check for large page by checking the `PageSize` bit. I leave large page translation as an exercise to the reader.

<br>

### __Demonstration__
`PageView64` was created to visualize these structures. The program consists of the `PageView64.sys` driver and `PageView64.exe` client. The driver calls `MmCopyMemory` on `IRP`. We send the process ID and receive the `4KB` page tables. The client uses `ImGui` with `SFML`.

<video width="100%" controls="controls"><source src="/assets/PageView64.mp4"></video>

```

`_posts/2025-04-18-Exploring-CI.dll-and-Bigpool-Cache.markdown`:

```markdown
---
layout: post
title:  "Exploring CI.dll and Bigpool Cache"
date:   2025-04-18 03:12:41 +0200
---
<br>
### __Rationale__

Various kernel mappers like `KDMapper` use vulnerable drivers to load unsigned code into the kernel. If the driver does not already exist on the system, this is achieved by either creating a temporary file from embedded or streamed bytes in the first stage of the payload. Loading the driver leaves traces and telemetry in the `OS` that can be used in forensic analysis. As a result, sophisticated developers use techniques to clear as many of these traces as possible. In this post we briefly give an introduction to code integrity telemetry and image validation, as well as some other known traces and lists.

The `CI.dll` integrity module is responsible for authenticating and verifying the reliability of kernel modules. The kernel initializes it by calling `CiInitialize()`, which returns the `g_CiCallbacks` array. This list of callbacks is then used elsewhere in the kernel. For example, `CiValidateImageHeader()` is called when a driver is loaded to verify its signature.

![CiValidateImageHeader Call Stack](/assets/{FD14D6FB-2AEC-4018-9882-8ABCDAAA56CF}.png)

We navigate to `CiValidateImageHeader()` and follow the call into `CiInitializePhase2()`.

![CiInitializePhase2 Call](/assets/{7E18B9B6-F4C0-4701-A08C-B2A6CF97B269}.png)

Here, in `CiInitializePhase2()`, `CI.dll` creates the `g_CiEaCacheLookasideList` with a call to `ExInitializePagedLookasideList()` which has type `PAGED_LOOKASIDE_LIST`. See [documentation.](https://www.vergiliusproject.com/kernels/x64/windows-11/24h2/_PAGED_LOOKASIDE_LIST) This lookaside list tracks paged big pool (heap) allocations.

<br>
### __A Word on Pool Allocations__

Insiders are already aware that there are two (well, three) pool allocators: regular and big allocator. The regular allocator is used for any allocation less than or equal to a page in size, including the 32 byte pool header and initial free block. Big pool allocator is used when the size is more than one page, or when the pool type is `CacheAligned`. Crucially, big pool allocations dont have room for headers, and are instead tracked in the `PoolBigTable`.

![ExInitializePagedLookasideList Usage](/assets/image.png)

In the docs, we see field `ListEntry` which we use to iterate over the list. Interestingly, we also see `PoolType`, `Tag` and `Size`. We generate the signature `48 8D 0D ?? ?? ?? ?? C7 44 24` and walk.

{% highlight C++ %}
#pragma pack(push, 1)
struct ci_lookaside_t
{
  u8 pad0[0x24];
  u32 type;                 // +0x24
  u32 tag;                  // +0x28
  u32 size;                 // +0x2c
  u8 pad1[0x10];
  list_entry_t link;        // +0x40
};
#pragma pack(pop)
{% endhighlight %}

{% highlight C++ %}
void enum_ci_cache_lookaside(u8* ci_base)
{
  auto ci_cache = uti::ida_sig<ci_lookaside_t*>(ci_base, "48 8D 0D ?? ?? ?? ?? C7 44 24").rva(3,7);
  if (!ci_cache) // oopsie                                             	^^^^^^^^^^^
    return;
  
  for (auto it = ci_cache->link.f; it != &ci_cache->link; it = it->f)
  {
    auto it_entry = CONTAINING_RECORD(it, ci_lookaside_t, link);
    if (!it_entry)
      continue;

    auto it_tag = (u8*)(&it_entry->tag);
    DbgPrintEx(0, 0, "-- size: %6X type: %4X tag: %c%c%c%c\n",
      it_entry->size, it_entry->type, it_tag[0], it_tag[1], it_tag[2], it_tag[3]);
  }
}
{% endhighlight %}

We load the driver and run it. The type is `POOL_TYPE`, which is [documented.](https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ne-wdm-_pool_type) The output shows many `PagedPool` entries with varying sizes. `CI.dll` keeps track of a lot of interesting telemetry. There are many lists like `g_BootDriverList`, `g_CiValidationLookasideList`, `g_KernelHashBucketList` and `g_KernelHashBucketList`.

![Output](/assets/{83E0EFE6-C7EE-420A-92C1-590E6A2EE129}.png)

<br>
### __The Bottom Line__

The traditional way of dealing dealing with these lists is locking, deleting and creating them with `ExDeleteLookasideListEx()` and `ExInitializeLookasideListEx()`. But clearing lists which would otherwise include reference to legitimate drivers is suspicious. Indeed, the best approach is to walk every relevant list and unlinking references to your vulnerable driver.

In addition, `ntoskrnl` tracks additional telemetry like `PiDDBCacheTable`, `MmLastUnloadedDriver`, `MmUnloadedDrivers`. The more you dig, the more you uncover. All these lists, caches and trees are potential detection vectors. Advanced malware and cheats should consider all of them and more.
```

`_posts/2025-04-20-Inline-x86-Syscall-Abuse-on-x86_64-Systems.markdown`:

```markdown
---
layout: post
title:  "Inline x86 Syscall Abuse on x86_64 Systems"
date:   2025-04-20 05:12:41 +0200
---

<br>
### Rationale

Malware and cheats often call system API to do things. Calls like `VirtualAlloc` and `VirtualProtect` are routed through `NtAllocateVirtualMemory` and `NtProtectVirtualMemory` after some user mode checks in `Kernel32.dll`. However, using the highest level API can fall victim to user mode hooks.

For example, instrumentation callbacks are set using `NtSetInformationProcess`. By using the info class `ProcessInstrumentationCallback` & passing a `PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION` structure containing a callback function, we handle all syscalls coming from all threads. We can also use `TLS` and examine the return address and arguments of all syscalls, storing context as we do so.


<br>
### Briefly on Syscalls
When we perform a `syscall`, we request that the OS do something. On Windows version `NT6+`, these system calls are implemented in `ntoskrnl` and `win32k` in exported tables [`KiServiceTables`](https://hfiref0x.github.io/X86_64/NT6_syscalls.html) and [`W32pServiceTables`](https://hfiref0x.github.io/X86_64/NT6_w32ksyscalls.html) respectively.

We can use syscalls to bridge the user-kernel gap not covered by public APIs, though many opaque routines are mirrored renames of syscalls, often with some error checking and so on. The majority of syscalls are trampolined via `ntdll`. We disassemble any x86 syscall.

![Syscall Disasm](/assets/{07E01347-FB93-43D5-BB8E-3880096AEA4B}.png)

The routine first places the syscall index into `EAX`. It then does something peculiar. Because the x86 call is not native, the syscall is instead routed through a translation layer `Wow64SystemServiceCall`. Instead of containing the expected `SYSENTER` instruction, it jumps into 64-bit mode and issues a `SYSCALL`.

![Wow64 Translation](/assets/{1C4BCA20-5531-4364-B3D0-B45FF6EB2670}.png)

We want to retrieve the address of this function, place the syscall id in `EAX`, dynamically fix the stack and return. Instead of calling the `ntdll` export, we avoid any hooks, filters and callbacks and instead ship the call straight to kernel. We can do this by allocating executable memory, setting up the function and calling it on the go.

{% highlight C++ %}
u64 nt_wow64_transition(u8* nt_base)
{
  // 1. vv vv vv vv
  // BA A0 A0 31 4B       mov     edx, 4B31A0A0h
  // FF D2                call    edx

  // 2.    vv vv vv vv
  // FF 25 24 22 3B 4B    jmp      ds:_Wow64Transition
  return *uti::ida_sig<u64*>("BA ?? ?? ?? ?? FF D2 C2 34 00").ref(1).ref(2);
}

template<u32 id, typename... arg_t>
u32 nt_make_call(arg_t... args)
{
  u8 call_stub[15] = {
    0xb8, 0x00, 0x00, 0x00, 0x00,  // mov eax, ?? ?? ?? ??
    0xba, 0x00, 0x00, 0x00, 0x00,  // mov edx, ?? ?? ?? ??
    0xff, 0xd2,                    // call edx
    0xc2, 0x00, 0x00               // retn ?? ??
  };

  auto mem_alloc = VirtualAlloc(0, sizeof(call_stub), MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);
  if (!mem_alloc)
    return STATUS_UNSUCCESSFUL;

  *(u32*)(&call_stub[0x1]) = id;
  *(u32*)(&call_stub[0x6]) = nt_wow64_transition(LoadLibraryA("ntdll.dll")); // get wow64 translation
  *(u16*)(&call_stub[0xd]) = (sizeof(arg_t) + ...);

  for (size_t i = 0; i < sizeof(call_stub); i++) mem_alloc[i] = call_stub[i]; // write stub to RWX alloc

  auto ret_status = (u32(__stdcall*)(arg_t...))(args...);

  if (!VirtualFree(mem_alloc, sizeof(call_stub), MEM_RELEASE | MEM_DECOMMIT))
    return STATUS_UNSUCCESSFUL;

  return ret_status;
}
{% endhighlight %}

<br>
### Conclusion
With this method, we are able to call syscalls on the go without calling the `ntdll` trampoline methods. I leave further analysis of `Wow64Transition` as an exercise to the reader. The bottom line is that we are able to implement syscalling trivially, effectively getting around many of the checks and balances that would otherwise catch us - such as those previously mentioned.

Similar methods are available in 64-bit, but the technique must be somewhat adapted. I leave this, too, as an exercise to the reader. Syscalls are a very interesting mechanic of operating system design.
```

`_posts/2025-04-25-Bypassing-CR3-Abuse-with-Physical-RW copy.markdown`:

```markdown
---
layout: post
title:  "Bypassing CR3 Abuse with Physical R/W"
date:   2025-04-25 09:12:29 +0200
---

<br>
### Rationale

Some kernel mode anti-cheat solutions have now begun to obscure `KPROCESS.DirectoryTableBase` by effectively moving the address space via page table manipulation on startup. This prevents attaching to the real process space and makes it slightly more difficult for cheats and malware to to read/write the protected memory.

The problem? User processes were realistically already not able to interact with the protected memory, and kernel drivers and hypervisors have access to the underlying physical memory. Currently `EAC` and `VKG` implement some form of `CR3` abuse, but using monkey bruteforce™ we can walk all physical ranges and parse the `PML4`.

In theory, this can also be achieved from user mode as page tables are mapped to virtual memory with some assistance. We can even force a `TLB` flush using `SwitchToThread()`. The method relies on finding the self-referencing `PML4` entry, so the caller must have some level of access to the underlying physical memory, or leak non-exported names like `MmPteBase`, `MmPdeBase` and `MmPfnDatabase` which are used internally. More closely studying `MmGetVirtualForPhysical()` is recommended.

<br>
### Technique to Find Directory Table

We first cache the physical memory ranges. Here we can either call `MmGetPhysicalMemoryRanges()` or implement the same behavior ourselves. The [ReactOS](https://doxygen.reactos.org/d1/d6d/dynamic_8c.html#a4d2191536acfdbcab710579f81193527) source can help provide context, but obviously look at the disassembly of `MiReferencePageRuns()` as well.

When walking the pages, we assume the page is the correct `PML4` and attempt a translation using a known user address like `EPROCESS.SectionBaseAddress`.

{% highlight C++ %}
#define _pfn_to_page(pfn) (pfn << _page_shift)
#define _page_to_pfn(pfn) (pfn >> _page_shift)

u64 mm_find_process_cr3(EPROCESS* proc)
{
  auto physical_range = MmGetPhysicalMemoryRanges(); // free with ExFreePool
  if (!physical_range)
    return 0;

  // for every physical range
  // for every page
  // for every page table entry -- self-ref can have any idx  

  virt_addr_t mz_base;
  mz_base.val = (u64)proc->SectionBaseAddress;

  do {
    u64 src = (u64)(physical_range->BaseAddress);
    u64 dst = (u64)(physical_range->BaseAddress) + (u64)(physical_range->NumberOfBytes);

    for (u64 it = src; it < dst; it += PAGE_SIZE) 
    for (u32 pml4e_idx = 0; pml4e_idx < 512; pml4e_idx++)
    {
      auto self_ref = read<pml4e_t>(it + pml4e_idx * sizeof(pml4e_t));
      if (it != _pfn_to_page(self_ref.pfn)) // self-ref?
        continue;

      // ok - attempt translation
      auto pml4e = read<pml4e_t>(it + mz_base.pml4_idx * sizeof(pml4e_t));
      if (!pml4e.present)
        break; // bad cr3, check next page...

      auto pml3e = read<pml3e_t>(_pfn_to_page(pml4e.pfn) + mz_base.pml3_idx * sizeof(pml3e_t));
      if (!pml3e.present)
        break;

      auto pml2e = read<pml2e_t>(_pfn_to_page(pml3e.pfn) + mz_base.pml2_idx * sizeof(pml2e_t));
      if (!pml2e.present)
        break;

      auto pml1e = read<pml1e_t>(_pfn_to_page(pml2e.pfn) + mz_base.pml1_idx * sizeof(pml1e_t));
      if (!pml1e.present)
        break;
      
      if (read<u16>(_pfn_to_page(pml1e.pfn) + mz_base.offset) != 'ZM') // check PE magic
        break;
      
      return _page_to_pfn(it); // found cr3!
    }
    physical_range++;
  } while (physical_range->BaseAddress);
}
{% endhighlight %}

<br>
### The Result

There's a lot more you can do in the way of filtering out bad pages before running expensive read operations, but I leave this as an exercise to the reader. In any case, this serves as a good proof of concept. Keep in mind that the latest `Virtualization Based Security` or `VBS` enforces read-only state at the hypervisor level via `Second Level Address Translation` or `SLAT`. However, other values like page frame number remain unprotected. This will be discussed in a separate post in the future.

![Driver Output](/assets/image2.png)
```

`_site/2025/04/17/Minesweeper-Classic-ESP.html`:

```html
<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Minesweeper Classic ESP | hLunaaa</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Minesweeper Classic ESP" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Minesweeper is a fun little game about clicking squares and avoiding bombs. But I’ve always wondered how it works under the hood. A grid game. There’s probably a bitmap somewhere." />
<meta property="og:description" content="Minesweeper is a fun little game about clicking squares and avoiding bombs. But I’ve always wondered how it works under the hood. A grid game. There’s probably a bitmap somewhere." />
<link rel="canonical" href="http://localhost:4000/2025/04/17/Minesweeper-Classic-ESP.html" />
<meta property="og:url" content="http://localhost:4000/2025/04/17/Minesweeper-Classic-ESP.html" />
<meta property="og:site_name" content="hLunaaa" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-04-17T09:19:42+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Minesweeper Classic ESP" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-04-17T09:19:42+02:00","datePublished":"2025-04-17T09:19:42+02:00","description":"Minesweeper is a fun little game about clicking squares and avoiding bombs. But I’ve always wondered how it works under the hood. A grid game. There’s probably a bitmap somewhere.","headline":"Minesweeper Classic ESP","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2025/04/17/Minesweeper-Classic-ESP.html"},"url":"http://localhost:4000/2025/04/17/Minesweeper-Classic-ESP.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="hLunaaa" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">hLunaaa</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Minesweeper Classic ESP</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-04-17T09:19:42+02:00" itemprop="datePublished">Apr 17, 2025
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Minesweeper is a fun little game about clicking squares and avoiding bombs. But I’ve always wondered how it works under the hood. A grid game. There’s probably a bitmap somewhere.</p>

<p>In the context menu we can create a custom came by setting width, height and number of bombs. I attach a debugger and see where these are accessed. They bring me to the function responsible for showing the dialog <code class="language-plaintext highlighter-rouge">winmine.hlp</code>. We rename the variables.</p>

<p><img src="/assets/{AB29194B-780E-4E52-A8D0-86B679B54278}.png" alt="" /></p>

<p>By cross referencing where these are used we find multiple functions. Some store the custom game values to registry keys, others load defaults on startup. We also find an interesting function that loops, reducing the bomb count on each iteration.</p>

<p><img src="/assets/{FB211914-8E66-435F-9BAD-01036C06A600}.png" alt="" /></p>

<p>At this point it is quite clear what this function does. We loop over the bitmap, setting the bomb flag <code class="language-plaintext highlighter-rouge">0x80</code> at random using <code class="language-plaintext highlighter-rouge">rand</code>. We see the bitmap stride <code class="language-plaintext highlighter-rouge">32 * Y + X</code>, with <code class="language-plaintext highlighter-rouge">X</code> and <code class="language-plaintext highlighter-rouge">Y</code> starting at <code class="language-plaintext highlighter-rouge">1</code>. With this information, we are able to read the bitmap and check for bomb flags.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">void</span> <span class="nf">loop_draw_esp</span><span class="p">(</span><span class="n">u8</span><span class="o">*</span> <span class="n">game</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">u32</span> <span class="n">hdc</span> <span class="o">=</span> <span class="n">GetDC</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// lazy, grab the entire screen</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdc</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="n">game</span> <span class="o">+</span> <span class="mh">0x5164</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// should clock start (is playing?)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="n">u32</span> <span class="n">win_x</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="n">game</span> <span class="o">+</span> <span class="mh">0x56B0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">18</span><span class="p">;</span>
  <span class="n">u32</span> <span class="n">win_y</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="n">game</span> <span class="o">+</span> <span class="mh">0x56B4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">105</span><span class="p">;</span> <span class="c1">// window pos + offset to tile grid</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">u32</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="n">game</span> <span class="o">+</span> <span class="mh">0x5338</span><span class="p">);</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">u32</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="n">game</span> <span class="o">+</span> <span class="mh">0x5334</span><span class="p">);</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="c1">// walk coords</span>
  <span class="p">{</span>
    <span class="n">u32</span> <span class="n">tile</span> <span class="o">=</span> <span class="p">(</span><span class="n">game</span> <span class="o">+</span> <span class="mh">0x5340</span><span class="p">)[</span><span class="mi">32</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">x</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tile</span> <span class="o">&amp;</span> <span class="mh">0x80u</span><span class="p">)</span> <span class="c1">// has bomb?</span>
      <span class="n">draw_tile</span><span class="p">(</span><span class="n">hdc</span><span class="p">,</span> <span class="n">win_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">15</span><span class="p">,</span> <span class="n">win_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">15</span><span class="p">,</span> <span class="n">RGB</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">ReleaseDC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hdc</span><span class="p">);</span>
  <span class="n">Sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>It really is that shrimple. We inject and play. This is the result.</p>

<p><img src="/assets/{EAB758A4-2E16-4FE7-929F-726D7CB065AB}.png" alt="" /></p>

  </div><a class="u-url" href="/2025/04/17/Minesweeper-Classic-ESP.html" hidden></a>
</article>

      </div>
    </main></body>

</html>

```

`_site/2025/04/17/PageView64.html`:

```html
<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>PageView64 Dynamic IA32e Paging Structure Explorer | hLunaaa</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="PageView64 Dynamic IA32e Paging Structure Explorer" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Paging is a system which allows each process to see a full virtual address space, without actually requiring the full amount of physical memory to be available or present. 32-bit x86 processors support 32-bit virtual addresses and 4-GiB virtual address spaces, and current 64-bit processors support 48-bit virtual addressing and 256-TiB virtual address spaces. - OSDev Wiki" />
<meta property="og:description" content="Paging is a system which allows each process to see a full virtual address space, without actually requiring the full amount of physical memory to be available or present. 32-bit x86 processors support 32-bit virtual addresses and 4-GiB virtual address spaces, and current 64-bit processors support 48-bit virtual addressing and 256-TiB virtual address spaces. - OSDev Wiki" />
<link rel="canonical" href="http://localhost:4000/2025/04/17/PageView64.html" />
<meta property="og:url" content="http://localhost:4000/2025/04/17/PageView64.html" />
<meta property="og:site_name" content="hLunaaa" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-04-17T07:19:42+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="PageView64 Dynamic IA32e Paging Structure Explorer" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-04-17T07:19:42+02:00","datePublished":"2025-04-17T07:19:42+02:00","description":"Paging is a system which allows each process to see a full virtual address space, without actually requiring the full amount of physical memory to be available or present. 32-bit x86 processors support 32-bit virtual addresses and 4-GiB virtual address spaces, and current 64-bit processors support 48-bit virtual addressing and 256-TiB virtual address spaces. - OSDev Wiki","headline":"PageView64 Dynamic IA32e Paging Structure Explorer","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2025/04/17/PageView64.html"},"url":"http://localhost:4000/2025/04/17/PageView64.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="hLunaaa" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">hLunaaa</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">PageView64 Dynamic IA32e Paging Structure Explorer</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-04-17T07:19:42+02:00" itemprop="datePublished">Apr 17, 2025
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <blockquote>
  <p>Paging is a system which allows each process to see a full virtual address space, without actually requiring the full amount of physical memory to be available or present. 32-bit x86 processors support 32-bit virtual addresses and 4-GiB virtual address spaces, and current 64-bit processors support 48-bit virtual addressing and 256-TiB virtual address spaces.
<br />- <a href="https://wiki.osdev.org/Paging#64-Bit_Paging">OSDev Wiki</a></p>
</blockquote>

<p><br /></p>
<h3 id="rationale"><strong>Rationale</strong></h3>
<p>For a long time I struggled to visualize <code class="language-plaintext highlighter-rouge">IA32e</code> paging structures in my head. I always viewed paging as redundant. You’d think paging redundant on modern systems. Indeed, it is possible to implement virtual addressing, protection and session spacing with identity mapping.</p>

<p>The argument for memory efficiency is also not very convincing, but there aren’t many reasons for Microsoft to mess with things that already work well enough, not to mention that paging as a concept is more a vertical issue than just software alone.</p>

<p>From the malware perspective, acting on the underlying physical memory is far more powerful than using official <code class="language-plaintext highlighter-rouge">API</code> to adjust virtual memory. We are able to get around many of the restrictions placed on virtual memory. We can ignore session spacing and page protection. We can construct our own paging structures and allocate memory hidden from the <code class="language-plaintext highlighter-rouge">Virtual Address Descriptor</code> or <code class="language-plaintext highlighter-rouge">VAD</code>.</p>

<p>The following diagram describes the layout of an <code class="language-plaintext highlighter-rouge">IA32e</code> virtual address.</p>

<p><img src="/assets/4_level_paging.png" alt="IA32e Paging Overview" /></p>

<p>Each page table is a list of <code class="language-plaintext highlighter-rouge">512</code> addresses. The first <code class="language-plaintext highlighter-rouge">256</code> are reserved for user addresses. There are four page tables. Also consider that <code class="language-plaintext highlighter-rouge">512 * sizeof(uintptr_t) == PAGE_SIZE</code>. The base physical address of the <code class="language-plaintext highlighter-rouge">PML4</code> is described by <code class="language-plaintext highlighter-rouge">EPROCESS.DirectoryTableBase</code>.</p>

<p><br /></p>
<h3 id="address-translation"><strong>Address Translation</strong></h3>
<p>Paging relates to session spacing. When a thread goes from one address space to another via <code class="language-plaintext highlighter-rouge">SwapContext</code>, the <code class="language-plaintext highlighter-rouge">CR3</code> is set. When the <code class="language-plaintext highlighter-rouge">CPU</code> wants to translate a physical address, it first checks if the translation already exists in the <code class="language-plaintext highlighter-rouge">Translation Lookaside Buffer</code> or <code class="language-plaintext highlighter-rouge">TLB</code>. If no translation exists, it walks the page tables.</p>

<blockquote>
  <p>Paging in long mode is similar to that of 32-bit paging, except Physical Address Extension (PAE) is required. Registers CR2 and CR3 are extended to 64 bits. Instead of just having to utilize 3 levels of page maps: page directory pointer table, page directory, and page table, a fourth page-map table is used: the level-4 page map table (PML4). This allows a processor to map 48-bit virtual addresses to 52-bit physical addresses.
<br />- <a href="https://wiki.osdev.org/Paging#64-Bit_Paging">OSDev Wiki</a></p>
</blockquote>

<p>As a sidenote, you can flush the <code class="language-plaintext highlighter-rouge">TLB</code> by toggling the <code class="language-plaintext highlighter-rouge">CR4.PGE</code> bit or firing the <code class="language-plaintext highlighter-rouge">INVLPG</code> instruction. User mode applications can use <code class="language-plaintext highlighter-rouge">SwitchToThread()</code> to force a context switch.</p>

<p>A word on naming conventions. Four-level paging is implemented in both <code class="language-plaintext highlighter-rouge">IA32e</code> and <code class="language-plaintext highlighter-rouge">AMD64</code>, but with different naming schemes. This often leads to confusion. In this paper we simplify to <code class="language-plaintext highlighter-rouge">PML4</code>, <code class="language-plaintext highlighter-rouge">PML3</code>, <code class="language-plaintext highlighter-rouge">PML2</code> and <code class="language-plaintext highlighter-rouge">PML1</code>.</p>

<p>We translate by walking down the chain.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#define _pfn_to_page(pfn) (pfn &lt;&lt; _page_shift)
</span>
<span class="n">u8</span><span class="o">*</span> <span class="nf">vtop</span><span class="p">(</span><span class="n">EPROCESS</span><span class="o">*</span> <span class="n">proc</span><span class="p">,</span> <span class="n">virt_addr_t</span> <span class="n">va</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// read from proc, but if it is currentproc we can obv __readcr3</span>
  <span class="c1">// procs can also obscure the DirectoryTableBase with tricks</span>
  <span class="n">pml4e_t</span> <span class="n">pml4e</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml4e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">DirectoryTableBase</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">va</span><span class="p">.</span><span class="n">pml4_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml4e_t</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pml4e</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  
  <span class="n">pml3e_t</span> <span class="n">pml3e</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml3e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">pml4e</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">va</span><span class="p">.</span><span class="n">pml3_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml3e_t</span><span class="p">))</span><span class="o">&gt;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pml3e</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">pml2e_t</span> <span class="n">pml2e</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml2e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">pml3e</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">va</span><span class="p">.</span><span class="n">pml2_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml2e_t</span><span class="p">))</span><span class="o">&gt;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pml2e</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">pml1e_t</span> <span class="n">pml1e</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml1e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">pml2e</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">va</span><span class="p">.</span><span class="n">pml1_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml1e_t</span><span class="p">))</span><span class="o">&gt;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pml1e</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  
  <span class="c1">// finally return pfn + page offset...</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">pml1e</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">va</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Both <code class="language-plaintext highlighter-rouge">PML3</code> and <code class="language-plaintext highlighter-rouge">PML2</code> can have large page entries, describing <code class="language-plaintext highlighter-rouge">1GB</code> and <code class="language-plaintext highlighter-rouge">2MB</code> pages respectively if <code class="language-plaintext highlighter-rouge">HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management\LargePageDrivers</code> is set. This is all outlined in my <a href="https://gist.github.com/hLunaaa/f23a48775bbe5425b4825eefcebf1197">header file.</a> We call these <code class="language-plaintext highlighter-rouge">PML3e_LARGE</code> and <code class="language-plaintext highlighter-rouge">PML2e_LARGE</code>. So in page table <code class="language-plaintext highlighter-rouge">PML3</code>, entries can describe the <code class="language-plaintext highlighter-rouge">PML2</code> or a <code class="language-plaintext highlighter-rouge">1GB</code> page directly. Similarly, entries in <code class="language-plaintext highlighter-rouge">PML2</code> might describe the <code class="language-plaintext highlighter-rouge">PML1</code> or a <code class="language-plaintext highlighter-rouge">2MB</code> page directly. We can check for large page by checking the <code class="language-plaintext highlighter-rouge">PageSize</code> bit. I leave large page translation as an exercise to the reader.</p>

<p><br /></p>

<h3 id="demonstration"><strong>Demonstration</strong></h3>
<p><code class="language-plaintext highlighter-rouge">PageView64</code> was created to visualize these structures. The program consists of the <code class="language-plaintext highlighter-rouge">PageView64.sys</code> driver and <code class="language-plaintext highlighter-rouge">PageView64.exe</code> client. The driver calls <code class="language-plaintext highlighter-rouge">MmCopyMemory</code> on <code class="language-plaintext highlighter-rouge">IRP</code>. We send the process ID and receive the <code class="language-plaintext highlighter-rouge">4KB</code> page tables. The client uses <code class="language-plaintext highlighter-rouge">ImGui</code> with <code class="language-plaintext highlighter-rouge">SFML</code>.</p>

<video width="100%" controls="controls"><source src="/assets/PageView64.mp4" /></video>

  </div><a class="u-url" href="/2025/04/17/PageView64.html" hidden></a>
</article>

      </div>
    </main></body>

</html>

```

`_site/2025/04/18/Exploring-CI.dll-and-Bigpool-Cache.html`:

```html
<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Exploring CI.dll and Bigpool Cache | hLunaaa</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Exploring CI.dll and Bigpool Cache" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Rationale" />
<meta property="og:description" content="Rationale" />
<link rel="canonical" href="http://localhost:4000/2025/04/18/Exploring-CI.dll-and-Bigpool-Cache.html" />
<meta property="og:url" content="http://localhost:4000/2025/04/18/Exploring-CI.dll-and-Bigpool-Cache.html" />
<meta property="og:site_name" content="hLunaaa" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-04-18T03:12:41+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Exploring CI.dll and Bigpool Cache" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-04-18T03:12:41+02:00","datePublished":"2025-04-18T03:12:41+02:00","description":"Rationale","headline":"Exploring CI.dll and Bigpool Cache","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2025/04/18/Exploring-CI.dll-and-Bigpool-Cache.html"},"url":"http://localhost:4000/2025/04/18/Exploring-CI.dll-and-Bigpool-Cache.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="hLunaaa" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">hLunaaa</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Exploring CI.dll and Bigpool Cache</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-04-18T03:12:41+02:00" itemprop="datePublished">Apr 18, 2025
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><br /></p>
<h3 id="rationale"><strong>Rationale</strong></h3>

<p>Various kernel mappers like <code class="language-plaintext highlighter-rouge">KDMapper</code> use vulnerable drivers to load unsigned code into the kernel. If the driver does not already exist on the system, this is achieved by either creating a temporary file from embedded or streamed bytes in the first stage of the payload. Loading the driver leaves traces and telemetry in the <code class="language-plaintext highlighter-rouge">OS</code> that can be used in forensic analysis. As a result, sophisticated developers use techniques to clear as many of these traces as possible. In this post we briefly give an introduction to code integrity telemetry and image validation, as well as some other known traces and lists.</p>

<p>The <code class="language-plaintext highlighter-rouge">CI.dll</code> integrity module is responsible for authenticating and verifying the reliability of kernel modules. The kernel initializes it by calling <code class="language-plaintext highlighter-rouge">CiInitialize()</code>, which returns the <code class="language-plaintext highlighter-rouge">g_CiCallbacks</code> array. This list of callbacks is then used elsewhere in the kernel. For example, <code class="language-plaintext highlighter-rouge">CiValidateImageHeader()</code> is called when a driver is loaded to verify its signature.</p>

<p><img src="/assets/{FD14D6FB-2AEC-4018-9882-8ABCDAAA56CF}.png" alt="CiValidateImageHeader Call Stack" /></p>

<p>We navigate to <code class="language-plaintext highlighter-rouge">CiValidateImageHeader()</code> and follow the call into <code class="language-plaintext highlighter-rouge">CiInitializePhase2()</code>.</p>

<p><img src="/assets/{7E18B9B6-F4C0-4701-A08C-B2A6CF97B269}.png" alt="CiInitializePhase2 Call" /></p>

<p>Here, in <code class="language-plaintext highlighter-rouge">CiInitializePhase2()</code>, <code class="language-plaintext highlighter-rouge">CI.dll</code> creates the <code class="language-plaintext highlighter-rouge">g_CiEaCacheLookasideList</code> with a call to <code class="language-plaintext highlighter-rouge">ExInitializePagedLookasideList()</code> which has type <code class="language-plaintext highlighter-rouge">PAGED_LOOKASIDE_LIST</code>. See <a href="https://www.vergiliusproject.com/kernels/x64/windows-11/24h2/_PAGED_LOOKASIDE_LIST">documentation.</a> This lookaside list tracks paged big pool (heap) allocations.</p>

<p><br /></p>
<h3 id="a-word-on-pool-allocations"><strong>A Word on Pool Allocations</strong></h3>

<p>Insiders are already aware that there are two (well, three) pool allocators: regular and big allocator. The regular allocator is used for any allocation less than or equal to a page in size, including the 32 byte pool header and initial free block. Big pool allocator is used when the size is more than one page, or when the pool type is <code class="language-plaintext highlighter-rouge">CacheAligned</code>. Crucially, big pool allocations dont have room for headers, and are instead tracked in the <code class="language-plaintext highlighter-rouge">PoolBigTable</code>.</p>

<p><img src="/assets/image.png" alt="ExInitializePagedLookasideList Usage" /></p>

<p>In the docs, we see field <code class="language-plaintext highlighter-rouge">ListEntry</code> which we use to iterate over the list. Interestingly, we also see <code class="language-plaintext highlighter-rouge">PoolType</code>, <code class="language-plaintext highlighter-rouge">Tag</code> and <code class="language-plaintext highlighter-rouge">Size</code>. We generate the signature <code class="language-plaintext highlighter-rouge">48 8D 0D ?? ?? ?? ?? C7 44 24</code> and walk.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#pragma pack(push, 1)
</span><span class="k">struct</span> <span class="nc">ci_lookaside_t</span>
<span class="p">{</span>
  <span class="n">u8</span> <span class="n">pad0</span><span class="p">[</span><span class="mh">0x24</span><span class="p">];</span>
  <span class="n">u32</span> <span class="n">type</span><span class="p">;</span>                 <span class="c1">// +0x24</span>
  <span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>                  <span class="c1">// +0x28</span>
  <span class="n">u32</span> <span class="n">size</span><span class="p">;</span>                 <span class="c1">// +0x2c</span>
  <span class="n">u8</span> <span class="n">pad1</span><span class="p">[</span><span class="mh">0x10</span><span class="p">];</span>
  <span class="n">list_entry_t</span> <span class="n">link</span><span class="p">;</span>        <span class="c1">// +0x40</span>
<span class="p">};</span>
<span class="cp">#pragma pack(pop)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">void</span> <span class="nf">enum_ci_cache_lookaside</span><span class="p">(</span><span class="n">u8</span><span class="o">*</span> <span class="n">ci_base</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">auto</span> <span class="n">ci_cache</span> <span class="o">=</span> <span class="n">uti</span><span class="o">::</span><span class="n">ida_sig</span><span class="o">&lt;</span><span class="n">ci_lookaside_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">ci_base</span><span class="p">,</span> <span class="s">"48 8D 0D ?? ?? ?? ?? C7 44 24"</span><span class="p">).</span><span class="n">rva</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ci_cache</span><span class="p">)</span> <span class="c1">// oopsie                                             	^^^^^^^^^^^</span>
    <span class="k">return</span><span class="p">;</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">ci_cache</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">f</span><span class="p">;</span> <span class="n">it</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">ci_cache</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">auto</span> <span class="n">it_entry</span> <span class="o">=</span> <span class="n">CONTAINING_RECORD</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">ci_lookaside_t</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">it_entry</span><span class="p">)</span>
      <span class="k">continue</span><span class="p">;</span>

    <span class="k">auto</span> <span class="n">it_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">it_entry</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
    <span class="n">DbgPrintEx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"-- size: %6X type: %4X tag: %c%c%c%c</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
      <span class="n">it_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">it_entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">it_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">it_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">it_tag</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">it_tag</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>We load the driver and run it. The type is <code class="language-plaintext highlighter-rouge">POOL_TYPE</code>, which is <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ne-wdm-_pool_type">documented.</a> The output shows many <code class="language-plaintext highlighter-rouge">PagedPool</code> entries with varying sizes. <code class="language-plaintext highlighter-rouge">CI.dll</code> keeps track of a lot of interesting telemetry. There are many lists like <code class="language-plaintext highlighter-rouge">g_BootDriverList</code>, <code class="language-plaintext highlighter-rouge">g_CiValidationLookasideList</code>, <code class="language-plaintext highlighter-rouge">g_KernelHashBucketList</code> and <code class="language-plaintext highlighter-rouge">g_KernelHashBucketList</code>.</p>

<p><img src="/assets/{83E0EFE6-C7EE-420A-92C1-590E6A2EE129}.png" alt="Output" /></p>

<p><br /></p>
<h3 id="the-bottom-line"><strong>The Bottom Line</strong></h3>

<p>The traditional way of dealing dealing with these lists is locking, deleting and creating them with <code class="language-plaintext highlighter-rouge">ExDeleteLookasideListEx()</code> and <code class="language-plaintext highlighter-rouge">ExInitializeLookasideListEx()</code>. But clearing lists which would otherwise include reference to legitimate drivers is suspicious. Indeed, the best approach is to walk every relevant list and unlinking references to your vulnerable driver.</p>

<p>In addition, <code class="language-plaintext highlighter-rouge">ntoskrnl</code> tracks additional telemetry like <code class="language-plaintext highlighter-rouge">PiDDBCacheTable</code>, <code class="language-plaintext highlighter-rouge">MmLastUnloadedDriver</code>, <code class="language-plaintext highlighter-rouge">MmUnloadedDrivers</code>. The more you dig, the more you uncover. All these lists, caches and trees are potential detection vectors. Advanced malware and cheats should consider all of them and more.</p>

  </div><a class="u-url" href="/2025/04/18/Exploring-CI.dll-and-Bigpool-Cache.html" hidden></a>
</article>

      </div>
    </main></body>

</html>

```

`_site/2025/04/20/Inline-x86-Syscall-Abuse-on-x86_64-Systems.html`:

```html
<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Inline x86 Syscall Abuse on x86_64 Systems | hLunaaa</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Inline x86 Syscall Abuse on x86_64 Systems" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Rationale" />
<meta property="og:description" content="Rationale" />
<link rel="canonical" href="http://localhost:4000/2025/04/20/Inline-x86-Syscall-Abuse-on-x86_64-Systems.html" />
<meta property="og:url" content="http://localhost:4000/2025/04/20/Inline-x86-Syscall-Abuse-on-x86_64-Systems.html" />
<meta property="og:site_name" content="hLunaaa" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-04-20T05:12:41+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Inline x86 Syscall Abuse on x86_64 Systems" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-04-20T05:12:41+02:00","datePublished":"2025-04-20T05:12:41+02:00","description":"Rationale","headline":"Inline x86 Syscall Abuse on x86_64 Systems","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2025/04/20/Inline-x86-Syscall-Abuse-on-x86_64-Systems.html"},"url":"http://localhost:4000/2025/04/20/Inline-x86-Syscall-Abuse-on-x86_64-Systems.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="hLunaaa" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">hLunaaa</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Inline x86 Syscall Abuse on x86_64 Systems</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-04-20T05:12:41+02:00" itemprop="datePublished">Apr 20, 2025
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><br /></p>
<h3 id="rationale">Rationale</h3>

<p>Malware and cheats often call system API to do things. Calls like <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> and <code class="language-plaintext highlighter-rouge">VirtualProtect</code> are routed through <code class="language-plaintext highlighter-rouge">NtAllocateVirtualMemory</code> and <code class="language-plaintext highlighter-rouge">NtProtectVirtualMemory</code> after some user mode checks in <code class="language-plaintext highlighter-rouge">Kernel32.dll</code>. However, using the highest level API can fall victim to user mode hooks.</p>

<p>For example, instrumentation callbacks are set using <code class="language-plaintext highlighter-rouge">NtSetInformationProcess</code>. By using the info class <code class="language-plaintext highlighter-rouge">ProcessInstrumentationCallback</code> &amp; passing a <code class="language-plaintext highlighter-rouge">PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION</code> structure containing a callback function, we handle all syscalls coming from all threads. We can also use <code class="language-plaintext highlighter-rouge">TLS</code> and examine the return address and arguments of all syscalls, storing context as we do so.</p>

<p><br /></p>
<h3 id="briefly-on-syscalls">Briefly on Syscalls</h3>
<p>When we perform a <code class="language-plaintext highlighter-rouge">syscall</code>, we request that the OS do something. On Windows version <code class="language-plaintext highlighter-rouge">NT6+</code>, these system calls are implemented in <code class="language-plaintext highlighter-rouge">ntoskrnl</code> and <code class="language-plaintext highlighter-rouge">win32k</code> in exported tables <a href="https://hfiref0x.github.io/X86_64/NT6_syscalls.html"><code class="language-plaintext highlighter-rouge">KiServiceTables</code></a> and <a href="https://hfiref0x.github.io/X86_64/NT6_w32ksyscalls.html"><code class="language-plaintext highlighter-rouge">W32pServiceTables</code></a> respectively.</p>

<p>We can use syscalls to bridge the user-kernel gap not covered by public APIs, though many opaque routines are mirrored renames of syscalls, often with some error checking and so on. The majority of syscalls are trampolined via <code class="language-plaintext highlighter-rouge">ntdll</code>. We disassemble any x86 syscall.</p>

<p><img src="/assets/{07E01347-FB93-43D5-BB8E-3880096AEA4B}.png" alt="Syscall Disasm" /></p>

<p>The routine first places the syscall index into <code class="language-plaintext highlighter-rouge">EAX</code>. It then does something peculiar. Because the x86 call is not native, the syscall is instead routed through a translation layer <code class="language-plaintext highlighter-rouge">Wow64SystemServiceCall</code>. Instead of containing the expected <code class="language-plaintext highlighter-rouge">SYSENTER</code> instruction, it jumps into 64-bit mode and issues a <code class="language-plaintext highlighter-rouge">SYSCALL</code>.</p>

<p><img src="/assets/{1C4BCA20-5531-4364-B3D0-B45FF6EB2670}.png" alt="Wow64 Translation" /></p>

<p>We want to retrieve the address of this function, place the syscall id in <code class="language-plaintext highlighter-rouge">EAX</code>, dynamically fix the stack and return. Instead of calling the <code class="language-plaintext highlighter-rouge">ntdll</code> export, we avoid any hooks, filters and callbacks and instead ship the call straight to kernel. We can do this by allocating executable memory, setting up the function and calling it on the go.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">u64</span> <span class="nf">nt_wow64_transition</span><span class="p">(</span><span class="n">u8</span><span class="o">*</span> <span class="n">nt_base</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// 1. vv vv vv vv</span>
  <span class="c1">// BA A0 A0 31 4B       mov     edx, 4B31A0A0h</span>
  <span class="c1">// FF D2                call    edx</span>

  <span class="c1">// 2.    vv vv vv vv</span>
  <span class="c1">// FF 25 24 22 3B 4B    jmp      ds:_Wow64Transition</span>
  <span class="k">return</span> <span class="o">*</span><span class="n">uti</span><span class="o">::</span><span class="n">ida_sig</span><span class="o">&lt;</span><span class="n">u64</span><span class="o">*&gt;</span><span class="p">(</span><span class="s">"BA ?? ?? ?? ?? FF D2 C2 34 00"</span><span class="p">).</span><span class="n">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">ref</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="k">typename</span><span class="o">...</span> <span class="nc">arg_t</span><span class="p">&gt;</span>
<span class="n">u32</span> <span class="nf">nt_make_call</span><span class="p">(</span><span class="n">arg_t</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">u8</span> <span class="n">call_stub</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>  <span class="c1">// mov eax, ?? ?? ?? ??</span>
    <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>  <span class="c1">// mov edx, ?? ?? ?? ??</span>
    <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span>                    <span class="c1">// call edx</span>
    <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>               <span class="c1">// retn ?? ??</span>
  <span class="p">};</span>

  <span class="k">auto</span> <span class="n">mem_alloc</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">call_stub</span><span class="p">),</span> <span class="n">MEM_RESERVE</span> <span class="o">|</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_alloc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">STATUS_UNSUCCESSFUL</span><span class="p">;</span>

  <span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">call_stub</span><span class="p">[</span><span class="mh">0x1</span><span class="p">])</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">call_stub</span><span class="p">[</span><span class="mh">0x6</span><span class="p">])</span> <span class="o">=</span> <span class="n">nt_wow64_transition</span><span class="p">(</span><span class="n">LoadLibraryA</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">));</span> <span class="c1">// get wow64 translation</span>
  <span class="o">*</span><span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">call_stub</span><span class="p">[</span><span class="mh">0xd</span><span class="p">])</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">arg_t</span><span class="p">)</span> <span class="o">+</span> <span class="p">...);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">call_stub</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">mem_alloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">call_stub</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="c1">// write stub to RWX alloc</span>

  <span class="k">auto</span> <span class="n">ret_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">(</span><span class="kr">__stdcall</span><span class="o">*</span><span class="p">)(</span><span class="n">arg_t</span><span class="p">...))(</span><span class="n">args</span><span class="p">...);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">VirtualFree</span><span class="p">(</span><span class="n">mem_alloc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">call_stub</span><span class="p">),</span> <span class="n">MEM_RELEASE</span> <span class="o">|</span> <span class="n">MEM_DECOMMIT</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">STATUS_UNSUCCESSFUL</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">ret_status</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>
<h3 id="conclusion">Conclusion</h3>
<p>With this method, we are able to call syscalls on the go without calling the <code class="language-plaintext highlighter-rouge">ntdll</code> trampoline methods. I leave further analysis of <code class="language-plaintext highlighter-rouge">Wow64Transition</code> as an exercise to the reader. The bottom line is that we are able to implement syscalling trivially, effectively getting around many of the checks and balances that would otherwise catch us - such as those previously mentioned.</p>

<p>Similar methods are available in 64-bit, but the technique must be somewhat adapted. I leave this, too, as an exercise to the reader. Syscalls are a very interesting mechanic of operating system design.</p>

  </div><a class="u-url" href="/2025/04/20/Inline-x86-Syscall-Abuse-on-x86_64-Systems.html" hidden></a>
</article>

      </div>
    </main></body>

</html>

```

`_site/2025/04/25/Bypassing-CR3-Abuse-with-Physical-RW-copy.html`:

```html
<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Bypassing CR3 Abuse with Physical R/W | hLunaaa</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Bypassing CR3 Abuse with Physical R/W" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Rationale" />
<meta property="og:description" content="Rationale" />
<link rel="canonical" href="http://localhost:4000/2025/04/25/Bypassing-CR3-Abuse-with-Physical-RW-copy.html" />
<meta property="og:url" content="http://localhost:4000/2025/04/25/Bypassing-CR3-Abuse-with-Physical-RW-copy.html" />
<meta property="og:site_name" content="hLunaaa" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-04-25T09:12:29+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bypassing CR3 Abuse with Physical R/W" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-04-25T09:12:29+02:00","datePublished":"2025-04-25T09:12:29+02:00","description":"Rationale","headline":"Bypassing CR3 Abuse with Physical R/W","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2025/04/25/Bypassing-CR3-Abuse-with-Physical-RW-copy.html"},"url":"http://localhost:4000/2025/04/25/Bypassing-CR3-Abuse-with-Physical-RW-copy.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="hLunaaa" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">hLunaaa</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Bypassing CR3 Abuse with Physical R/W</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-04-25T09:12:29+02:00" itemprop="datePublished">Apr 25, 2025
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><br /></p>
<h3 id="rationale">Rationale</h3>

<p>Some kernel mode anti-cheat solutions have now begun to obscure <code class="language-plaintext highlighter-rouge">KPROCESS.DirectoryTableBase</code> by effectively moving the address space via page table manipulation on startup. This prevents attaching to the real process space and makes it slightly more difficult for cheats and malware to to read/write the protected memory.</p>

<p>The problem? User processes were realistically already not able to interact with the protected memory, and kernel drivers and hypervisors have access to the underlying physical memory. Currently <code class="language-plaintext highlighter-rouge">EAC</code> and <code class="language-plaintext highlighter-rouge">VKG</code> implement some form of <code class="language-plaintext highlighter-rouge">CR3</code> abuse, but using monkey bruteforce™ we can walk all physical ranges and parse the <code class="language-plaintext highlighter-rouge">PML4</code>.</p>

<p>In theory, this can also be achieved from user mode as page tables are mapped to virtual memory with some assistance. We can even force a <code class="language-plaintext highlighter-rouge">TLB</code> flush using <code class="language-plaintext highlighter-rouge">SwitchToThread()</code>. The method relies on finding the self-referencing <code class="language-plaintext highlighter-rouge">PML4</code> entry, so the caller must have some level of access to the underlying physical memory, or leak non-exported names like <code class="language-plaintext highlighter-rouge">MmPteBase</code>, <code class="language-plaintext highlighter-rouge">MmPdeBase</code> and <code class="language-plaintext highlighter-rouge">MmPfnDatabase</code> which are used internally. More closely studying <code class="language-plaintext highlighter-rouge">MmGetVirtualForPhysical()</code> is recommended.</p>

<p><br /></p>
<h3 id="technique-to-find-directory-table">Technique to Find Directory Table</h3>

<p>We first cache the physical memory ranges. Here we can either call <code class="language-plaintext highlighter-rouge">MmGetPhysicalMemoryRanges()</code> or implement the same behavior ourselves. The <a href="https://doxygen.reactos.org/d1/d6d/dynamic_8c.html#a4d2191536acfdbcab710579f81193527">ReactOS</a> source can help provide context, but obviously look at the disassembly of <code class="language-plaintext highlighter-rouge">MiReferencePageRuns()</code> as well.</p>

<p>When walking the pages, we assume the page is the correct <code class="language-plaintext highlighter-rouge">PML4</code> and attempt a translation using a known user address like <code class="language-plaintext highlighter-rouge">EPROCESS.SectionBaseAddress</code>.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#define _pfn_to_page(pfn) (pfn &lt;&lt; _page_shift)
#define _page_to_pfn(pfn) (pfn &gt;&gt; _page_shift)
</span>
<span class="n">u64</span> <span class="nf">mm_find_process_cr3</span><span class="p">(</span><span class="n">EPROCESS</span><span class="o">*</span> <span class="n">proc</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">auto</span> <span class="n">physical_range</span> <span class="o">=</span> <span class="n">MmGetPhysicalMemoryRanges</span><span class="p">();</span> <span class="c1">// free with ExFreePool</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">physical_range</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1">// for every physical range</span>
  <span class="c1">// for every page</span>
  <span class="c1">// for every page table entry -- self-ref can have any idx  </span>

  <span class="n">virt_addr_t</span> <span class="n">mz_base</span><span class="p">;</span>
  <span class="n">mz_base</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">SectionBaseAddress</span><span class="p">;</span>

  <span class="k">do</span> <span class="p">{</span>
    <span class="n">u64</span> <span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">physical_range</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">);</span>
    <span class="n">u64</span> <span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">physical_range</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">physical_range</span><span class="o">-&gt;</span><span class="n">NumberOfBytes</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">u64</span> <span class="n">it</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="n">dst</span><span class="p">;</span> <span class="n">it</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> 
    <span class="k">for</span> <span class="p">(</span><span class="n">u32</span> <span class="n">pml4e_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pml4e_idx</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">;</span> <span class="n">pml4e_idx</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">auto</span> <span class="n">self_ref</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml4e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">it</span> <span class="o">+</span> <span class="n">pml4e_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml4e_t</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">self_ref</span><span class="p">.</span><span class="n">pfn</span><span class="p">))</span> <span class="c1">// self-ref?</span>
        <span class="k">continue</span><span class="p">;</span>

      <span class="c1">// ok - attempt translation</span>
      <span class="k">auto</span> <span class="n">pml4e</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml4e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">it</span> <span class="o">+</span> <span class="n">mz_base</span><span class="p">.</span><span class="n">pml4_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml4e_t</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pml4e</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span> <span class="c1">// bad cr3, check next page...</span>

      <span class="k">auto</span> <span class="n">pml3e</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml3e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">pml4e</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">mz_base</span><span class="p">.</span><span class="n">pml3_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml3e_t</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pml3e</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">auto</span> <span class="n">pml2e</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml2e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">pml3e</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">mz_base</span><span class="p">.</span><span class="n">pml2_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml2e_t</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pml2e</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">auto</span> <span class="n">pml1e</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml1e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">pml2e</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">mz_base</span><span class="p">.</span><span class="n">pml1_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml1e_t</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pml1e</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="o">&lt;</span><span class="n">u16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">pml1e</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">mz_base</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">!=</span> <span class="err">'</span><span class="n">ZM</span><span class="err">'</span><span class="p">)</span> <span class="c1">// check PE magic</span>
        <span class="k">break</span><span class="p">;</span>
      
      <span class="k">return</span> <span class="n">_page_to_pfn</span><span class="p">(</span><span class="n">it</span><span class="p">);</span> <span class="c1">// found cr3!</span>
    <span class="p">}</span>
    <span class="n">physical_range</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">physical_range</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>
<h3 id="the-result">The Result</h3>

<p>There’s a lot more you can do in the way of filtering out bad pages before running expensive read operations, but I leave this as an exercise to the reader. In any case, this serves as a good proof of concept. Keep in mind that the latest <code class="language-plaintext highlighter-rouge">Virtualization Based Security</code> or <code class="language-plaintext highlighter-rouge">VBS</code> enforces read-only state at the hypervisor level via <code class="language-plaintext highlighter-rouge">Second Level Address Translation</code> or <code class="language-plaintext highlighter-rouge">SLAT</code>. However, other values like page frame number remain unprotected. This will be discussed in a separate post in the future.</p>

<p><img src="/assets/image2.png" alt="Driver Output" /></p>

  </div><a class="u-url" href="/2025/04/25/Bypassing-CR3-Abuse-with-Physical-RW-copy.html" hidden></a>
</article>

      </div>
    </main></body>

</html>

```

`_site/2025/04/29/Examining-Malware-Thread-Creation-Techniques.html`:

```html
<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Examining Malware Thread Creation Techniques | hLunaaa</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Examining Malware Thread Creation Techniques" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Most malware want to quickly implant and exit the first stage of the payload execution. They do this by writing the second stage payload bytes to some executable memory and passing control there, either by creating a new thread or by redirecting an existing legitimate thread. In this post we examine the primarily four ways that most malware accomplish this." />
<meta property="og:description" content="Most malware want to quickly implant and exit the first stage of the payload execution. They do this by writing the second stage payload bytes to some executable memory and passing control there, either by creating a new thread or by redirecting an existing legitimate thread. In this post we examine the primarily four ways that most malware accomplish this." />
<link rel="canonical" href="http://localhost:4000/2025/04/29/Examining-Malware-Thread-Creation-Techniques.html" />
<meta property="og:url" content="http://localhost:4000/2025/04/29/Examining-Malware-Thread-Creation-Techniques.html" />
<meta property="og:site_name" content="hLunaaa" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-04-29T12:13:25+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Examining Malware Thread Creation Techniques" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-04-29T12:13:25+02:00","datePublished":"2025-04-29T12:13:25+02:00","description":"Most malware want to quickly implant and exit the first stage of the payload execution. They do this by writing the second stage payload bytes to some executable memory and passing control there, either by creating a new thread or by redirecting an existing legitimate thread. In this post we examine the primarily four ways that most malware accomplish this.","headline":"Examining Malware Thread Creation Techniques","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2025/04/29/Examining-Malware-Thread-Creation-Techniques.html"},"url":"http://localhost:4000/2025/04/29/Examining-Malware-Thread-Creation-Techniques.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="hLunaaa" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">hLunaaa</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Examining Malware Thread Creation Techniques</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-04-29T12:13:25+02:00" itemprop="datePublished">Apr 29, 2025
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Most malware want to quickly implant and exit the first stage of the payload execution. They do this by writing the second stage payload bytes to some executable memory and passing control there, either by creating a new thread or by redirecting an existing legitimate thread. In this post we examine the primarily four ways that most malware accomplish this.</p>

<p><code class="language-plaintext highlighter-rouge">CreateThread</code> and <code class="language-plaintext highlighter-rouge">CreateRemoteThread</code></p>

<p><code class="language-plaintext highlighter-rouge">QueueUserAPC</code></p>

<p>Set Thread IP</p>

<p><code class="language-plaintext highlighter-rouge">SetWindowsHookExA</code></p>


  </div><a class="u-url" href="/2025/04/29/Examining-Malware-Thread-Creation-Techniques.html" hidden></a>
</article>

      </div>
    </main></body>

</html>

```

`_site/404.html`:

```html
<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>hLunaaa | 8086 and C++23</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="hLunaaa" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="8086 and C++23" />
<meta property="og:description" content="8086 and C++23" />
<link rel="canonical" href="http://localhost:4000/404.html" />
<meta property="og:url" content="http://localhost:4000/404.html" />
<meta property="og:site_name" content="hLunaaa" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="hLunaaa" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"8086 and C++23","headline":"hLunaaa","url":"http://localhost:4000/404.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="hLunaaa" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">hLunaaa</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title"></h1>
  </header>

  <div class="post-content">
    <style type="text/css" media="screen">
  .container {
    margin: 10px auto;
    max-width: 600px;
    text-align: center;
  }
  h1 {
    margin: 30px 0;
    font-size: 4em;
    line-height: 1;
    letter-spacing: -1px;
  }
</style>

<div class="container">
  <h1>404</h1>

  <p><strong>Page not found :(</strong></p>
  <p>The requested page could not be found.</p>
</div>

  </div>

</article>

      </div>
    </main></body>

</html>

```

`_site/about/index.html`:

```html
<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>About | hLunaaa</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="About" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="8086 and C++23" />
<meta property="og:description" content="8086 and C++23" />
<link rel="canonical" href="http://localhost:4000/about/" />
<meta property="og:url" content="http://localhost:4000/about/" />
<meta property="og:site_name" content="hLunaaa" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="About" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebSite","description":"8086 and C++23","headline":"About","name":"hLunaaa","url":"http://localhost:4000/about/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="hLunaaa" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">hLunaaa</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">About</h1>
  </header>

  <div class="post-content">
    <p><img src="/assets/{80160CA8-EB1C-4189-9B32-ED16BD8B0FA4}.png" alt="John Martin" /></p>

<p>Blog where I write whatever I want, whenever I want. Mostly reverse engineering and malware research.</p>

<p>View my <a href="https://github.com/hLunaaa">projects.</a></p>


  </div>

</article>

      </div>
    </main></body>

</html>

```

`_site/assets/main.css`:

```css
/**
 * Reset some basic elements
 */
body, h1, h2, h3, h4, h5, h6,
p, blockquote, pre, hr,
dl, dd, ol, ul, figure {
  margin: 0;
  padding: 0;
}

/**
 * Basic styling
 */
body {
  font: 400 16px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  color: #111;
  background-color: #fdfdfd;
  -webkit-text-size-adjust: 100%;
  -webkit-font-feature-settings: "kern" 1;
  -moz-font-feature-settings: "kern" 1;
  -o-font-feature-settings: "kern" 1;
  font-feature-settings: "kern" 1;
  font-kerning: normal;
  display: flex;
  min-height: 100vh;
  flex-direction: column;
}

/**
 * Set `margin-bottom` to maintain vertical rhythm
 */
h1, h2, h3, h4, h5, h6,
p, blockquote, pre,
ul, ol, dl, figure,
.highlight {
  margin-bottom: 15px;
}

/**
 * `main` element
 */
main {
  display: block; /* Default value of `display` of `main` element is 'inline' in IE 11. */
}

/**
 * Images
 */
img {
  max-width: 100%;
  vertical-align: middle;
}

/**
 * Figures
 */
figure > img {
  display: block;
}

figcaption {
  font-size: 14px;
}

/**
 * Lists
 */
ul, ol {
  margin-left: 30px;
}

li > ul,
li > ol {
  margin-bottom: 0;
}

/**
 * Headings
 */
h1, h2, h3, h4, h5, h6 {
  font-weight: 400;
}

/**
 * Links
 */
a {
  color: #2a7ae2;
  text-decoration: none;
}
a:visited {
  color: rgb(22.9483471074, 86.2541322314, 168.5516528926);
}
a:hover {
  color: #111;
  text-decoration: underline;
}
.social-media-list a:hover {
  text-decoration: none;
}
.social-media-list a:hover .username {
  text-decoration: underline;
}

/**
 * Blockquotes
 */
blockquote {
  color: #828282;
  border-left: 4px solid #e8e8e8;
  padding-left: 15px;
  font-size: 18px;
  letter-spacing: -1px;
  font-style: italic;
}
blockquote > :last-child {
  margin-bottom: 0;
}

/**
 * Code formatting
 */
pre,
code {
  font-size: 15px;
  border: 1px solid #e8e8e8;
  border-radius: 3px;
  background-color: #eef;
}

code {
  padding: 1px 5px;
}

pre {
  padding: 8px 12px;
  overflow-x: auto;
}
pre > code {
  border: 0;
  padding-right: 0;
  padding-left: 0;
}

/**
 * Wrapper
 */
.wrapper {
  max-width: -webkit-calc(800px - (30px * 2));
  max-width: calc(800px - 30px * 2);
  margin-right: auto;
  margin-left: auto;
  padding-right: 30px;
  padding-left: 30px;
}
@media screen and (max-width: 800px) {
  .wrapper {
    max-width: -webkit-calc(800px - (30px));
    max-width: calc(800px - (30px));
    padding-right: 15px;
    padding-left: 15px;
  }
}

/**
 * Clearfix
 */
.footer-col-wrapper:after, .wrapper:after {
  content: "";
  display: table;
  clear: both;
}

/**
 * Icons
 */
.svg-icon {
  width: 16px;
  height: 16px;
  display: inline-block;
  fill: #828282;
  padding-right: 5px;
  vertical-align: text-top;
}

.social-media-list li + li {
  padding-top: 5px;
}

/**
 * Tables
 */
table {
  margin-bottom: 30px;
  width: 100%;
  text-align: left;
  color: rgb(62.9, 62.9, 62.9);
  border-collapse: collapse;
  border: 1px solid #e8e8e8;
}
table tr:nth-child(even) {
  background-color: rgb(247.3, 247.3, 247.3);
}
table th, table td {
  padding: 9.999999999px 15px;
}
table th {
  background-color: rgb(239.65, 239.65, 239.65);
  border: 1px solid rgb(221.8, 221.8, 221.8);
  border-bottom-color: rgb(201.4, 201.4, 201.4);
}
table td {
  border: 1px solid #e8e8e8;
}

/**
 * Site header
 */
.site-header {
  border-top: 5px solid rgb(66.25, 66.25, 66.25);
  border-bottom: 1px solid #e8e8e8;
  min-height: 55.95px;
  position: relative;
}

.site-title {
  font-size: 26px;
  font-weight: 300;
  line-height: 54px;
  letter-spacing: -1px;
  margin-bottom: 0;
  float: left;
}
.site-title, .site-title:visited {
  color: rgb(66.25, 66.25, 66.25);
}

.site-nav {
  float: right;
  line-height: 54px;
}
.site-nav .nav-trigger {
  display: none;
}
.site-nav .menu-icon {
  display: none;
}
.site-nav .page-link {
  color: #111;
  line-height: 1.5;
}
.site-nav .page-link:not(:last-child) {
  margin-right: 20px;
}
@media screen and (max-width: 600px) {
  .site-nav {
    position: absolute;
    top: 9px;
    right: 15px;
    background-color: #fdfdfd;
    border: 1px solid #e8e8e8;
    border-radius: 5px;
    text-align: right;
  }
  .site-nav label[for=nav-trigger] {
    display: block;
    float: right;
    width: 36px;
    height: 36px;
    z-index: 2;
    cursor: pointer;
  }
  .site-nav .menu-icon {
    display: block;
    float: right;
    width: 36px;
    height: 26px;
    line-height: 0;
    padding-top: 10px;
    text-align: center;
  }
  .site-nav .menu-icon > svg {
    fill: rgb(66.25, 66.25, 66.25);
  }
  .site-nav input ~ .trigger {
    clear: both;
    display: none;
  }
  .site-nav input:checked ~ .trigger {
    display: block;
    padding-bottom: 5px;
  }
  .site-nav .page-link {
    display: block;
    margin-left: 20px;
    padding: 5px 10px;
  }
  .site-nav .page-link:not(:last-child) {
    margin-right: 0;
  }
}

/**
 * Site footer
 */
.site-footer {
  border-top: 1px solid #e8e8e8;
  padding: 30px 0;
}

.footer-heading {
  font-size: 18px;
  margin-bottom: 15px;
}

.contact-list,
.social-media-list {
  list-style: none;
  margin-left: 0;
}

.footer-col-wrapper {
  font-size: 15px;
  color: #828282;
  margin-left: -15px;
}

.footer-col {
  float: left;
  margin-bottom: 15px;
  padding-left: 15px;
}

.footer-col-1 {
  width: -webkit-calc(35% - (30px / 2));
  width: calc(35% - 30px / 2);
}

.footer-col-2 {
  width: -webkit-calc(20% - (30px / 2));
  width: calc(20% - 30px / 2);
}

.footer-col-3 {
  width: -webkit-calc(45% - (30px / 2));
  width: calc(45% - 30px / 2);
}

@media screen and (max-width: 800px) {
  .footer-col-1,
  .footer-col-2 {
    width: -webkit-calc(50% - (30px / 2));
    width: calc(50% - 30px / 2);
  }
  .footer-col-3 {
    width: -webkit-calc(100% - (30px / 2));
    width: calc(100% - 30px / 2);
  }
}
@media screen and (max-width: 600px) {
  .footer-col {
    float: none;
    width: -webkit-calc(100% - (30px / 2));
    width: calc(100% - 30px / 2);
  }
}
/**
 * Page content
 */
.page-content {
  padding: 30px 0;
  flex: 1;
}

.page-heading {
  font-size: 32px;
}

.post-list-heading {
  font-size: 28px;
}

.post-list {
  margin-left: 0;
  list-style: none;
}
.post-list > li {
  margin-bottom: 30px;
}

.post-meta {
  font-size: 14px;
  color: #828282;
}

.post-link {
  display: block;
  font-size: 24px;
}

/**
 * Posts
 */
.post-header {
  margin-bottom: 30px;
}

.post-title {
  font-size: 42px;
  letter-spacing: -1px;
  line-height: 1;
}
@media screen and (max-width: 800px) {
  .post-title {
    font-size: 36px;
  }
}

.post-content {
  margin-bottom: 30px;
}
.post-content h2 {
  font-size: 32px;
}
@media screen and (max-width: 800px) {
  .post-content h2 {
    font-size: 28px;
  }
}
.post-content h3 {
  font-size: 26px;
}
@media screen and (max-width: 800px) {
  .post-content h3 {
    font-size: 22px;
  }
}
.post-content h4 {
  font-size: 20px;
}
@media screen and (max-width: 800px) {
  .post-content h4 {
    font-size: 18px;
  }
}

/**
 * Syntax highlighting styles
 */
.highlight {
  background: #fff;
}
.highlighter-rouge .highlight {
  background: #eef;
}
.highlight .c {
  color: #998;
  font-style: italic;
}
.highlight .err {
  color: #a61717;
  background-color: #e3d2d2;
}
.highlight .k {
  font-weight: bold;
}
.highlight .o {
  font-weight: bold;
}
.highlight .cm {
  color: #998;
  font-style: italic;
}
.highlight .cp {
  color: #999;
  font-weight: bold;
}
.highlight .c1 {
  color: #998;
  font-style: italic;
}
.highlight .cs {
  color: #999;
  font-weight: bold;
  font-style: italic;
}
.highlight .gd {
  color: #000;
  background-color: #fdd;
}
.highlight .gd .x {
  color: #000;
  background-color: #faa;
}
.highlight .ge {
  font-style: italic;
}
.highlight .gr {
  color: #a00;
}
.highlight .gh {
  color: #999;
}
.highlight .gi {
  color: #000;
  background-color: #dfd;
}
.highlight .gi .x {
  color: #000;
  background-color: #afa;
}
.highlight .go {
  color: #888;
}
.highlight .gp {
  color: #555;
}
.highlight .gs {
  font-weight: bold;
}
.highlight .gu {
  color: #aaa;
}
.highlight .gt {
  color: #a00;
}
.highlight .kc {
  font-weight: bold;
}
.highlight .kd {
  font-weight: bold;
}
.highlight .kp {
  font-weight: bold;
}
.highlight .kr {
  font-weight: bold;
}
.highlight .kt {
  color: #458;
  font-weight: bold;
}
.highlight .m {
  color: #099;
}
.highlight .s {
  color: #d14;
}
.highlight .na {
  color: #008080;
}
.highlight .nb {
  color: #0086B3;
}
.highlight .nc {
  color: #458;
  font-weight: bold;
}
.highlight .no {
  color: #008080;
}
.highlight .ni {
  color: #800080;
}
.highlight .ne {
  color: #900;
  font-weight: bold;
}
.highlight .nf {
  color: #900;
  font-weight: bold;
}
.highlight .nn {
  color: #555;
}
.highlight .nt {
  color: #000080;
}
.highlight .nv {
  color: #008080;
}
.highlight .ow {
  font-weight: bold;
}
.highlight .w {
  color: #bbb;
}
.highlight .mf {
  color: #099;
}
.highlight .mh {
  color: #099;
}
.highlight .mi {
  color: #099;
}
.highlight .mo {
  color: #099;
}
.highlight .sb {
  color: #d14;
}
.highlight .sc {
  color: #d14;
}
.highlight .sd {
  color: #d14;
}
.highlight .s2 {
  color: #d14;
}
.highlight .se {
  color: #d14;
}
.highlight .sh {
  color: #d14;
}
.highlight .si {
  color: #d14;
}
.highlight .sx {
  color: #d14;
}
.highlight .sr {
  color: #009926;
}
.highlight .s1 {
  color: #d14;
}
.highlight .ss {
  color: #990073;
}
.highlight .bp {
  color: #999;
}
.highlight .vc {
  color: #008080;
}
.highlight .vg {
  color: #008080;
}
.highlight .vi {
  color: #008080;
}
.highlight .il {
  color: #099;
}

/*# sourceMappingURL=main.css.map */
```

`_site/assets/main.css.map`:

```map
{"version":3,"sourceRoot":"","sources":["../../../.local/share/gem/ruby/3.3.0/gems/minima-2.5.2/_sass/minima/_base.scss","../../../.local/share/gem/ruby/3.3.0/gems/minima-2.5.2/_sass/minima.scss","../../../.local/share/gem/ruby/3.3.0/gems/minima-2.5.2/_sass/minima/_layout.scss","../../../.local/share/gem/ruby/3.3.0/gems/minima-2.5.2/_sass/minima/_syntax-highlighting.scss"],"names":[],"mappings":"AAAA;AAAA;AAAA;AAGA;AAAA;AAAA;EAGE;EACA;;;AAKF;AAAA;AAAA;AAGA;EACE;EACA,OCLiB;EDMjB,kBCLiB;EDMjB;EACA;EACG;EACE;EACG;EACR;EACA;EACA;EACA;;;AAKF;AAAA;AAAA;AAGA;AAAA;AAAA;AAAA;EAIE;;;AAKF;AAAA;AAAA;AAGA;EACE;;;AAKF;AAAA;AAAA;AAGA;EACE;EACA;;;AAKF;AAAA;AAAA;AAGA;EACE;;;AAGF;EACE,WChEiB;;;ADqEnB;AAAA;AAAA;AAGA;EACE,aCtEiB;;;AD0EjB;AAAA;EAEE;;;AAMJ;AAAA;AAAA;AAGA;EACE,aC1FiB;;;AD+FnB;AAAA;AAAA;AAGA;EACE,OC3FiB;ED4FjB;;AAEA;EACE;;AAGF;EACE,OCrGe;EDsGf;;AAGF;EACE;;AAEA;EACE;;;AAMN;AAAA;AAAA;AAGA;EACE,OCnHiB;EDoHjB;EACA;EC3FA;ED6FA;EACA;;AAEA;EACE;;;AAMJ;AAAA;AAAA;AAGA;AAAA;EC1GE;ED6GA;EACA;EACA;;;AAGF;EACE;;;AAGF;EACE;EACA;;AAEA;EACE;EACA;EACA;;;AAMJ;AAAA;AAAA;AAGA;EACE;EACA;EACA;EACA;EACA,eC3KiB;ED4KjB,cC5KiB;;AA0BjB;ED4IF;IAUI;IACA;IACA;IACA;;;;AAMJ;AAAA;AAAA;AAGA;EACE;EACA;EACA;;;AAKF;AAAA;AAAA;AAIA;EACI;EACA;EACA;EACA;EACA;EACA;;;AAIF;EACE;;;AAMJ;AAAA;AAAA;AAGA;EACE,eC7NiB;ED8NjB;EACA,YCrNiB;EDsNjB;EACA;EACA;;AAEE;EACE;;AAGJ;EACE;;AAEF;EACE;EACA;EACA;;AAEF;EACE;;;AE3PJ;AAAA;AAAA;AAGA;EACE;EACA;EACA;EAGA;;;AAGF;ED8BE;EC5BA;EACA;EACA;EACA;EACA;;AAEA;EAEE,ODJe;;;ACQnB;EACE;EACA;;AAEA;EACI;;AAGJ;EACE;;AAGF;EACE,OD3Be;EC4Bf,aDhCe;;ACmCf;EACE;;ADRJ;ECVF;IAuBI;IACA;IACA;IACA,kBDvCe;ICwCf;IACA;IACA;;EAEA;IACE;IACA;IACA;IACA;IACA;IACA;;EAGF;IACE;IACA;IACA;IACA;IACA;IACA;IACA;;EAEA;IACE,MD1DW;;EC8Df;IACE;IACA;;EAGF;IACE;IACA;;EAGF;IACE;IACA;IACA;;EAEA;IACE;;;;AAQR;AAAA;AAAA;AAGA;EACE;EACA;;;AAGF;EDtEE;ECwEA;;;AAGF;AAAA;EAEE;EACA;;;AAGF;EDjFE;ECmFA,OD7GiB;EC8GjB;;;AAIF;EACE;EACA;EACA;;;AAGF;EACE;EACA;;;AAGF;EACE;EACA;;;AAGF;EACE;EACA;;;ADhHA;ECoHA;AAAA;IAEE;IACA;;EAGF;IACE;IACA;;;AD5HF;ECiIA;IACE;IACA;IACA;;;AAMJ;AAAA;AAAA;AAGA;EACE;EACA;;;AAGF;ED5IE;;;ACgJF;EDhJE;;;ACoJF;EACE;EACA;;AAEA;EACE,eDzLe;;;AC6LnB;EACE,WDjMiB;ECkMjB,ODzLiB;;;AC4LnB;EACE;EDnKA;;;ACyKF;AAAA;AAAA;AAGA;EACE,eD7MiB;;;ACgNnB;EDhLE;ECkLA;EACA;;ADzLA;ECsLF;IDhLE;;;;AC0LF;EACE,eD3NiB;;AC6NjB;ED7LA;;AANA;ECmMA;ID7LA;;;ACqMA;EDrMA;;AANA;EC2MA;IDrMA;;;AC6MA;ED7MA;;AANA;ECmNA;ID7MA;;;;AE1CF;AAAA;AAAA;AAGA;EACE;;AAGA;EACE;;AAGF;EAAS;EAAa;;AACtB;EAAS;EAAgB;;AACzB;EAAS;;AACT;EAAS;;AACT;EAAS;EAAa;;AACtB;EAAS;EAAa;;AACtB;EAAS;EAAa;;AACtB;EAAS;EAAa;EAAmB;;AACzC;EAAS;EAAa;;AACtB;EAAS;EAAa;;AACtB;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;EAAa;;AACtB;EAAS;EAAa;;AACtB;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;EAAa;;AACtB;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;EAAa;;AACtB;EAAS;;AACT;EAAS;;AACT;EAAS;EAAa;;AACtB;EAAS;EAAa;;AACtB;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS;;AACT;EAAS","sourcesContent":["/**\n * Reset some basic elements\n */\nbody, h1, h2, h3, h4, h5, h6,\np, blockquote, pre, hr,\ndl, dd, ol, ul, figure {\n  margin: 0;\n  padding: 0;\n}\n\n\n\n/**\n * Basic styling\n */\nbody {\n  font: $base-font-weight #{$base-font-size}/#{$base-line-height} $base-font-family;\n  color: $text-color;\n  background-color: $background-color;\n  -webkit-text-size-adjust: 100%;\n  -webkit-font-feature-settings: \"kern\" 1;\n     -moz-font-feature-settings: \"kern\" 1;\n       -o-font-feature-settings: \"kern\" 1;\n          font-feature-settings: \"kern\" 1;\n  font-kerning: normal;\n  display: flex;\n  min-height: 100vh;\n  flex-direction: column;\n}\n\n\n\n/**\n * Set `margin-bottom` to maintain vertical rhythm\n */\nh1, h2, h3, h4, h5, h6,\np, blockquote, pre,\nul, ol, dl, figure,\n%vertical-rhythm {\n  margin-bottom: $spacing-unit * 0.5;\n}\n\n\n\n/**\n * `main` element\n */\nmain {\n  display: block; /* Default value of `display` of `main` element is 'inline' in IE 11. */\n}\n\n\n\n/**\n * Images\n */\nimg {\n  max-width: 100%;\n  vertical-align: middle;\n}\n\n\n\n/**\n * Figures\n */\nfigure > img {\n  display: block;\n}\n\nfigcaption {\n  font-size: $small-font-size;\n}\n\n\n\n/**\n * Lists\n */\nul, ol {\n  margin-left: $spacing-unit;\n}\n\nli {\n  > ul,\n  > ol {\n    margin-bottom: 0;\n  }\n}\n\n\n\n/**\n * Headings\n */\nh1, h2, h3, h4, h5, h6 {\n  font-weight: $base-font-weight;\n}\n\n\n\n/**\n * Links\n */\na {\n  color: $brand-color;\n  text-decoration: none;\n\n  &:visited {\n    color: darken($brand-color, 15%);\n  }\n\n  &:hover {\n    color: $text-color;\n    text-decoration: underline;\n  }\n\n  .social-media-list &:hover {\n    text-decoration: none;\n\n    .username {\n      text-decoration: underline;\n    }\n  }\n}\n\n\n/**\n * Blockquotes\n */\nblockquote {\n  color: $grey-color;\n  border-left: 4px solid $grey-color-light;\n  padding-left: $spacing-unit * 0.5;\n  @include relative-font-size(1.125);\n  letter-spacing: -1px;\n  font-style: italic;\n\n  > :last-child {\n    margin-bottom: 0;\n  }\n}\n\n\n\n/**\n * Code formatting\n */\npre,\ncode {\n  @include relative-font-size(0.9375);\n  border: 1px solid $grey-color-light;\n  border-radius: 3px;\n  background-color: #eef;\n}\n\ncode {\n  padding: 1px 5px;\n}\n\npre {\n  padding: 8px 12px;\n  overflow-x: auto;\n\n  > code {\n    border: 0;\n    padding-right: 0;\n    padding-left: 0;\n  }\n}\n\n\n\n/**\n * Wrapper\n */\n.wrapper {\n  max-width: -webkit-calc(#{$content-width} - (#{$spacing-unit} * 2));\n  max-width:         calc(#{$content-width} - (#{$spacing-unit} * 2));\n  margin-right: auto;\n  margin-left: auto;\n  padding-right: $spacing-unit;\n  padding-left: $spacing-unit;\n  @extend %clearfix;\n\n  @include media-query($on-laptop) {\n    max-width: -webkit-calc(#{$content-width} - (#{$spacing-unit}));\n    max-width:         calc(#{$content-width} - (#{$spacing-unit}));\n    padding-right: $spacing-unit * 0.5;\n    padding-left: $spacing-unit * 0.5;\n  }\n}\n\n\n\n/**\n * Clearfix\n */\n%clearfix:after {\n  content: \"\";\n  display: table;\n  clear: both;\n}\n\n\n\n/**\n * Icons\n */\n\n.svg-icon {\n    width: 16px;\n    height: 16px;\n    display: inline-block;\n    fill: #{$grey-color};\n    padding-right: 5px;\n    vertical-align: text-top;\n}\n\n.social-media-list {\n  li + li {\n    padding-top: 5px;\n  }\n}\n\n\n\n/**\n * Tables\n */\ntable {\n  margin-bottom: $spacing-unit;\n  width: 100%;\n  text-align: $table-text-align;\n  color: lighten($text-color, 18%);\n  border-collapse: collapse;\n  border: 1px solid $grey-color-light;\n  tr {\n    &:nth-child(even) {\n      background-color: lighten($grey-color-light, 6%);\n    }\n  }\n  th, td {\n    padding: ($spacing-unit * 0.3333333333) ($spacing-unit * 0.5);\n  }\n  th {\n    background-color: lighten($grey-color-light, 3%);\n    border: 1px solid darken($grey-color-light, 4%);\n    border-bottom-color: darken($grey-color-light, 12%);\n  }\n  td {\n    border: 1px solid $grey-color-light;\n  }\n}\n","@charset \"utf-8\";\n\n// Define defaults for each variable.\n\n$base-font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Helvetica, Arial, sans-serif, \"Apple Color Emoji\", \"Segoe UI Emoji\", \"Segoe UI Symbol\" !default;\n$base-font-size:   16px !default;\n$base-font-weight: 400 !default;\n$small-font-size:  $base-font-size * 0.875 !default;\n$base-line-height: 1.5 !default;\n\n$spacing-unit:     30px !default;\n\n$text-color:       #111 !default;\n$background-color: #fdfdfd !default;\n$brand-color:      #2a7ae2 !default;\n\n$grey-color:       #828282 !default;\n$grey-color-light: lighten($grey-color, 40%) !default;\n$grey-color-dark:  darken($grey-color, 25%) !default;\n\n$table-text-align: left !default;\n\n// Width of the content area\n$content-width:    800px !default;\n\n$on-palm:          600px !default;\n$on-laptop:        800px !default;\n\n// Use media queries like this:\n// @include media-query($on-palm) {\n//   .wrapper {\n//     padding-right: $spacing-unit / 2;\n//     padding-left: $spacing-unit / 2;\n//   }\n// }\n@mixin media-query($device) {\n  @media screen and (max-width: $device) {\n    @content;\n  }\n}\n\n@mixin relative-font-size($ratio) {\n  font-size: $base-font-size * $ratio;\n}\n\n// Import partials.\n@import\n  \"minima/base\",\n  \"minima/layout\",\n  \"minima/syntax-highlighting\"\n;\n","/**\n * Site header\n */\n.site-header {\n  border-top: 5px solid $grey-color-dark;\n  border-bottom: 1px solid $grey-color-light;\n  min-height: $spacing-unit * 1.865;\n\n  // Positioning context for the mobile navigation icon\n  position: relative;\n}\n\n.site-title {\n  @include relative-font-size(1.625);\n  font-weight: 300;\n  line-height: $base-line-height * $base-font-size * 2.25;\n  letter-spacing: -1px;\n  margin-bottom: 0;\n  float: left;\n\n  &,\n  &:visited {\n    color: $grey-color-dark;\n  }\n}\n\n.site-nav {\n  float: right;\n  line-height: $base-line-height * $base-font-size * 2.25;\n\n  .nav-trigger {\n      display: none;\n  }\n\n  .menu-icon {\n    display: none;\n  }\n\n  .page-link {\n    color: $text-color;\n    line-height: $base-line-height;\n\n    // Gaps between nav items, but not on the last one\n    &:not(:last-child) {\n      margin-right: 20px;\n    }\n  }\n\n  @include media-query($on-palm) {\n    position: absolute;\n    top: 9px;\n    right: $spacing-unit * 0.5;\n    background-color: $background-color;\n    border: 1px solid $grey-color-light;\n    border-radius: 5px;\n    text-align: right;\n\n    label[for=\"nav-trigger\"] {\n      display: block;\n      float: right;\n      width: 36px;\n      height: 36px;\n      z-index: 2;\n      cursor: pointer;\n    }\n\n    .menu-icon {\n      display: block;\n      float: right;\n      width: 36px;\n      height: 26px;\n      line-height: 0;\n      padding-top: 10px;\n      text-align: center;\n\n      > svg {\n        fill: $grey-color-dark;\n      }\n    }\n\n    input ~ .trigger {\n      clear: both;\n      display: none;\n    }\n\n    input:checked ~ .trigger {\n      display: block;\n      padding-bottom: 5px;\n    }\n\n    .page-link {\n      display: block;\n      margin-left: 20px;\n      padding: 5px 10px;\n\n      &:not(:last-child) {\n        margin-right: 0;\n      }\n    }\n  }\n}\n\n\n\n/**\n * Site footer\n */\n.site-footer {\n  border-top: 1px solid $grey-color-light;\n  padding: $spacing-unit 0;\n}\n\n.footer-heading {\n  @include relative-font-size(1.125);\n  margin-bottom: $spacing-unit * 0.5;\n}\n\n.contact-list,\n.social-media-list {\n  list-style: none;\n  margin-left: 0;\n}\n\n.footer-col-wrapper {\n  @include relative-font-size(0.9375);\n  color: $grey-color;\n  margin-left: -$spacing-unit * 0.5;\n  @extend %clearfix;\n}\n\n.footer-col {\n  float: left;\n  margin-bottom: $spacing-unit * 0.5;\n  padding-left: $spacing-unit * 0.5;\n}\n\n.footer-col-1 {\n  width: -webkit-calc(35% - (#{$spacing-unit} / 2));\n  width:         calc(35% - (#{$spacing-unit} / 2));\n}\n\n.footer-col-2 {\n  width: -webkit-calc(20% - (#{$spacing-unit} / 2));\n  width:         calc(20% - (#{$spacing-unit} / 2));\n}\n\n.footer-col-3 {\n  width: -webkit-calc(45% - (#{$spacing-unit} / 2));\n  width:         calc(45% - (#{$spacing-unit} / 2));\n}\n\n@include media-query($on-laptop) {\n  .footer-col-1,\n  .footer-col-2 {\n    width: -webkit-calc(50% - (#{$spacing-unit} / 2));\n    width:         calc(50% - (#{$spacing-unit} / 2));\n  }\n\n  .footer-col-3 {\n    width: -webkit-calc(100% - (#{$spacing-unit} / 2));\n    width:         calc(100% - (#{$spacing-unit} / 2));\n  }\n}\n\n@include media-query($on-palm) {\n  .footer-col {\n    float: none;\n    width: -webkit-calc(100% - (#{$spacing-unit} / 2));\n    width:         calc(100% - (#{$spacing-unit} / 2));\n  }\n}\n\n\n\n/**\n * Page content\n */\n.page-content {\n  padding: $spacing-unit 0;\n  flex: 1;\n}\n\n.page-heading {\n  @include relative-font-size(2);\n}\n\n.post-list-heading {\n  @include relative-font-size(1.75);\n}\n\n.post-list {\n  margin-left: 0;\n  list-style: none;\n\n  > li {\n    margin-bottom: $spacing-unit;\n  }\n}\n\n.post-meta {\n  font-size: $small-font-size;\n  color: $grey-color;\n}\n\n.post-link {\n  display: block;\n  @include relative-font-size(1.5);\n}\n\n\n\n/**\n * Posts\n */\n.post-header {\n  margin-bottom: $spacing-unit;\n}\n\n.post-title {\n  @include relative-font-size(2.625);\n  letter-spacing: -1px;\n  line-height: 1;\n\n  @include media-query($on-laptop) {\n    @include relative-font-size(2.25);\n  }\n}\n\n.post-content {\n  margin-bottom: $spacing-unit;\n\n  h2 {\n    @include relative-font-size(2);\n\n    @include media-query($on-laptop) {\n      @include relative-font-size(1.75);\n    }\n  }\n\n  h3 {\n    @include relative-font-size(1.625);\n\n    @include media-query($on-laptop) {\n      @include relative-font-size(1.375);\n    }\n  }\n\n  h4 {\n    @include relative-font-size(1.25);\n\n    @include media-query($on-laptop) {\n      @include relative-font-size(1.125);\n    }\n  }\n}\n","/**\n * Syntax highlighting styles\n */\n.highlight {\n  background: #fff;\n  @extend %vertical-rhythm;\n\n  .highlighter-rouge & {\n    background: #eef;\n  }\n\n  .c     { color: #998; font-style: italic } // Comment\n  .err   { color: #a61717; background-color: #e3d2d2 } // Error\n  .k     { font-weight: bold } // Keyword\n  .o     { font-weight: bold } // Operator\n  .cm    { color: #998; font-style: italic } // Comment.Multiline\n  .cp    { color: #999; font-weight: bold } // Comment.Preproc\n  .c1    { color: #998; font-style: italic } // Comment.Single\n  .cs    { color: #999; font-weight: bold; font-style: italic } // Comment.Special\n  .gd    { color: #000; background-color: #fdd } // Generic.Deleted\n  .gd .x { color: #000; background-color: #faa } // Generic.Deleted.Specific\n  .ge    { font-style: italic } // Generic.Emph\n  .gr    { color: #a00 } // Generic.Error\n  .gh    { color: #999 } // Generic.Heading\n  .gi    { color: #000; background-color: #dfd } // Generic.Inserted\n  .gi .x { color: #000; background-color: #afa } // Generic.Inserted.Specific\n  .go    { color: #888 } // Generic.Output\n  .gp    { color: #555 } // Generic.Prompt\n  .gs    { font-weight: bold } // Generic.Strong\n  .gu    { color: #aaa } // Generic.Subheading\n  .gt    { color: #a00 } // Generic.Traceback\n  .kc    { font-weight: bold } // Keyword.Constant\n  .kd    { font-weight: bold } // Keyword.Declaration\n  .kp    { font-weight: bold } // Keyword.Pseudo\n  .kr    { font-weight: bold } // Keyword.Reserved\n  .kt    { color: #458; font-weight: bold } // Keyword.Type\n  .m     { color: #099 } // Literal.Number\n  .s     { color: #d14 } // Literal.String\n  .na    { color: #008080 } // Name.Attribute\n  .nb    { color: #0086B3 } // Name.Builtin\n  .nc    { color: #458; font-weight: bold } // Name.Class\n  .no    { color: #008080 } // Name.Constant\n  .ni    { color: #800080 } // Name.Entity\n  .ne    { color: #900; font-weight: bold } // Name.Exception\n  .nf    { color: #900; font-weight: bold } // Name.Function\n  .nn    { color: #555 } // Name.Namespace\n  .nt    { color: #000080 } // Name.Tag\n  .nv    { color: #008080 } // Name.Variable\n  .ow    { font-weight: bold } // Operator.Word\n  .w     { color: #bbb } // Text.Whitespace\n  .mf    { color: #099 } // Literal.Number.Float\n  .mh    { color: #099 } // Literal.Number.Hex\n  .mi    { color: #099 } // Literal.Number.Integer\n  .mo    { color: #099 } // Literal.Number.Oct\n  .sb    { color: #d14 } // Literal.String.Backtick\n  .sc    { color: #d14 } // Literal.String.Char\n  .sd    { color: #d14 } // Literal.String.Doc\n  .s2    { color: #d14 } // Literal.String.Double\n  .se    { color: #d14 } // Literal.String.Escape\n  .sh    { color: #d14 } // Literal.String.Heredoc\n  .si    { color: #d14 } // Literal.String.Interpol\n  .sx    { color: #d14 } // Literal.String.Other\n  .sr    { color: #009926 } // Literal.String.Regex\n  .s1    { color: #d14 } // Literal.String.Single\n  .ss    { color: #990073 } // Literal.String.Symbol\n  .bp    { color: #999 } // Name.Builtin.Pseudo\n  .vc    { color: #008080 } // Name.Variable.Class\n  .vg    { color: #008080 } // Name.Variable.Global\n  .vi    { color: #008080 } // Name.Variable.Instance\n  .il    { color: #099 } // Literal.Number.Integer.Long\n}\n"],"file":"main.css"}
```

`_site/assets/minima-social-icons.svg`:

```svg
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">

<symbol id="dribbble" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M8 16c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm6.747-6.905c-.234-.074-2.115-.635-4.257-.292.894 2.456 1.258 4.456 1.328 4.872 1.533-1.037 2.624-2.68 2.93-4.58zM10.67 14.3c-.102-.6-.5-2.688-1.46-5.18l-.044.014C5.312 10.477 3.93 13.15 3.806 13.4c1.158.905 2.614 1.444 4.194 1.444.947 0 1.85-.194 2.67-.543zm-7.747-1.72c.155-.266 2.03-3.37 5.555-4.51.09-.03.18-.056.27-.08-.173-.39-.36-.778-.555-1.16-3.413 1.02-6.723.977-7.023.97l-.003.208c0 1.755.665 3.358 1.756 4.57zM1.31 6.61c.307.005 3.122.017 6.318-.832-1.132-2.012-2.353-3.705-2.533-3.952-1.912.902-3.34 2.664-3.784 4.785zM6.4 1.368c.188.253 1.43 1.943 2.548 4 2.43-.91 3.46-2.293 3.582-2.468C11.323 1.827 9.736 1.176 8 1.176c-.55 0-1.087.066-1.6.19zm6.89 2.322c-.145.194-1.29 1.662-3.816 2.694.16.325.31.656.453.99.05.117.1.235.147.352 2.274-.286 4.533.172 4.758.22-.015-1.613-.59-3.094-1.543-4.257z"/></symbol>

<symbol id="facebook" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M15.117 0H.883C.395 0 0 .395 0 .883v14.234c0 .488.395.883.883.883h7.663V9.804H6.46V7.39h2.086V5.607c0-2.066 1.262-3.19 3.106-3.19.883 0 1.642.064 1.863.094v2.16h-1.28c-1 0-1.195.48-1.195 1.18v1.54h2.39l-.31 2.42h-2.08V16h4.077c.488 0 .883-.395.883-.883V.883C16 .395 15.605 0 15.117 0" fill-rule="nonzero"/></symbol>

<symbol id="flickr" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M0 8c0 2.05 1.662 3.71 3.71 3.71 2.05 0 3.713-1.66 3.713-3.71S5.76 4.29 3.71 4.29C1.663 4.29 0 5.95 0 8zm8.577 0c0 2.05 1.662 3.71 3.712 3.71C14.33 11.71 16 10.05 16 8s-1.662-3.71-3.71-3.71c-2.05 0-3.713 1.66-3.713 3.71z"/></symbol>

<symbol id="github" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M8 0C3.58 0 0 3.582 0 8c0 3.535 2.292 6.533 5.47 7.59.4.075.547-.172.547-.385 0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.725-.496.056-.486.056-.486.803.056 1.225.824 1.225.824.714 1.223 1.873.87 2.33.665.072-.517.278-.87.507-1.07-1.777-.2-3.644-.888-3.644-3.953 0-.873.31-1.587.823-2.147-.09-.202-.36-1.015.07-2.117 0 0 .67-.215 2.2.82.64-.178 1.32-.266 2-.27.68.004 1.36.092 2 .27 1.52-1.035 2.19-.82 2.19-.82.43 1.102.16 1.915.08 2.117.51.56.82 1.274.82 2.147 0 3.073-1.87 3.75-3.65 3.947.28.24.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.14.46.55.38C13.71 14.53 16 11.53 16 8c0-4.418-3.582-8-8-8"/></symbol>

<symbol id="googleplus" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M5.09 7.273v1.745h2.89c-.116.75-.873 2.197-2.887 2.197-1.737 0-3.155-1.44-3.155-3.215S3.353 4.785 5.09 4.785c.99 0 1.652.422 2.03.786l1.382-1.33c-.887-.83-2.037-1.33-3.41-1.33C2.275 2.91 0 5.19 0 8s2.276 5.09 5.09 5.09c2.94 0 4.888-2.065 4.888-4.974 0-.334-.036-.59-.08-.843H5.09zm10.91 0h-1.455V5.818H13.09v1.455h-1.454v1.454h1.455v1.455h1.46V8.727H16"/></symbol>

<symbol id="instagram" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M8 0C5.827 0 5.555.01 4.702.048 3.85.088 3.27.222 2.76.42c-.526.204-.973.478-1.417.923-.445.444-.72.89-.923 1.417-.198.51-.333 1.09-.372 1.942C.008 5.555 0 5.827 0 8s.01 2.445.048 3.298c.04.852.174 1.433.372 1.942.204.526.478.973.923 1.417.444.445.89.72 1.417.923.51.198 1.09.333 1.942.372.853.04 1.125.048 3.298.048s2.445-.01 3.298-.048c.852-.04 1.433-.174 1.942-.372.526-.204.973-.478 1.417-.923.445-.444.72-.89.923-1.417.198-.51.333-1.09.372-1.942.04-.853.048-1.125.048-3.298s-.01-2.445-.048-3.298c-.04-.852-.174-1.433-.372-1.942-.204-.526-.478-.973-.923-1.417-.444-.445-.89-.72-1.417-.923-.51-.198-1.09-.333-1.942-.372C10.445.008 10.173 0 8 0zm0 1.44c2.136 0 2.39.01 3.233.048.78.036 1.203.166 1.485.276.374.145.64.318.92.598.28.28.453.546.598.92.11.282.24.705.276 1.485.038.844.047 1.097.047 3.233s-.01 2.39-.05 3.233c-.04.78-.17 1.203-.28 1.485-.15.374-.32.64-.6.92-.28.28-.55.453-.92.598-.28.11-.71.24-1.49.276-.85.038-1.1.047-3.24.047s-2.39-.01-3.24-.05c-.78-.04-1.21-.17-1.49-.28-.38-.15-.64-.32-.92-.6-.28-.28-.46-.55-.6-.92-.11-.28-.24-.71-.28-1.49-.03-.84-.04-1.1-.04-3.23s.01-2.39.04-3.24c.04-.78.17-1.21.28-1.49.14-.38.32-.64.6-.92.28-.28.54-.46.92-.6.28-.11.7-.24 1.48-.28.85-.03 1.1-.04 3.24-.04zm0 2.452c-2.27 0-4.108 1.84-4.108 4.108 0 2.27 1.84 4.108 4.108 4.108 2.27 0 4.108-1.84 4.108-4.108 0-2.27-1.84-4.108-4.108-4.108zm0 6.775c-1.473 0-2.667-1.194-2.667-2.667 0-1.473 1.194-2.667 2.667-2.667 1.473 0 2.667 1.194 2.667 2.667 0 1.473-1.194 2.667-2.667 2.667zm5.23-6.937c0 .53-.43.96-.96.96s-.96-.43-.96-.96.43-.96.96-.96.96.43.96.96z"/></symbol>

<symbol id="linkedin" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51v1.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z" fill-rule="nonzero"/></symbol>

<symbol id="pinterest" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M8 0C3.582 0 0 3.582 0 8c0 3.39 2.108 6.285 5.084 7.45-.07-.633-.133-1.604.028-2.295.146-.625.938-3.977.938-3.977s-.24-.48-.24-1.188c0-1.11.646-1.943 1.448-1.943.683 0 1.012.513 1.012 1.127 0 .687-.436 1.713-.662 2.664-.19.797.4 1.445 1.185 1.445 1.42 0 2.514-1.498 2.514-3.662 0-1.91-1.376-3.25-3.342-3.25-2.276 0-3.61 1.71-3.61 3.47 0 .69.263 1.43.593 1.83.066.08.075.15.057.23-.06.25-.196.8-.223.91-.035.15-.115.18-.268.11C3.516 10.46 2.89 9 2.89 7.82c0-2.52 1.834-4.84 5.287-4.84 2.774 0 4.932 1.98 4.932 4.62 0 2.76-1.74 4.98-4.16 4.98-.81 0-1.57-.42-1.84-.92l-.5 1.9c-.18.698-.67 1.57-1 2.1.75.23 1.54.357 2.37.357 4.41 0 8-3.58 8-8s-3.59-8-8-8z" fill-rule="nonzero"/></symbol>

<symbol id="rss" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194 11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.99 2.194-2.2 2.194C.98 16 0 15.017 0 13.806c0-1.21.983-2.195 2.194-2.195zM10.606 16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"/></symbol>

<symbol id="stackoverflow" class="svg-icon" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M12.658 14.577v-4.27h1.423V16H1.23v-5.693h1.42v4.27h10.006zm-8.583-1.423h7.16V11.73h-7.16v1.424zm.173-3.235l6.987 1.46.3-1.38L4.55 8.54l-.302 1.38zm.906-3.37l6.47 3.02.602-1.3-6.47-3.02-.602 1.29zm1.81-3.19l5.478 4.57.906-1.08L7.87 2.28l-.9 1.078zM10.502 0L9.338.863l4.27 5.735 1.164-.862L10.5 0z"/></symbol>

<symbol id="twitter" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M16 3.038c-.59.26-1.22.437-1.885.517.677-.407 1.198-1.05 1.443-1.816-.634.37-1.337.64-2.085.79-.598-.64-1.45-1.04-2.396-1.04-1.812 0-3.282 1.47-3.282 3.28 0 .26.03.51.085.75-2.728-.13-5.147-1.44-6.766-3.42C.83 2.58.67 3.14.67 3.75c0 1.14.58 2.143 1.46 2.732-.538-.017-1.045-.165-1.487-.41v.04c0 1.59 1.13 2.918 2.633 3.22-.276.074-.566.114-.865.114-.21 0-.41-.02-.61-.058.42 1.304 1.63 2.253 3.07 2.28-1.12.88-2.54 1.404-4.07 1.404-.26 0-.52-.015-.78-.045 1.46.93 3.18 1.474 5.04 1.474 6.04 0 9.34-5 9.34-9.33 0-.14 0-.28-.01-.42.64-.46 1.2-1.04 1.64-1.7z" fill-rule="nonzero"/></symbol>

<symbol id="youtube" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M0 7.345c0-1.294.16-2.59.16-2.59s.156-1.1.636-1.587c.608-.637 1.408-.617 1.764-.684C3.84 2.36 8 2.324 8 2.324s3.362.004 5.6.166c.314.038.996.04 1.604.678.48.486.636 1.588.636 1.588S16 6.05 16 7.346v1.258c0 1.296-.16 2.59-.16 2.59s-.156 1.102-.636 1.588c-.608.638-1.29.64-1.604.678-2.238.162-5.6.166-5.6.166s-4.16-.037-5.44-.16c-.356-.067-1.156-.047-1.764-.684-.48-.487-.636-1.587-.636-1.587S0 9.9 0 8.605v-1.26zm6.348 2.73V5.58l4.323 2.255-4.32 2.24z"/></symbol>

<symbol id="mastodon" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414">
  <path transform="scale(0.07)" d="M211.80734 139.0875c-3.18125 16.36625-28.4925 34.2775-57.5625 37.74875-15.15875 1.80875-30.08375 3.47125-45.99875 2.74125-26.0275-1.1925-46.565-6.2125-46.565-6.2125 0 2.53375.15625 4.94625.46875 7.2025 3.38375 25.68625 25.47 27.225 46.39125 27.9425 21.11625.7225 39.91875-5.20625 39.91875-5.20625l.8675 19.09s-14.77 7.93125-41.08125 9.39c-14.50875.7975-32.52375-.365-53.50625-5.91875C9.23234 213.82 1.40609 165.31125.20859 116.09125c-.365-14.61375-.14-28.39375-.14-39.91875 0-50.33 32.97625-65.0825 32.97625-65.0825C49.67234 3.45375 78.20359.2425 107.86484 0h.72875c29.66125.2425 58.21125 3.45375 74.8375 11.09 0 0 32.975 14.7525 32.975 65.0825 0 0 .41375 37.13375-4.59875 62.915"/>
  <path transform="scale(0.07)" fill="#FFF" d="M177.50984 80.077v60.94125h-24.14375v-59.15c0-12.46875-5.24625-18.7975-15.74-18.7975-11.6025 0-17.4175 7.5075-17.4175 22.3525v32.37625H96.20734V85.42325c0-14.845-5.81625-22.3525-17.41875-22.3525-10.49375 0-15.74 6.32875-15.74 18.7975v59.15H38.90484V80.077c0-12.455 3.17125-22.3525 9.54125-29.675 6.56875-7.3225 15.17125-11.07625 25.85-11.07625 12.355 0 21.71125 4.74875 27.8975 14.2475l6.01375 10.08125 6.015-10.08125c6.185-9.49875 15.54125-14.2475 27.8975-14.2475 10.6775 0 19.28 3.75375 25.85 11.07625 6.36875 7.3225 9.54 17.22 9.54 29.675"/>
</symbol>


</svg>

```

`_site/feed.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2025-05-01T05:29:56+02:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">hLunaaa</title><subtitle>8086 and C++23</subtitle><entry><title type="html">Examining Malware Thread Creation Techniques</title><link href="http://localhost:4000/2025/04/29/Examining-Malware-Thread-Creation-Techniques.html" rel="alternate" type="text/html" title="Examining Malware Thread Creation Techniques" /><published>2025-04-29T12:13:25+02:00</published><updated>2025-04-29T12:13:25+02:00</updated><id>http://localhost:4000/2025/04/29/Examining-Malware-Thread-Creation-Techniques</id><content type="html" xml:base="http://localhost:4000/2025/04/29/Examining-Malware-Thread-Creation-Techniques.html"><![CDATA[<p>Most malware want to quickly implant and exit the first stage of the payload execution. They do this by writing the second stage payload bytes to some executable memory and passing control there, either by creating a new thread or by redirecting an existing legitimate thread. In this post we examine the primarily four ways that most malware accomplish this.</p>

<p><code class="language-plaintext highlighter-rouge">CreateThread</code> and <code class="language-plaintext highlighter-rouge">CreateRemoteThread</code></p>

<p><code class="language-plaintext highlighter-rouge">QueueUserAPC</code></p>

<p>Set Thread IP</p>

<p><code class="language-plaintext highlighter-rouge">SetWindowsHookExA</code></p>]]></content><author><name></name></author><summary type="html"><![CDATA[Most malware want to quickly implant and exit the first stage of the payload execution. They do this by writing the second stage payload bytes to some executable memory and passing control there, either by creating a new thread or by redirecting an existing legitimate thread. In this post we examine the primarily four ways that most malware accomplish this.]]></summary></entry><entry><title type="html">Bypassing CR3 Abuse with Physical R/W</title><link href="http://localhost:4000/2025/04/25/Bypassing-CR3-Abuse-with-Physical-RW-copy.html" rel="alternate" type="text/html" title="Bypassing CR3 Abuse with Physical R/W" /><published>2025-04-25T09:12:29+02:00</published><updated>2025-04-25T09:12:29+02:00</updated><id>http://localhost:4000/2025/04/25/Bypassing-CR3-Abuse-with-Physical-RW%20copy</id><content type="html" xml:base="http://localhost:4000/2025/04/25/Bypassing-CR3-Abuse-with-Physical-RW-copy.html"><![CDATA[<p><br /></p>
<h3 id="rationale">Rationale</h3>

<p>Some kernel mode anti-cheat solutions have now begun to obscure <code class="language-plaintext highlighter-rouge">KPROCESS.DirectoryTableBase</code> by effectively moving the address space via page table manipulation on startup. This prevents attaching to the real process space and makes it slightly more difficult for cheats and malware to to read/write the protected memory.</p>

<p>The problem? User processes were realistically already not able to interact with the protected memory, and kernel drivers and hypervisors have access to the underlying physical memory. Currently <code class="language-plaintext highlighter-rouge">EAC</code> and <code class="language-plaintext highlighter-rouge">VKG</code> implement some form of <code class="language-plaintext highlighter-rouge">CR3</code> abuse, but using monkey bruteforce™ we can walk all physical ranges and parse the <code class="language-plaintext highlighter-rouge">PML4</code>.</p>

<p>In theory, this can also be achieved from user mode as page tables are mapped to virtual memory with some assistance. We can even force a <code class="language-plaintext highlighter-rouge">TLB</code> flush using <code class="language-plaintext highlighter-rouge">SwitchToThread()</code>. The method relies on finding the self-referencing <code class="language-plaintext highlighter-rouge">PML4</code> entry, so the caller must have some level of access to the underlying physical memory, or leak non-exported names like <code class="language-plaintext highlighter-rouge">MmPteBase</code>, <code class="language-plaintext highlighter-rouge">MmPdeBase</code> and <code class="language-plaintext highlighter-rouge">MmPfnDatabase</code> which are used internally. More closely studying <code class="language-plaintext highlighter-rouge">MmGetVirtualForPhysical()</code> is recommended.</p>

<p><br /></p>
<h3 id="technique-to-find-directory-table">Technique to Find Directory Table</h3>

<p>We first cache the physical memory ranges. Here we can either call <code class="language-plaintext highlighter-rouge">MmGetPhysicalMemoryRanges()</code> or implement the same behavior ourselves. The <a href="https://doxygen.reactos.org/d1/d6d/dynamic_8c.html#a4d2191536acfdbcab710579f81193527">ReactOS</a> source can help provide context, but obviously look at the disassembly of <code class="language-plaintext highlighter-rouge">MiReferencePageRuns()</code> as well.</p>

<p>When walking the pages, we assume the page is the correct <code class="language-plaintext highlighter-rouge">PML4</code> and attempt a translation using a known user address like <code class="language-plaintext highlighter-rouge">EPROCESS.SectionBaseAddress</code>.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#define _pfn_to_page(pfn) (pfn &lt;&lt; _page_shift)
#define _page_to_pfn(pfn) (pfn &gt;&gt; _page_shift)
</span>
<span class="n">u64</span> <span class="nf">mm_find_process_cr3</span><span class="p">(</span><span class="n">EPROCESS</span><span class="o">*</span> <span class="n">proc</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">auto</span> <span class="n">physical_range</span> <span class="o">=</span> <span class="n">MmGetPhysicalMemoryRanges</span><span class="p">();</span> <span class="c1">// free with ExFreePool</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">physical_range</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1">// for every physical range</span>
  <span class="c1">// for every page</span>
  <span class="c1">// for every page table entry -- self-ref can have any idx  </span>

  <span class="n">virt_addr_t</span> <span class="n">mz_base</span><span class="p">;</span>
  <span class="n">mz_base</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">SectionBaseAddress</span><span class="p">;</span>

  <span class="k">do</span> <span class="p">{</span>
    <span class="n">u64</span> <span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">physical_range</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">);</span>
    <span class="n">u64</span> <span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">physical_range</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">physical_range</span><span class="o">-&gt;</span><span class="n">NumberOfBytes</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">u64</span> <span class="n">it</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="n">dst</span><span class="p">;</span> <span class="n">it</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> 
    <span class="k">for</span> <span class="p">(</span><span class="n">u32</span> <span class="n">pml4e_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pml4e_idx</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">;</span> <span class="n">pml4e_idx</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">auto</span> <span class="n">self_ref</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml4e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">it</span> <span class="o">+</span> <span class="n">pml4e_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml4e_t</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">self_ref</span><span class="p">.</span><span class="n">pfn</span><span class="p">))</span> <span class="c1">// self-ref?</span>
        <span class="k">continue</span><span class="p">;</span>

      <span class="c1">// ok - attempt translation</span>
      <span class="k">auto</span> <span class="n">pml4e</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml4e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">it</span> <span class="o">+</span> <span class="n">mz_base</span><span class="p">.</span><span class="n">pml4_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml4e_t</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pml4e</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span> <span class="c1">// bad cr3, check next page...</span>

      <span class="k">auto</span> <span class="n">pml3e</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml3e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">pml4e</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">mz_base</span><span class="p">.</span><span class="n">pml3_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml3e_t</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pml3e</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">auto</span> <span class="n">pml2e</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml2e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">pml3e</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">mz_base</span><span class="p">.</span><span class="n">pml2_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml2e_t</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pml2e</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">auto</span> <span class="n">pml1e</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml1e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">pml2e</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">mz_base</span><span class="p">.</span><span class="n">pml1_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml1e_t</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pml1e</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="o">&lt;</span><span class="n">u16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">pml1e</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">mz_base</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">!=</span> <span class="err">'</span><span class="n">ZM</span><span class="err">'</span><span class="p">)</span> <span class="c1">// check PE magic</span>
        <span class="k">break</span><span class="p">;</span>
      
      <span class="k">return</span> <span class="n">_page_to_pfn</span><span class="p">(</span><span class="n">it</span><span class="p">);</span> <span class="c1">// found cr3!</span>
    <span class="p">}</span>
    <span class="n">physical_range</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">physical_range</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>
<h3 id="the-result">The Result</h3>

<p>There’s a lot more you can do in the way of filtering out bad pages before running expensive read operations, but I leave this as an exercise to the reader. In any case, this serves as a good proof of concept. Keep in mind that the latest <code class="language-plaintext highlighter-rouge">Virtualization Based Security</code> or <code class="language-plaintext highlighter-rouge">VBS</code> enforces read-only state at the hypervisor level via <code class="language-plaintext highlighter-rouge">Second Level Address Translation</code> or <code class="language-plaintext highlighter-rouge">SLAT</code>. However, other values like page frame number remain unprotected. This will be discussed in a separate post in the future.</p>

<p><img src="/assets/image2.png" alt="Driver Output" /></p>]]></content><author><name></name></author><summary type="html"><![CDATA[Rationale]]></summary></entry><entry><title type="html">Inline x86 Syscall Abuse on x86_64 Systems</title><link href="http://localhost:4000/2025/04/20/Inline-x86-Syscall-Abuse-on-x86_64-Systems.html" rel="alternate" type="text/html" title="Inline x86 Syscall Abuse on x86_64 Systems" /><published>2025-04-20T05:12:41+02:00</published><updated>2025-04-20T05:12:41+02:00</updated><id>http://localhost:4000/2025/04/20/Inline-x86-Syscall-Abuse-on-x86_64-Systems</id><content type="html" xml:base="http://localhost:4000/2025/04/20/Inline-x86-Syscall-Abuse-on-x86_64-Systems.html"><![CDATA[<p><br /></p>
<h3 id="rationale">Rationale</h3>

<p>Malware and cheats often call system API to do things. Calls like <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> and <code class="language-plaintext highlighter-rouge">VirtualProtect</code> are routed through <code class="language-plaintext highlighter-rouge">NtAllocateVirtualMemory</code> and <code class="language-plaintext highlighter-rouge">NtProtectVirtualMemory</code> after some user mode checks in <code class="language-plaintext highlighter-rouge">Kernel32.dll</code>. However, using the highest level API can fall victim to user mode hooks.</p>

<p>For example, instrumentation callbacks are set using <code class="language-plaintext highlighter-rouge">NtSetInformationProcess</code>. By using the info class <code class="language-plaintext highlighter-rouge">ProcessInstrumentationCallback</code> &amp; passing a <code class="language-plaintext highlighter-rouge">PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION</code> structure containing a callback function, we handle all syscalls coming from all threads. We can also use <code class="language-plaintext highlighter-rouge">TLS</code> and examine the return address and arguments of all syscalls, storing context as we do so.</p>

<p><br /></p>
<h3 id="briefly-on-syscalls">Briefly on Syscalls</h3>
<p>When we perform a <code class="language-plaintext highlighter-rouge">syscall</code>, we request that the OS do something. On Windows version <code class="language-plaintext highlighter-rouge">NT6+</code>, these system calls are implemented in <code class="language-plaintext highlighter-rouge">ntoskrnl</code> and <code class="language-plaintext highlighter-rouge">win32k</code> in exported tables <a href="https://hfiref0x.github.io/X86_64/NT6_syscalls.html"><code class="language-plaintext highlighter-rouge">KiServiceTables</code></a> and <a href="https://hfiref0x.github.io/X86_64/NT6_w32ksyscalls.html"><code class="language-plaintext highlighter-rouge">W32pServiceTables</code></a> respectively.</p>

<p>We can use syscalls to bridge the user-kernel gap not covered by public APIs, though many opaque routines are mirrored renames of syscalls, often with some error checking and so on. The majority of syscalls are trampolined via <code class="language-plaintext highlighter-rouge">ntdll</code>. We disassemble any x86 syscall.</p>

<p><img src="/assets/{07E01347-FB93-43D5-BB8E-3880096AEA4B}.png" alt="Syscall Disasm" /></p>

<p>The routine first places the syscall index into <code class="language-plaintext highlighter-rouge">EAX</code>. It then does something peculiar. Because the x86 call is not native, the syscall is instead routed through a translation layer <code class="language-plaintext highlighter-rouge">Wow64SystemServiceCall</code>. Instead of containing the expected <code class="language-plaintext highlighter-rouge">SYSENTER</code> instruction, it jumps into 64-bit mode and issues a <code class="language-plaintext highlighter-rouge">SYSCALL</code>.</p>

<p><img src="/assets/{1C4BCA20-5531-4364-B3D0-B45FF6EB2670}.png" alt="Wow64 Translation" /></p>

<p>We want to retrieve the address of this function, place the syscall id in <code class="language-plaintext highlighter-rouge">EAX</code>, dynamically fix the stack and return. Instead of calling the <code class="language-plaintext highlighter-rouge">ntdll</code> export, we avoid any hooks, filters and callbacks and instead ship the call straight to kernel. We can do this by allocating executable memory, setting up the function and calling it on the go.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">u64</span> <span class="nf">nt_wow64_transition</span><span class="p">(</span><span class="n">u8</span><span class="o">*</span> <span class="n">nt_base</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// 1. vv vv vv vv</span>
  <span class="c1">// BA A0 A0 31 4B       mov     edx, 4B31A0A0h</span>
  <span class="c1">// FF D2                call    edx</span>

  <span class="c1">// 2.    vv vv vv vv</span>
  <span class="c1">// FF 25 24 22 3B 4B    jmp      ds:_Wow64Transition</span>
  <span class="k">return</span> <span class="o">*</span><span class="n">uti</span><span class="o">::</span><span class="n">ida_sig</span><span class="o">&lt;</span><span class="n">u64</span><span class="o">*&gt;</span><span class="p">(</span><span class="s">"BA ?? ?? ?? ?? FF D2 C2 34 00"</span><span class="p">).</span><span class="n">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">ref</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="k">typename</span><span class="o">...</span> <span class="nc">arg_t</span><span class="p">&gt;</span>
<span class="n">u32</span> <span class="nf">nt_make_call</span><span class="p">(</span><span class="n">arg_t</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">u8</span> <span class="n">call_stub</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>  <span class="c1">// mov eax, ?? ?? ?? ??</span>
    <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>  <span class="c1">// mov edx, ?? ?? ?? ??</span>
    <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span>                    <span class="c1">// call edx</span>
    <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>               <span class="c1">// retn ?? ??</span>
  <span class="p">};</span>

  <span class="k">auto</span> <span class="n">mem_alloc</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">call_stub</span><span class="p">),</span> <span class="n">MEM_RESERVE</span> <span class="o">|</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_alloc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">STATUS_UNSUCCESSFUL</span><span class="p">;</span>

  <span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">call_stub</span><span class="p">[</span><span class="mh">0x1</span><span class="p">])</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">call_stub</span><span class="p">[</span><span class="mh">0x6</span><span class="p">])</span> <span class="o">=</span> <span class="n">nt_wow64_transition</span><span class="p">(</span><span class="n">LoadLibraryA</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">));</span> <span class="c1">// get wow64 translation</span>
  <span class="o">*</span><span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">call_stub</span><span class="p">[</span><span class="mh">0xd</span><span class="p">])</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">arg_t</span><span class="p">)</span> <span class="o">+</span> <span class="p">...);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">call_stub</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">mem_alloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">call_stub</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="c1">// write stub to RWX alloc</span>

  <span class="k">auto</span> <span class="n">ret_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">(</span><span class="kr">__stdcall</span><span class="o">*</span><span class="p">)(</span><span class="n">arg_t</span><span class="p">...))(</span><span class="n">args</span><span class="p">...);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">VirtualFree</span><span class="p">(</span><span class="n">mem_alloc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">call_stub</span><span class="p">),</span> <span class="n">MEM_RELEASE</span> <span class="o">|</span> <span class="n">MEM_DECOMMIT</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">STATUS_UNSUCCESSFUL</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">ret_status</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>
<h3 id="conclusion">Conclusion</h3>
<p>With this method, we are able to call syscalls on the go without calling the <code class="language-plaintext highlighter-rouge">ntdll</code> trampoline methods. I leave further analysis of <code class="language-plaintext highlighter-rouge">Wow64Transition</code> as an exercise to the reader. The bottom line is that we are able to implement syscalling trivially, effectively getting around many of the checks and balances that would otherwise catch us - such as those previously mentioned.</p>

<p>Similar methods are available in 64-bit, but the technique must be somewhat adapted. I leave this, too, as an exercise to the reader. Syscalls are a very interesting mechanic of operating system design.</p>]]></content><author><name></name></author><summary type="html"><![CDATA[Rationale]]></summary></entry><entry><title type="html">Exploring CI.dll and Bigpool Cache</title><link href="http://localhost:4000/2025/04/18/Exploring-CI.dll-and-Bigpool-Cache.html" rel="alternate" type="text/html" title="Exploring CI.dll and Bigpool Cache" /><published>2025-04-18T03:12:41+02:00</published><updated>2025-04-18T03:12:41+02:00</updated><id>http://localhost:4000/2025/04/18/Exploring-CI.dll-and-Bigpool-Cache</id><content type="html" xml:base="http://localhost:4000/2025/04/18/Exploring-CI.dll-and-Bigpool-Cache.html"><![CDATA[<p><br /></p>
<h3 id="rationale"><strong>Rationale</strong></h3>

<p>Various kernel mappers like <code class="language-plaintext highlighter-rouge">KDMapper</code> use vulnerable drivers to load unsigned code into the kernel. If the driver does not already exist on the system, this is achieved by either creating a temporary file from embedded or streamed bytes in the first stage of the payload. Loading the driver leaves traces and telemetry in the <code class="language-plaintext highlighter-rouge">OS</code> that can be used in forensic analysis. As a result, sophisticated developers use techniques to clear as many of these traces as possible. In this post we briefly give an introduction to code integrity telemetry and image validation, as well as some other known traces and lists.</p>

<p>The <code class="language-plaintext highlighter-rouge">CI.dll</code> integrity module is responsible for authenticating and verifying the reliability of kernel modules. The kernel initializes it by calling <code class="language-plaintext highlighter-rouge">CiInitialize()</code>, which returns the <code class="language-plaintext highlighter-rouge">g_CiCallbacks</code> array. This list of callbacks is then used elsewhere in the kernel. For example, <code class="language-plaintext highlighter-rouge">CiValidateImageHeader()</code> is called when a driver is loaded to verify its signature.</p>

<p><img src="/assets/{FD14D6FB-2AEC-4018-9882-8ABCDAAA56CF}.png" alt="CiValidateImageHeader Call Stack" /></p>

<p>We navigate to <code class="language-plaintext highlighter-rouge">CiValidateImageHeader()</code> and follow the call into <code class="language-plaintext highlighter-rouge">CiInitializePhase2()</code>.</p>

<p><img src="/assets/{7E18B9B6-F4C0-4701-A08C-B2A6CF97B269}.png" alt="CiInitializePhase2 Call" /></p>

<p>Here, in <code class="language-plaintext highlighter-rouge">CiInitializePhase2()</code>, <code class="language-plaintext highlighter-rouge">CI.dll</code> creates the <code class="language-plaintext highlighter-rouge">g_CiEaCacheLookasideList</code> with a call to <code class="language-plaintext highlighter-rouge">ExInitializePagedLookasideList()</code> which has type <code class="language-plaintext highlighter-rouge">PAGED_LOOKASIDE_LIST</code>. See <a href="https://www.vergiliusproject.com/kernels/x64/windows-11/24h2/_PAGED_LOOKASIDE_LIST">documentation.</a> This lookaside list tracks paged big pool (heap) allocations.</p>

<p><br /></p>
<h3 id="a-word-on-pool-allocations"><strong>A Word on Pool Allocations</strong></h3>

<p>Insiders are already aware that there are two (well, three) pool allocators: regular and big allocator. The regular allocator is used for any allocation less than or equal to a page in size, including the 32 byte pool header and initial free block. Big pool allocator is used when the size is more than one page, or when the pool type is <code class="language-plaintext highlighter-rouge">CacheAligned</code>. Crucially, big pool allocations dont have room for headers, and are instead tracked in the <code class="language-plaintext highlighter-rouge">PoolBigTable</code>.</p>

<p><img src="/assets/image.png" alt="ExInitializePagedLookasideList Usage" /></p>

<p>In the docs, we see field <code class="language-plaintext highlighter-rouge">ListEntry</code> which we use to iterate over the list. Interestingly, we also see <code class="language-plaintext highlighter-rouge">PoolType</code>, <code class="language-plaintext highlighter-rouge">Tag</code> and <code class="language-plaintext highlighter-rouge">Size</code>. We generate the signature <code class="language-plaintext highlighter-rouge">48 8D 0D ?? ?? ?? ?? C7 44 24</code> and walk.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#pragma pack(push, 1)
</span><span class="k">struct</span> <span class="nc">ci_lookaside_t</span>
<span class="p">{</span>
  <span class="n">u8</span> <span class="n">pad0</span><span class="p">[</span><span class="mh">0x24</span><span class="p">];</span>
  <span class="n">u32</span> <span class="n">type</span><span class="p">;</span>                 <span class="c1">// +0x24</span>
  <span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>                  <span class="c1">// +0x28</span>
  <span class="n">u32</span> <span class="n">size</span><span class="p">;</span>                 <span class="c1">// +0x2c</span>
  <span class="n">u8</span> <span class="n">pad1</span><span class="p">[</span><span class="mh">0x10</span><span class="p">];</span>
  <span class="n">list_entry_t</span> <span class="n">link</span><span class="p">;</span>        <span class="c1">// +0x40</span>
<span class="p">};</span>
<span class="cp">#pragma pack(pop)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">void</span> <span class="nf">enum_ci_cache_lookaside</span><span class="p">(</span><span class="n">u8</span><span class="o">*</span> <span class="n">ci_base</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">auto</span> <span class="n">ci_cache</span> <span class="o">=</span> <span class="n">uti</span><span class="o">::</span><span class="n">ida_sig</span><span class="o">&lt;</span><span class="n">ci_lookaside_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">ci_base</span><span class="p">,</span> <span class="s">"48 8D 0D ?? ?? ?? ?? C7 44 24"</span><span class="p">).</span><span class="n">rva</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ci_cache</span><span class="p">)</span> <span class="c1">// oopsie                                             	^^^^^^^^^^^</span>
    <span class="k">return</span><span class="p">;</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">ci_cache</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">f</span><span class="p">;</span> <span class="n">it</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">ci_cache</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">auto</span> <span class="n">it_entry</span> <span class="o">=</span> <span class="n">CONTAINING_RECORD</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">ci_lookaside_t</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">it_entry</span><span class="p">)</span>
      <span class="k">continue</span><span class="p">;</span>

    <span class="k">auto</span> <span class="n">it_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">it_entry</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
    <span class="n">DbgPrintEx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"-- size: %6X type: %4X tag: %c%c%c%c</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
      <span class="n">it_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">it_entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">it_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">it_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">it_tag</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">it_tag</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>We load the driver and run it. The type is <code class="language-plaintext highlighter-rouge">POOL_TYPE</code>, which is <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ne-wdm-_pool_type">documented.</a> The output shows many <code class="language-plaintext highlighter-rouge">PagedPool</code> entries with varying sizes. <code class="language-plaintext highlighter-rouge">CI.dll</code> keeps track of a lot of interesting telemetry. There are many lists like <code class="language-plaintext highlighter-rouge">g_BootDriverList</code>, <code class="language-plaintext highlighter-rouge">g_CiValidationLookasideList</code>, <code class="language-plaintext highlighter-rouge">g_KernelHashBucketList</code> and <code class="language-plaintext highlighter-rouge">g_KernelHashBucketList</code>.</p>

<p><img src="/assets/{83E0EFE6-C7EE-420A-92C1-590E6A2EE129}.png" alt="Output" /></p>

<p><br /></p>
<h3 id="the-bottom-line"><strong>The Bottom Line</strong></h3>

<p>The traditional way of dealing dealing with these lists is locking, deleting and creating them with <code class="language-plaintext highlighter-rouge">ExDeleteLookasideListEx()</code> and <code class="language-plaintext highlighter-rouge">ExInitializeLookasideListEx()</code>. But clearing lists which would otherwise include reference to legitimate drivers is suspicious. Indeed, the best approach is to walk every relevant list and unlinking references to your vulnerable driver.</p>

<p>In addition, <code class="language-plaintext highlighter-rouge">ntoskrnl</code> tracks additional telemetry like <code class="language-plaintext highlighter-rouge">PiDDBCacheTable</code>, <code class="language-plaintext highlighter-rouge">MmLastUnloadedDriver</code>, <code class="language-plaintext highlighter-rouge">MmUnloadedDrivers</code>. The more you dig, the more you uncover. All these lists, caches and trees are potential detection vectors. Advanced malware and cheats should consider all of them and more.</p>]]></content><author><name></name></author><summary type="html"><![CDATA[Rationale]]></summary></entry><entry><title type="html">Minesweeper Classic ESP</title><link href="http://localhost:4000/2025/04/17/Minesweeper-Classic-ESP.html" rel="alternate" type="text/html" title="Minesweeper Classic ESP" /><published>2025-04-17T09:19:42+02:00</published><updated>2025-04-17T09:19:42+02:00</updated><id>http://localhost:4000/2025/04/17/Minesweeper-Classic-ESP</id><content type="html" xml:base="http://localhost:4000/2025/04/17/Minesweeper-Classic-ESP.html"><![CDATA[<p>Minesweeper is a fun little game about clicking squares and avoiding bombs. But I’ve always wondered how it works under the hood. A grid game. There’s probably a bitmap somewhere.</p>

<p>In the context menu we can create a custom came by setting width, height and number of bombs. I attach a debugger and see where these are accessed. They bring me to the function responsible for showing the dialog <code class="language-plaintext highlighter-rouge">winmine.hlp</code>. We rename the variables.</p>

<p><img src="/assets/{AB29194B-780E-4E52-A8D0-86B679B54278}.png" alt="" /></p>

<p>By cross referencing where these are used we find multiple functions. Some store the custom game values to registry keys, others load defaults on startup. We also find an interesting function that loops, reducing the bomb count on each iteration.</p>

<p><img src="/assets/{FB211914-8E66-435F-9BAD-01036C06A600}.png" alt="" /></p>

<p>At this point it is quite clear what this function does. We loop over the bitmap, setting the bomb flag <code class="language-plaintext highlighter-rouge">0x80</code> at random using <code class="language-plaintext highlighter-rouge">rand</code>. We see the bitmap stride <code class="language-plaintext highlighter-rouge">32 * Y + X</code>, with <code class="language-plaintext highlighter-rouge">X</code> and <code class="language-plaintext highlighter-rouge">Y</code> starting at <code class="language-plaintext highlighter-rouge">1</code>. With this information, we are able to read the bitmap and check for bomb flags.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">void</span> <span class="nf">loop_draw_esp</span><span class="p">(</span><span class="n">u8</span><span class="o">*</span> <span class="n">game</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">u32</span> <span class="n">hdc</span> <span class="o">=</span> <span class="n">GetDC</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// lazy, grab the entire screen</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdc</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="n">game</span> <span class="o">+</span> <span class="mh">0x5164</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// should clock start (is playing?)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="n">u32</span> <span class="n">win_x</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="n">game</span> <span class="o">+</span> <span class="mh">0x56B0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">18</span><span class="p">;</span>
  <span class="n">u32</span> <span class="n">win_y</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="n">game</span> <span class="o">+</span> <span class="mh">0x56B4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">105</span><span class="p">;</span> <span class="c1">// window pos + offset to tile grid</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">u32</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="n">game</span> <span class="o">+</span> <span class="mh">0x5338</span><span class="p">);</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">u32</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="n">game</span> <span class="o">+</span> <span class="mh">0x5334</span><span class="p">);</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="c1">// walk coords</span>
  <span class="p">{</span>
    <span class="n">u32</span> <span class="n">tile</span> <span class="o">=</span> <span class="p">(</span><span class="n">game</span> <span class="o">+</span> <span class="mh">0x5340</span><span class="p">)[</span><span class="mi">32</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">x</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tile</span> <span class="o">&amp;</span> <span class="mh">0x80u</span><span class="p">)</span> <span class="c1">// has bomb?</span>
      <span class="n">draw_tile</span><span class="p">(</span><span class="n">hdc</span><span class="p">,</span> <span class="n">win_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">15</span><span class="p">,</span> <span class="n">win_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">15</span><span class="p">,</span> <span class="n">RGB</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">ReleaseDC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hdc</span><span class="p">);</span>
  <span class="n">Sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>It really is that shrimple. We inject and play. This is the result.</p>

<p><img src="/assets/{EAB758A4-2E16-4FE7-929F-726D7CB065AB}.png" alt="" /></p>]]></content><author><name></name></author><summary type="html"><![CDATA[Minesweeper is a fun little game about clicking squares and avoiding bombs. But I’ve always wondered how it works under the hood. A grid game. There’s probably a bitmap somewhere.]]></summary></entry><entry><title type="html">PageView64 Dynamic IA32e Paging Structure Explorer</title><link href="http://localhost:4000/2025/04/17/PageView64.html" rel="alternate" type="text/html" title="PageView64 Dynamic IA32e Paging Structure Explorer" /><published>2025-04-17T07:19:42+02:00</published><updated>2025-04-17T07:19:42+02:00</updated><id>http://localhost:4000/2025/04/17/PageView64</id><content type="html" xml:base="http://localhost:4000/2025/04/17/PageView64.html"><![CDATA[<blockquote>
  <p>Paging is a system which allows each process to see a full virtual address space, without actually requiring the full amount of physical memory to be available or present. 32-bit x86 processors support 32-bit virtual addresses and 4-GiB virtual address spaces, and current 64-bit processors support 48-bit virtual addressing and 256-TiB virtual address spaces.
<br />- <a href="https://wiki.osdev.org/Paging#64-Bit_Paging">OSDev Wiki</a></p>
</blockquote>

<p><br /></p>
<h3 id="rationale"><strong>Rationale</strong></h3>
<p>For a long time I struggled to visualize <code class="language-plaintext highlighter-rouge">IA32e</code> paging structures in my head. I always viewed paging as redundant. You’d think paging redundant on modern systems. Indeed, it is possible to implement virtual addressing, protection and session spacing with identity mapping.</p>

<p>The argument for memory efficiency is also not very convincing, but there aren’t many reasons for Microsoft to mess with things that already work well enough, not to mention that paging as a concept is more a vertical issue than just software alone.</p>

<p>From the malware perspective, acting on the underlying physical memory is far more powerful than using official <code class="language-plaintext highlighter-rouge">API</code> to adjust virtual memory. We are able to get around many of the restrictions placed on virtual memory. We can ignore session spacing and page protection. We can construct our own paging structures and allocate memory hidden from the <code class="language-plaintext highlighter-rouge">Virtual Address Descriptor</code> or <code class="language-plaintext highlighter-rouge">VAD</code>.</p>

<p>The following diagram describes the layout of an <code class="language-plaintext highlighter-rouge">IA32e</code> virtual address.</p>

<p><img src="/assets/4_level_paging.png" alt="IA32e Paging Overview" /></p>

<p>Each page table is a list of <code class="language-plaintext highlighter-rouge">512</code> addresses. The first <code class="language-plaintext highlighter-rouge">256</code> are reserved for user addresses. There are four page tables. Also consider that <code class="language-plaintext highlighter-rouge">512 * sizeof(uintptr_t) == PAGE_SIZE</code>. The base physical address of the <code class="language-plaintext highlighter-rouge">PML4</code> is described by <code class="language-plaintext highlighter-rouge">EPROCESS.DirectoryTableBase</code>.</p>

<p><br /></p>
<h3 id="address-translation"><strong>Address Translation</strong></h3>
<p>Paging relates to session spacing. When a thread goes from one address space to another via <code class="language-plaintext highlighter-rouge">SwapContext</code>, the <code class="language-plaintext highlighter-rouge">CR3</code> is set. When the <code class="language-plaintext highlighter-rouge">CPU</code> wants to translate a physical address, it first checks if the translation already exists in the <code class="language-plaintext highlighter-rouge">Translation Lookaside Buffer</code> or <code class="language-plaintext highlighter-rouge">TLB</code>. If no translation exists, it walks the page tables.</p>

<blockquote>
  <p>Paging in long mode is similar to that of 32-bit paging, except Physical Address Extension (PAE) is required. Registers CR2 and CR3 are extended to 64 bits. Instead of just having to utilize 3 levels of page maps: page directory pointer table, page directory, and page table, a fourth page-map table is used: the level-4 page map table (PML4). This allows a processor to map 48-bit virtual addresses to 52-bit physical addresses.
<br />- <a href="https://wiki.osdev.org/Paging#64-Bit_Paging">OSDev Wiki</a></p>
</blockquote>

<p>As a sidenote, you can flush the <code class="language-plaintext highlighter-rouge">TLB</code> by toggling the <code class="language-plaintext highlighter-rouge">CR4.PGE</code> bit or firing the <code class="language-plaintext highlighter-rouge">INVLPG</code> instruction. User mode applications can use <code class="language-plaintext highlighter-rouge">SwitchToThread()</code> to force a context switch.</p>

<p>A word on naming conventions. Four-level paging is implemented in both <code class="language-plaintext highlighter-rouge">IA32e</code> and <code class="language-plaintext highlighter-rouge">AMD64</code>, but with different naming schemes. This often leads to confusion. In this paper we simplify to <code class="language-plaintext highlighter-rouge">PML4</code>, <code class="language-plaintext highlighter-rouge">PML3</code>, <code class="language-plaintext highlighter-rouge">PML2</code> and <code class="language-plaintext highlighter-rouge">PML1</code>.</p>

<p>We translate by walking down the chain.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#define _pfn_to_page(pfn) (pfn &lt;&lt; _page_shift)
</span>
<span class="n">u8</span><span class="o">*</span> <span class="nf">vtop</span><span class="p">(</span><span class="n">EPROCESS</span><span class="o">*</span> <span class="n">proc</span><span class="p">,</span> <span class="n">virt_addr_t</span> <span class="n">va</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// read from proc, but if it is currentproc we can obv __readcr3</span>
  <span class="c1">// procs can also obscure the DirectoryTableBase with tricks</span>
  <span class="n">pml4e_t</span> <span class="n">pml4e</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml4e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">DirectoryTableBase</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">va</span><span class="p">.</span><span class="n">pml4_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml4e_t</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pml4e</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  
  <span class="n">pml3e_t</span> <span class="n">pml3e</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml3e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">pml4e</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">va</span><span class="p">.</span><span class="n">pml3_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml3e_t</span><span class="p">))</span><span class="o">&gt;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pml3e</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">pml2e_t</span> <span class="n">pml2e</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml2e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">pml3e</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">va</span><span class="p">.</span><span class="n">pml2_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml2e_t</span><span class="p">))</span><span class="o">&gt;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pml2e</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">pml1e_t</span> <span class="n">pml1e</span> <span class="o">=</span> <span class="n">read</span><span class="o">&lt;</span><span class="n">pml1e_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">pml2e</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">va</span><span class="p">.</span><span class="n">pml1_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pml1e_t</span><span class="p">))</span><span class="o">&gt;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pml1e</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  
  <span class="c1">// finally return pfn + page offset...</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)(</span><span class="n">_pfn_to_page</span><span class="p">(</span><span class="n">pml1e</span><span class="p">.</span><span class="n">pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">va</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Both <code class="language-plaintext highlighter-rouge">PML3</code> and <code class="language-plaintext highlighter-rouge">PML2</code> can have large page entries, describing <code class="language-plaintext highlighter-rouge">1GB</code> and <code class="language-plaintext highlighter-rouge">2MB</code> pages respectively if <code class="language-plaintext highlighter-rouge">HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management\LargePageDrivers</code> is set. This is all outlined in my <a href="https://gist.github.com/hLunaaa/f23a48775bbe5425b4825eefcebf1197">header file.</a> We call these <code class="language-plaintext highlighter-rouge">PML3e_LARGE</code> and <code class="language-plaintext highlighter-rouge">PML2e_LARGE</code>. So in page table <code class="language-plaintext highlighter-rouge">PML3</code>, entries can describe the <code class="language-plaintext highlighter-rouge">PML2</code> or a <code class="language-plaintext highlighter-rouge">1GB</code> page directly. Similarly, entries in <code class="language-plaintext highlighter-rouge">PML2</code> might describe the <code class="language-plaintext highlighter-rouge">PML1</code> or a <code class="language-plaintext highlighter-rouge">2MB</code> page directly. We can check for large page by checking the <code class="language-plaintext highlighter-rouge">PageSize</code> bit. I leave large page translation as an exercise to the reader.</p>

<p><br /></p>

<h3 id="demonstration"><strong>Demonstration</strong></h3>
<p><code class="language-plaintext highlighter-rouge">PageView64</code> was created to visualize these structures. The program consists of the <code class="language-plaintext highlighter-rouge">PageView64.sys</code> driver and <code class="language-plaintext highlighter-rouge">PageView64.exe</code> client. The driver calls <code class="language-plaintext highlighter-rouge">MmCopyMemory</code> on <code class="language-plaintext highlighter-rouge">IRP</code>. We send the process ID and receive the <code class="language-plaintext highlighter-rouge">4KB</code> page tables. The client uses <code class="language-plaintext highlighter-rouge">ImGui</code> with <code class="language-plaintext highlighter-rouge">SFML</code>.</p>

<video width="100%" controls="controls"><source src="/assets/PageView64.mp4" /></video>]]></content><author><name></name></author><summary type="html"><![CDATA[Paging is a system which allows each process to see a full virtual address space, without actually requiring the full amount of physical memory to be available or present. 32-bit x86 processors support 32-bit virtual addresses and 4-GiB virtual address spaces, and current 64-bit processors support 48-bit virtual addressing and 256-TiB virtual address spaces. - OSDev Wiki]]></summary></entry></feed>
```

`_site/index.html`:

```html
<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>hLunaaa | 8086 and C++23</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="hLunaaa" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="8086 and C++23" />
<meta property="og:description" content="8086 and C++23" />
<link rel="canonical" href="http://localhost:4000/" />
<meta property="og:url" content="http://localhost:4000/" />
<meta property="og:site_name" content="hLunaaa" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="hLunaaa" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebSite","description":"8086 and C++23","headline":"hLunaaa","name":"hLunaaa","url":"http://localhost:4000/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="hLunaaa" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">hLunaaa</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="home">
<h2 class="post-list-heading">Posts</h2>
    <ul class="post-list"><li><span class="post-meta">Apr 29, 2025</span>
        <h3>
          <a class="post-link" href="/2025/04/29/Examining-Malware-Thread-Creation-Techniques.html">
            Examining Malware Thread Creation Techniques
          </a>
        </h3></li><li><span class="post-meta">Apr 25, 2025</span>
        <h3>
          <a class="post-link" href="/2025/04/25/Bypassing-CR3-Abuse-with-Physical-RW-copy.html">
            Bypassing CR3 Abuse with Physical R/W
          </a>
        </h3></li><li><span class="post-meta">Apr 20, 2025</span>
        <h3>
          <a class="post-link" href="/2025/04/20/Inline-x86-Syscall-Abuse-on-x86_64-Systems.html">
            Inline x86 Syscall Abuse on x86_64 Systems
          </a>
        </h3></li><li><span class="post-meta">Apr 18, 2025</span>
        <h3>
          <a class="post-link" href="/2025/04/18/Exploring-CI.dll-and-Bigpool-Cache.html">
            Exploring CI.dll and Bigpool Cache
          </a>
        </h3></li><li><span class="post-meta">Apr 17, 2025</span>
        <h3>
          <a class="post-link" href="/2025/04/17/Minesweeper-Classic-ESP.html">
            Minesweeper Classic ESP
          </a>
        </h3></li><li><span class="post-meta">Apr 17, 2025</span>
        <h3>
          <a class="post-link" href="/2025/04/17/PageView64.html">
            PageView64 Dynamic IA32e Paging Structure Explorer
          </a>
        </h3></li></ul></div>

      </div>
    </main></body>

</html>

```

`about.markdown`:

```markdown
---
layout: page
title: About
permalink: /about/
---

![John Martin](/assets/{80160CA8-EB1C-4189-9B32-ED16BD8B0FA4}.png)

Blog where I write whatever I want, whenever I want. Mostly reverse engineering and malware research.

View my [projects.](https://github.com/hLunaaa)


```

`assets/2025-04-29-Examining-Malware-Thread-Creation-Techniques.markdown`:

```markdown
---
layout: post
title:  "Examining Malware Thread Creation Techniques"
date:   2025-04-29 12:13:25 +0200
---

Most malware want to quickly implant and exit the first stage of the payload execution. They do this by writing the second stage payload bytes to some executable memory and passing control there, either by creating a new thread or by redirecting an existing legitimate thread. In this post we examine the four main ways that most malware accomplish this.

`CreateThread` and `CreateRemoteThread`

`QueueUserAPC`

Set Thread IP

`SetWindowsHookExA`

{% highlight C++ %}

{% endhighlight %}

```

`index.markdown`:

```markdown
---
# Feel free to add content and custom Front Matter to this file.
# To modify the layout, see https://jekyllrb.com/docs/themes/#overriding-theme-defaults

layout: home
---

```