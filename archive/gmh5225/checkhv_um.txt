Project Path: arc_gmh5225_checkhv_um_83knwoig

Source Tree:

```txt
arc_gmh5225_checkhv_um_83knwoig
├── README.md
├── hv_um.cpp
├── hv_um.sln
├── hv_um.vcxproj
└── hv_um.vcxproj.filters

```

`README.md`:

```md
## CheckSyntheticCPUID
CPUID leaf is explicitly defined for hypervisors to expose their presence and vendor ID; any honest vm stack should set this up
***

## CheckCrystalClock
compare freq from crystal clock or base MHz to measured TSC freq via RDTSC againsst QueryPerformanceCounter; large mismatch suggests TSC scaling/offsetting or lazy CPUID emulation
***

## CheckKUserSharedData
calculate the delta between the shared page time and RDTSC;  large deviation suggests the OS timer and TSC/time virtualization are out of sync
***

## CheckUMIP_SGDT
modern CPUs support UMIP (User Mode Instruction Prevention), executing instructions like SGDT, SIDT and SLDT should throw a #GP exception and be emulated by the OS; should be slower and return dummy-ish values; very fast SGDT suggests UMIP is off or badly emulated; keep in mind this doesnt apply for old CPUs
***

```

`hv_um.cpp`:

```cpp
#include <windows.h>
#include <iostream>
#include <intrin.h>
#include <iomanip>
#include <chrono>

void Log(const char* label, const char* msg, bool detected) {
    HANDLE hConsole = GetStdHandle(STD_OUTPUT_HANDLE);
    std::cout << "[";
    if (detected) {
        SetConsoleTextAttribute(hConsole, FOREGROUND_RED | FOREGROUND_INTENSITY);
        std::cout << "failed";
    }
    else {
        SetConsoleTextAttribute(hConsole, FOREGROUND_GREEN | FOREGROUND_INTENSITY);
        std::cout << "success";
    }
    SetConsoleTextAttribute(hConsole, FOREGROUND_RED | FOREGROUND_GREEN | FOREGROUND_BLUE);
    std::cout << "] " << std::left << std::setw(25) << label << ": " << msg << std::endl;
}

void CheckSyntheticCPUID() {
    int cpuInfo[4] = { 0 };
    __cpuid(cpuInfo, 0x40000000);

    // only flag if it returns a valid hypervisor vendor string
    char vendor[13] = { 0 };
    memcpy(vendor, &cpuInfo[1], 4);
    memcpy(vendor + 4, &cpuInfo[2], 4);
    memcpy(vendor + 8, &cpuInfo[3], 4);

    bool isHypervisor = (cpuInfo[0] >= 0x40000000) &&
        (strcmp(vendor, "Microsoft Hv") == 0 ||
            strcmp(vendor, "VMwareVMware") == 0 ||
            strcmp(vendor, "KVMKVMKVM") == 0 ||
            strcmp(vendor, "XenVMMXenVMM") == 0);

    char msg[128];
    sprintf_s(msg, "eax=0x%08X vendor=%s", cpuInfo[0], vendor);
    Log("synthetic CPUID", msg, isHypervisor);
}

void CheckCrystalClock() {
    int leaf15[4] = { 0 };
    int leaf16[4] = { 0 };

    __cpuid(leaf15, 0x15);
    __cpuid(leaf16, 0x16);

    bool has15 = (leaf15[2] != 0); // ECX = crystal freq if supported 
    bool has16 = (leaf16[0] != 0); // EAX = base freq MHz if supported 

    double official_hz = 0.0;

    if (has15) {
        // TSC freq = ECX * EBX / EAX
        unsigned long long denom = leaf15[0] ? leaf15[0] : 1;
        official_hz = (double)leaf15[2] * (double)leaf15[1] / (double)denom;
    }
    else if (has16) {
        // leaf 0x16: base frequency in MHz, not guaranteed == TSC
        // but often very close on modern Intel, good enough as "nominal"
        unsigned int base_mhz = (unsigned int)leaf16[0];
        official_hz = (double)base_mhz * 1.0e6;
    }
    else {
        // no CPUID based freq info at all fall back to consistency only mode
        // we still measure TSC vs QPC but dont label it against an official value
    }

    LARGE_INTEGER freq, t1, t2;
    QueryPerformanceFrequency(&freq);
    QueryPerformanceCounter(&t1);

    unsigned __int64 rdtsc1 = __rdtsc();
    Sleep(100);  // short interval reduces noise
    unsigned __int64 rdtsc2 = __rdtsc();
    QueryPerformanceCounter(&t2);

    double wallSecs = (double)(t2.QuadPart - t1.QuadPart) / (double)freq.QuadPart;
    double measured_hz = (double)(rdtsc2 - rdtsc1) / wallSecs;

    char msg[128];

    if (official_hz > 0.0) {
        double pctDiff = fabs(official_hz - measured_hz) / official_hz;
        bool mismatch = (pctDiff > 0.05); // 5% tolerance

        sprintf_s(msg, "official: %.0f | measured: %.0f | %.1f%% diff",
            official_hz / 1e6, measured_hz / 1e6, pctDiff * 100.0);

        Log("CPUID.0x15/0x16", msg, mismatch);
    }
    else {
        // no official reference; just print measured TSC freq and mark as success
        sprintf_s(msg, "measured: %.0f MHz (no CPUID freq info)", measured_hz / 1e6);
        Log("TSC (measured only)", msg, false);
    }
}

void CheckKUserSharedData() {
    volatile DWORD* low = (DWORD*)0x7FFE0008;
    volatile DWORD* high = (DWORD*)0x7FFE000C;

    ULONGLONG tsc1 = __rdtsc();
    ULONGLONG k1 = ((ULONGLONG)*high << 32) | *low;

    Sleep(1000);

    ULONGLONG tsc2 = __rdtsc();
    ULONGLONG k2 = ((ULONGLONG)*high << 32) | *low;

    ULONGLONG kDelta = k2 - k1;  // should be ~10M for 1s
    bool skew = (kDelta < 9000000LL || kDelta > 11000000LL);

    char msg[64];
    sprintf_s(msg, "delta: %llu (10M expected)", kDelta);
    Log("KUSER_SHARED_DATA", msg, skew);
}

void CheckUMIP_SGDT() {
    // 8829 cycles = normal windows emulation 
    // baremetal w/ UMIP ON: kernel emulates -> 5k-15k cycles typical
    unsigned char gdtr[10] = { 0 };
    ULONGLONG t1 = __rdtsc();
    _sgdt(gdtr);
    ULONGLONG t2 = __rdtsc();

    ULONGLONG cycles = t2 - t1;
    ULONGLONG base = *(ULONGLONG*)(gdtr + 2);

    bool suspicious = (cycles < 1000);  // only flag raw hardware execution

    char msg[64];
    sprintf_s(msg, "cycles: %llu | base: 0x%llx", cycles, base);
    Log("SGDT/UMIP", msg, suspicious);
}

void CheckTSX() {
    int info[4];
    __cpuidex(info, 7, 0);

    if (!(info[1] & (1 << 11))) {
        Log("TSX/RTM", "disabled by Intel microcode (normal post-2021)", false);
        return;
    }

    // mhm
    Log("TSX/RTM", "RTM supported", false);
}

int main() {
    SetPriorityClass(GetCurrentProcess(), HIGH_PRIORITY_CLASS);

    CheckSyntheticCPUID();
    CheckCrystalClock();
    CheckKUserSharedData();
    CheckUMIP_SGDT();
    CheckTSX();

    std::cout << "\press any key to exit.\n";
    std::cin.get();
    return 0;
}

```

`hv_um.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.13.35913.81 d17.13
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "hv_um", "hv_um.vcxproj", "{C62441FD-A2B8-473A-871E-AAFE85324453}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|x64 = Debug|x64
		Debug|x86 = Debug|x86
		Release|x64 = Release|x64
		Release|x86 = Release|x86
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{C62441FD-A2B8-473A-871E-AAFE85324453}.Debug|x64.ActiveCfg = Debug|x64
		{C62441FD-A2B8-473A-871E-AAFE85324453}.Debug|x64.Build.0 = Debug|x64
		{C62441FD-A2B8-473A-871E-AAFE85324453}.Debug|x86.ActiveCfg = Debug|Win32
		{C62441FD-A2B8-473A-871E-AAFE85324453}.Debug|x86.Build.0 = Debug|Win32
		{C62441FD-A2B8-473A-871E-AAFE85324453}.Release|x64.ActiveCfg = Release|x64
		{C62441FD-A2B8-473A-871E-AAFE85324453}.Release|x64.Build.0 = Release|x64
		{C62441FD-A2B8-473A-871E-AAFE85324453}.Release|x86.ActiveCfg = Release|Win32
		{C62441FD-A2B8-473A-871E-AAFE85324453}.Release|x86.Build.0 = Release|Win32
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {3DCBBC00-2386-4D33-82F4-DA732F7A2B53}
	EndGlobalSection
EndGlobal

```

`hv_um.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>17.0</VCProjectVersion>
    <Keyword>Win32Proj</Keyword>
    <ProjectGuid>{c62441fd-a2b8-473a-871e-aafe85324453}</ProjectGuid>
    <RootNamespace>hvum</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="hv_um.cpp" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`hv_um.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;c++;cppm;ixx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;h++;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="hv_um.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```