Project Path: arc_gmh5225_edgegdi_hook_7erqhvr1

Source Tree:

```txt
arc_gmh5225_edgegdi_hook_7erqhvr1
├── README.md
├── edgegdi.cpp
├── edgegdi.hpp
├── images
│   ├── bitblt_10.0.18363.1350.PNG
│   ├── bitblt_10.0.19042.746.PNG
│   └── edgegdi_exe.PNG
├── pattern.hpp
└── test.cpp

```

`README.md`:

```md
# edgegdi_hook

Let us take a look at BitBlt in gdi32.dll...

***Windows Version 10.0.18363.1350***
![Windows Version 10.0.18363.1350](https://github.com/0mdi/edgegdi_hook/blob/main/images/bitblt_10.0.18363.1350.PNG)  

***Windows Version 10.0.19042.746 (20H2)***  
![Windows Version 10.0.19042.746](https://github.com/0mdi/edgegdi_hook/blob/main/images/bitblt_10.0.19042.746.PNG)  

## Example PoC
We can abuse this to hook various exported gdi32 functions with only one .data patch...
![Example PoC](https://github.com/0mdi/edgegdi_hook/blob/main/images/edgegdi_exe.PNG)
  
 

```

`edgegdi.cpp`:

```cpp
#include "edgegdi.hpp"
#include "pattern.hpp"

#include <stdio.h>

uintptr_t edgegdi::g_pEdgeGdi = 0;
uintptr_t edgegdi::own_table[25] = { 0 };

//
// Original functions
edgegdi::BitBlt_t edgegdi::BitBltOrig = nullptr;
edgegdi::CreateDIBSection_t edgegdi::CreateDIBSectionOrig = nullptr;
edgegdi::CreateFontW_t edgegdi::CreateFontWOrig = nullptr;
edgegdi::CreateFontIndirectW_t edgegdi::CreateFontIndirectWOrig = nullptr;
edgegdi::CreateCompatibleDC_t edgegdi::CreateCompatibleDCOrig = nullptr;
edgegdi::CreateDCW_t edgegdi::CreateDCWOrig = nullptr;
edgegdi::CreateICW_t edgegdi::CreateICWOrig = nullptr;
edgegdi::InternalDeleteDC_t edgegdi::InternalDeleteDCOrig = nullptr;
edgegdi::InternalDeleteObject_t edgegdi::InternalDeleteObjectOrig = nullptr;
edgegdi::GetObjectType_t edgegdi::GetObjectTypeOrig = nullptr;
edgegdi::GetObjectW_t edgegdi::GetObjectWOrig = nullptr;
edgegdi::GetStockObject_t edgegdi::GetStockObjectOrig = nullptr;
edgegdi::GetTextMetricsW_t edgegdi::GetTextMetricsWOrig = nullptr;
edgegdi::GetTextExtentPoint32W_t edgegdi::GetTextExtentPoint32WOrig = nullptr;
edgegdi::SelectClipRgn_t edgegdi::SelectClipRgnOrig = nullptr;
edgegdi::SelectObject_t edgegdi::SelectObjectOrig = nullptr;
edgegdi::SetMapMode_t edgegdi::SetMapModeOrig = nullptr;
edgegdi::D3DKMTOpenAdapterFromHdc_t edgegdi::D3DKMTOpenAdapterFromHdcOrig = nullptr;
edgegdi::ExtCreateRegion_t edgegdi::ExtCreateRegionOrig = nullptr;
edgegdi::GdiTrackHCreate_t edgegdi::GdiTrackHCreate = nullptr;


int NotImplemented()
{
    return 1;
}


bool edgegdi::init()
{
    auto gdi32 = (uintptr_t)GetModuleHandleA("gdi32.dll");
    if (!gdi32)
        return false;

    /*
    48 89 05 ?? ?? ?? ?? E9 ?? ?? ?? ??
    \x48\x89\x05\x00\x00\x00\x00\xE9\x00\x00\x00\x00, xxx????x????
    */
    g_pEdgeGdi = FindPattern(gdi32, 0xFF000, "\x48\x89\x05\x00\x00\x00\x00\xE9\x00\x00\x00\x00", "xxx????x????", 0);
    if (g_pEdgeGdi)
    {
        uint32_t offset = *(uint32_t*)(g_pEdgeGdi + 3);
        g_pEdgeGdi = g_pEdgeGdi + 7 + offset;
    }
    printf("g_pEdgeGdi: 0x%p\n", g_pEdgeGdi);
    return g_pEdgeGdi != NULL;
}

bool edgegdi::hook(uintptr_t BitBltHook)
{
    auto win32u = GetModuleHandleA("win32u.dll");
    auto gdi32 = GetModuleHandleA("gdi32.dll");
    auto gdi32full = GetModuleHandleA("gdi32full.dll");
    auto ntdll = GetModuleHandleA("ntdll.dll");
    if (!gdi32full || !gdi32 || !win32u || !ntdll)
        return false;

    //
    // Initialize orig functions
    BitBltOrig = (BitBlt_t)GetProcAddress(gdi32full, "BitBlt");
    CreateDIBSectionOrig = (CreateDIBSection_t)GetProcAddress(gdi32full, "CreateDIBSection");
    CreateFontWOrig = (CreateFontW_t)GetProcAddress(gdi32full, "CreateFontW");
    CreateFontIndirectWOrig = (CreateFontIndirectW_t)GetProcAddress(gdi32full, "CreateFontIndirectW");
    CreateCompatibleDCOrig = (CreateCompatibleDC_t)GetProcAddress(gdi32full, "CreateCompatibleDC");
    CreateDCWOrig = (CreateDCW_t)GetProcAddress(gdi32, "bCreateDCW");
    CreateICWOrig = (CreateICW_t)CreateDCWOrig;
    InternalDeleteDCOrig = (InternalDeleteDC_t)GetProcAddress(gdi32, "InternalDeleteDC");
    InternalDeleteObjectOrig = (InternalDeleteObject_t)GetProcAddress(gdi32, "InternalDeleteObject");
    GetObjectTypeOrig = (GetObjectType_t)GetProcAddress(gdi32full, "GetObjectType");
    GetObjectWOrig = (GetObjectW_t)GetProcAddress(gdi32full, "GetObjectW");
    GetStockObjectOrig = (GetStockObject_t)GetProcAddress(gdi32full, "GetStockObject");
    GetTextMetricsWOrig = (GetTextMetricsW_t)GetProcAddress(gdi32full, "GetTextMetricsW");
    GetTextExtentPoint32WOrig = (GetTextExtentPoint32W_t)GetProcAddress(gdi32full, "GetTextExtentPoint32W");
    SelectClipRgnOrig = (SelectClipRgn_t)GetProcAddress(gdi32full, "SelectClipRgnImpl");
    SelectObjectOrig = (SelectObject_t)GetProcAddress(gdi32full, "SelectObjectImpl");
    SetMapModeOrig = (SetMapMode_t)GetProcAddress(gdi32full, "SetMapMode");
    D3DKMTOpenAdapterFromHdcOrig = (D3DKMTOpenAdapterFromHdc_t)GetProcAddress(win32u, "NtGdiDdDDIOpenAdapterFromHdc");
    ExtCreateRegionOrig = (ExtCreateRegion_t)GetProcAddress(gdi32full, "NtGdiExtCreateRegion");

    //
    // Initialize own_table
    own_table[0] = (uintptr_t)BitBltHook/*BitBltOrig*/;
    own_table[1] = (uintptr_t)CreateDIBSectionOrig;
    own_table[2] = (uintptr_t)CreateFontWOrig;
    own_table[3] = (uintptr_t)CreateFontIndirectWOrig;
    own_table[4] = (uintptr_t)CreateCompatibleDCOrig;
    own_table[5] = (uintptr_t)CreateDCWOrig;
    own_table[6] = (uintptr_t)CreateICWOrig;
    own_table[9] = (uintptr_t)InternalDeleteDCOrig;
    own_table[11] = (uintptr_t)InternalDeleteObjectOrig;
    own_table[12] = (uintptr_t)GetObjectTypeOrig;
    own_table[13] = (uintptr_t)GetObjectWOrig;
    own_table[14] = (uintptr_t)GetStockObjectOrig;
    own_table[15] = (uintptr_t)GetTextMetricsWOrig;
    own_table[16] = (uintptr_t)GetTextExtentPoint32WOrig;
    own_table[17] = (uintptr_t)SelectClipRgnOrig;
    own_table[18] = (uintptr_t)SelectObjectOrig;
    own_table[19] = (uintptr_t)SetMapModeOrig;
    own_table[22] = (uintptr_t)D3DKMTOpenAdapterFromHdcOrig;
    own_table[23] = (uintptr_t)NotImplemented;
    own_table[24] = (uintptr_t)NotImplemented;


    // Replace vtable ptr
    DWORD OldProtect;
    VirtualProtect((LPVOID)g_pEdgeGdi, sizeof(uintptr_t), PAGE_READWRITE, &OldProtect);
    *(uintptr_t**)g_pEdgeGdi = own_table;
    VirtualProtect((LPVOID)g_pEdgeGdi, sizeof(uintptr_t), OldProtect, &OldProtect);

    return true;
}

```

`edgegdi.hpp`:

```hpp
#pragma once
#include <Windows.h>
#include <stdint.h>


namespace edgegdi
{
	extern uintptr_t g_pEdgeGdi;
	extern uintptr_t own_table[25];

	bool init();
	bool hook(uintptr_t BitBltHook);

	//
	// All original functions
	using BitBlt_t = BOOL(*)(HDC, int, int, int, int, HDC, int, int, DWORD);
	extern BitBlt_t BitBltOrig;
	using CreateDIBSection_t = HBITMAP(*)(HDC, BITMAPINFO*, UINT, void**, HANDLE, DWORD);
	extern CreateDIBSection_t CreateDIBSectionOrig;
	using CreateFontW_t = HFONT(*)(int, int, int, int, int, DWORD, DWORD, DWORD, DWORD, DWORD, DWORD, DWORD, DWORD, LPCWSTR);
	extern CreateFontW_t CreateFontWOrig;
	using CreateFontIndirectW_t = HFONT(*)(LOGFONTW*);
	extern CreateFontIndirectW_t CreateFontIndirectWOrig;
	using CreateCompatibleDC_t = HDC(*)(HDC);
	extern CreateCompatibleDC_t CreateCompatibleDCOrig;
	using CreateDCW_t = HDC(*)(LPCWSTR, LPCWSTR, LPCWSTR, DEVMODEW*);
	extern CreateDCW_t CreateDCWOrig;
	using CreateICW_t = HDC(*)(LPCWSTR, LPCWSTR, LPCWSTR, DEVMODEW*);
	extern CreateICW_t CreateICWOrig;
	using InternalDeleteDC_t = BOOL(*)(PVOID);
	extern InternalDeleteDC_t InternalDeleteDCOrig;
	using InternalDeleteObject_t = BOOL(*)(PVOID);
	extern InternalDeleteObject_t InternalDeleteObjectOrig;
	using GetObjectType_t = DWORD(*)(HGDIOBJ);
	extern GetObjectType_t GetObjectTypeOrig;
	using GetObjectW_t = int(*)(HANDLE, int, LPVOID);
	extern GetObjectW_t GetObjectWOrig;
	using GetStockObject_t = HGDIOBJ(*)(int);
	extern GetStockObject_t GetStockObjectOrig;
	using GetTextMetricsW_t = BOOL(*)(HDC, LPTEXTMETRICW);
	extern GetTextMetricsW_t GetTextMetricsWOrig;
	using GetTextExtentPoint32W_t = BOOL(*)(HDC, LPCWSTR, int, LPSIZE);
	extern GetTextExtentPoint32W_t GetTextExtentPoint32WOrig;
	using SelectClipRgn_t = int(*)(HDC, HRGN);
	extern SelectClipRgn_t SelectClipRgnOrig;
	using SelectObject_t = HGDIOBJ(*)(HDC, HGDIOBJ);
	extern SelectObject_t SelectObjectOrig;
	using SetMapMode_t = int(*)(HDC, int);
	extern SetMapMode_t SetMapModeOrig;
	using D3DKMTOpenAdapterFromHdc_t = PVOID(*)(HDC);
	extern D3DKMTOpenAdapterFromHdc_t D3DKMTOpenAdapterFromHdcOrig;
	using ExtCreateRegion_t = HRGN(*)(XFORM*, DWORD, RGNDATA*);
	extern ExtCreateRegion_t ExtCreateRegionOrig;
	using GdiTrackHCreate_t = void(*)(HDC);
	extern GdiTrackHCreate_t GdiTrackHCreate;
}
```

`pattern.hpp`:

```hpp
#pragma once
#include <stdint.h>

bool DataCompare(const uint8_t* OpCodes, const uint8_t* Mask, const char* StrMask)
{
	while (*StrMask)
	{
		if (*StrMask == 'x' && *OpCodes != *Mask)
			return false;

		++StrMask;
		++OpCodes;
		++Mask;
	}

	return true;
}

uintptr_t FindPattern(uintptr_t StartAddress, uint32_t CodeLen, const char* Mask, const char* StrMask, unsigned short ignore)
{
	uint16_t Ign = 0;
	uint32_t i = 0;

	while (Ign <= ignore)
	{
		if (DataCompare((uint8_t*)(StartAddress + i++), (uint8_t*)Mask, StrMask))
			++Ign;

		else if (i >= CodeLen)
			return 0;
	}

	return StartAddress + i - 1;
}
```

`test.cpp`:

```cpp
#include <Windows.h>
#include <stdio.h>
#include "edgegdi.hpp"


BOOL BitBltHook(HDC hdc, int x, int y, int cx, int cy, HDC hdcSrc, int x1, int y1, DWORD rop)
{
    auto CurrentPid = GetCurrentProcessId();
    auto CurrentTid = GetCurrentThreadId();

    char buf[256] = { 0 };
    sprintf_s(buf, sizeof(buf), "%s (PID: %i, TID: %i) (X: %i (%i), Y: %i (%i)) (X: %i, Y: %i) (%X, %X)",
        __FUNCTION__,
        CurrentPid, CurrentTid,
        x, cx, y, cy,
        x1, y1,
        hdc, hdcSrc);
    printf(buf);

    return edgegdi::BitBltOrig(hdc, x, y, cx, cy, hdcSrc, x1, y1, rop);
}

int main()
{
    SetConsoleTitleA("EDGEGDI.EXE");
    printf("Calling BitBlt.\n");
    BitBlt(nullptr, 0, 0, 0, 0, nullptr, 0, 0, 0);

    printf("Hooking BitBlt.\n");
    if (!edgegdi::init() || !edgegdi::hook((uintptr_t)BitBltHook))
    {
        printf("Failed to hook BitBlt.\n");
        return -1;
    }

    printf("Calling BitBlt again.\n");
    BitBlt((HDC)0xB16B00B5, 0, 0, 0, 0, (HDC)0xCAFEBABE, 0, 0, 0);

    getchar();
    return 0;
}
```