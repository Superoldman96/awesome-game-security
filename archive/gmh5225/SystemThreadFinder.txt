Project Path: arc_gmh5225_SystemThreadFinder_ydsu4ea_

Source Tree:

```txt
arc_gmh5225_SystemThreadFinder_ydsu4ea_
├── README.md
├── SystemThreadFinder
│   ├── SystemThreadFinder.vcxproj
│   ├── SystemThreadFinder.vcxproj.filters
│   ├── SystemThreadFinder.vcxproj.user
│   ├── includes.h
│   ├── main.cpp
│   ├── nt.cpp
│   ├── nt.h
│   ├── threadfinder.cpp
│   └── threadfinder.h
└── SystemThreadFinder.sln

```

`README.md`:

```md
# SystemThreadFinder
A tool to find hidden / mapped system threads.
Created by reversing BE

```

`SystemThreadFinder.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 16
VisualStudioVersion = 16.0.31205.134
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "SystemThreadFinder", "SystemThreadFinder\SystemThreadFinder.vcxproj", "{122CC5C6-2875-4817-BCFC-C22EFF1CF05B}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|x64 = Debug|x64
		Debug|x86 = Debug|x86
		Release|x64 = Release|x64
		Release|x86 = Release|x86
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{122CC5C6-2875-4817-BCFC-C22EFF1CF05B}.Debug|x64.ActiveCfg = Debug|x64
		{122CC5C6-2875-4817-BCFC-C22EFF1CF05B}.Debug|x64.Build.0 = Debug|x64
		{122CC5C6-2875-4817-BCFC-C22EFF1CF05B}.Debug|x86.ActiveCfg = Debug|Win32
		{122CC5C6-2875-4817-BCFC-C22EFF1CF05B}.Debug|x86.Build.0 = Debug|Win32
		{122CC5C6-2875-4817-BCFC-C22EFF1CF05B}.Release|x64.ActiveCfg = Release|x64
		{122CC5C6-2875-4817-BCFC-C22EFF1CF05B}.Release|x64.Build.0 = Release|x64
		{122CC5C6-2875-4817-BCFC-C22EFF1CF05B}.Release|x86.ActiveCfg = Release|Win32
		{122CC5C6-2875-4817-BCFC-C22EFF1CF05B}.Release|x86.Build.0 = Release|Win32
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {8A82D2F5-8CFD-4916-A62F-17FE88BB75F8}
	EndGlobalSection
EndGlobal

```

`SystemThreadFinder/SystemThreadFinder.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <Keyword>Win32Proj</Keyword>
    <ProjectGuid>{122cc5c6-2875-4817-bcfc-c22eff1cf05b}</ProjectGuid>
    <RootNamespace>SystemThreadFinder</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <AdditionalDependencies>ntdll.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="main.cpp" />
    <ClCompile Include="nt.cpp" />
    <ClCompile Include="threadfinder.cpp" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="includes.h" />
    <ClInclude Include="nt.h" />
    <ClInclude Include="threadfinder.h" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`SystemThreadFinder/SystemThreadFinder.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Quelldateien">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;c++;cppm;ixx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Headerdateien">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;h++;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Ressourcendateien">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
    <Filter Include="Headerdateien\nt">
      <UniqueIdentifier>{c9a6a8f7-ad05-42ee-8d69-009ad6d03e70}</UniqueIdentifier>
    </Filter>
    <Filter Include="Headerdateien\threadfinder">
      <UniqueIdentifier>{99998dcd-0b02-4f26-a141-2c43d0cb37b7}</UniqueIdentifier>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="main.cpp">
      <Filter>Ressourcendateien</Filter>
    </ClCompile>
    <ClCompile Include="nt.cpp">
      <Filter>Headerdateien\nt</Filter>
    </ClCompile>
    <ClCompile Include="threadfinder.cpp">
      <Filter>Headerdateien\threadfinder</Filter>
    </ClCompile>
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="includes.h">
      <Filter>Headerdateien</Filter>
    </ClInclude>
    <ClInclude Include="nt.h">
      <Filter>Headerdateien\nt</Filter>
    </ClInclude>
    <ClInclude Include="threadfinder.h">
      <Filter>Headerdateien\threadfinder</Filter>
    </ClInclude>
  </ItemGroup>
</Project>
```

`SystemThreadFinder/SystemThreadFinder.vcxproj.user`:

```user
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="Current" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup />
</Project>
```

`SystemThreadFinder/includes.h`:

```h
#include <Windows.h>
#include <iostream>
#include <SubAuth.h>

#pragma comment(lib, "ntdll.lib");

#include "nt.h"
#include "threadfinder.h"
```

`SystemThreadFinder/main.cpp`:

```cpp
#include "includes.h"

int main() {
	if (threadfinder::driver_range_check()) {
		printf("Detection: Range check\n");
	}
	if (threadfinder::system_time_check(10)) {
		printf("Detection: Time check\n");
	}
	system("pause");
}
```

`SystemThreadFinder/nt.cpp`:

```cpp
#include "includes.h"
int* nt::get_proc_list() {
	int* proc_list = NULL;
	ULONG proc_list_size = 0;
	NtQuerySystemInformation(SystemProcessInformation, proc_list, proc_list_size, &proc_list_size);
	proc_list = (int*)realloc(proc_list, proc_list_size);
	NtQuerySystemInformation(SystemProcessInformation, proc_list, proc_list_size, &proc_list_size);
	return proc_list;
}
int* nt::get_driver_list() {
	int* driver_list = NULL;
	ULONG driver_list_size = 0;
	NtQuerySystemInformation((SYSTEM_INFORMATION_CLASS)0xB, 0, driver_list_size, &driver_list_size);
	driver_list = (int*)realloc(driver_list, driver_list_size);
	NtQuerySystemInformation((SYSTEM_INFORMATION_CLASS)0xB, driver_list, driver_list_size, &driver_list_size);
	return driver_list;
}
```

`SystemThreadFinder/nt.h`:

```h
namespace nt {
	int* get_proc_list();
	int* get_driver_list();
}

typedef struct _VM_COUNTERS {
	SIZE_T PeakVirtualSize;
	SIZE_T VirtualSize;
	ULONG PageFaultCount;
	SIZE_T PeakWorkingSetSize;
	SIZE_T WorkingSetSize;
	SIZE_T QuotaPeakPagedPoolUsage;
	SIZE_T QuotaPagedPoolUsage;
	SIZE_T QuotaPeakNonPagedPoolUsage;
	SIZE_T QuotaNonPagedPoolUsage;
	SIZE_T PagefileUsage;
	SIZE_T PeakPagefileUsage;
} VM_COUNTERS;



typedef struct _CLIENT_ID
{
	PVOID UniqueProcess;
	PVOID UniqueThread;
} CLIENT_ID, * PCLIENT_ID;


typedef struct
{
	FILETIME ProcessorTime;
	FILETIME UserTime;
	FILETIME CreateTime;
	ULONG WaitTime;
#ifdef _WIN64
	ULONG pad1;
#endif
	PVOID StartAddress;
	CLIENT_ID Client_Id;
	LONG CurrentPriority;
	LONG BasePriority;
	ULONG ContextSwitchesPerSec;
	ULONG ThreadState;
	ULONG ThreadWaitReason;
	ULONG pad2;
} SYSTEM_THREAD_INFORMATION;

typedef struct
{
	ULONG NextOffset;
	ULONG ThreadCount;
	LARGE_INTEGER WorkingSetPrivateSize;
	ULONG HardFaultCount;
	ULONG NumberOfThreadsHighWatermark;
	ULONGLONG CycleTime;
	FILETIME CreateTime;
	FILETIME UserTime;
	FILETIME KernelTime;
	UNICODE_STRING ImageName;
	long BasePriority;
#ifdef _WIN64
	ULONG pad1;
#endif
	ULONG ProcessId;
#ifdef _WIN64
	ULONG pad2;
#endif
	ULONG InheritedFromProcessId;
#ifdef _WIN64
	ULONG pad3;
#endif
	ULONG HandleCount;
	ULONG SessionId;
	ULONG_PTR UniqueProcessKey;
	VM_COUNTERS VirtualMemoryCounters;
	ULONG_PTR PrivatePageCount;
	IO_COUNTERS IoCounters;
	SYSTEM_THREAD_INFORMATION ThreadInfos[1];
} SYSTEM_PROCESS_INFORMATION;
typedef enum _SYSTEM_INFORMATION_CLASS {
	SystemBasicInformation = 0,
	SystemPerformanceInformation = 2,
	SystemTimeOfDayInformation = 3,
	SystemProcessInformation = 5,
	SystemProcessorPerformanceInformation = 8,
	SystemInterruptInformation = 23,
	SystemExceptionInformation = 33,
	SystemRegistryQuotaInformation = 37,
	SystemLookasideInformation = 45,
	SystemCodeIntegrityInformation = 103,
	SystemPolicyInformation = 134,
} SYSTEM_INFORMATION_CLASS;

typedef struct _SYSTEM_MODULE_ENTRY {
	HANDLE Section;
	PVOID MappedBase;
	PVOID ImageBase;
	ULONG ImageSize;
	ULONG Flags;
	USHORT LoadOrderIndex;
	USHORT InitOrderIndex;
	USHORT LoadCount;
	USHORT OffsetToFileName;
	UCHAR FullPathName[256];
} SYSTEM_MODULE_ENTRY, * PSYSTEM_MODULE_ENTRY;

typedef struct _SYSTEM_MODULE_INFORMATION {
	ULONG Count;
	SYSTEM_MODULE_ENTRY Module[1];
} SYSTEM_MODULE_INFORMATION, * PSYSTEM_MODULE_INFORMATION;

extern "C" NTSTATUS NtQuerySystemInformation(SYSTEM_INFORMATION_CLASS SystemInformationClass, PVOID SystemInformation, ULONG SystemInformationLength, PULONG ReturnLength);
```

`SystemThreadFinder/threadfinder.cpp`:

```cpp
#include "includes.h"

bool threadfinder::system_time_check(int amount_of_tries) {
	int iteration;
	uintptr_t idletime1, kerneltime1, usertime1;
	uintptr_t idletime2, kerneltime2, usertime2;
	uintptr_t deltatime1, deltatime2, deltatime3;

	SYSTEM_PROCESS_INFORMATION* proc1;
	SYSTEM_PROCESS_INFORMATION* proc2;
	for (iteration = 0; iteration < amount_of_tries; iteration++) {
		int* proc_list_start = nt::get_proc_list();
		GetSystemTimes((PFILETIME)&idletime1, (PFILETIME)&kerneltime1, (PFILETIME)&usertime1);
		Sleep(1000);
		int* proc_list_end = nt::get_proc_list();
		GetSystemTimes((PFILETIME)&idletime2, (PFILETIME)&kerneltime2, (PFILETIME)&usertime2);

		deltatime1 = 0;
		for (proc2 = (SYSTEM_PROCESS_INFORMATION*)proc_list_end;; proc2 = (SYSTEM_PROCESS_INFORMATION*)((char*)proc2 + proc2->NextOffset)) {
			for (proc1 = (SYSTEM_PROCESS_INFORMATION*)proc_list_start; proc2->ProcessId != proc1->ProcessId; proc1 = (SYSTEM_PROCESS_INFORMATION*)((char*)proc1 + proc1->NextOffset)) {
				if (!proc1->NextOffset) {
					deltatime1 += *(uintptr_t*)&proc2->KernelTime + *(uintptr_t*)&proc2->UserTime;
					goto END;
				}
			}
			deltatime2 = *(uintptr_t*)&proc2->KernelTime - *(uintptr_t*)&proc1->KernelTime + *(uintptr_t*)&proc2->UserTime - *(uintptr_t*)&proc1->UserTime;
			deltatime1 += deltatime2;
			END:
			if (!proc2->NextOffset)
				break;
		}
		deltatime3 = usertime2 - usertime1 + kerneltime2 - kerneltime1 - deltatime1;
		if (deltatime3 < 0x7270E0)
			break;
		free(proc_list_start);
		free(proc_list_end);
	}

	return iteration == amount_of_tries;
}


bool is_in_range(uintptr_t address) {
	int* driver_list = nt::get_driver_list();
	auto currentModule = reinterpret_cast<PSYSTEM_MODULE_INFORMATION>(driver_list)->Module;

	for (size_t i{}; i < reinterpret_cast<PSYSTEM_MODULE_INFORMATION>(driver_list)->Count; ++i, ++currentModule) {
		if (address > (uintptr_t)currentModule->ImageBase && address < ((uintptr_t)currentModule->ImageBase + currentModule->ImageSize))
			return true;
	}
	return false;
}

bool threadfinder::driver_range_check() {
	int* proc_list = nt::get_proc_list();
	SYSTEM_PROCESS_INFORMATION* proc = 0;
	for (proc = (SYSTEM_PROCESS_INFORMATION*)proc_list; proc->NextOffset != 0; proc = (SYSTEM_PROCESS_INFORMATION*)((char*)proc + proc->NextOffset)) {
		if (proc->ProcessId == 4) {
			for (int j = 0; j < proc->ThreadCount; j++) {
				if (!is_in_range((uintptr_t)proc->ThreadInfos[j].StartAddress)) {
					printf("Detection: %p not in range!", (uintptr_t)proc->ThreadInfos[j].StartAddress);
					return true;
				}

			}
			break;
		}
	}
	return false;
}
```

`SystemThreadFinder/threadfinder.h`:

```h
namespace threadfinder {
	bool system_time_check(int amount_of_tries);
	bool driver_range_check();
}
```