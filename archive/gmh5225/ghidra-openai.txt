Project Path: arc_gmh5225_ghidra-openai_a_ib3513

Source Tree:

```txt
arc_gmh5225_ghidra-openai_a_ib3513
├── LICENSE
├── README.md
├── build.gradle
├── extension.properties
├── ghidra_scripts
│   └── KotlinExtensionExampleScript.kt
├── gradle.properties
├── imgs
│   ├── API_key.png
│   ├── after.png
│   ├── before.png
│   └── parameters.png
├── lib
└── src
    └── main
        └── kotlin
            └── ghidra
                └── openai
                    ├── GetFunctionSummaryAction.kt
                    ├── OpenAIPlugin.kt
                    ├── OpenAIService.kt
                    └── OpenAIServiceInterface.kt

```

`LICENSE`:

```
MIT License

Copyright (c) 2021 Florian Magin

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

```

`README.md`:

```md
# OpenAI Integration for Ghidra

> Get Function Summaries from ChatGTP

## Installation

1. This plugin requires Kotlin language support in Ghidra, so make sure that you have it installed:
https://github.com/GhidraJupyter/ghidra-jupyter-kotlin/releases

2. Grab the latest release of this Plugin from the [releases page](https://github.com/fmagin/ghidra-openai/releases)
and install it in Ghidra.


## Usage

### Initial Setup

Configure your API Key via `Edit -> Tool Options -> OpenAI`

![img.png](imgs/API_key.png)


### GUI Integration

Right Click in the Decompiler, and select `Get and apply Function Summary via OpenAI`

Before:
![img.png](imgs/before.png)

After:
![img.png](imgs/after.png)


### Configuration

You can easily change the model used for the completions and its parameters via
the `Edit -> Tool Options -> OpenAI -> Model` menu.

![img.png](imgs/parameters.png)

The decompiled text will be appended to the prompt and will be sent as a completion request to the OpenAI API.


## Potential Future Work

No promises that I will ever implement them, but I'll gladly provide advice if you want to try:
* Dedicated Dialog that previews the function summary and allows retrying before applying
* Allow a custom prompt to be specified for a specific _program_ via the `Options for $program` menu
* Request better variable or function names like https://github.com/JusticeRage/Gepetto does
```

`build.gradle`:

```gradle
// Builds a Ghidra Extension for a given Ghidra installation.
//
// An absolute path to the Ghidra installation directory must be supplied
// To make this work well with IntelliJ this should be automatically resolve able and NOT an environmental variable
// You can either:
// * use the `gradle.properties` file in the extension folder to set it for this project
// * add the line `GHIDRA_INSTALL_DIR=/path/to/ghidras/ghidra_10.1_PUBLIC/` to your global config (`.gradle/gradle.properties` in your home folder)


plugins {
	id 'org.jetbrains.kotlin.jvm' version "1.6.0"
	id 'idea'
}

repositories {
	mavenCentral()
}

//----------------------START "DO NOT MODIFY" SECTION------------------------------
def ghidraInstallDir

if (System.env.GHIDRA_INSTALL_DIR) {
	ghidraInstallDir = System.env.GHIDRA_INSTALL_DIR
}
else if (project.hasProperty("GHIDRA_INSTALL_DIR")) {
	ghidraInstallDir = project.getProperty("GHIDRA_INSTALL_DIR")
}

if (ghidraInstallDir) {
	apply from: new File(ghidraInstallDir).getCanonicalPath() + "/support/buildExtension.gradle"
}
else {
	throw new GradleException("GHIDRA_INSTALL_DIR is not defined!")
}
//----------------------END "DO NOT MODIFY" SECTION-------------------------------

// Set the JVM target to 17, as described in https://stackoverflow.com/a/44297713/13220684
// Ghidra requires 17 and the buildExtension.gradle sets this for Java
// IntelliJ will complain about the discrepancy between the Java and the Kotlin target otherwise
tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
	kotlinOptions {
		jvmTarget = "17"
	}
}

dependencies {
	// If you are using the Ghidra Jupyter Plugin for Kotlin, add the following line to declare it as a dependency
	// This allows using the extension methods and makes sure that the required Kotlin libraries are present and not
	// conflicting
		api fileTree(dir: ghidraInstallDir + '/Ghidra/Extensions/GhidraJupyterKotlin/', include: "**/*.jar")

	// OpenAI API
	implementation "com.aallam.openai:openai-client:2.0.0"
//	implementation platform('com.aallam.openai:openai-client-bom:2.0.0')
//	implementation 'io.ktor:ktor-client:1.5.4'
//	implementation 'io.ktor:ktor-client-jvm:1.5.4'
	implementation 'io.ktor:ktor-client-java:2.1.0'
}

// Make it explicit that the compilation depends on some libraries in the `lib` folder,
// otherwise gradle will issue warnings
compileKotlin.dependsOn(copyDependencies)

// Add the ghidra_scripts directory as an additional source set, so IntelliJ IDEA treats the scripts there as part of
// the module
// this means that your plugin code is available for code completion and analysis and that all dependencies of the module
// are inherited
sourceSets {
	main {
		kotlin {
			srcDirs 'ghidra_scripts'
		}
	}
}

```

`extension.properties`:

```properties
name=@extname@
description=OpenAI Integration Proof of Concept.
author=Florian Magin
createdOn=2022-12-06
version=@extversion@

```

`ghidra_scripts/KotlinExtensionExampleScript.kt`:

```kt
// SCRIPT DESCRIPTION
//@category    Examples
//@toolbar    world.png

import ghidra.app.script.GhidraScript

@Suppress("unused")
class KotlinExtensionExampleScript : GhidraScript() {
    @Throws(Exception::class)
    override fun run() {
        TODO("Script code goes here")
    }
}
```

`gradle.properties`:

```properties
#GHIDRA_INSTALL_DIR=/path/to/ghidras/ghidra_10.1_PUBLIC/
```

`src/main/kotlin/ghidra/openai/GetFunctionSummaryAction.kt`:

```kt
package ghidra.app.plugin.core.decompile.actions

import GhidraJupyterKotlin.extensions.misc.runTransaction
import docking.DialogComponentProvider
import docking.action.MenuData
import ghidra.app.plugin.core.decompile.DecompilerActionContext
import ghidra.app.util.HelpTopics
import ghidra.openai.OpenAIServiceInterface
import ghidra.util.HelpLocation
import ghidra.util.task.Task
import ghidra.util.task.TaskLauncher
import ghidra.util.task.TaskMonitor


class GetFunctionSummaryAction: AbstractDecompilerAction("Get Function Summary"){

    init {
        helpLocation = HelpLocation(HelpTopics.DECOMPILER, "ActionEditSignature")
        popupMenuData = MenuData(arrayOf("Get and apply Function Summary via OpenAI"), "Decompile")
    }

    override fun isEnabledForDecompilerContext(context: DecompilerActionContext?): Boolean {
        return true
    }

    override fun decompilerActionPerformed(context: DecompilerActionContext?) {
        val task = GetFunctionSummaryTask(context!!)
        TaskLauncher(task, context.tool.toolFrame)
    }

}

class GetFunctionSummaryTask(val context: DecompilerActionContext): Task("Get Function Summary", false, false, false) {
    override fun run(taskMonitor: TaskMonitor?) {
        val aiSrv = context.tool.getService(OpenAIServiceInterface::class.java)
        val summary = aiSrv.getFunctionSummaryShort(context.function)
        context.program.runTransaction("Apply OpenAI Function Summary"){
            context.function.comment = summary
        }
    }

}
```

`src/main/kotlin/ghidra/openai/OpenAIPlugin.kt`:

```kt
package ghidra.openai

import ghidra.app.ExamplesPluginPackage
import ghidra.app.plugin.PluginCategoryNames
import ghidra.app.plugin.ProgramPlugin
import ghidra.app.plugin.core.decompile.actions.GetFunctionSummaryAction
import ghidra.app.services.ProgramManager
import ghidra.framework.plugintool.PluginInfo
import ghidra.framework.plugintool.PluginTool
import ghidra.framework.plugintool.util.PluginStatus
import io.ktor.client.plugins.HttpTimeout

//@formatter:off
@PluginInfo(
    status = PluginStatus.RELEASED,
    packageName = "GhidraOpenAI",
    category = PluginCategoryNames.MISC,
    shortDescription = "OpenAI Integration",
    description = "Proof of Concept Plugin for OpenAI API integration",
    servicesProvided = [OpenAIServiceInterface::class],
) //@formatter:on
class OpenAIPlugin(tool: PluginTool?) : ProgramPlugin(tool) {
    init {
        setupOptions()
        setupServices()
        registerActions()
//        state.tool.getService(ghidra.openai.OpenAIServiceInterface::class.java)


    }

    private fun registerActions() {
        tool.addAction(GetFunctionSummaryAction())
    }

    private fun setupServices() {
        HttpTimeout

        val options = tool.getOptions("OpenAI")
        val apiKey: String? = options.getString("API_KEY", null)
        // TODO: Cleanly handle lack of configured API key
        registerServiceProvided(OpenAIServiceInterface::class.java, OpenAIService(apiKey!!, tool))
    }

    private fun setupOptions() {
        // Create  Ghidra Tool options to save the API key
        val options = tool.getOptions("OpenAI")
        options.registerOption("API_KEY", "", null, "OpenAI API Key")
        val modelOptions = options.getOptions("Model")

        // Parameters taken from https://github.com/JusticeRage/Gepetto/blob/main/gepetto.py#L188-L194
        modelOptions.registerOption("MODEL", "text-davinci-003", null, "OpenAI Model")
        // Temperature Option
        modelOptions.registerOption("TEMPERATURE", 0.6, null, "Temperature")
        // TopP Option
        modelOptions.registerOption("TOP_P", 1.0, null, "TopP")
        // Max Tokens Option
        modelOptions.registerOption("MAX_TOKENS", 2500, null, "Max Tokens")
        // Prompt option
        modelOptions.registerOption("PROMPT",
            "Can you explain what the following C function does and suggest a better name for it?",
            null, "Prompt")

    }
}
```

`src/main/kotlin/ghidra/openai/OpenAIService.kt`:

```kt
package ghidra.openai

import com.aallam.openai.api.completion.CompletionRequest
import com.aallam.openai.api.completion.TextCompletion
import com.aallam.openai.api.model.ModelId
import com.aallam.openai.client.OpenAI
import ghidra.app.decompiler.flatapi.FlatDecompilerAPI
import ghidra.framework.plugintool.PluginTool
import ghidra.program.flatapi.FlatProgramAPI
import ghidra.program.model.listing.Function
import kotlinx.coroutines.runBlocking

class OpenAIService(val apiKey: String, val tool: PluginTool): OpenAIServiceInterface {
    override fun getEngine(): OpenAI {
        return OpenAI(apiKey)
    }


    override fun getFunctionSummaryShort(function: Function): String {
        val openAI = this.getEngine()



        // Get the decompiled function via the Ghidra API
        val funcText = FlatDecompilerAPI(FlatProgramAPI(function.program)).decompile(function, 0)


        val modelOptions = tool.getOptions("OpenAI").getOptions("Model")

        val basePrompt = modelOptions.getString("PROMPT", "Can you explain what the following C function does and suggest a better name for it?")

        val prompt = basePrompt + '\n' + funcText

        // Get model options
        val completionRequest = CompletionRequest(
            model = ModelId(modelOptions.getString("MODEL", "text-davinci-003")),
            prompt = prompt,
            temperature = modelOptions.getDouble("TEMPERATURE", 0.6),
            topP = modelOptions.getDouble("TOP_P", 1.0),
            maxTokens = modelOptions.getInt("MAX_TOKENS", 2500),
        )

        val completion: TextCompletion = runBlocking {
            openAI.completion(completionRequest)
        }
        val result = completion.choices[0].text
        return result
    }


}
```

`src/main/kotlin/ghidra/openai/OpenAIServiceInterface.kt`:

```kt
package ghidra.openai

import com.aallam.openai.client.OpenAI
import ghidra.framework.plugintool.ServiceInfo
import ghidra.program.model.listing.Function

@ServiceInfo(defaultProvider = [OpenAIPlugin::class])
interface OpenAIServiceInterface {
    fun getEngine(): OpenAI?
    fun getFunctionSummaryShort(function: Function): String
}


```