Project Path: arc_gmh5225_VmdtStr_q9czdguv

Source Tree:

```txt
arc_gmh5225_VmdtStr_q9czdguv
├── BareKVM.png
├── README.md
├── VmdtStr
│   ├── VmdtStr
│   │   ├── VmdtStr.vcxproj
│   │   ├── VmdtStr.vcxproj.filters
│   │   ├── VmdtStr.vcxproj.user
│   │   ├── main.c
│   │   └── vmdt.asm
│   └── VmdtStr.sln
└── WithHVPP.png

```

`README.md`:

```md
# VmdtStr
Detect VMMs with faulty handling of STR exit <br>
**NOTE:** This detection requires the VMM in question to exit on descriptor table access, otherwise it won't work!
# Showcase
This is the output on a KVM with no nested VMM active:
![](BareKVM.png)

And this is with HVPP as a nested VMM:
![](WithHVPP.png)
# How it works
This demo works because some public VMMs don't emulate `STR` instruction correctly.
Let me quote the relevant part in the instruction set reference from Intel website:<br>
```
When the destination operand is a 32-bit register, the 16-bit segment selector is copied into the lower 16 bits of the
register and the upper 16 bits of the register are cleared. When the destination operand is a memory location, the
segment selector is written to memory as a 16-bit quantity, regardless of operand size.

In 64-bit mode, operation is the *same*. The size of the memory operand is fixed at 16 bits. In register stores, the 2-
byte TR is *zero extended* if stored to a 64-bit register.
```

# Disclaimer
This has been tested using HVPP and some other public VMMs, in a KVM virtual machine.<br>
Although i think the results on bare metal should be the same, more evaluation is required if this should be used legitimately.<br>

```

`VmdtStr/VmdtStr.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 16
VisualStudioVersion = 16.0.33130.400
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "VmdtStr", "VmdtStr\VmdtStr.vcxproj", "{95CFEA70-B741-4ED4-B5D1-569CC7F92035}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|ARM = Debug|ARM
		Debug|ARM64 = Debug|ARM64
		Debug|x64 = Debug|x64
		Debug|x86 = Debug|x86
		Release|ARM = Release|ARM
		Release|ARM64 = Release|ARM64
		Release|x64 = Release|x64
		Release|x86 = Release|x86
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Debug|ARM.ActiveCfg = Debug|ARM
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Debug|ARM.Build.0 = Debug|ARM
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Debug|ARM.Deploy.0 = Debug|ARM
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Debug|ARM64.ActiveCfg = Debug|ARM64
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Debug|ARM64.Build.0 = Debug|ARM64
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Debug|ARM64.Deploy.0 = Debug|ARM64
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Debug|x64.ActiveCfg = Debug|x64
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Debug|x64.Build.0 = Debug|x64
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Debug|x64.Deploy.0 = Debug|x64
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Debug|x86.ActiveCfg = Debug|Win32
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Debug|x86.Build.0 = Debug|Win32
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Debug|x86.Deploy.0 = Debug|Win32
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Release|ARM.ActiveCfg = Release|ARM
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Release|ARM.Build.0 = Release|ARM
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Release|ARM.Deploy.0 = Release|ARM
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Release|ARM64.ActiveCfg = Release|ARM64
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Release|ARM64.Build.0 = Release|ARM64
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Release|ARM64.Deploy.0 = Release|ARM64
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Release|x64.ActiveCfg = Release|x64
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Release|x64.Build.0 = Release|x64
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Release|x64.Deploy.0 = Release|x64
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Release|x86.ActiveCfg = Release|Win32
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Release|x86.Build.0 = Release|Win32
		{95CFEA70-B741-4ED4-B5D1-569CC7F92035}.Release|x86.Deploy.0 = Release|Win32
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {BD053014-D2E5-481D-906C-DF0F107FFAB1}
	EndGlobalSection
EndGlobal

```

`VmdtStr/VmdtStr/VmdtStr.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|ARM">
      <Configuration>Debug</Configuration>
      <Platform>ARM</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM">
      <Configuration>Release</Configuration>
      <Platform>ARM</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|ARM64">
      <Configuration>Debug</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM64">
      <Configuration>Release</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <ProjectGuid>{95CFEA70-B741-4ED4-B5D1-569CC7F92035}</ProjectGuid>
    <TemplateGuid>{1bc93793-694f-48fe-9372-81e2b05556fd}</TemplateGuid>
    <TargetFrameworkVersion>v4.5</TargetFrameworkVersion>
    <MinimumVisualStudioVersion>12.0</MinimumVisualStudioVersion>
    <Configuration>Debug</Configuration>
    <Platform Condition="'$(Platform)' == ''">Win32</Platform>
    <RootNamespace>VmdtStr</RootNamespace>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
    <Driver_SpectreMitigation>false</Driver_SpectreMitigation>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
    <Driver_SpectreMitigation>false</Driver_SpectreMitigation>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <Optimization>Disabled</Optimization>
    </ClCompile>
    <DriverSign>
      <FileDigestAlgorithm>SHA256</FileDigestAlgorithm>
    </DriverSign>
    <PostBuildEvent>
      <Command>copy $(OutDir)VmdtStr.sys C:\shared\build\VMDTStr.sys</Command>
    </PostBuildEvent>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <DriverSign>
      <FileDigestAlgorithm>SHA256</FileDigestAlgorithm>
    </DriverSign>
    <PostBuildEvent>
      <Command>copy $(OutDir)VmdtStr.sys C:\shared\build\VMDTStr.sys</Command>
    </PostBuildEvent>
  </ItemDefinitionGroup>
  <ItemGroup>
    <FilesToPackage Include="$(TargetPath)" />
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="main.c" />
    <MASM Include="vmdt.asm">
      <FileType>Document</FileType>
    </MASM>
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`VmdtStr/VmdtStr/VmdtStr.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <ClCompile Include="main.c" />
  </ItemGroup>
  <ItemGroup>
    <MASM Include="vmdt.asm" />
  </ItemGroup>
</Project>
```

`VmdtStr/VmdtStr/VmdtStr.vcxproj.user`:

```user
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="Current" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <ShowAllFiles>true</ShowAllFiles>
  </PropertyGroup>
</Project>
```

`VmdtStr/VmdtStr/main.c`:

```c
#include <ntddk.h>

BOOLEAN VmdtRunCheck();

VOID Msg(const char* text)
{
	while (text[0] != 0)
	{
		__outbyte(0x2F8, text[0]);
		text++;
	}
}

NTSTATUS DriverEntry(PDRIVER_OBJECT drvObj, PUNICODE_STRING regPath)
{
	UNREFERENCED_PARAMETER(drvObj);
	UNREFERENCED_PARAMETER(regPath);

	BOOLEAN checkPassed = VmdtRunCheck();

	checkPassed ?	Msg("(PASS) Register is cleared!\n") : 
					Msg("(FAIL) Register still contains bogus bits!\n");

	return STATUS_FAILED_DRIVER_ENTRY;
}

```

`VmdtStr/VmdtStr/vmdt.asm`:

```asm
.CODE

VmdtRunCheck PROC
    xor rax, rax

    push rsi
    push rdi

    mov rsi, 0FFFFFFFFFFFFFFFFh
    str rsi

    xor rdi, rdi
    mov rdi, 0FFFFh
    not rdi

    and rsi, rdi
    cmp rsi, 0
    jne finish
    mov al, 1

finish:
    pop rdi
    pop rsi

    ret
VmdtRunCheck ENDP

END

```