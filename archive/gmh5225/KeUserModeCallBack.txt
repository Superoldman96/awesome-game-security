Project Path: arc_gmh5225_KeUserModeCallBack_ldzbb60x

Source Tree:

```txt
arc_gmh5225_KeUserModeCallBack_ldzbb60x
└── KeUserModeCallBack
    ├── Windows Driver1
    │   ├── IO.h
    │   ├── Windows Driver1.c
    │   ├── Windows Driver1.vcxproj
    │   ├── Windows Driver1.vcxproj.filters
    │   ├── Windows Driver1.vcxproj.user
    │   └── ZTY_DEFINE.h
    └── Windows Driver1.sln

```

`KeUserModeCallBack/Windows Driver1.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio 2013
VisualStudioVersion = 12.0.31101.0
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "Windows Driver1", "Windows Driver1\Windows Driver1.vcxproj", "{B54482B9-0297-4D9E-8CE7-6690A9D85315}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Win7 Checked|Win32 = Win7 Checked|Win32
		Win7 Checked|x64 = Win7 Checked|x64
		Win7 Free|Win32 = Win7 Free|Win32
		Win7 Free|x64 = Win7 Free|x64
		WinXP Checked|Win32 = WinXP Checked|Win32
		WinXP Checked|x64 = WinXP Checked|x64
		WinXP Free|Win32 = WinXP Free|Win32
		WinXP Free|x64 = WinXP Free|x64
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{B54482B9-0297-4D9E-8CE7-6690A9D85315}.Win7 Checked|Win32.ActiveCfg = Win7 Checked|Win32
		{B54482B9-0297-4D9E-8CE7-6690A9D85315}.Win7 Checked|Win32.Build.0 = Win7 Checked|Win32
		{B54482B9-0297-4D9E-8CE7-6690A9D85315}.Win7 Checked|x64.ActiveCfg = Win7 Checked|x64
		{B54482B9-0297-4D9E-8CE7-6690A9D85315}.Win7 Checked|x64.Build.0 = Win7 Checked|x64
		{B54482B9-0297-4D9E-8CE7-6690A9D85315}.Win7 Free|Win32.ActiveCfg = Win7 Free|Win32
		{B54482B9-0297-4D9E-8CE7-6690A9D85315}.Win7 Free|Win32.Build.0 = Win7 Free|Win32
		{B54482B9-0297-4D9E-8CE7-6690A9D85315}.Win7 Free|x64.ActiveCfg = Win7 Free|x64
		{B54482B9-0297-4D9E-8CE7-6690A9D85315}.Win7 Free|x64.Build.0 = Win7 Free|x64
		{B54482B9-0297-4D9E-8CE7-6690A9D85315}.WinXP Checked|Win32.ActiveCfg = WinXP Checked|Win32
		{B54482B9-0297-4D9E-8CE7-6690A9D85315}.WinXP Checked|Win32.Build.0 = WinXP Checked|Win32
		{B54482B9-0297-4D9E-8CE7-6690A9D85315}.WinXP Checked|x64.ActiveCfg = WinXP Checked|x64
		{B54482B9-0297-4D9E-8CE7-6690A9D85315}.WinXP Checked|x64.Build.0 = WinXP Checked|x64
		{B54482B9-0297-4D9E-8CE7-6690A9D85315}.WinXP Free|Win32.ActiveCfg = WinXP Free|Win32
		{B54482B9-0297-4D9E-8CE7-6690A9D85315}.WinXP Free|Win32.Build.0 = WinXP Free|Win32
		{B54482B9-0297-4D9E-8CE7-6690A9D85315}.WinXP Free|x64.ActiveCfg = WinXP Free|x64
		{B54482B9-0297-4D9E-8CE7-6690A9D85315}.WinXP Free|x64.Build.0 = WinXP Free|x64
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
EndGlobal

```

`KeUserModeCallBack/Windows Driver1/IO.h`:

```h
#ifndef _IO_H
#define _IO_H

#define CWK_CDO_SYB_NAME  L"\\??\\zty_1997"

// 从应用层给驱动发送一个字符串。
#define  CWK_DVC_SEND_STR \
	(ULONG)CTL_CODE( \
	FILE_DEVICE_UNKNOWN, \
	0x911,METHOD_BUFFERED, \
	FILE_WRITE_DATA)

extern VOID Start();
extern VOID CallMessageBox();

NTSTATUS DispatchFunction(IN PDEVICE_OBJECT dev, IN PIRP irp)
{
	PIO_STACK_LOCATION irpsp = IoGetCurrentIrpStackLocation(irp);
	ULONG InLen;
	ULONG RetLen = 0;
	NTSTATUS status = STATUS_UNSUCCESSFUL;


	if (irpsp->MajorFunction == IRP_MJ_DEVICE_CONTROL)
	{
		InLen = irpsp->Parameters.DeviceIoControl.InputBufferLength;

		if (irpsp->Parameters.DeviceIoControl.IoControlCode == CWK_DVC_SEND_STR)
		{
        	Start();
		}

		irp->IoStatus.Information = RetLen;
		irp->IoStatus.Status = STATUS_SUCCESS;
		IoCompleteRequest(irp, IO_NO_INCREMENT);

		return STATUS_SUCCESS;
	}

	irp->IoStatus.Information = 0;
	irp->IoStatus.Status = STATUS_SUCCESS;
	IoCompleteRequest(irp, IO_NO_INCREMENT);

	return STATUS_SUCCESS;
}

NTSTATUS CreateDevice(PDRIVER_OBJECT DriverObject)
{
	UNICODE_STRING DeviceName;
	UNICODE_STRING LinkName;
	PDEVICE_OBJECT DeviceObject;
	NTSTATUS status;
	ULONG i = 0;

	RtlInitUnicodeString(&DeviceName, L"\\Device\\zty_1997");

	RtlInitUnicodeString(&LinkName, CWK_CDO_SYB_NAME);

	status = IoCreateDevice(
		DriverObject,
		0,
		&DeviceName,
		FILE_DEVICE_UNKNOWN,
		FILE_DEVICE_SECURE_OPEN,
		FALSE,
		&DeviceObject
		);

	if (!NT_SUCCESS(status))
	{
		KdPrint(("CreateDvice Error！\n"));
		return STATUS_UNSUCCESSFUL;
	}

	IoDeleteSymbolicLink(&LinkName);
	status = IoCreateSymbolicLink(&LinkName, &DeviceName);
	if (!NT_SUCCESS(status))
	{
		KdPrint(("Create SymbolLink Error！\n"));
		IoDeleteDevice(DeviceObject);
		return STATUS_UNSUCCESSFUL;
	}


	while (i < IRP_MJ_MAXIMUM_FUNCTION)
	{
		DriverObject->MajorFunction[i] = DispatchFunction;
		++i;
	}
	DeviceObject->Flags = DO_BUFFERED_IO;
	DeviceObject->Flags ^= DO_DEVICE_INITIALIZING;

	return STATUS_SUCCESS;
}

VOID DeleteDevice(PDRIVER_OBJECT DriverObject)
{
	UNICODE_STRING SymbolName;
	IoDeleteDevice(DriverObject->DeviceObject);
	RtlInitUnicodeString(&SymbolName, CWK_CDO_SYB_NAME);
	IoDeleteSymbolicLink(&SymbolName);
}

#endif // !_IO_H

```

`KeUserModeCallBack/Windows Driver1/Windows Driver1.c`:

```c
#include <ntifs.h>
#include <ntddk.h>
#include <ntimage.h>
#include "ZTY_DEFINE.h"
#include "IO.h"

#ifdef _WIN64

UCHAR gShellCode[] = "\x48\x83\xEC\x28"     //sub rsp,28h
                     "\x48\x89\xC8"         //mov rax,rcx
                     "\x48\x8B\x48\x08"     //mov rcx,qword ptr [rax+8]
                     "\x48\x8B\x50\x10"     //mov rdx,qword ptr [rax+10h]  
                     "\x4C\x8B\x40\x18"     //mov r8,qword ptr [rax+18h]
                     "\x4C\x8B\x48\x20"     //mov r9,qword ptr [rax+20h]  
                     "\x48\x8B\x00"         //mov rax,qword ptr [rax] 
                     "\xFF\xD0"             //call rax
                     "\x48\x83\xC4\x28"     //add rsp,28h
                     "\xC3"                 //ret
                     "\xCC";                //int 3

#else

UCHAR gShellCode[] = "\x8B\x44\x24\x04"     //mov eax,[esp+4]
					 "\xFF\x70\x10"         //push dword ptr [eax+0x10]
					 "\xFF\x70\x0C"         //push dword ptr [eax+0xC]
					 "\xFF\x70\x08"         //push dword ptr [eax+0x8]
					 "\xFF\x70\x04"         //push dword ptr [eax+0x4]
					 "\xFF\x10"             //call dword ptr [eax]
					 "\xC2\x08\x00"         //retn 8
					 "\xCC";                //int 3

#endif

CHAR gMsgText[] = "Msg From Driver！";

//从指定模块的导出表获取指定名称的函数地址
ULONG_PTR GetProcAddressFromModule(ULONG_PTR ModuleAddress, CHAR *ProcName)
{
	PIMAGE_DOS_HEADER DosHeader = NULL;
	PIMAGE_NT_HEADERS NtHeader = NULL;
	PIMAGE_EXPORT_DIRECTORY ExportDirectory = NULL;
	
	ULONG *NameArry = NULL;													
	ULONG *AddressArry = NULL;											
	USHORT *OrdinalArry = NULL;

	ULONG Index = 0;

	DosHeader = (PIMAGE_DOS_HEADER)ModuleAddress;
	if (DosHeader->e_magic != IMAGE_DOS_SIGNATURE)
		return 0;

	NtHeader = (PIMAGE_NT_HEADERS)(ModuleAddress + DosHeader->e_lfanew);
	if (NtHeader->Signature != IMAGE_NT_SIGNATURE)
		return 0;
	
	if (NtHeader->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].Size == 0)
		return 0;

	ExportDirectory = (PIMAGE_EXPORT_DIRECTORY)(ModuleAddress + (ULONG_PTR)NtHeader->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);
	NameArry = (ULONG *)(ModuleAddress + ExportDirectory->AddressOfNames);
	AddressArry = (ULONG *)(ModuleAddress + ExportDirectory->AddressOfFunctions);
	OrdinalArry = (USHORT *)(ModuleAddress + ExportDirectory->AddressOfNameOrdinals);

	for (Index = 0; Index < ExportDirectory->AddressOfNames; ++Index)
	{
		if (NameArry[Index] != 0)
		{
			if (strcmp(ProcName, (CHAR*)(ModuleAddress + NameArry[Index])) == 0)
				return (ULONG_PTR)(ModuleAddress + AddressArry[OrdinalArry[Index]]);
		}
	}

	return 0;
}

//先从PEB中获取指定名称的DLL的基址
ULONG_PTR GetModuleHandleFromProcessPEB(PPEB Peb, CHAR *szDllName)
{
	PPEB_LDR_DATA pLdrData = NULL;
	PLDR_DATA_TABLE_ENTRY pLdrDataEntry = NULL;
	PLIST_ENTRY TempListItem = NULL;
	ANSI_STRING AnsiDllName = { 0 };

	ULONG_PTR DllBase = 0;
	
	pLdrData = Peb->Ldr;
	TempListItem = &pLdrData->InLoadOrderModuleList;

	for (TempListItem = TempListItem->Flink; TempListItem != &pLdrData->InLoadOrderModuleList; TempListItem = TempListItem->Flink)
	{
		pLdrDataEntry = (PLDR_DATA_TABLE_ENTRY)TempListItem;
		if (pLdrDataEntry->BaseDllName.Buffer)
		{
			RtlUnicodeStringToAnsiString(&AnsiDllName, &(pLdrDataEntry->BaseDllName), TRUE);
			if (strcmp(szDllName, AnsiDllName.Buffer) == 0)
			{
				DllBase = (ULONG)pLdrDataEntry->DllBase;
           	}
			RtlFreeAnsiString(&AnsiDllName);

			if (DllBase) 
				break;
		}
	}
	return DllBase;
}

PPEB GetCurrentProcessPeb()
{
	PROCESS_BASIC_INFORMATION BasicInfo = { 0 };
	NTSTATUS Status = STATUS_UNSUCCESSFUL;
	ULONG ReturenLength = 0;

	Status = ZwQueryInformationProcess(NtCurrentProcess(),
		ProcessBasicInformation,
		&BasicInfo,
		sizeof(PROCESS_BASIC_INFORMATION),
		&ReturenLength);

	if (NT_SUCCESS(Status))
		return BasicInfo.PebBaseAddress;

	return 0;
}

VOID Start()
{
	NTSTATUS Status = STATUS_UNSUCCESSFUL;

	ULONG_PTR AllocateSize = 0;
	PVOID ShellCodeBuffer = NULL;							//KeUserModeCallBack去执行的ShellCode
	PVOID MsgText = NULL;									//MsgBox弹出的字符串的地址
	
	PPEB CurrentPeb = NULL; 								//当前进程的PEB
	ULONG_PTR KernelCallBackTable = 0;						//PEB中的KernelCallBackTable的地址
	ULONG_PTR User32Base = 0;								//在当前进程中User32的基址
	ULONG_PTR MsgBoxABase = 0;								//在当前进程中MessageBoxA的基址

	ULONG ApiIndex = 0;
	ULONG_PTR Arguments[5] = { 0 };							//第一个是函数地址，后面四个是参数
	PVOID RetBuffer = 0;
	ULONG_PTR RetLength = 0;

	do
	{
        CurrentPeb = GetCurrentProcessPeb();
        if (CurrentPeb == NULL)
        {
            KdPrint(("获取PEB失败！\n"));
            break;
        }
        KernelCallBackTable = CurrentPeb->KernelCallbackTable;

        User32Base = GetModuleHandleFromProcessPEB(CurrentPeb, "USER32.dll");
        if (User32Base == 0)
        {
            KdPrint(("寻找User32.dll失败！\n"));
            break;
        }

        MsgBoxABase = GetProcAddressFromModule(User32Base, "MessageBoxA");
        if (MsgBoxABase == 0)
        {
            KdPrint(("寻找MessageBoxA失败！\n"));
            break;
        }

#ifdef _WIN64
        //64位是有点问题的，因为ApiIndex只是一个ULONG类型的，也就是说，shellcode的地址要和kernelcallbacktable的地址相差不超过4G空间
        //在32位下，完全没这个问题，不管是小于还是大于都无所谓，全部在4G空间内。
        //而64位就需要在kernelcallbacktable之后的空间分配内存了
        ShellCodeBuffer = (PVOID)(KernelCallBackTable + 0x100);
        AllocateSize = sizeof(gShellCode) + sizeof(ULONG_PTR);
        while (TRUE)
        {
            Status = ZwAllocateVirtualMemory(NtCurrentProcess(), &ShellCodeBuffer, 0, (SIZE_T *)&AllocateSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
            if (NT_SUCCESS(Status))
                break;

            ShellCodeBuffer = (PVOID)((ULONG_PTR)ShellCodeBuffer + 0x100);
        }
#else
		AllocateSize = sizeof(gShellCode) + sizeof(ULONG_PTR);
        Status = ZwAllocateVirtualMemory(NtCurrentProcess(), &ShellCodeBuffer, 0, (SIZE_T *)&AllocateSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
		if (FailStatus(Status))
		{
			KdPrint(("AllocateMemory Faile!,status is %x\n", Status));
			break;
		}
#endif
		RtlZeroMemory(ShellCodeBuffer, AllocateSize);
		RtlCopyMemory((PVOID)((ULONG_PTR)ShellCodeBuffer + sizeof(ULONG_PTR)), gShellCode, sizeof(gShellCode));
        *(ULONG_PTR*)ShellCodeBuffer = (ULONG_PTR)ShellCodeBuffer + sizeof(ULONG_PTR);

		AllocateSize = sizeof(gMsgText);
        Status = ZwAllocateVirtualMemory(NtCurrentProcess(), &MsgText, 0, (SIZE_T *)&AllocateSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
		if (FailStatus(Status))
		{
			KdPrint(("AllocateMemory Faile!,status is %x\n", Status));
			break;
		}
		RtlZeroMemory(MsgText, AllocateSize);
		RtlCopyMemory(MsgText, gMsgText, sizeof(gMsgText));

        ApiIndex = (ULONG)(((ULONG_PTR)ShellCodeBuffer - KernelCallBackTable) / sizeof(ULONG_PTR));
		Arguments[0] = MsgBoxABase;
		Arguments[1] = 0;							//hwnd = NULL
		Arguments[2] = (ULONG_PTR)MsgText;
		Arguments[3] = (ULONG_PTR)MsgText;
		Arguments[4] = 0;							//MB_OK

		Status = KeUserModeCallback(ApiIndex, Arguments, sizeof(Arguments), &RetBuffer, &RetLength);
		if (FailStatus(Status))
		{
			KdPrint(("调用KeUserModeCallBack失败！错误码是：%x！\n", Status));
			break; 
		}

	} while (FALSE);
}

VOID Unload(PDRIVER_OBJECT DriverObject)
{
	DeleteDevice(DriverObject);
	KdPrint(("Unload Success!\n"));
}

NTSTATUS DriverEntry(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegString)
{
	KdPrint(("Entry Driver!\n"));
	CreateDevice(DriverObject);
	DriverObject->DriverUnload = Unload;
	return STATUS_SUCCESS;
}
```

`KeUserModeCallBack/Windows Driver1/Windows Driver1.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Win7 Checked|Win32">
      <Configuration>Win7 Checked</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win7 Checked|x64">
      <Configuration>Win7 Checked</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win7 Free|Win32">
      <Configuration>Win7 Free</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win7 Free|x64">
      <Configuration>Win7 Free</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="WinXP Checked|Win32">
      <Configuration>WinXP Checked</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="WinXP Checked|x64">
      <Configuration>WinXP Checked</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="WinXP Free|Win32">
      <Configuration>WinXP Free</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="WinXP Free|x64">
      <Configuration>WinXP Free</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="Windows Driver1.c" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="IO.h" />
    <ClInclude Include="ZTY_DEFINE.h" />
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <ProjectGuid>{B54482B9-0297-4D9E-8CE7-6690A9D85315}</ProjectGuid>
    <RootNamespace>Windows_Driver1</RootNamespace>
    <ProjectName>KernelUserModeCallBack</ProjectName>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Label="Configuration" Condition="'$(Configuration)|$(Platform)'=='Win7 Checked|Win32'">
    <PlatformToolset>v120</PlatformToolset>
    <ConfigurationType>DynamicLibrary</ConfigurationType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|Win32'" Label="Configuration">
    <PlatformToolset>v120</PlatformToolset>
    <ConfigurationType>DynamicLibrary</ConfigurationType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|Win32'" Label="Configuration">
    <PlatformToolset>v120_xp</PlatformToolset>
    <ConfigurationType>DynamicLibrary</ConfigurationType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|Win32'" Label="Configuration">
    <PlatformToolset>v120_xp</PlatformToolset>
    <ConfigurationType>DynamicLibrary</ConfigurationType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Free|Win32'" Label="Configuration">
    <PlatformToolset>v120</PlatformToolset>
    <ConfigurationType>DynamicLibrary</ConfigurationType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Free|Win32'" Label="Configuration">
    <PlatformToolset>v120_xp</PlatformToolset>
    <ConfigurationType>DynamicLibrary</ConfigurationType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|Win32'" Label="Configuration">
    <PlatformToolset>v120_xp</PlatformToolset>
    <ConfigurationType>DynamicLibrary</ConfigurationType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Checked|x64'" Label="Configuration">
    <PlatformToolset>v120</PlatformToolset>
    <ConfigurationType>DynamicLibrary</ConfigurationType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|x64'" Label="Configuration">
    <PlatformToolset>v120_xp</PlatformToolset>
    <ConfigurationType>DynamicLibrary</ConfigurationType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Free|x64'" Label="Configuration">
    <PlatformToolset>v120</PlatformToolset>
    <ConfigurationType>DynamicLibrary</ConfigurationType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Free|x64'" Label="Configuration">
    <PlatformToolset>v120_xp</PlatformToolset>
    <ConfigurationType>DynamicLibrary</ConfigurationType>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Checked|Win32'">
    <TargetExt>.sys</TargetExt>
    <ExecutablePath>$(WDKPATH)\bin\x86\x86;$(ExecutablePath)</ExecutablePath>
    <IncludePath>$(WDKPATH)\inc\ddk;$(WDKPATH)\inc\api;$(WDKPATH)\inc\crt;$(VCInstallDir)include;$(WindowsSdkDir)include</IncludePath>
    <LibraryPath>$(WDKPATH)\lib\Crt\i386;$(WDKPATH)\lib\ATL\i386;$(WDKPATH)\lib\win7\i386</LibraryPath>
    <LinkIncremental>false</LinkIncremental>
    <GenerateManifest>false</GenerateManifest>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|Win32'">
    <TargetExt>.sys</TargetExt>
    <ExecutablePath>$(WDKPATH)\bin\x86\x86;$(ExecutablePath)</ExecutablePath>
    <IncludePath>$(WDKPATH)\inc\ddk;$(WDKPATH)\inc\api;$(WDKPATH)\inc\crt;$(VCInstallDir)include;$(WindowsSdkDir)include</IncludePath>
    <LibraryPath>$(WDKPATH)\lib\Crt\i386;$(WDKPATH)\lib\ATL\i386;$(WDKPATH)\lib\win7\i386</LibraryPath>
    <LinkIncremental>false</LinkIncremental>
    <GenerateManifest>false</GenerateManifest>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|Win32'">
    <TargetExt>.sys</TargetExt>
    <ExecutablePath>$(WDKPATH)\bin\x86\x86;$(ExecutablePath)</ExecutablePath>
    <IncludePath>$(WDKPATH)\inc\ddk;$(WDKPATH)\inc\api;$(WDKPATH)\inc\crt;$(VCInstallDir)include;$(WindowsSdkDir)include</IncludePath>
    <LibraryPath>$(WDKPATH)\lib\Crt\i386;$(WDKPATH)\lib\ATL\i386;$(WDKPATH)\lib\win7\i386</LibraryPath>
    <LinkIncremental>false</LinkIncremental>
    <GenerateManifest>false</GenerateManifest>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|Win32'">
    <TargetExt>.sys</TargetExt>
    <ExecutablePath>$(WDKPATH)\bin\x86\x86;$(ExecutablePath)</ExecutablePath>
    <IncludePath>$(WDKPATH)\inc\ddk;$(WDKPATH)\inc\api;$(WDKPATH)\inc\crt;$(VCInstallDir)include;$(WindowsSdkDir)include</IncludePath>
    <LibraryPath>$(WDKPATH)\lib\Crt\i386;$(WDKPATH)\lib\ATL\i386;$(WDKPATH)\lib\win7\i386</LibraryPath>
    <LinkIncremental>false</LinkIncremental>
    <GenerateManifest>false</GenerateManifest>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Free|Win32'">
    <TargetExt>.sys</TargetExt>
    <ExecutablePath>$(WDKPATH)\bin\x86\x86;$(ExecutablePath)</ExecutablePath>
    <IncludePath>$(WDKPATH)\inc\ddk;$(WDKPATH)\inc\api;$(WDKPATH)\inc\crt;$(VCInstallDir)include;$(WindowsSdkDir)include</IncludePath>
    <LibraryPath>$(WDKPATH)\lib\Crt\i386;$(WDKPATH)\lib\ATL\i386;$(WDKPATH)\lib\win7\i386</LibraryPath>
    <LinkIncremental>false</LinkIncremental>
    <GenerateManifest>false</GenerateManifest>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Free|Win32'">
    <TargetExt>.sys</TargetExt>
    <ExecutablePath>$(WDKPATH)\bin\x86\x86;$(ExecutablePath)</ExecutablePath>
    <IncludePath>$(WDKPATH)\inc\ddk;$(WDKPATH)\inc\api;$(WDKPATH)\inc\crt;$(VCInstallDir)include;$(WindowsSdkDir)include</IncludePath>
    <LibraryPath>$(WDKPATH)\lib\Crt\i386;$(WDKPATH)\lib\ATL\i386;$(WDKPATH)\lib\wxp\i386</LibraryPath>
    <LinkIncremental>false</LinkIncremental>
    <GenerateManifest>false</GenerateManifest>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|Win32'">
    <TargetExt>.sys</TargetExt>
    <ExecutablePath>$(WDKPATH)\bin\x86\x86;$(ExecutablePath)</ExecutablePath>
    <IncludePath>$(WDKPATH)\inc\ddk;$(WDKPATH)\inc\api;$(WDKPATH)\inc\crt;$(VCInstallDir)include;$(WindowsSdkDir)include</IncludePath>
    <LibraryPath>$(WDKPATH)\lib\Crt\i386;$(WDKPATH)\lib\ATL\i386;$(WDKPATH)\lib\wxp\i386</LibraryPath>
    <LinkIncremental>false</LinkIncremental>
    <GenerateManifest>false</GenerateManifest>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Free|x64'">
    <TargetExt>.sys</TargetExt>
    <ExecutablePath>$(WDKPATH)\bin\x86\amd64</ExecutablePath>
    <IncludePath>$(WDKPATH)\inc\ddk;$(WDKPATH)\inc\api;$(WDKPATH)\inc\crt;$(VCInstallDir)include;$(WindowsSdkDir)include</IncludePath>
    <LibraryPath>$(WDKPATH)\lib\Crt\amd64;$(WDKPATH)\lib\ATL\amd64;$(WDKPATH)\lib\win7\amd64</LibraryPath>
    <LinkIncremental>false</LinkIncremental>
    <GenerateManifest>false</GenerateManifest>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Free|x64'">
    <TargetExt>.sys</TargetExt>
    <ExecutablePath>$(WDKPATH)\bin\x86\amd64</ExecutablePath>
    <IncludePath>$(WDKPATH)\inc\ddk;$(WDKPATH)\inc\api;$(WDKPATH)\inc\crt;$(VCInstallDir)include;$(WindowsSdkDir)include</IncludePath>
    <LibraryPath>$(WDKPATH)\lib\Crt\amd64;$(WDKPATH)\lib\ATL\amd64;</LibraryPath>
    <LinkIncremental>false</LinkIncremental>
    <GenerateManifest>false</GenerateManifest>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Checked|x64'">
    <TargetExt>.sys</TargetExt>
    <ExecutablePath>$(WDKPATH)\bin\x86\amd64;$(ExecutablePath)</ExecutablePath>
    <IncludePath>$(WDKPATH)\inc\ddk;$(WDKPATH)\inc\api;$(WDKPATH)\inc\crt;$(VCInstallDir)include;$(WindowsSdkDir)include;$(IncludePath)</IncludePath>
    <LibraryPath>$(WDKPATH)\lib\Crt\amd64;$(WDKPATH)\lib\ATL\amd64;$(WDKPATH)\lib\win7\amd64;$(LibraryPath)</LibraryPath>
    <LinkIncremental>false</LinkIncremental>
    <GenerateManifest>false</GenerateManifest>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|x64'">
    <TargetExt>.sys</TargetExt>
    <ExecutablePath>$(WDKPATH)\bin\x86\amd64</ExecutablePath>
    <IncludePath>$(WDKPATH)\inc\ddk;$(WDKPATH)\inc\api;$(WDKPATH)\inc\crt;$(VCInstallDir)include;$(WindowsSdkDir)include</IncludePath>
    <LibraryPath>$(WDKPATH)\lib\Crt\amd64;$(WDKPATH)\lib\ATL\amd64</LibraryPath>
    <LinkIncremental>false</LinkIncremental>
    <GenerateManifest>false</GenerateManifest>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Checked|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Free|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Free|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Checked|Win32'">
    <ClCompile>
      <TreatWarningAsError>false</TreatWarningAsError>
      <Optimization>Disabled</Optimization>
      <MinimalRebuild>true</MinimalRebuild>
      <ExceptionHandling>false</ExceptionHandling>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <CallingConvention>StdCall</CallingConvention>
      <PreprocessorDefinitions>_X86_;_DDK_;_WIN32_WINNT=0x0600;WINVER=0x0600;WINVER=0x0501;_NDEBUG;DBG=1</PreprocessorDefinitions>
      <DisableSpecificWarnings>
      </DisableSpecificWarnings>
      <TreatSpecificWarningsAsErrors>
      </TreatSpecificWarningsAsErrors>
    </ClCompile>
    <Link>
      <AdditionalDependencies>ntoskrnl.lib;ndis.lib;Hal.lib;wdm.lib;wdmsec.lib;wmilib.lib</AdditionalDependencies>
    </Link>
    <Link>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
      <EnableUAC>false</EnableUAC>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <GenerateMapFile>true</GenerateMapFile>
      <MapFileName>$(TargetDir)$(TargetName).map </MapFileName>
      <SubSystem>Native</SubSystem>
      <Driver>Driver</Driver>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
      <RandomizedBaseAddress />
      <DataExecutionPrevention />
      <AdditionalOptions> /SECTION:INIT,D /IGNORE:4078 /safeseh:no %(AdditionalOptions)</AdditionalOptions>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|Win32'">
    <ClCompile>
      <TreatWarningAsError>true</TreatWarningAsError>
      <Optimization>Disabled</Optimization>
      <MinimalRebuild>true</MinimalRebuild>
      <ExceptionHandling>false</ExceptionHandling>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <CallingConvention>StdCall</CallingConvention>
      <PreprocessorDefinitions>_X86_;_DDK_;_WIN32_WINNT=0x0600;WINVER=0x0600;WINVER=0x0501;_NDEBUG;DBG=0</PreprocessorDefinitions>
    </ClCompile>
    <Link>
      <AdditionalDependencies>ntoskrnl.lib;ndis.lib;Hal.lib;wdm.lib;wdmsec.lib;wmilib.lib</AdditionalDependencies>
    </Link>
    <Link>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
      <EnableUAC>false</EnableUAC>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <GenerateMapFile>true</GenerateMapFile>
      <MapFileName>$(TargetDir)$(TargetName).map </MapFileName>
      <SubSystem>Native</SubSystem>
      <Driver>Driver</Driver>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|Win32'">
    <ClCompile>
      <TreatWarningAsError>true</TreatWarningAsError>
      <Optimization>Disabled</Optimization>
      <MinimalRebuild>true</MinimalRebuild>
      <ExceptionHandling>false</ExceptionHandling>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <CallingConvention>StdCall</CallingConvention>
      <PreprocessorDefinitions>_X86_;_DDK_;_WIN32_WINNT=0x0600;WINVER=0x0600;WINVER=0x0501;_NDEBUG;DBG=0</PreprocessorDefinitions>
    </ClCompile>
    <Link>
      <AdditionalDependencies>ntoskrnl.lib;ndis.lib;Hal.lib;wdm.lib;wdmsec.lib;wmilib.lib</AdditionalDependencies>
    </Link>
    <Link>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
      <EnableUAC>false</EnableUAC>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <GenerateMapFile>true</GenerateMapFile>
      <MapFileName>$(TargetDir)$(TargetName).map </MapFileName>
      <SubSystem>Native</SubSystem>
      <Driver>Driver</Driver>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|Win32'">
    <ClCompile>
      <TreatWarningAsError>true</TreatWarningAsError>
      <Optimization>Disabled</Optimization>
      <MinimalRebuild>true</MinimalRebuild>
      <ExceptionHandling>false</ExceptionHandling>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <CallingConvention>StdCall</CallingConvention>
      <PreprocessorDefinitions>_X86_;_DDK_;_WIN32_WINNT=0x0600;WINVER=0x0600;WINVER=0x0501;_NDEBUG;DBG=0</PreprocessorDefinitions>
    </ClCompile>
    <Link>
      <AdditionalDependencies>ntoskrnl.lib;ndis.lib;Hal.lib;wdm.lib;wdmsec.lib;wmilib.lib</AdditionalDependencies>
    </Link>
    <Link>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
      <EnableUAC>false</EnableUAC>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <GenerateMapFile>true</GenerateMapFile>
      <MapFileName>$(TargetDir)$(TargetName).map </MapFileName>
      <SubSystem>Native</SubSystem>
      <Driver>Driver</Driver>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Free|Win32'">
    <ClCompile>
      <TreatWarningAsError>true</TreatWarningAsError>
      <Optimization>Disabled</Optimization>
      <MinimalRebuild>true</MinimalRebuild>
      <ExceptionHandling>false</ExceptionHandling>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <CallingConvention>StdCall</CallingConvention>
      <PreprocessorDefinitions>_X86_;_DDK_;_WIN32_WINNT=0x0601;WINVER=0x0601;WINVER=0x0501;_NDEBUG;DBG=0</PreprocessorDefinitions>
      <FunctionLevelLinking>false</FunctionLevelLinking>
    </ClCompile>
    <Link>
      <AdditionalDependencies>ntoskrnl.lib;ndis.lib;Hal.lib;wdm.lib;wdmsec.lib;wmilib.lib</AdditionalDependencies>
    </Link>
    <Link>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
      <EnableUAC>false</EnableUAC>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <GenerateMapFile>true</GenerateMapFile>
      <MapFileName>$(TargetDir)$(TargetName).map </MapFileName>
      <SubSystem>Native</SubSystem>
      <Driver>Driver</Driver>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
      <RandomizedBaseAddress />
      <DataExecutionPrevention />
      <AdditionalOptions> /SECTION:INIT,D /IGNORE:4078 /safeseh:no %(AdditionalOptions)</AdditionalOptions>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Free|Win32'">
    <ClCompile>
      <TreatWarningAsError>true</TreatWarningAsError>
      <Optimization>Disabled</Optimization>
      <MinimalRebuild>true</MinimalRebuild>
      <ExceptionHandling>false</ExceptionHandling>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <CallingConvention>StdCall</CallingConvention>
      <PreprocessorDefinitions>_X86_;_DDK_;_WIN32_WINNT=0x0501;WINVER=0x0501;WINVER=0x0501;_NDEBUG;DBG=0</PreprocessorDefinitions>
      <FunctionLevelLinking>false</FunctionLevelLinking>
    </ClCompile>
    <Link>
      <AdditionalDependencies>ntoskrnl.lib;ndis.lib;Hal.lib;wdm.lib;wdmsec.lib;wmilib.lib</AdditionalDependencies>
    </Link>
    <Link>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
      <EnableUAC>false</EnableUAC>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <GenerateMapFile>true</GenerateMapFile>
      <MapFileName>$(TargetDir)$(TargetName).map </MapFileName>
      <SubSystem>Native</SubSystem>
      <Driver>Driver</Driver>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
      <AdditionalOptions> /SECTION:INIT,D /IGNORE:4078 /safeseh:no %(AdditionalOptions)</AdditionalOptions>
      <RandomizedBaseAddress />
      <DataExecutionPrevention />
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|Win32'">
    <ClCompile>
      <TreatWarningAsError>true</TreatWarningAsError>
      <Optimization>Disabled</Optimization>
      <MinimalRebuild>true</MinimalRebuild>
      <ExceptionHandling>false</ExceptionHandling>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <CallingConvention>StdCall</CallingConvention>
      <PreprocessorDefinitions>_X86_;_DDK_;_WIN32_WINNT=0x0501;WINVER=0x0501;_DEBUG;DBG=1</PreprocessorDefinitions>
      <FunctionLevelLinking>false</FunctionLevelLinking>
    </ClCompile>
    <Link>
      <AdditionalDependencies>ntoskrnl.lib;ndis.lib;Hal.lib;wdm.lib;wdmsec.lib;wmilib.lib</AdditionalDependencies>
    </Link>
    <Link>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
      <EnableUAC>false</EnableUAC>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <GenerateMapFile>true</GenerateMapFile>
      <MapFileName>$(TargetDir)$(TargetName).map </MapFileName>
      <SubSystem>Native</SubSystem>
      <Driver>Driver</Driver>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
      <RandomizedBaseAddress />
      <DataExecutionPrevention />
      <AdditionalOptions> /SECTION:INIT,D /IGNORE:4078 /safeseh:no %(AdditionalOptions)</AdditionalOptions>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Checked|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <PreprocessorDefinitions>_AMD64_;_DDK_;_WIN32_WINNT=0x0601;WINVER=0x0601;_DEBUG;DBG=1</PreprocessorDefinitions>
      <MinimalRebuild>true</MinimalRebuild>
      <ExceptionHandling>false</ExceptionHandling>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <CallingConvention>StdCall</CallingConvention>
    </ClCompile>
    <Link>
      <AdditionalDependencies>ntoskrnl.lib;ndis.lib;Hal.lib;wdm.lib;wdmsec.lib;wmilib.lib</AdditionalDependencies>
    </Link>
    <Link>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
      <EnableUAC>false</EnableUAC>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <GenerateMapFile>true</GenerateMapFile>
      <MapFileName>$(TargetDir)$(TargetName).map </MapFileName>
      <SubSystem>Native</SubSystem>
      <Driver>Driver</Driver>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
      <RandomizedBaseAddress />
      <DataExecutionPrevention />
      <AdditionalOptions> /SECTION:INIT,D /IGNORE:4078 /safeseh:no %(AdditionalOptions)</AdditionalOptions>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Free|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <PreprocessorDefinitions>_AMD64_;_DDK_;_WIN32_WINNT=0x0601;WINVER=0x0601;WINVER=0x0501;_NDEBUG;DBG=0</PreprocessorDefinitions>
      <ExceptionHandling>false</ExceptionHandling>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <CallingConvention>StdCall</CallingConvention>
    </ClCompile>
    <Link>
      <AdditionalDependencies>ntoskrnl.lib;ndis.lib;Hal.lib;wdm.lib;wdmsec.lib;wmilib.lib</AdditionalDependencies>
    </Link>
    <Link>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
      <EnableUAC>false</EnableUAC>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <GenerateMapFile>true</GenerateMapFile>
      <MapFileName>$(TargetDir)$(TargetName).map </MapFileName>
      <SubSystem>Native</SubSystem>
      <MinimumRequiredVersion />
      <Driver>Driver</Driver>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
      <RandomizedBaseAddress />
      <DataExecutionPrevention />
      <AdditionalOptions> /SECTION:INIT,D /IGNORE:4078 /safeseh:no %(AdditionalOptions)</AdditionalOptions>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Checked|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <PreprocessorDefinitions>_AMD64_;_DDK_;_WIN32_WINNT=0x0501;WINVER=0x0501;_DEBUG;DBG=1</PreprocessorDefinitions>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <CallingConvention>StdCall</CallingConvention>
    </ClCompile>
    <Link>
      <AdditionalDependencies>ntoskrnl.lib;ndis.lib;Hal.lib;wdm.lib;wdmsec.lib;wmilib.lib</AdditionalDependencies>
    </Link>
    <Link>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
      <EnableUAC>false</EnableUAC>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <GenerateMapFile>true</GenerateMapFile>
      <MapFileName>$(TargetDir)$(TargetName).map </MapFileName>
      <SubSystem>Native</SubSystem>
      <MinimumRequiredVersion />
      <Driver>Driver</Driver>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
      <RandomizedBaseAddress />
      <DataExecutionPrevention />
      <AdditionalOptions> /SECTION:INIT,D /IGNORE:4078 /safeseh:no %(AdditionalOptions)</AdditionalOptions>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='WinXP Free|x64'">
    <Link>
      <AdditionalOptions> /SECTION:INIT,D /IGNORE:4078 /safeseh:no %(AdditionalOptions)</AdditionalOptions>
      <AdditionalDependencies>Hal.lib;wdm.lib;wdmsec.lib;wmilib.lib</AdditionalDependencies>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
      <EnableUAC>false</EnableUAC>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <GenerateMapFile>true</GenerateMapFile>
      <MapFileName>$(TargetDir)$(TargetName).map </MapFileName>
      <SubSystem>Native</SubSystem>
      <MinimumRequiredVersion />
      <Driver>Driver</Driver>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
      <RandomizedBaseAddress />
      <DataExecutionPrevention />
    </Link>
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <PreprocessorDefinitions>_AMD64_;_DDK_;_WIN32_WINNT=0x0501;WINVER=0x0501;WINVER=0x0501;_NDEBUG;DBG=0</PreprocessorDefinitions>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <CallingConvention>StdCall</CallingConvention>
    </ClCompile>
  </ItemDefinitionGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`KeUserModeCallBack/Windows Driver1/Windows Driver1.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="源文件">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="头文件">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;xsd</Extensions>
    </Filter>
    <Filter Include="资源文件">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="Windows Driver1.c">
      <Filter>源文件</Filter>
    </ClCompile>
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="ZTY_DEFINE.h">
      <Filter>头文件</Filter>
    </ClInclude>
    <ClInclude Include="IO.h">
      <Filter>头文件</Filter>
    </ClInclude>
  </ItemGroup>
</Project>
```

`KeUserModeCallBack/Windows Driver1/Windows Driver1.vcxproj.user`:

```user
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup />
</Project>
```

`KeUserModeCallBack/Windows Driver1/ZTY_DEFINE.h`:

```h
#ifndef _ZTY_DEFINE_H_
#define _ZTY_DEFINE_H_

#define sfAllocateMemory(SIZE) ExAllocatePoolWithTag(NonPagedPool,SIZE,'ytz')
#define sfFreeMemory(P) if(P != NULL){ExFreePoolWithTag(P,'ytz');P = NULL;}
#define FailStatus(status) !NT_SUCCESS(status)

#define SystemProcessInformation 5

typedef enum _THREAD_STATE{
	StateInitialized,
	StateReady,
	StateRunning,
	StateStandby,
	StateTerminated,
	StateWait,
	StateTransition,
	StateUnknown
} THREAD_STATE;

typedef struct _SYSTEM_THREAD_INFORMATION
{
	LARGE_INTEGER KernelTime;
	LARGE_INTEGER UserTime;
	LARGE_INTEGER CreateTime;
	ULONG WaitTime;
	PVOID StartAddress;
	CLIENT_ID ClientId;
	KPRIORITY Priority;
	LONG BasePriority;
	ULONG ContextSwitches;
	THREAD_STATE ThreadState;
	KWAIT_REASON WaitReason;
} SYSTEM_THREAD_INFORMATION, *PSYSTEM_THREAD_INFORMATION;

typedef struct _SYSTEM_PROCESS_INFORMATION
{
	ULONG NextEntryOffset;
	ULONG NumberOfThreads;
	LARGE_INTEGER SpareLi1;
	LARGE_INTEGER SpareLi2;
	LARGE_INTEGER SpareLi3;
	LARGE_INTEGER CreateTime;
	LARGE_INTEGER UserTime;
	LARGE_INTEGER KernelTime;
	UNICODE_STRING ImageName;
	KPRIORITY BasePriority;
	HANDLE UniqueProcessId;
	HANDLE InheritedFromUniqueProcessId;
	ULONG HandleCount;
	ULONG SessionId;
	ULONG_PTR PageDirectoryBase;

	//
	// This part corresponds to VM_COUNTERS_EX.
	// NOTE: *NOT* THE SAME AS VM_COUNTERS!
	//
	SIZE_T PeakVirtualSize;
	ULONG VirtualSize;
	SIZE_T PageFaultCount;
	SIZE_T PeakWorkingSetSize;
	SIZE_T WorkingSetSize;
	SIZE_T QuotaPeakPagedPoolUsage;
	SIZE_T QuotaPagedPoolUsage;
	SIZE_T QuotaPeakNonPagedPoolUsage;
	SIZE_T QuotaNonPagedPoolUsage;
	SIZE_T PagefileUsage;
	SIZE_T PeakPagefileUsage;
	SIZE_T PrivatePageCount;

	//
	// This part corresponds to IO_COUNTERS
	//
	LARGE_INTEGER ReadOperationCount;
	LARGE_INTEGER WriteOperationCount;
	LARGE_INTEGER OtherOperationCount;
	LARGE_INTEGER ReadTransferCount;
	LARGE_INTEGER WriteTransferCount;
	LARGE_INTEGER OtherTransferCount;

	SYSTEM_THREAD_INFORMATION Threads[1];
} SYSTEM_PROCESS_INFORMATION, *PSYSTEM_PROCESS_INFORMATION;

typedef NTSTATUS(*ZWQUERYSYSTEMINFORMATION)(IN ULONG SystemInformationClass, OUT PVOID SystemInformation, IN ULONG SystemInformationLength, OUT PULONG ReturnLength);

typedef struct _LDR_DATA_TABLE_ENTRY
{
	LIST_ENTRY InLoadOrderLinks;
	LIST_ENTRY InMemoryOrderLinks;
	LIST_ENTRY InInitializationOrderLinks;
	PVOID DllBase;
	PVOID EntryPoint;
	ULONG SizeOfImage;
	UNICODE_STRING FullDllName;
	UNICODE_STRING BaseDllName;
	ULONG Flags;
	USHORT LoadCount;
	USHORT
		TlsIndex;
	union
	{
		LIST_ENTRY HashLinks;
		struct
		{
			PVOID SectionPointer;
			ULONG CheckSum;
		};
	};
	union
	{
		ULONG TimeDateStamp;
		PVOID LoadedImports;
	};
	VOID * EntryPointActivationContext;
	PVOID PatchInformation;
	LIST_ENTRY ForwarderLinks;
	LIST_ENTRY ServiceTagLinks;
	LIST_ENTRY StaticLinks;
} LDR_DATA_TABLE_ENTRY, *PLDR_DATA_TABLE_ENTRY;

typedef struct _PEB_LDR_DATA {
	ULONG Length;
	UCHAR Initialized;
	PVOID SsHandle;
	LIST_ENTRY InLoadOrderModuleList;
	LIST_ENTRY InMemoryOrderModuleList;
} PEB_LDR_DATA, *PPEB_LDR_DATA;

typedef struct _PEB {
	UCHAR                         Reserved1[2];
	UCHAR                         BeingDebugged;
	UCHAR                         Reserved2[1];
	PVOID                         Reserved3[2];
	PPEB_LDR_DATA                 Ldr;
	PVOID						  ProcessParameters;
	PVOID                         Reserved4[3];
	PVOID                         AtlThunkSListPtr;
	PVOID                         Reserved5;
	ULONG                         Reserved6;
	ULONG_PTR                     KernelCallbackTable;				//其实是一个数组指针的地址，里面都是从内核返回的函数地址
	ULONG                         Reserved8;
	ULONG                         AtlThunkSListPtr32;
	PVOID                         Reserved9[45];
	UCHAR                         Reserved10[96];
	PVOID						  PostProcessInitRoutine;
	UCHAR                         Reserved11[128];
	PVOID                         Reserved12[1];
	ULONG                         SessionId;
} PEB, *PPEB;

UCHAR * PsGetProcessImageFileName(__in PEPROCESS Process);

PVOID GetProcAddress(WCHAR *FuncName)
{
	UNICODE_STRING u_FuncName;
	RtlInitUnicodeString(&u_FuncName, FuncName);
	return MmGetSystemRoutineAddress(&u_FuncName);
}

#endif

```