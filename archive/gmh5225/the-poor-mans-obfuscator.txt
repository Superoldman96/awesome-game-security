Project Path: arc_gmh5225_the-poor-mans-obfuscator_3e2fs3zz

Source Tree:

```txt
arc_gmh5225_the-poor-mans-obfuscator_3e2fs3zz
├── README.md
├── bin
│   ├── mbedtls_self_test.arm64.elf
│   ├── mbedtls_self_test.arm64.macho
│   ├── mbedtls_self_test.nostrip.arm64.elf
│   └── test_objc_arm64.macho
├── scripts
│   ├── 00-unwind-eh_frame
│   │   ├── 01-macho-unwind.py
│   │   └── 02-elf-eh_frame.py
│   ├── 01-symbols
│   │   ├── 01-exports-elf.py
│   │   ├── 02-exports-name-elf.py
│   │   ├── 03-exports-name-elf.py
│   │   └── 04-exports-name-unaligned-elf.py
│   ├── 02-sections
│   │   ├── 01-macho-section.py
│   │   └── 02-elf-sections-swap.py
│   └── 03-misc
│       ├── 01-elf-dynsym.py
│       └── 02-macho-LC_FUNCTION_STARTS.py
└── transformed
    ├── 00-unwind-eh_frame
    │   ├── eh-frame_mbedtls_self_test.arm64.elf
    │   └── unwind_mbedtls_self_test.arm64.macho
    ├── 01-symbols
    │   ├── 01-mbedtls_self_test.arm64.elf
    │   ├── 02-mbedtls_self_test.arm64.elf
    │   ├── 03-mbedtls_self_test.arm64.elf
    │   └── 04-mbedtls_self_test.arm64.elf
    ├── 02-sections
    │   ├── swapped_mbedtls_self_test.arm64.elf
    │   └── test_objc_arm64_shifted.macho
    └── 03-misc
        ├── dynsym-mbedtls_self_test.arm64.elf
        └── fstarts_mbedtls_self_test.arm64.macho

```

`README.md`:

```md
<p align="center">
  <br /> <br />
  <a href="https://www.romainthomas.fr/publication/22-PST-The-Poor-Mans-Obfuscator">
  <img src=".github/front.png" alt="The Poor Man's Obfuscator">
  </a>
</p>


```

`scripts/00-unwind-eh_frame/01-macho-unwind.py`:

```py
#!/usr/bin/env python3
import lief
import random

target = lief.parse("mbedtls_self_test.arm64.macho")

section = target.get_section("__unwind_info")
content = list(section.content)
random.shuffle(content)
section.content = content

target.write("unwind_mbedtls_self_test.arm64.macho")

```

`scripts/00-unwind-eh_frame/02-elf-eh_frame.py`:

```py
#!/usr/bin/env python3
import lief
import random

target = lief.parse("mbedtls_self_test.arm64.elf")
for sname in [".eh_frame", ".eh_frame_hdr"]:
    section = target.get_section(sname)
    if section is None:
        continue
    content = list(section.content)
    random.shuffle(content)
    section.content = content

target.write("eh-frame_mbedtls_self_test.arm64.elf")

```

`scripts/01-symbols/01-exports-elf.py`:

```py
#!/usr/bin/env python3
"""
This script creates exports with random names.
"""

import lief
import random
import string
target: lief.ELF.Binary = lief.parse("mbedtls_self_test.arm64.elf")

for idx, function in enumerate(target.functions):
    name = "".join(random.choice(string.ascii_letters) for i in range(20))
    target.add_exported_function(function.address, name)

target.write("01-mbedtls_self_test.arm64.elf")

```

`scripts/01-symbols/02-exports-name-elf.py`:

```py
#!/usr/bin/env python3
"""
This script creates exports with names taken from the
unstripped version of the mbedtls binary
"""

import lief
import random

target: lief.ELF.Binary = lief.parse("mbedtls_self_test.arm64.elf")
non_striped = lief.parse("mbedtls_self_test.nostrip.arm64.elf")

SYMBOLS = [s.name for s in non_striped.symbols if s.name.startswith("mbedtls_")]

for idx, function in enumerate(target.functions):
    if len(SYMBOLS) == 0:
        break

    sym = random.choice(SYMBOLS)
    SYMBOLS.remove(sym)
    target.add_exported_function(function.address, sym)

target.write("02-mbedtls_self_test.arm64.elf")

```

`scripts/01-symbols/03-exports-name-elf.py`:

```py
#!/usr/bin/env python3
"""
This script creates exports with names taken from the libc.so
"""
import lief
import random

target: lief.ELF.Binary = lief.parse("mbedtls_self_test.arm64.elf")
libc = lief.parse("<ANDROID_HOME>/sdk/ndk/24.0.8215888/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/23/libc.so")

libc_symbols = {s.name for s in libc.exported_symbols}
libc_symbols -= {s.name for s in target.imported_symbols}
libc_symbols = list(libc_symbols)


for idx, function in enumerate(target.functions):
    if len(libc_symbols) == 0:
        break

    sym = random.choice(libc_symbols)
    libc_symbols.remove(sym)

    export = target.add_exported_function(function.address, sym)

    export.binding    = lief.ELF.SYMBOL_BINDINGS.GNU_UNIQUE
    export.visibility = lief.ELF.SYMBOL_VISIBILITY.INTERNAL

target.write("03-mbedtls_self_test.arm64.elf")

```

`scripts/01-symbols/04-exports-name-unaligned-elf.py`:

```py
#!/usr/bin/env python3
"""
This scripts creates exports with names taken from the libc and
and addresses not aligned with the beginning of a function.
"""
import lief
import random

target: lief.ELF.Binary = lief.parse("mbedtls_self_test.arm64.elf")
libc = lief.parse("<ANDROID_HOME>/sdk/ndk/24.0.8215888/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/23/libc.so")

libc_symbols = {s.name for s in libc.exported_symbols}
libc_symbols -= {s.name for s in target.imported_symbols}
libc_symbols = list(libc_symbols)


for idx, function in enumerate(target.functions):
    if len(libc_symbols) == 0:
        break

    sym = random.choice(libc_symbols)
    libc_symbols.remove(sym)

    address = function.address
    address += random.randint(16, 32)
    address -= address % 4

    export = target.add_exported_function(address, sym)

    export.binding    = lief.ELF.SYMBOL_BINDINGS.GNU_UNIQUE
    export.visibility = lief.ELF.SYMBOL_VISIBILITY.INTERNAL

target.write("04-mbedtls_self_test.arm64.elf")

```

`scripts/02-sections/01-macho-section.py`:

```py
import lief

target = lief.parse("test_objc_arm64.macho")

__text  = target.get_section("__text")
__stubs = target.get_section("__stubs")

SHIFT = 0x100

__text.size             -= SHIFT
__stubs.offset          -= SHIFT
__stubs.virtual_address -= SHIFT
__stubs.size            += SHIFT

target.write("test_objc_arm64_shifted.macho")

```

`scripts/02-sections/02-elf-sections-swap.py`:

```py
import lief
SWAP_LIST = [
    (".rela.dyn", ".data.rel.ro"),
    (".got",      ".got.plt"),
    #(".got",      ".data"),
    (".plt",      ".text"),
    (".dynsym",   ".gnu.version"),

    #(".preinit_array", ".bss"),
]

target = lief.parse("mbedtls_self_test.arm64.elf")

for (lhs_name, rhs_name) in SWAP_LIST:
    print(lhs_name, rhs_name)
    lhs = target.get_section(lhs_name).as_frame()
    rhs = target.get_section(rhs_name).as_frame()
    tmp = lhs.offset, lhs.size, lhs.name, lhs.type, lhs.virtual_address

    lhs.offset          = rhs.offset
    lhs.size            = rhs.size
    lhs.name            = rhs.name
    lhs.type            = rhs.type
    lhs.virtual_address = rhs.virtual_address

    rhs.offset          = tmp[0]
    rhs.size            = tmp[1]
    rhs.name            = tmp[2]
    rhs.type            = tmp[3]
    rhs.virtual_address = tmp[4]

target.write("swapped_mbedtls_self_test.arm64.elf")

```

`scripts/03-misc/01-elf-dynsym.py`:

```py
import lief
import random

target: lief.ELF.Binary = lief.parse("mbedtls_self_test.arm64.elf")

dynsym = target.get_section(".dynsym").as_frame()

sizeof = dynsym.entry_size
osize = dynsym.size
nsyms = osize / sizeof
dynsym.size = sizeof * min(3, nsyms)

target.write("dynsym-mbedtls_self_test.arm64.elf")

```

`scripts/03-misc/02-macho-LC_FUNCTION_STARTS.py`:

```py
#!/usr/bin/env python3
import lief
import random

bin = lief.parse("./mbedtls_self_test.arm64.macho")
LC_FUNCTION_STARTS = bin[lief.MachO.LOAD_COMMAND_TYPES.FUNCTION_STARTS]

functions = [f for f in LC_FUNCTION_STARTS.functions]

for idx, f in enumerate(functions):
    if idx % 2 == 0:
        functions[idx] += 4 * 7
    else:
        functions[idx] -= 4 * 7

bin.write("./fstarts_mbedtls_self_test.arm64.macho")




```