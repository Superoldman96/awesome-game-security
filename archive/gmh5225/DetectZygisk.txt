Project Path: arc_gmh5225_DetectZygisk_9dz5j5u2

Source Tree:

```txt
arc_gmh5225_DetectZygisk_9dz5j5u2
├── DetectZ.apk
├── DetectZygisk.cpp
└── README.md

```

`DetectZygisk.cpp`:

```cpp
#include <jni.h>
#include <unistd.h>
#include <sys/ptrace.h>
#include <sys/wait.h>
#include <signal.h>
#include <string>
#include <android/log.h>
#include <errno.h>
#include <stdlib.h>

#define LOG_TAG "DetectZygisk"
#define LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, LOG_TAG, __VA_ARGS__)
#define LOGE(...) __android_log_print(ANDROID_LOG_ERROR, LOG_TAG, __VA_ARGS__)
#define LOGI(...) __android_log_print(ANDROID_LOG_INFO, LOG_TAG, __VA_ARGS__)

bool detectZygisk() {
    LOGI("Starting Zygisk detection");

    pid_t child_pid = fork();
    LOGD("fork() returned: %d", child_pid);

    if (child_pid == 0) {
        LOGD("Child process started");

        pid_t parent_pid = getppid();
        LOGD("Parent PID: %d", parent_pid);

        LOGD("Attempting ptrace(PTRACE_ATTACH, %d, 0, 0)", parent_pid);
        if (ptrace(PTRACE_ATTACH, parent_pid, 0, 0) == -1) {
            LOGE("ptrace(PTRACE_ATTACH) failed, errno: %d", errno);
            _exit(0);
        }
        LOGD("ptrace(PTRACE_ATTACH) successful");

        int status;
        LOGD("Calling waitpid(%d, &status, 0)", parent_pid);
        if (waitpid(parent_pid, &status, 0) == -1) {
            LOGE("waitpid() failed, errno: %d", errno);
            ptrace(PTRACE_DETACH, parent_pid, 0, 0);
            _exit(0);
        }
        LOGD("waitpid() successful, status: %d", status);

        unsigned long msg = 0;
        LOGD("Calling ptrace(PTRACE_GETEVENTMSG, %d, 0, &msg)", parent_pid);
        if (ptrace(PTRACE_GETEVENTMSG, parent_pid, 0, &msg) == -1) {
            LOGE("ptrace(PTRACE_GETEVENTMSG) failed, errno: %d", errno);
            ptrace(PTRACE_DETACH, parent_pid, 0, 0);
            _exit(0);
        }
        LOGI("ptrace(PTRACE_GETEVENTMSG) successful, msg: %lu", msg);

        LOGD("Calling ptrace(PTRACE_DETACH, %d, 0, 0)", parent_pid);
        if (ptrace(PTRACE_DETACH, parent_pid, 0, 0) == -1) {
            LOGE("ptrace(PTRACE_DETACH) failed, errno: %d", errno);
        }
        LOGD("ptrace(PTRACE_DETACH) completed");

        if (msg > 0 && msg < 65536) {
            LOGI("Zygisk DETECTED - ptrace have zygote64 pid: %lu", msg);
            _exit(1);
        } else {
            LOGI("Zygisk NOT DETECTED - ptrace message: %lu", msg);
            _exit(0);
        }
    } else if (child_pid > 0) {
        LOGD("Parent process waiting for child: %d", child_pid);

        int status;
        pid_t wait_result = waitpid(child_pid, &status, 0);
        LOGD("waitpid returned: %d, status: %d", wait_result, status);

        if (WIFEXITED(status)) {
            int exit_code = WEXITSTATUS(status);
            LOGD("Child exited normally with exit code: %d", exit_code);
            bool result = (exit_code == 1);
            LOGI("Final detection result: %s", result ? "ZYGISK DETECTED" : "ZYGISK NOT DETECTED");
            return result;
        } else if (WIFSIGNALED(status)) {
            int signal_num = WTERMSIG(status);
            LOGE("Child process killed by signal: %d", signal_num);
            LOGE("Child was terminated abnormally");
        } else {
            LOGE("Child process status unknown: %d", status);
        }
    } else {
        LOGE("fork() failed, errno: %d", errno);
    }

    LOGI("Detection failed or error occurred");
    return false;
}

extern "C" JNIEXPORT jstring JNICALL
Java_com_test_detectz_MainActivity_stringFromJNI(
        JNIEnv* env,
        jobject /* this */) {

    LOGI("JNI function called - starting detection");

    if (detectZygisk()) {
        LOGI("Returning: Detected Zygisk");
        return env->NewStringUTF("Zygisk Detected");
    } else {
        LOGI("Returning: Zygisk Not Detected");
        return env->NewStringUTF("Zygisk Not Detected");
    }

}
```

`README.md`:

```md
# DetectZygisk
A POC to detect zygisk

Idea of detection is taken from this github issue https://github.com/PerformanC/ReZygisk/issues/171

Writing here in case issue is deleted or removed - 

---------------------------------------------------------------------------------------------------------------------------------------------

# Description

YONO SBI forks a child process where it will do something like this:

```cpp
ptrace(PTRACE_ATTACH, getppid(), 0, 0);
int status;
waitpid(getppid(), &status, 0);
unsigned long msg = 0;
ptrace(PTRACE_GETEVENTMSG, getppid(), 0, &msg);
```

If ReZygisk is active, then msg will be the pid of zygote. I think this is because when init forks into zygote, Linux will put the pid of zygote as the ptrace message of the ptrace fork stop event. Then apparently in the absence of another ptrace stop that would overwrite it, it will propagate into the child processes. YONO SBI then detects this leftover value.

Running something like this just once on zygote makes YONO SBI work fine on my device:
```cpp
ptrace(PTRACE_ATTACH, zygote_pid, 0, 0);
int status;
waitpid(zygote_pid, &status, 0);
ptrace(PTRACE_SYSCALL, zygote_pid, 0, 0);
waitpid(zygote_pid, &status, 0);
ptrace(PTRACE_DETACH, zygote_pid, 0, 0);
```
The syscall ptrace stop will set the ptrace event message to zero.

---------------------------------------------------------------------------------------------------------------------------------------------


# Implementation

Core idea is written by ChatGPT deep research ( Good use of AI )

```sh
DetectZygisk: JNI function called - starting detection
DetectZygisk: Starting Zygisk detection
DetectZygisk: fork() returned: 22137
DetectZygisk: Parent process waiting for child: 22137
DetectZygisk: fork() returned: 0
DetectZygisk: Child process started
DetectZygisk: Parent PID: 22098
DetectZygisk: Attempting ptrace(PTRACE_ATTACH, 22098, 0, 0)
DetectZygisk: ptrace(PTRACE_ATTACH) successful
DetectZygisk: Calling waitpid(22098, &status, 0)
DetectZygisk: waitpid() successful, status: 4991
DetectZygisk: Calling ptrace(PTRACE_GETEVENTMSG, 22098, 0, &msg)
DetectZygisk: ptrace(PTRACE_GETEVENTMSG) successful, msg: 1456
DetectZygisk: Calling ptrace(PTRACE_DETACH, 22098, 0, 0)
DetectZygisk: ptrace(PTRACE_DETACH) completed
DetectZygisk: Zygisk DETECTED - ptrace have zygote64 pid: 1456
DetectZygisk: waitpid returned: 22137, status: 256
DetectZygisk: Child exited normally with exit code: 1
DetectZygisk: Final detection result: ZYGISK DETECTED
DetectZygisk: Returning: Detected Zygisk
```


# ✅ Testing

| Repository                                                                                      | Status      |
|--------------------------------------------------------------------------------------------------|-------------|
| [PerformanC/ReZygisk](https://github.com/PerformanC/ReZygisk)                                   | ✅ Detected |
| [Dr-TSNG/ZygiskNext](https://github.com/Dr-TSNG/ZygiskNext)                                     | ✅ Detected |
| [JingMatrix/NeoZygisk](https://github.com/JingMatrix/NeoZygisk)                                 | ✅ Detected |
| [topjohnwu/Magisk - zygisk core](https://github.com/topjohnwu/Magisk/tree/master/native/src/core/zygisk) | ❌ Not Detected |



```